<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>GhostLedger â€” Operations Hub v5</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;background:#0a0e14;color:#e6edf3;min-height:100vh}
.app{max-width:1280px;margin:0 auto;padding:24px 20px}

/* HEADER */
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:42px;height:42px;background:linear-gradient(135deg,#8B5E3C,#c9956b);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#0a0e14}
.brand h1{font-size:22px;color:#fff;letter-spacing:-0.5px}
.brand .tagline{font-size:12px;color:#8B5E3C;margin-top:2px;letter-spacing:0.5px;text-transform:uppercase}
.brand .descriptor{font-size:12px;color:#8b949e;margin-top:4px;letter-spacing:0;text-transform:none;line-height:1.4;max-width:460px}
.api-status{display:flex;align-items:center;gap:6px;font-size:11px;margin-top:6px}
.api-dot{width:8px;height:8px;border-radius:50%;animation:pulse 2s infinite}
.api-dot.online{background:#238636}
.api-dot.offline{background:#da3633}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
.timestamp{font-size:11px;color:#484f58;text-align:right;line-height:1.6}
.timestamp strong{color:#6e7681}

/* TABS */
.tabs{display:flex;gap:2px;margin-bottom:20px;background:#161b22;border-radius:10px;padding:4px;border:1px solid #21262d;flex-wrap:wrap}
.tab{position:relative;padding:10px 16px;background:transparent;border:none;border-radius:8px;cursor:pointer;color:#6e7681;font-size:13px;font-weight:500;transition:all .2s}
.tab:hover{color:#c9d1d9;background:#1c2129}
.tab.active{background:#0a0e14;color:#e6edf3;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.tab .badge{position:absolute;top:4px;right:6px;background:#da3633;color:#fff;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px}
.tab .badge.green{background:#238636}
.tab .badge.blue{background:#1f6feb}
.tab .badge.copper{background:#8B5E3C}
.tab .badge.hidden{display:none}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:#12171e;border:1px solid #1c2129;border-radius:12px;padding:18px 16px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
.stat-card.blue::before{background:linear-gradient(90deg,#1f6feb,#58a6ff)}
.stat-card.green::before{background:linear-gradient(90deg,#238636,#4ade80)}
.stat-card.purple::before{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
.stat-card.copper::before{background:linear-gradient(90deg,#8B5E3C,#c9956b)}
.stat-card.red::before{background:linear-gradient(90deg,#da3633,#f85149)}
.stat-card.cyan::before{background:linear-gradient(90deg,#0891b2,#22d3ee)}
.stat-icon{font-size:20px;margin-bottom:8px}
.stat-num{font-size:28px;font-weight:700;letter-spacing:-1px;margin-bottom:2px}
.stat-card.blue .stat-num{color:#58a6ff}
.stat-card.green .stat-num{color:#4ade80}
.stat-card.purple .stat-num{color:#a78bfa}
.stat-card.copper .stat-num{color:#c9956b}
.stat-card.red .stat-num{color:#f85149}
.stat-card.cyan .stat-num{color:#22d3ee}
.stat-label{font-size:10px;color:#585e68;letter-spacing:1px;text-transform:uppercase;font-weight:600}

/* PANEL */
.panel{display:none;animation:fadeIn .2s ease}
.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* TABLE */
.table-wrap{overflow-x:auto;border:1px solid #1c2129;border-radius:10px;background:#12171e}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#161b22;color:#585e68;text-align:left;padding:12px 10px;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #21262d;position:sticky;top:0;z-index:1}
td{padding:10px;border-bottom:1px solid #1c2129;color:#c9d1d9;vertical-align:middle}
tr:hover td{background:#161b22}
tr:last-child td{border-bottom:none}
.empty-row{text-align:center;color:#484f58;padding:40px 10px;font-size:14px}
.empty-row .empty-icon{font-size:32px;margin-bottom:8px;opacity:.5}

/* FORM ELEMENTS */
input,select,textarea{background:#0d1117;border:1px solid #21262d;color:#e6edf3;padding:7px 10px;border-radius:6px;width:100%;font-size:12px;font-family:inherit;transition:border-color .2s}
input:focus,select:focus,textarea:focus{outline:none;border-color:#8B5E3C;box-shadow:0 0 0 2px rgba(139,94,60,.2)}
select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236e7681' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:28px}

/* STATUS */
.status{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;display:inline-block;white-space:nowrap}
.s-draft{background:rgba(110,118,129,.12);color:#6e7681}
.s-filed{background:rgba(88,166,255,.12);color:#58a6ff}
.s-under_review{background:rgba(251,191,36,.12);color:#fbbf24}
.s-escalated{background:rgba(249,115,22,.12);color:#f97316}
.s-in_resolution{background:rgba(167,139,250,.12);color:#a78bfa}
.s-resolved{background:rgba(74,222,128,.12);color:#4ade80}
.s-closed{background:rgba(110,118,129,.12);color:#6e7681}
.s-appealed{background:rgba(248,81,73,.12);color:#f85149}

/* VALUE BAND */
.vb{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.vb-micro{background:rgba(110,118,129,.12);color:#6e7681}
.vb-small{background:rgba(88,166,255,.12);color:#58a6ff}
.vb-medium{background:rgba(251,191,36,.12);color:#fbbf24}
.vb-large{background:rgba(249,115,22,.12);color:#f97316}
.vb-strategic{background:rgba(248,81,73,.12);color:#f85149}

/* BUTTONS */
.btn{padding:9px 18px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;font-family:inherit;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#8B5E3C;color:#fff}
.btn-primary:hover{background:#a0704d;transform:translateY(-1px)}
.btn-ghost{background:#1c2129;color:#c9d1d9;border:1px solid #30363d}
.btn-ghost:hover{background:#21262d;border-color:#484f58}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:6px}
.btn-danger{background:transparent;color:#f85149;border:1px solid #30363d;padding:5px 8px;font-size:11px;border-radius:6px;cursor:pointer}
.btn-danger:hover{background:rgba(248,81,73,.1);border-color:#f85149}
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:10px;flex-wrap:wrap}
.toolbar-right{display:flex;gap:8px}

/* TEMPLATE CARDS */
.templates-grid{display:flex;flex-direction:column;gap:12px}
.tpl-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;overflow:hidden}
.tpl-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1c2129;cursor:pointer}
.tpl-header h4{font-size:14px;color:#e6edf3;font-weight:600}
.tpl-header .day-tag{font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.day-early{background:rgba(88,166,255,.12);color:#58a6ff}
.day-mid{background:rgba(251,191,36,.12);color:#fbbf24}
.day-late{background:rgba(248,81,73,.12);color:#f85149}
.day-outreach{background:rgba(139,94,60,.15);color:#c9956b}
.tpl-body{padding:16px;display:none}
.tpl-body.open{display:block}
.tpl-body pre{white-space:pre-wrap;font-size:13px;color:#c9d1d9;line-height:1.7;font-family:inherit;background:#0a0e14;border:1px solid #1c2129;border-radius:8px;padding:16px}
.tpl-actions{display:flex;gap:8px;margin-top:12px}

/* TIMELINE TABLE */
.timeline-table th{font-size:10px}
.timeline-table td{font-size:13px}

/* TWEET CARDS */
.tweet-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px;margin-bottom:10px;position:relative}
.tweet-card .handle{color:#8B5E3C;font-weight:600;font-size:12px;margin-bottom:8px}
.tweet-card .tweet-text{font-size:14px;line-height:1.6;color:#e6edf3}
.tweet-card .tweet-meta{display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:10px;border-top:1px solid #1c2129}
.tweet-card .char-count{font-size:11px;color:#484f58}
.tweet-num{position:absolute;top:16px;right:16px;font-size:10px;color:#30363d;font-weight:700}

/* RULES */
.rules-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px}
.rule-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px 14px;font-size:13px;color:#c9d1d9;display:flex;gap:10px;align-items:flex-start}
.rule-icon{flex-shrink:0;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px}
.rule-do{background:rgba(74,222,128,.12);color:#4ade80}
.rule-dont{background:rgba(248,81,73,.12);color:#f85149}

/* SECTION HEADERS */
.section-hdr{display:flex;align-items:center;gap:10px;margin:24px 0 14px;padding-bottom:10px;border-bottom:1px solid #1c2129}
.section-hdr h3{font-size:16px;color:#e6edf3}
.section-hdr .section-icon{font-size:18px}

/* ARCHITECTURE DIAGRAM */
.arch-flow{display:flex;align-items:center;gap:0;margin:20px 0;flex-wrap:wrap;justify-content:center}
.arch-box{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px 18px;text-align:center;min-width:140px}
.arch-box .arch-name{font-size:14px;font-weight:700;color:#e6edf3;margin-bottom:4px}
.arch-box .arch-role{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.5px}
.arch-box.active-layer{border-color:#8B5E3C;box-shadow:0 0 12px rgba(139,94,60,.2)}
.arch-arrow{color:#30363d;font-size:20px;padding:0 6px}

/* DOCTRINE CARD */
.doctrine-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:20px;margin-bottom:12px}
.doctrine-card h4{font-size:14px;color:#c9956b;margin-bottom:8px}
.doctrine-card p{font-size:13px;color:#8b949e;line-height:1.6}

/* FORM INLINE */
.inline-form{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:16px;padding:16px;background:#12171e;border:1px solid #1c2129;border-radius:10px}
.inline-form label{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;display:block}
@media(max-width:768px){.inline-form{grid-template-columns:1fr 1fr}}

/* CCE INTELLIGENCE PANEL */
.cce-container{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px;margin-bottom:20px}
.cce-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.cce-section h4{font-size:12px;color:#c9956b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;border-bottom:1px solid #1c2129;padding-bottom:4px}
.cce-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:13px}
.cce-row span{text-transform:capitalize}
.cce-row strong{color:#e6edf3}
.triage-alert{margin-top:12px;padding:10px 14px;background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);border-radius:8px;color:#f85149;font-size:13px;font-weight:600}

/* FOLLOW-UP CARDS */
.fu-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px 16px;margin-bottom:8px;display:grid;grid-template-columns:60px 1fr 140px 120px;gap:12px;align-items:center}
.fu-card.urgency-critical{border-left:3px solid #f85149}
.fu-card.urgency-high{border-left:3px solid #fbbf24}
.fu-card.urgency-medium{border-left:3px solid #1f6feb}
.fu-card.urgency-low{border-left:3px solid #21262d}
.fu-age{font-size:22px;font-weight:700;color:#e6edf3;text-align:center;line-height:1}
.fu-age small{font-size:10px;color:#484f58;font-weight:400;display:block;margin-top:2px}
.fu-info{min-width:0}
.fu-action{font-size:13px;font-weight:600;color:#e6edf3;margin-bottom:2px}
.fu-meta{font-size:12px;color:#8b949e}
.fu-meta strong{color:#c9956b}
.fu-urgency{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;padding:4px 10px;border-radius:6px;text-align:center}
.fu-urgency.critical{background:rgba(248,81,73,.15);color:#f85149}
.fu-urgency.high{background:rgba(251,191,36,.15);color:#fbbf24}
.fu-urgency.medium{background:rgba(31,111,235,.15);color:#58a6ff}
.fu-urgency.low{background:rgba(33,38,45,.5);color:#6e7681}
@media(max-width:768px){.fu-card{grid-template-columns:1fr;gap:6px}}

/* SIGNAL SCOUTS */
.signals-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px}
.sig-stat{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px;text-align:center}
.sig-stat .sig-num{font-size:28px;font-weight:700;letter-spacing:-1px}
.sig-stat .sig-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.sig-num.critical{color:#f85149}
.sig-num.alert{color:#fbbf24}
.sig-num.warning{color:#58a6ff}
.sig-num.info{color:#6e7681}
.sig-num.total{color:#e6edf3}
.sig-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px 16px;margin-bottom:8px;display:flex;gap:14px;align-items:flex-start}
.sig-card.sev-critical{border-left:3px solid #f85149}
.sig-card.sev-alert{border-left:3px solid #fbbf24}
.sig-card.sev-warning{border-left:3px solid #1f6feb}
.sig-card.sev-info{border-left:3px solid #21262d}
.sig-badge{flex-shrink:0;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:4px 8px;border-radius:4px;white-space:nowrap}
.sig-badge.critical{background:rgba(248,81,73,.15);color:#f85149}
.sig-badge.alert{background:rgba(251,191,36,.15);color:#fbbf24}
.sig-badge.warning{background:rgba(31,111,235,.15);color:#58a6ff}
.sig-badge.info{background:rgba(33,38,45,.5);color:#6e7681}
.sig-body{flex:1;min-width:0}
.sig-msg{font-size:14px;font-weight:600;color:#e6edf3;margin-bottom:4px}
.sig-type{font-size:11px;color:#8b949e;text-transform:uppercase;letter-spacing:.3px}
.sig-details{font-size:12px;color:#6e7681;margin-top:6px}
.sig-details span{margin-right:12px}
.threat-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:12px}
.threat-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px}
.threat-rank{font-size:24px;font-weight:700;color:#30363d;flex-shrink:0}
.threat-name{font-size:14px;font-weight:600;color:#e6edf3}
.threat-count{font-size:12px;color:#8b949e}

/* STATUS SELECT IN TABLE */
.status-select{background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:4px 6px;font-size:11px;cursor:pointer}
.status-select:focus{outline:none;border-color:#8B5E3C}

/* CASE DETAIL DRAWER */
.drawer{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;justify-content:flex-end}
.drawer.open{display:flex}
.drawer-content{width:520px;max-width:90vw;background:#0d1117;border-left:1px solid #21262d;overflow-y:auto;padding:24px}
.drawer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid #21262d}
.drawer-header h3{color:#e6edf3;font-size:16px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}
.detail-item{padding:10px;background:#12171e;border-radius:8px;border:1px solid #1c2129}
.detail-item .label{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.5px}
.detail-item .value{font-size:14px;color:#e6edf3;margin-top:2px}
.detail-item.full{grid-column:1/-1}

/* EVENT TIMELINE */
.timeline{position:relative;padding-left:24px;margin-top:16px}
.timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:#21262d}
.tl-event{position:relative;margin-bottom:16px;padding:10px 14px;background:#12171e;border:1px solid #1c2129;border-radius:8px}
.tl-event::before{content:'';position:absolute;left:-20px;top:14px;width:10px;height:10px;border-radius:50%;background:#8B5E3C;border:2px solid #0d1117}
.tl-event.intake::before{background:#1f6feb}
.tl-event.status::before{background:#238636}
.tl-event.classified::before{background:#8b5cf6}
.tl-topic{font-size:11px;color:#c9956b;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.tl-time{font-size:10px;color:#484f58;float:right}
.tl-detail{font-size:12px;color:#8b949e;margin-top:4px;line-height:1.5}

/* SEARCH COMMAND PALETTE */
.search-palette{display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.65);align-items:flex-start;justify-content:center;padding-top:min(20vh,160px)}
.search-palette.open{display:flex}
.search-box{width:560px;max-width:92vw;background:#161b22;border:1px solid #30363d;border-radius:14px;box-shadow:0 16px 48px rgba(0,0,0,.5);overflow:hidden;animation:searchIn .15s ease}
@keyframes searchIn{from{opacity:0;transform:translateY(-12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.search-input-wrap{display:flex;align-items:center;gap:10px;padding:14px 18px;border-bottom:1px solid #21262d}
.search-input-wrap .search-icon{font-size:18px;color:#6e7681;flex-shrink:0}
.search-input-wrap input{flex:1;background:transparent;border:none;color:#e6edf3;font-size:16px;font-family:inherit;outline:none;min-width:0}
.search-input-wrap input::placeholder{color:#484f58}
.search-input-wrap .search-shortcut{font-size:10px;color:#484f58;border:1px solid #30363d;border-radius:4px;padding:2px 6px;font-weight:600;flex-shrink:0;white-space:nowrap}
.search-results{max-height:380px;overflow-y:auto;padding:6px 0}
.search-results::-webkit-scrollbar{width:6px}
.search-results::-webkit-scrollbar-track{background:transparent}
.search-results::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
.search-category{padding:8px 18px 4px;font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:1px;font-weight:700}
.search-item{display:flex;align-items:center;gap:12px;padding:10px 18px;cursor:pointer;transition:background .1s}
.search-item:hover,.search-item.active{background:#1c2129}
.search-item .si-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.search-item .si-icon.claim{background:rgba(88,166,255,.12);color:#58a6ff}
.search-item .si-icon.professional{background:rgba(139,94,60,.15);color:#c9956b}
.search-item .si-icon.referral{background:rgba(167,139,250,.12);color:#a78bfa}
.search-item .si-body{flex:1;min-width:0}
.search-item .si-title{font-size:14px;color:#e6edf3;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.search-item .si-title mark{background:rgba(251,191,36,.25);color:#fbbf24;border-radius:2px;padding:0 1px}
.search-item .si-sub{font-size:12px;color:#6e7681;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.search-item .si-meta{flex-shrink:0;text-align:right}
.search-item .si-meta .si-type{font-size:10px;color:#484f58;text-transform:uppercase;letter-spacing:.3px}
.search-empty{text-align:center;padding:32px 18px;color:#484f58}
.search-empty .se-icon{font-size:28px;margin-bottom:8px;opacity:.5}
.search-empty .se-text{font-size:13px}
.search-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 18px;border-top:1px solid #21262d;font-size:11px;color:#484f58}
.search-footer kbd{background:#0d1117;border:1px solid #30363d;border-radius:4px;padding:1px 5px;font-size:10px;font-family:inherit;color:#6e7681;margin:0 2px}

/* ACTIVITY FEED */
.feed-item{display:flex;gap:12px;padding:12px 14px;border-bottom:1px solid #1c2129;transition:background .1s;cursor:pointer}
.feed-item:hover{background:#161b22}
.feed-item:last-child{border-bottom:none}
.feed-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.feed-icon.intake{background:rgba(88,166,255,.12);color:#58a6ff}
.feed-icon.status{background:rgba(74,222,128,.12);color:#4ade80}
.feed-icon.classify{background:rgba(167,139,250,.12);color:#a78bfa}
.feed-icon.handoff{background:rgba(249,115,22,.12);color:#f97316}
.feed-icon.letter{background:rgba(139,94,60,.15);color:#c9956b}
.feed-icon.scan{background:rgba(34,211,238,.12);color:#22d3ee}
.feed-icon.professional{background:rgba(139,94,60,.15);color:#c9956b}
.feed-icon.referral{background:rgba(167,139,250,.12);color:#a78bfa}
.feed-icon.note{background:rgba(110,118,129,.12);color:#6e7681}
.feed-icon.export{background:rgba(251,191,36,.12);color:#fbbf24}
.feed-icon.system{background:rgba(33,38,45,.5);color:#484f58}
.feed-body{flex:1;min-width:0}
.feed-title{font-size:14px;color:#e6edf3;font-weight:500}
.feed-detail{font-size:12px;color:#6e7681;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.feed-time{flex-shrink:0;font-size:11px;color:#484f58;white-space:nowrap}

/* NOTIFICATION BELL */
.notif-bell{position:relative;cursor:pointer;background:none;border:none;font-size:18px;color:#6e7681;padding:4px 8px;border-radius:6px;transition:all .15s}
.notif-bell:hover{color:#e6edf3;background:#1c2129}
.notif-bell .notif-dot{position:absolute;top:2px;right:4px;width:8px;height:8px;border-radius:50%;background:#da3633;display:none}
.notif-bell .notif-dot.active{display:block;animation:pulse 2s infinite}
.notif-bell .notif-count{position:absolute;top:-2px;right:-2px;min-width:16px;height:16px;border-radius:8px;background:#da3633;color:#fff;font-size:9px;font-weight:800;display:none;align-items:center;justify-content:center;padding:0 4px;line-height:16px}
.notif-bell .notif-count.active{display:flex}
/* Notification Panel */
.notif-panel{position:fixed;top:60px;right:20px;width:380px;max-height:70vh;background:#161b22;border:1px solid #30363d;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:9999;display:none;flex-direction:column;overflow:hidden}
.notif-panel.open{display:flex}
.notif-panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #21262d}
.notif-panel-header h3{font-size:14px;color:#e6edf3;margin:0}
.notif-panel-header .notif-actions{display:flex;gap:6px}
.notif-panel-header .notif-actions button{background:none;border:none;color:#58a6ff;font-size:10px;cursor:pointer;padding:2px 6px;border-radius:4px}
.notif-panel-header .notif-actions button:hover{background:rgba(88,166,255,.1)}
.notif-panel-body{overflow-y:auto;max-height:calc(70vh - 80px);padding:4px 0}
.notif-item{display:flex;gap:10px;padding:10px 16px;border-bottom:1px solid #161b22;cursor:pointer;transition:background .15s}
.notif-item:hover{background:rgba(88,166,255,.05)}
.notif-item.unread{background:rgba(88,166,255,.04);border-left:3px solid #58a6ff}
.notif-item .ni-icon{font-size:18px;flex-shrink:0;margin-top:2px}
.notif-item .ni-content{flex:1;min-width:0}
.notif-item .ni-title{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.notif-item .ni-msg{font-size:11px;color:#8b949e;margin-top:2px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.notif-item .ni-time{font-size:10px;color:#484f58;margin-top:3px}
.notif-item .ni-sev{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:6px}
.ni-sev.critical{background:#da3633}
.ni-sev.warning{background:#f0ad4e}
.ni-sev.info{background:#58a6ff}
.notif-item .ni-dismiss{background:none;border:none;color:#484f58;cursor:pointer;font-size:14px;padding:2px;flex-shrink:0;opacity:0;transition:opacity .15s}
.notif-item:hover .ni-dismiss{opacity:1}
.notif-item .ni-dismiss:hover{color:#f85149}
.notif-empty{text-align:center;padding:40px 20px;color:#484f58;font-size:12px}
.notif-scan-btn{width:100%;padding:8px;background:none;border:none;border-top:1px solid #21262d;color:#58a6ff;font-size:11px;cursor:pointer;font-weight:600}
.notif-scan-btn:hover{background:rgba(88,166,255,.05)}
/* Case Groups & Linking */
.cg-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.cg-widget h3{font-size:14px;color:#79c0ff;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.cg-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
.cg-card{background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:8px;padding:10px;text-align:center}
.cg-card .cg-val{font-size:18px;font-weight:800;color:#e6edf3}
.cg-card .cg-label{font-size:10px;color:#6e7681;margin-top:2px}
.cg-group-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #21262d;border-radius:8px;margin-bottom:4px;background:#0d1117;cursor:pointer;transition:background .15s}
.cg-group-item:hover{background:#161b22}
.cg-group-item .cg-name{font-size:12px;font-weight:600;color:#e6edf3;flex:1}
.cg-group-item .cg-count{font-size:10px;color:#79c0ff;background:rgba(121,192,255,.1);padding:1px 6px;border-radius:3px;font-weight:700}
.cg-group-item .cg-type{font-size:9px;padding:1px 5px;border-radius:3px;text-transform:uppercase;font-weight:700;background:rgba(121,192,255,.12);color:#79c0ff}
.group-section{margin-top:14px;padding:12px;background:#161b22;border:1px solid #1c2129;border-radius:10px}
.group-section h4{font-size:12px;color:#79c0ff;margin:0 0 10px;display:flex;align-items:center;gap:6px}
.grp-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border:1px solid #21262d;border-radius:6px;background:#0d1117;font-size:11px;color:#e6edf3;margin:2px}
.grp-tag .grp-role{font-size:9px;color:#79c0ff;text-transform:uppercase}
.grp-tag .grp-x{background:none;border:none;color:#484f58;cursor:pointer;font-size:12px;padding:0 2px}
.grp-tag .grp-x:hover{color:#f85149}

/* PRIORITY QUEUE & TRIAGE */
.triage-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.triage-widget h3{font-size:14px;color:#f85149;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.tri-summary{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:12px}
.tri-card{background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:8px;padding:8px;text-align:center}
.tri-card .tri-val{font-size:16px;font-weight:800;color:#e6edf3}
.tri-card .tri-lbl{font-size:9px;color:#6e7681;margin-top:2px;text-transform:uppercase}
.tri-queue{max-height:220px;overflow-y:auto}
.tri-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #21262d;border-radius:8px;margin-bottom:4px;background:#0d1117;cursor:pointer;transition:background .15s}
.tri-item:hover{background:#161b22}
.tri-item .tri-score{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#e6edf3;flex-shrink:0;border:2px solid}
.tri-item .tri-info{flex:1;min-width:0}
.tri-item .tri-name{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tri-item .tri-meta{font-size:10px;color:#6e7681}
.tri-item .tri-level{font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700;text-transform:uppercase}
.tri-level.critical{background:rgba(248,81,73,.15);color:#f85149;border:1px solid rgba(248,81,73,.3)}
.tri-level.high{background:rgba(240,136,62,.12);color:#f0883e;border:1px solid rgba(240,136,62,.3)}
.tri-level.medium{background:rgba(88,166,255,.12);color:#58a6ff;border:1px solid rgba(88,166,255,.3)}
.tri-level.low{background:rgba(139,148,158,.12);color:#8b949e;border:1px solid rgba(139,148,158,.3)}
.tri-level.minimal{background:rgba(72,79,88,.12);color:#484f58;border:1px solid rgba(72,79,88,.3)}
.tri-filter-row{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.tri-filter-btn{font-size:10px;padding:3px 8px;border-radius:4px;border:1px solid #21262d;background:#0d1117;color:#8b949e;cursor:pointer;transition:all .15s}
.tri-filter-btn:hover,.tri-filter-btn.active{background:#161b22;color:#e6edf3;border-color:#30363d}

/* ANALYTICS & PERFORMANCE */
.analytics-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.analytics-widget h3{font-size:14px;color:#f0883e;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.an-health{display:flex;align-items:center;gap:16px;margin-bottom:14px;padding:12px;background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:10px}
.an-score-ring{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;flex-shrink:0;font-weight:800;font-size:22px;color:#e6edf3;border:4px solid #21262d;position:relative}
.an-score-ring .an-grade{font-size:10px;color:#6e7681;font-weight:600;margin-top:-2px}
.an-factors{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:4px 12px}
.an-factor{display:flex;justify-content:space-between;font-size:11px;color:#8b949e}
.an-factor .an-fv{font-weight:700;color:#e6edf3}
.an-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.an-kpi{background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:8px;padding:10px;text-align:center}
.an-kpi .an-kv{font-size:18px;font-weight:800;color:#e6edf3}
.an-kpi .an-kl{font-size:10px;color:#6e7681;margin-top:2px}
.an-funnel{margin-bottom:12px}
.an-funnel-bar{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:11px}
.an-funnel-bar .an-fb-label{width:90px;text-align:right;color:#8b949e;font-size:10px}
.an-funnel-bar .an-fb-track{flex:1;height:14px;background:#21262d;border-radius:4px;overflow:hidden;position:relative}
.an-funnel-bar .an-fb-fill{height:100%;border-radius:4px;transition:width .4s ease}
.an-funnel-bar .an-fb-val{font-size:10px;color:#e6edf3;font-weight:700;width:34px}
.an-ops{max-height:160px;overflow-y:auto}
.an-op-row{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid #21262d;border-radius:6px;margin-bottom:3px;background:#0d1117}
.an-op-row .an-op-rank{font-size:11px;font-weight:800;color:#f0883e;width:18px;text-align:center}
.an-op-row .an-op-name{font-size:12px;font-weight:600;color:#e6edf3;flex:1}
.an-op-row .an-op-stat{font-size:10px;color:#8b949e;text-align:right}
.an-op-row .an-op-score{font-size:12px;font-weight:800;color:#4ade80;width:36px;text-align:right}
.an-resp-cards{max-height:140px;overflow-y:auto}
.an-resp{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid #21262d;border-radius:6px;margin-bottom:3px;background:#0d1117}
.an-resp .an-r-name{font-size:12px;font-weight:600;color:#e6edf3;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.an-resp .an-r-badge{font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700;text-transform:uppercase}
.an-r-badge.cooperative{background:rgba(74,222,128,.12);color:#4ade80}
.an-r-badge.mixed{background:rgba(240,136,62,.12);color:#f0883e}
.an-r-badge.uncooperative{background:rgba(248,81,73,.12);color:#f85149}
.an-resp .an-r-score{font-size:11px;font-weight:700;color:#8b949e;width:40px;text-align:right}
.an-section-label{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;margin-top:10px}

/* TAGS & CUSTOM FIELDS */
.tags-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.tags-widget h3{font-size:14px;color:#ffd33d;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.tw-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
.tw-card{background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:8px;padding:8px;text-align:center}
.tw-card .tw-val{font-size:16px;font-weight:800;color:#e6edf3}
.tw-card .tw-lbl{font-size:9px;color:#6e7681;margin-top:2px;text-transform:uppercase}
.tw-tag-list{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px;max-height:100px;overflow-y:auto}
.tw-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;cursor:default;border:1px solid rgba(255,255,255,.1)}
.tw-tag .tw-tag-count{font-size:9px;opacity:.7}
.claim-tag{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:600;margin:1px;border:1px solid rgba(255,255,255,.08)}
.claim-tag .ct-x{background:none;border:none;color:inherit;cursor:pointer;font-size:11px;padding:0 1px;opacity:.5}
.claim-tag .ct-x:hover{opacity:1}
.tw-add-form{display:flex;gap:4px;margin-top:6px}
.tw-add-form input{flex:1;background:#0d1117;border:1px solid #21262d;border-radius:4px;padding:4px 8px;font-size:11px;color:#e6edf3}
.tw-add-form button{padding:4px 10px;font-size:10px;border-radius:4px}

/* WEBHOOKS & INTEGRATIONS */
.wh-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.wh-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.wh-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.wh-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.wh-val{font-size:24px;font-weight:700;letter-spacing:-1px}
.wh-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.wh-list{max-height:250px;overflow-y:auto;margin-top:10px}
.wh-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px}
.wh-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.wh-status-dot.active{background:#4ade80}
.wh-status-dot.paused{background:#ffd33d}
.wh-status-dot.disabled{background:#f85149}
.wh-info{flex:1;min-width:0}
.wh-url{font-size:11px;font-family:monospace;color:#58a6ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wh-meta{font-size:10px;color:#585e68;margin-top:2px}
.wh-actions{display:flex;gap:4px;flex-shrink:0}
.wh-actions button{padding:3px 8px;font-size:10px;border-radius:4px;border:1px solid #30363d;cursor:pointer;background:transparent;color:#8b949e;transition:all .2s}
.wh-actions button:hover{color:#e6edf3;border-color:#58a6ff}
.wh-add-form{display:flex;gap:6px;margin-top:10px}
.wh-add-form input{flex:1;background:#0d1117;border:1px solid #21262d;border-radius:4px;padding:6px 8px;font-size:11px;color:#e6edf3;font-family:monospace}

/* REMINDERS & FOLLOW-UP SCHEDULER */
.rem-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.rem-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.rem-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.rem-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.rem-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.rem-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.rem-overdue-badge{color:#f85149;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.rem-list{max-height:320px;overflow-y:auto}
.rem-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:flex-start;gap:10px;transition:all .2s}
.rem-item:hover{border-color:#30363d;background:#1a2030}
.rem-item.overdue{border-left:3px solid #f85149}
.rem-item.urgent{border-left:3px solid #ffa657}
.rem-item.snoozed{opacity:.6}
.rem-dot{width:10px;height:10px;border-radius:50%;margin-top:4px;flex-shrink:0}
.rem-dot.pending{background:#ffd33d}
.rem-dot.overdue{background:#f85149}
.rem-dot.snoozed{background:#8b949e}
.rem-dot.completed{background:#4ade80}
.rem-info{flex:1;min-width:0}
.rem-title{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rem-meta{font-size:10px;color:#585e68;margin-top:2px}
.rem-claim-link{color:#58a6ff;cursor:pointer;text-decoration:underline}
.rem-actions{display:flex;gap:4px;flex-shrink:0}
.rem-actions button{padding:3px 8px;font-size:10px;border-radius:4px;border:1px solid #30363d;cursor:pointer;background:transparent;color:#8b949e;transition:all .2s}
.rem-actions button:hover{color:#e6edf3;border-color:#58a6ff}
.rem-add-row{display:flex;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid #21262d}
.rem-add-row input,.rem-add-row select{background:#0d1117;border:1px solid #21262d;border-radius:4px;padding:6px 8px;font-size:11px;color:#e6edf3}
.rem-add-row input{flex:1}
.rem-quick-btns{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.rem-quick-btn{padding:4px 10px;font-size:10px;border-radius:12px;border:1px solid #30363d;background:transparent;color:#8b949e;cursor:pointer;transition:all .2s;white-space:nowrap}
.rem-quick-btn:hover{border-color:#ffd33d;color:#ffd33d;background:rgba(255,211,61,.05)}
.drawer-rem{margin-top:16px;padding:14px;background:#0d1117;border-radius:10px;border:1px solid #21262d}
.drawer-rem h4{margin:0 0 10px;font-size:13px;color:#ffd33d}

/* SAVED SEARCHES & SMART FILTERS */
.ss-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.ss-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.ss-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.ss-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.ss-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.ss-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.ss-pinned{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.ss-pin-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;font-size:11px;border-radius:16px;border:1px solid #1f6feb;background:rgba(31,111,235,.1);color:#58a6ff;cursor:pointer;transition:all .2s;white-space:nowrap}
.ss-pin-btn:hover{background:rgba(31,111,235,.25);border-color:#58a6ff}
.ss-pin-btn .pin-icon{font-size:12px}
.ss-pin-btn .pin-count{font-size:9px;background:rgba(31,111,235,.3);padding:1px 6px;border-radius:10px}
.ss-list{max-height:300px;overflow-y:auto}
.ss-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s}
.ss-item:hover{border-color:#30363d;background:#1a2030}
.ss-item-info{flex:1;min-width:0}
.ss-item-name{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ss-item-meta{font-size:10px;color:#585e68;margin-top:2px}
.ss-item-filters{font-size:10px;color:#8b949e;margin-top:3px;display:flex;flex-wrap:wrap;gap:4px}
.ss-filter-tag{background:#21262d;padding:1px 6px;border-radius:4px;font-size:9px;color:#d2a8ff}
.ss-item-actions{display:flex;gap:4px;flex-shrink:0}
.ss-item-actions button{padding:3px 8px;font-size:10px;border-radius:4px;border:1px solid #30363d;cursor:pointer;background:transparent;color:#8b949e;transition:all .2s}
.ss-item-actions button:hover{color:#e6edf3;border-color:#58a6ff}
.ss-add-form{display:flex;flex-direction:column;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid #21262d}
.ss-add-row{display:flex;gap:6px}
.ss-add-form input,.ss-add-form select{background:#0d1117;border:1px solid #21262d;border-radius:4px;padding:6px 8px;font-size:11px;color:#e6edf3}
.ss-add-form input{flex:1}
.ss-add-form select{min-width:100px}
.ss-filter-row{display:flex;flex-wrap:wrap;gap:6px}

/* FINANCIAL RECONCILIATION */
.fin-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.fin-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.fin-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.fin-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:14px;text-align:center}
.fin-kpi-val{font-size:20px;font-weight:800;letter-spacing:-.5px}
.fin-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.fin-bar-chart{display:flex;align-items:flex-end;gap:4px;height:80px;margin-bottom:16px;padding:8px 0;border-bottom:1px solid #21262d}
.fin-bar{flex:1;background:linear-gradient(180deg,#1f6feb 0%,#0d419d 100%);border-radius:3px 3px 0 0;min-height:2px;position:relative;transition:height .3s}
.fin-bar:hover{opacity:.8}
.fin-bar-label{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:8px;color:#585e68;white-space:nowrap}
.fin-resp-table{width:100%;border-collapse:collapse;font-size:11px}
.fin-resp-table th{text-align:left;font-size:10px;color:#585e68;text-transform:uppercase;padding:6px 8px;border-bottom:1px solid #21262d}
.fin-resp-table td{padding:6px 8px;border-bottom:1px solid #161b22;color:#c9d1d9}
.fin-resp-table tr:hover{background:#12171e}
.fin-gap-bar{height:6px;border-radius:3px;background:#21262d;overflow:hidden;position:relative}
.fin-gap-fill{height:100%;border-radius:3px;transition:width .3s}
.fin-section-title{font-size:12px;font-weight:700;color:#8b949e;text-transform:uppercase;letter-spacing:.5px;margin:16px 0 10px;padding-top:12px;border-top:1px solid #21262d}

/* COMPLIANCE & REGULATORY FRAMEWORK */
.comp-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.comp-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.comp-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.comp-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.comp-kpi-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.comp-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.comp-score-bar{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:14px;margin-bottom:14px}
.comp-score-track{height:18px;background:#21262d;border-radius:9px;overflow:hidden;position:relative;margin-top:8px}
.comp-score-fill{height:100%;border-radius:9px;transition:width .6s ease}
.comp-score-label{position:absolute;right:8px;top:1px;font-size:11px;font-weight:700;color:#fff}
.comp-section-title{font-size:12px;font-weight:700;color:#8b949e;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.comp-rules-list{max-height:300px;overflow-y:auto}
.comp-rule{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;gap:10px}
.comp-rule:hover{border-color:#30363d;background:#161b22}
.comp-sev{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.comp-sev.critical{background:#f85149}.comp-sev.high{background:#f0883e}.comp-sev.medium{background:#d29922}.comp-sev.low{background:#3fb950}
.comp-rule-info{flex:1;min-width:0}
.comp-rule-name{font-size:13px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.comp-rule-meta{font-size:10px;color:#6e7681;margin-top:2px}
.comp-rule-badge{padding:2px 8px;font-size:10px;border-radius:10px;font-weight:600}
.comp-rule-badge.active{background:rgba(63,185,80,.15);color:#3fb950}
.comp-rule-badge.overdue{background:rgba(248,81,73,.15);color:#f85149}
.comp-add-btn{background:#238636;color:#fff;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer;margin-bottom:10px}
.comp-add-btn:hover{background:#2ea043}
.comp-modal{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
.comp-modal-body{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:24px;max-width:520px;width:92%}
.comp-form-group{margin-bottom:12px}
.comp-form-group label{display:block;font-size:11px;color:#8b949e;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.comp-form-group input,.comp-form-group select,.comp-form-group textarea{width:100%;background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:8px 10px;font-size:13px;color:#e6edf3;box-sizing:border-box}
.comp-form-group textarea{min-height:60px;resize:vertical}
.comp-drawer{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-top:10px}
.comp-check-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #161b22}
.comp-check-item:last-child{border-bottom:none}
.comp-check-status{padding:2px 8px;font-size:10px;border-radius:8px;font-weight:600}
.comp-check-status.pending{background:rgba(210,153,34,.15);color:#d29922}
.comp-check-status.passed{background:rgba(63,185,80,.15);color:#3fb950}
.comp-check-status.failed{background:rgba(248,81,73,.15);color:#f85149}
.comp-check-status.waived{background:rgba(139,148,158,.15);color:#8b949e}

/* CLAIM SCORING & RISK ASSESSMENT */
.risk-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.risk-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.risk-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px}
.risk-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px;text-align:center}
.risk-kpi-val{font-size:20px;font-weight:800;letter-spacing:-.5px}
.risk-kpi-lbl{font-size:9px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:3px}
.risk-heatmap{display:flex;gap:4px;margin-bottom:14px;height:28px}
.risk-heat-seg{border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;transition:flex .4s ease;min-width:30px}
.risk-section-title{font-size:12px;font-weight:700;color:#8b949e;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.risk-list{max-height:280px;overflow-y:auto}
.risk-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 12px;margin-bottom:5px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s}
.risk-item:hover{border-color:#30363d;background:#161b22}
.risk-score-badge{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;flex-shrink:0}
.risk-item-info{flex:1;min-width:0}
.risk-item-title{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.risk-item-meta{font-size:10px;color:#6e7681;margin-top:2px}
.risk-tier-badge{padding:2px 8px;font-size:10px;border-radius:10px;font-weight:700;text-transform:uppercase}
.risk-factors{margin-top:6px}
.risk-factor{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px;color:#8b949e}
.risk-factor-bar{height:4px;border-radius:2px;flex-shrink:0}
.risk-factor-pts{font-weight:700;min-width:24px;text-align:right}

/* CORRESPONDENCE & COMMUNICATION LOG */
.corr-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.corr-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.corr-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.corr-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.corr-kpi-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.corr-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.corr-channel-bar{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap}
.corr-ch-btn{padding:4px 10px;font-size:10px;border-radius:12px;border:1px solid #30363d;background:transparent;color:#8b949e;cursor:pointer;transition:all .2s}
.corr-ch-btn:hover,.corr-ch-btn.active{border-color:#58a6ff;color:#58a6ff;background:rgba(88,166,255,.08)}
.corr-list{max-height:300px;overflow-y:auto}
.corr-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 14px;margin-bottom:5px;display:flex;align-items:center;gap:10px}
.corr-item:hover{border-color:#30363d;background:#161b22}
.corr-dir{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.corr-dir.outbound{background:rgba(31,111,235,.15);color:#58a6ff}
.corr-dir.inbound{background:rgba(63,185,80,.15);color:#3fb950}
.corr-item-info{flex:1;min-width:0}
.corr-item-subj{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.corr-item-meta{font-size:10px;color:#6e7681;margin-top:2px}
.corr-status-badge{padding:2px 8px;font-size:10px;border-radius:10px;font-weight:600}
.corr-status-badge.draft{background:rgba(139,148,158,.15);color:#8b949e}
.corr-status-badge.sent{background:rgba(88,166,255,.15);color:#58a6ff}
.corr-status-badge.delivered{background:rgba(63,185,80,.15);color:#3fb950}
.corr-status-badge.failed{background:rgba(248,81,73,.15);color:#f85149}
.corr-status-badge.responded{background:rgba(210,168,255,.15);color:#d2a8ff}
.corr-status-badge.archived{background:rgba(110,118,129,.15);color:#6e7681}
.corr-add-btn{background:#1f6feb;color:#fff;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer;margin-bottom:10px}
.corr-add-btn:hover{background:#388bfd}
.corr-modal{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
.corr-modal-body{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:24px;max-width:560px;width:92%;max-height:85vh;overflow-y:auto}
.corr-form-group{margin-bottom:12px}
.corr-form-group label{display:block;font-size:11px;color:#8b949e;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.corr-form-group input,.corr-form-group select,.corr-form-group textarea{width:100%;background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:8px 10px;font-size:13px;color:#e6edf3;box-sizing:border-box}
.corr-form-group textarea{min-height:80px;resize:vertical}
.corr-drawer{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-top:10px}
.corr-tl-item{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid #161b22;font-size:11px}
.corr-tl-item:last-child{border-bottom:none}

/* CLAIM WATCHLIST & OPERATOR BOOKMARKS */
.wl-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.wl-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.wl-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.wl-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.wl-kpi-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.wl-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.wl-list{max-height:350px;overflow-y:auto}
.wl-item{background:#12171e;border-left:4px solid #58a6ff;border-right:1px solid #1c2129;border-top:1px solid #1c2129;border-bottom:1px solid #1c2129;border-radius:8px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s}
.wl-item:hover{background:#161b22;border-right-color:#30363d;border-top-color:#30363d;border-bottom-color:#30363d}
.wl-item-info{flex:1;min-width:0}
.wl-item-title{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wl-item-meta{font-size:10px;color:#6e7681;margin-top:2px}
.wl-item-label{font-size:10px;color:#d2a8ff;font-style:italic;margin-top:1px}
.wl-pri{padding:2px 8px;font-size:9px;border-radius:10px;font-weight:700;text-transform:uppercase}
.wl-pri.urgent{background:rgba(248,81,73,.15);color:#f85149}
.wl-pri.high{background:rgba(240,136,62,.15);color:#f0883e}
.wl-pri.normal{background:rgba(88,166,255,.15);color:#58a6ff}
.wl-rm-btn{background:none;border:none;color:#484f58;cursor:pointer;font-size:16px;padding:2px 4px}
.wl-rm-btn:hover{color:#f85149}

/* SETTLEMENT NEGOTIATION TRACKER */
.neg-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.neg-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.neg-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.neg-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.neg-kpi-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.neg-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.neg-section-title{font-size:12px;font-weight:700;color:#8b949e;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.neg-round{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 14px;margin-bottom:6px;position:relative}
.neg-round:hover{border-color:#30363d}
.neg-round-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.neg-round-num{font-size:11px;font-weight:700;color:#58a6ff}
.neg-round-status{padding:2px 8px;font-size:10px;border-radius:10px;font-weight:600}
.neg-round-status.pending{background:rgba(210,153,34,.15);color:#d29922}
.neg-round-status.countered{background:rgba(88,166,255,.15);color:#58a6ff}
.neg-round-status.accepted{background:rgba(63,185,80,.15);color:#3fb950}
.neg-round-status.rejected{background:rgba(248,81,73,.15);color:#f85149}
.neg-round-status.expired{background:rgba(110,118,129,.15);color:#6e7681}
.neg-round-status.withdrawn{background:rgba(139,148,158,.15);color:#8b949e}
.neg-amounts{display:flex;gap:16px;margin-top:4px;font-size:12px}
.neg-offer{color:#ffd33d}.neg-counter{color:#d2a8ff}
.neg-terms{font-size:11px;color:#6e7681;margin-top:4px;font-style:italic}
.neg-drawer{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-top:10px}
.neg-drawer-round{padding:8px 0;border-bottom:1px solid #161b22;font-size:11px}
.neg-drawer-round:last-child{border-bottom:none}
.neg-add-btn{background:#238636;color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:10px;font-weight:600;cursor:pointer}
.neg-add-btn:hover{background:#2ea043}

/* TASK QUEUE & OPERATOR ASSIGNMENTS */
.tq-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.tq-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.tq-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:14px}
.tq-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.tq-kpi-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.tq-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.tq-filters{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.tq-filter-btn{background:#161b22;border:1px solid #21262d;color:#8b949e;border-radius:6px;padding:4px 10px;font-size:10px;cursor:pointer;font-weight:600}
.tq-filter-btn.active{background:#1f6feb;color:#fff;border-color:#1f6feb}
.tq-list{max-height:320px;overflow-y:auto}
.tq-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:border-color .2s}
.tq-item:hover{border-color:#30363d}
.tq-pri{width:4px;height:32px;border-radius:2px;flex-shrink:0}
.tq-pri.critical{background:#f85149}.tq-pri.urgent{background:#f0883e}.tq-pri.high{background:#d29922}.tq-pri.normal{background:#58a6ff}.tq-pri.low{background:#3fb950}
.tq-item-body{flex:1;min-width:0}
.tq-item-title{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tq-item-meta{font-size:10px;color:#6e7681;margin-top:2px}
.tq-status-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase;letter-spacing:.5px}
.tq-status-badge.open{background:rgba(88,166,255,.15);color:#58a6ff}
.tq-status-badge.in_progress{background:rgba(210,168,255,.15);color:#d2a8ff}
.tq-status-badge.completed{background:rgba(63,185,80,.15);color:#3fb950}
.tq-status-badge.blocked{background:rgba(248,81,73,.15);color:#f85149}
.tq-status-badge.deferred{background:rgba(139,148,158,.15);color:#8b949e}
.tq-status-badge.cancelled{background:rgba(110,118,129,.15);color:#6e7681}
.tq-overdue{color:#f85149;font-weight:700;font-size:9px}
.tq-drawer{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-top:10px}
.tq-drawer-item{padding:6px 0;border-bottom:1px solid #161b22;font-size:11px;display:flex;align-items:center;gap:8px}
.tq-drawer-item:last-child{border-bottom:none}
.tq-add-btn{background:#238636;color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:10px;font-weight:600;cursor:pointer}
.tq-add-btn:hover{background:#2ea043}

/* OPERATOR PERFORMANCE SCORECARDS */
.sc-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.sc-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.sc-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.sc-summary-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.sc-summary-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.sc-summary-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.sc-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.sc-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px;cursor:pointer;transition:border-color .2s,transform .15s}
.sc-card:hover{border-color:#30363d;transform:translateY(-1px)}
.sc-card-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.sc-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff}
.sc-card-name{font-size:13px;font-weight:700;color:#e6edf3}
.sc-card-role{font-size:10px;color:#6e7681;text-transform:capitalize}
.sc-score-circle{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;margin-left:auto;border:3px solid}
.sc-grade-A{border-color:#3fb950;color:#3fb950;background:rgba(63,185,80,.08)}
.sc-grade-B{border-color:#58a6ff;color:#58a6ff;background:rgba(88,166,255,.08)}
.sc-grade-C{border-color:#d29922;color:#d29922;background:rgba(210,153,34,.08)}
.sc-grade-D{border-color:#f0883e;color:#f0883e;background:rgba(240,136,62,.08)}
.sc-grade-F{border-color:#f85149;color:#f85149;background:rgba(248,81,73,.08)}
.sc-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.sc-metric{text-align:center;padding:6px 4px;background:#0d1117;border-radius:6px}
.sc-metric-val{font-size:14px;font-weight:700;color:#e6edf3}
.sc-metric-lbl{font-size:9px;color:#585e68;text-transform:uppercase;margin-top:2px}
.sc-bar{height:6px;background:#161b22;border-radius:3px;overflow:hidden;margin-top:10px}
.sc-bar-fill{height:100%;border-radius:3px;transition:width .5s ease}

/* EXPORT & DOWNLOAD CENTER */
.exp-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.exp-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.exp-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.exp-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.exp-kpi-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.exp-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.exp-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;margin-bottom:14px}
.exp-btn{background:#12171e;border:1px solid #21262d;border-radius:8px;padding:10px;text-align:center;cursor:pointer;transition:all .2s}
.exp-btn:hover{border-color:#1f6feb;background:#0d1117;transform:translateY(-1px)}
.exp-btn-icon{font-size:20px;margin-bottom:4px}
.exp-btn-label{font-size:11px;font-weight:600;color:#e6edf3}
.exp-btn-sub{font-size:9px;color:#6e7681;margin-top:2px}
.exp-history{max-height:200px;overflow-y:auto}
.exp-hist-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #161b22;font-size:11px}
.exp-hist-item:last-child{border-bottom:none}
.exp-fmt{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;text-transform:uppercase}
.exp-fmt.json{background:rgba(88,166,255,.15);color:#58a6ff}
.exp-fmt.csv{background:rgba(63,185,80,.15);color:#3fb950}

/* CASE MILESTONES & PROGRESS TRACKING */
.ms-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.ms-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.ms-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.ms-kpi{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.ms-kpi-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.ms-kpi-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.ms-progress-bar{height:8px;background:#161b22;border-radius:4px;overflow:hidden;margin-bottom:14px}
.ms-progress-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#238636,#3fb950);transition:width .5s ease}
.ms-drawer{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-top:10px}
.ms-timeline{position:relative;padding-left:20px}
.ms-timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:#21262d}
.ms-step{position:relative;padding:6px 0 6px 12px;font-size:11px}
.ms-step::before{content:'';position:absolute;left:-16px;top:10px;width:12px;height:12px;border-radius:50%;border:2px solid #21262d;background:#0d1117;z-index:1}
.ms-step.completed::before{background:#3fb950;border-color:#3fb950}
.ms-step.in_progress::before{background:#1f6feb;border-color:#1f6feb;box-shadow:0 0 6px rgba(31,111,235,.5)}
.ms-step.skipped::before{background:#6e7681;border-color:#6e7681}
.ms-step.blocked::before{background:#f85149;border-color:#f85149}
.ms-step-title{font-weight:600;color:#e6edf3}
.ms-step.completed .ms-step-title{color:#3fb950}
.ms-step-meta{font-size:10px;color:#6e7681;margin-top:1px}
.ms-init-btn{background:#238636;color:#fff;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer}
.ms-init-btn:hover{background:#2ea043}

/* RESPONDENT PROFILE & HISTORY */
.rp-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.rp-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.rp-list{max-height:350px;overflow-y:auto}
.rp-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:border-color .2s}
.rp-card:hover{border-color:#30363d}
.rp-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.rp-card-name{font-size:13px;font-weight:700;color:#e6edf3;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rp-risk{font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;text-transform:uppercase}
.rp-risk.critical{background:rgba(248,81,73,.15);color:#f85149}
.rp-risk.high{background:rgba(240,136,62,.15);color:#f0883e}
.rp-risk.medium{background:rgba(210,153,34,.15);color:#d29922}
.rp-risk.low{background:rgba(63,185,80,.15);color:#3fb950}
.rp-card-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;font-size:10px}
.rp-stat{text-align:center}
.rp-stat-val{font-weight:700;color:#e6edf3}
.rp-stat-lbl{color:#585e68;font-size:9px}
.rp-search{background:#0d1117;border:1px solid #21262d;color:#c9d1d9;border-radius:6px;padding:6px 10px;font-size:11px;width:100%;margin-bottom:10px}
.rp-search:focus{outline:none;border-color:#1f6feb}

/* KNOWLEDGE BASE & SOPs */
.kb-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.kb-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.kb-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.kb-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.kb-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.kb-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.kb-search-bar{display:flex;gap:6px;margin-bottom:14px}
.kb-search-bar input{flex:1;background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:8px 12px;font-size:12px;color:#e6edf3}
.kb-search-bar button{background:#1f6feb;color:#fff;border:none;border-radius:6px;padding:8px 14px;font-size:11px;font-weight:600;cursor:pointer}
.kb-cat-bar{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap}
.kb-cat-btn{padding:4px 10px;font-size:10px;border-radius:12px;border:1px solid #30363d;background:transparent;color:#8b949e;cursor:pointer;transition:all .2s}
.kb-cat-btn:hover,.kb-cat-btn.active{border-color:#58a6ff;color:#58a6ff;background:rgba(88,166,255,.08)}
.kb-list{max-height:350px;overflow-y:auto}
.kb-article{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.kb-article:hover{border-color:#30363d;background:#1a2030}
.kb-article-title{font-size:13px;font-weight:700;color:#e6edf3;margin-bottom:4px}
.kb-article-preview{font-size:11px;color:#8b949e;line-height:1.5;margin-bottom:6px}
.kb-article-meta{font-size:10px;color:#585e68;display:flex;gap:12px;align-items:center}
.kb-article-tags{display:flex;gap:3px;flex-wrap:wrap}
.kb-article-tag{font-size:9px;background:#21262d;color:#d2a8ff;padding:1px 6px;border-radius:4px}
.kb-viewer{position:fixed;top:0;right:0;bottom:0;width:520px;background:#0d1117;border-left:1px solid #21262d;z-index:9600;overflow-y:auto;padding:24px;box-shadow:-10px 0 40px rgba(0,0,0,.5);transform:translateX(100%);transition:transform .3s}
.kb-viewer.open{transform:translateX(0)}
.kb-viewer-close{position:absolute;top:12px;right:12px;background:none;border:1px solid #30363d;color:#8b949e;width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.kb-viewer h2{font-size:18px;color:#e6edf3;margin:0 0 8px;padding-right:40px}
.kb-viewer-meta{font-size:11px;color:#585e68;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #21262d}
.kb-viewer-content{font-size:13px;color:#c9d1d9;line-height:1.7;white-space:pre-wrap}
.kb-viewer-actions{display:flex;gap:8px;margin-top:20px;padding-top:16px;border-top:1px solid #21262d}
.kb-viewer-actions button{padding:6px 14px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid #30363d;background:transparent;color:#8b949e;transition:all .2s}
.kb-viewer-actions button:hover{border-color:#58a6ff;color:#e6edf3}

/* CLAIM TEMPLATES */
.tpl-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.tpl-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.tpl-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.tpl-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.tpl-val{font-size:22px;font-weight:800;letter-spacing:-.5px}
.tpl-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:14px}
.tpl-tile{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.tpl-tile:hover{border-color:#58a6ff;background:#1a2030;transform:translateY(-1px)}
.tpl-tile-icon{font-size:24px;margin-bottom:8px}
.tpl-tile-name{font-size:13px;font-weight:700;color:#e6edf3;margin-bottom:4px}
.tpl-tile-desc{font-size:10px;color:#8b949e;line-height:1.4}
.tpl-tile-meta{font-size:9px;color:#585e68;margin-top:8px;display:flex;justify-content:space-between}
.tpl-tile-badge{position:absolute;top:8px;right:8px;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600}
.tpl-tile-badge.popular{background:rgba(255,211,61,.15);color:#ffd33d}
.tpl-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:9500;display:flex;align-items:center;justify-content:center}
.tpl-modal-box{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:24px;width:480px;max-height:80vh;overflow-y:auto}
.tpl-modal-box h3{margin:0 0 16px;font-size:16px;color:#e6edf3}
.tpl-form-group{margin-bottom:12px}
.tpl-form-group label{display:block;font-size:11px;color:#8b949e;margin-bottom:4px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.tpl-form-group input,.tpl-form-group select,.tpl-form-group textarea{width:100%;background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:8px 10px;font-size:12px;color:#e6edf3;box-sizing:border-box}
.tpl-form-group textarea{height:60px;resize:vertical}
.tpl-form-actions{display:flex;gap:8px;margin-top:16px}
.tpl-form-actions button{padding:8px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:none}

/* BULK OPERATIONS */
.bulk-bar{position:fixed;bottom:0;left:0;right:0;background:#161b22;border-top:2px solid #1f6feb;padding:10px 20px;display:none;align-items:center;gap:12px;z-index:9000;box-shadow:0 -4px 20px rgba(0,0,0,.5)}
.bulk-bar.active{display:flex}
.bulk-count{font-size:13px;font-weight:700;color:#58a6ff;min-width:100px}
.bulk-actions{display:flex;gap:6px;flex:1;flex-wrap:wrap}
.bulk-btn{padding:5px 12px;font-size:11px;border-radius:6px;border:1px solid #30363d;background:#21262d;color:#e6edf3;cursor:pointer;transition:all .2s;white-space:nowrap}
.bulk-btn:hover{border-color:#58a6ff;background:#1a2332}
.bulk-btn.danger{border-color:#f85149;color:#f85149}
.bulk-btn.danger:hover{background:#2a1510}
.bulk-btn.primary{background:#238636;border-color:#238636;color:#fff}
.bulk-btn.primary:hover{background:#2ea043}
.bulk-close{padding:5px 10px;font-size:11px;border-radius:6px;border:1px solid #30363d;background:transparent;color:#8b949e;cursor:pointer}
.bulk-close:hover{color:#e6edf3}
.claim-checkbox{width:14px;height:14px;accent-color:#1f6feb;cursor:pointer;margin-right:6px;flex-shrink:0}
.bulk-modal{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center}
.bulk-modal-box{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:24px;max-width:420px;width:90%}
.bulk-modal-box h4{margin:0 0 12px;color:#e6edf3;font-size:14px}
.bulk-modal-box label{display:block;font-size:11px;color:#8b949e;margin-bottom:4px}
.bulk-modal-box select,.bulk-modal-box input{width:100%;background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:8px;font-size:12px;color:#e6edf3;margin-bottom:10px}
.bulk-modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}

/* ACTIVITY TIMELINE */
.tl-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.tl-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.tl-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.tl-filters{display:flex;gap:4px;flex-wrap:wrap}
.tl-filter-btn{padding:3px 10px;font-size:10px;border-radius:12px;border:1px solid #30363d;background:transparent;color:#8b949e;cursor:pointer;transition:all .2s}
.tl-filter-btn.active{background:#1f6feb;color:#fff;border-color:#1f6feb}
.tl-filter-btn:hover{border-color:#58a6ff}
.tl-feed{max-height:400px;overflow-y:auto}
.tl-event{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #161b22;position:relative}
.tl-event:last-child{border-bottom:none}
.tl-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px}
.tl-dot.note{background:#1a2332;color:#58a6ff}
.tl-dot.audit{background:#1e1a2e;color:#d2a8ff}
.tl-dot.recovery{background:#132219;color:#4ade80}
.tl-dot.settlement{background:#2a1f0d;color:#ffd33d}
.tl-dot.outreach{background:#1a2332;color:#79c0ff}
.tl-dot.triage{background:#2a1510;color:#f0883e}
.tl-dot.tag{background:#1a2332;color:#58a6ff}
.tl-dot.document{background:#1e1a2e;color:#a5d6ff}
.tl-dot.group{background:#132219;color:#7ee787}
.tl-dot.merge{background:#2a1510;color:#ff7b72}
.tl-body{flex:1;min-width:0}
.tl-body .tl-summary{font-size:12px;color:#e6edf3;line-height:1.4}
.tl-body .tl-meta{font-size:10px;color:#585e68;margin-top:2px}
.tl-body .tl-claim-link{color:#58a6ff;cursor:pointer;font-size:10px}
.tl-body .tl-claim-link:hover{text-decoration:underline}
.tl-empty{text-align:center;color:#484f58;font-size:11px;padding:20px}
/* drawer timeline */
.drawer-tl{max-height:350px;overflow-y:auto}
.drawer-tl .tl-event{padding:6px 0}

/* DATA QUALITY & DEDUPLICATION */
.dq-widget{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border:1px solid #21262d;border-radius:12px;padding:18px;margin-bottom:18px}
.dq-widget h3{margin:0 0 14px;font-size:15px;color:#e6edf3}
.dq-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.dq-card{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px;text-align:center}
.dq-val{font-size:24px;font-weight:700;letter-spacing:-1px}
.dq-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.dq-score-bar{height:8px;border-radius:4px;background:#21262d;margin:8px 0 4px;overflow:hidden}
.dq-score-fill{height:100%;border-radius:4px;transition:width .6s ease}
.dq-dup-list{max-height:300px;overflow-y:auto;margin-top:10px}
.dq-dup-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px}
.dq-dup-sim{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
.dq-dup-info{flex:1;min-width:0}
.dq-dup-info .dq-name{font-size:12px;font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dq-dup-info .dq-meta{font-size:10px;color:#585e68;margin-top:2px}
.dq-dup-actions{display:flex;gap:4px;flex-shrink:0}
.dq-dup-actions button{padding:3px 8px;font-size:10px;border-radius:4px;border:1px solid #30363d;cursor:pointer;transition:all .2s}
.dq-btn-dismiss{background:transparent;color:#585e68}
.dq-btn-dismiss:hover{background:#21262d;color:#e6edf3}
.dq-btn-merge{background:#238636;color:#fff;border-color:#238636!important}
.dq-btn-merge:hover{background:#2ea043}
.dq-scan-btn{padding:6px 14px;font-size:11px;border-radius:6px;background:#1f6feb;color:#fff;border:none;cursor:pointer;margin-top:8px;transition:all .2s}
.dq-scan-btn:hover{background:#388bfd}
.dq-scan-btn:disabled{opacity:.5;cursor:not-allowed}
.dq-field-coverage{margin-top:10px}
.dq-field-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:11px;color:#8b949e}
.dq-field-row .dq-fname{width:100px;text-align:right;flex-shrink:0}
.dq-field-row .dq-fbar{flex:1;height:6px;border-radius:3px;background:#21262d;overflow:hidden}
.dq-field-row .dq-ffill{height:100%;border-radius:3px}
.dq-field-row .dq-fpct{width:36px;text-align:right;font-size:10px;color:#58a6ff}

/* RESPONDENT INTELLIGENCE */
.intel-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}
.intel-stat{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:14px;text-align:center}
.intel-stat .is-num{font-size:28px;font-weight:700;letter-spacing:-1px}
.intel-stat .is-lbl{font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.8px;margin-top:4px}
.is-num.respondents{color:#e6edf3}
.is-num.claims{color:#58a6ff}
.is-num.critical{color:#f85149}
.is-num.high{color:#fbbf24}
.is-num.resolved{color:#4ade80}
.intel-card{background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px;margin-bottom:10px;cursor:pointer;transition:all .15s}
.intel-card:hover{border-color:#30363d;transform:translateY(-1px)}
.intel-card.risk-critical{border-left:3px solid #f85149}
.intel-card.risk-high{border-left:3px solid #fbbf24}
.intel-card.risk-medium{border-left:3px solid #1f6feb}
.intel-card.risk-low{border-left:3px solid #21262d}
.intel-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.intel-entity{font-size:16px;font-weight:700;color:#e6edf3;display:flex;align-items:center;gap:8px}
.intel-risk{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:4px 10px;border-radius:6px;white-space:nowrap}
.intel-risk.critical{background:rgba(248,81,73,.15);color:#f85149}
.intel-risk.high{background:rgba(251,191,36,.15);color:#fbbf24}
.intel-risk.medium{background:rgba(31,111,235,.15);color:#58a6ff}
.intel-risk.low{background:rgba(33,38,45,.5);color:#6e7681}
.intel-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;margin-bottom:10px}
.intel-metric{padding:8px;background:#0d1117;border-radius:6px;text-align:center}
.intel-metric .im-num{font-size:18px;font-weight:700;color:#e6edf3}
.intel-metric .im-lbl{font-size:9px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.intel-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
.intel-tag{font-size:10px;padding:3px 8px;border-radius:4px;background:rgba(139,94,60,.12);color:#c9956b;text-transform:capitalize}
.intel-bar{height:6px;border-radius:3px;background:#21262d;overflow:hidden;margin-top:6px}
.intel-bar-fill{height:100%;border-radius:3px;transition:width .4s ease}
.intel-bar-fill.fill-resolved{background:#4ade80}
.intel-bar-fill.fill-active{background:#58a6ff}
.intel-bar-fill.fill-escalated{background:#f97316}
.intel-expand{display:none;margin-top:12px;padding-top:12px;border-top:1px solid #1c2129}
.intel-expand.open{display:block}
.intel-claims-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
.intel-claims-table th{text-align:left;font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;padding:6px 8px;border-bottom:1px solid #1c2129}
.intel-claims-table td{padding:6px 8px;color:#c9d1d9;border-bottom:1px solid #1c2129}
.intel-claims-table tr:hover td{background:#161b22}
.risk-score-dial{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;font-size:14px;font-weight:800;border:3px solid}
.risk-score-dial.critical{border-color:#f85149;color:#f85149}
.risk-score-dial.high{border-color:#fbbf24;color:#fbbf24}
.risk-score-dial.medium{border-color:#58a6ff;color:#58a6ff}
.risk-score-dial.low{border-color:#30363d;color:#6e7681}

/* PIPELINE BOARD (KANBAN) */
.view-toggle{display:inline-flex;background:#161b22;border:1px solid #21262d;border-radius:6px;overflow:hidden}
.view-toggle button{background:transparent;border:none;color:#6e7681;font-size:11px;font-weight:600;padding:5px 12px;cursor:pointer;font-family:inherit;transition:all .15s}
.view-toggle button.active{background:#0a0e14;color:#e6edf3}
.view-toggle button:hover:not(.active){color:#c9d1d9;background:#1c2129}
.pipeline-board{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;min-height:400px;margin-top:12px}
@media(max-width:1200px){.pipeline-board{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.pipeline-board{grid-template-columns:1fr 1fr}}
.pipeline-col{background:#12171e;border:1px solid #1c2129;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;min-height:200px}
.pipeline-col-header{padding:10px 12px;border-bottom:1px solid #1c2129;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
.pipeline-col-header h4{font-size:12px;text-transform:uppercase;letter-spacing:.5px;font-weight:700}
.pipeline-col-header .col-count{font-size:11px;font-weight:700;min-width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;padding:0 6px}
.pipeline-col.filed .pipeline-col-header h4{color:#58a6ff}
.pipeline-col.filed .col-count{background:rgba(88,166,255,.12);color:#58a6ff}
.pipeline-col.under_review .pipeline-col-header h4{color:#fbbf24}
.pipeline-col.under_review .col-count{background:rgba(251,191,36,.12);color:#fbbf24}
.pipeline-col.escalated .pipeline-col-header h4{color:#f97316}
.pipeline-col.escalated .col-count{background:rgba(249,115,22,.12);color:#f97316}
.pipeline-col.in_resolution .pipeline-col-header h4{color:#a78bfa}
.pipeline-col.in_resolution .col-count{background:rgba(167,139,250,.12);color:#a78bfa}
.pipeline-col.resolved .pipeline-col-header h4{color:#4ade80}
.pipeline-col.resolved .col-count{background:rgba(74,222,128,.12);color:#4ade80}
.pipeline-col.closed .pipeline-col-header h4{color:#6e7681}
.pipeline-col.closed .col-count{background:rgba(110,118,129,.12);color:#6e7681}
.pipeline-cards{flex:1;padding:8px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
.pipeline-cards::-webkit-scrollbar{width:4px}
.pipeline-cards::-webkit-scrollbar-track{background:transparent}
.pipeline-cards::-webkit-scrollbar-thumb{background:#21262d;border-radius:2px}
.pipeline-card{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:10px 12px;cursor:pointer;transition:all .15s}
.pipeline-card:hover{border-color:#30363d;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.3)}
.pc-respondent{font-size:13px;font-weight:700;color:#e6edf3;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pc-amount{font-size:15px;font-weight:700;color:#c9956b;margin-bottom:6px}
.pc-meta{display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#484f58}
.pc-id{font-family:monospace;letter-spacing:.3px}
.pc-age{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:4px;font-weight:600;font-size:10px}
.pc-age.fresh{background:rgba(74,222,128,.1);color:#4ade80}
.pc-age.normal{background:rgba(88,166,255,.1);color:#58a6ff}
.pc-age.aging{background:rgba(251,191,36,.1);color:#fbbf24}
.pc-age.overdue{background:rgba(248,81,73,.1);color:#f85149}
.pc-tags{display:flex;gap:3px;margin-top:6px;flex-wrap:wrap}
.pc-tag{font-size:9px;padding:2px 5px;border-radius:3px;text-transform:capitalize}
.pc-tag.vb{background:rgba(139,94,60,.12);color:#c9956b}
.pc-tag.harm{background:rgba(110,118,129,.08);color:#6e7681}
.pipeline-empty{text-align:center;padding:20px 8px;color:#30363d;font-size:11px}

/* SYSTEM HEALTH MONITOR */
.health-banner{display:flex;align-items:center;gap:14px;padding:14px 18px;background:#12171e;border:1px solid #1c2129;border-radius:10px;margin-bottom:12px;cursor:pointer;transition:all .15s}
.health-banner:hover{border-color:#30363d}
.health-score-ring{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;border:3px solid;flex-shrink:0}
.health-score-ring.healthy{border-color:#4ade80;color:#4ade80}
.health-score-ring.good{border-color:#58a6ff;color:#58a6ff}
.health-score-ring.warning{border-color:#fbbf24;color:#fbbf24}
.health-score-ring.degraded{border-color:#f85149;color:#f85149}
.health-info{flex:1;min-width:0}
.health-title{font-size:14px;font-weight:600;color:#e6edf3;margin-bottom:2px}
.health-sub{font-size:12px;color:#6e7681}
.health-pills{display:flex;gap:6px;flex-shrink:0}
.health-pill{font-size:11px;font-weight:600;padding:4px 10px;border-radius:6px}
.health-pill.pass{background:rgba(74,222,128,.1);color:#4ade80}
.health-pill.warn{background:rgba(251,191,36,.1);color:#fbbf24}
.health-pill.fail{background:rgba(248,81,73,.1);color:#f85149}
.health-detail{display:none;margin-bottom:16px;animation:fadeIn .2s ease}
.health-detail.open{display:block}
.health-checks{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px}
.hc-item{background:#12171e;border:1px solid #1c2129;border-radius:8px;padding:12px 14px;display:flex;gap:10px;align-items:flex-start}
.hc-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.hc-icon.pass{background:rgba(74,222,128,.12);color:#4ade80}
.hc-icon.warn{background:rgba(251,191,36,.12);color:#fbbf24}
.hc-icon.fail{background:rgba(248,81,73,.12);color:#f85149}
.hc-body{flex:1;min-width:0}
.hc-name{font-size:13px;font-weight:600;color:#e6edf3;margin-bottom:2px}
.hc-desc{font-size:11px;color:#484f58;margin-bottom:3px}
.hc-detail{font-size:12px;color:#8b949e}

/* STATUS TRANSITION MODAL */
.transition-modal{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
.transition-modal.open{display:flex}
.transition-box{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:24px 28px;max-width:440px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:searchIn .15s ease}
.transition-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.transition-header h3{font-size:16px;color:#e6edf3}
.transition-current{display:flex;align-items:center;gap:8px;margin-bottom:14px;font-size:13px;color:#8b949e}
.transition-options{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
.transition-opt{display:flex;align-items:center;gap:10px;padding:10px 14px;background:#0d1117;border:2px solid #21262d;border-radius:8px;cursor:pointer;transition:all .15s;font-size:14px;color:#c9d1d9}
.transition-opt:hover{border-color:#30363d;background:#12171e}
.transition-opt.selected{border-color:#8B5E3C;background:#12171e}
.transition-opt .to-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.to-dot.filed{background:#58a6ff}
.to-dot.under_review{background:#fbbf24}
.to-dot.escalated{background:#f97316}
.to-dot.in_resolution{background:#a78bfa}
.to-dot.resolved{background:#4ade80}
.to-dot.closed{background:#6e7681}
.to-dot.appealed{background:#f85149}
.transition-reason{margin-bottom:16px}
.transition-reason label{font-size:11px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px}
.transition-reason textarea{width:100%;min-height:60px;resize:vertical}
.transition-error{font-size:12px;color:#f85149;margin-bottom:10px;display:none}

/* BULK ACTIONS BAR */
.bulk-bar{display:none;align-items:center;gap:12px;padding:10px 16px;background:#161b22;border:1px solid #8B5E3C;border-radius:8px;margin-bottom:10px;animation:fadeIn .2s ease}
.bulk-bar.active{display:flex}
.bulk-count{font-size:13px;font-weight:600;color:#c9956b}
.bulk-sep{height:20px;width:1px;background:#30363d}
.bulk-bar .btn{white-space:nowrap}
th .bulk-check,td .bulk-check{width:16px;height:16px;accent-color:#8B5E3C;cursor:pointer}

/* RECOVERY TRACKING */
.recovery-section{margin-top:16px;padding:16px;background:#0d1117;border:1px solid #1c2129;border-radius:10px}
.recovery-section h4{font-size:13px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin:0 0 12px}
.recovery-bar{display:flex;height:8px;background:#161b22;border-radius:4px;overflow:hidden;margin-bottom:8px}
.recovery-bar .filled{background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .4s ease}
.recovery-stats-row{display:flex;justify-content:space-between;font-size:12px;color:#8b949e;margin-bottom:10px}
.recovery-stats-row .val{font-weight:700;color:#e6edf3}
.recovery-log{max-height:160px;overflow-y:auto}
.recovery-log .rec-entry{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:#161b22;border-radius:6px;margin-bottom:4px;font-size:12px}
.rec-entry .rec-amt{color:#4ade80;font-weight:700}
.rec-entry .rec-method{color:#8b949e;font-size:11px;text-transform:capitalize}
.rec-entry .rec-date{color:#484f58;font-size:10px}
.recovery-form{display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;margin-top:8px}
.recovery-form input,.recovery-form select{background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:6px 8px;font-size:12px;font-family:inherit}
.recovery-form input[type="number"]{width:110px}
.recovery-form select{width:150px}
.recovery-form input[type="text"]{flex:1;min-width:120px}

/* Dashboard Recovery Metrics */
.recovery-dash{margin:20px 0;padding:16px;background:#0d1117;border:1px solid #1c2129;border-radius:10px}
.recovery-dash h3{font-size:14px;color:#c9956b;margin:0 0 12px;font-weight:600}
.recovery-dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.recovery-dash-card{background:#161b22;border-radius:8px;padding:12px;text-align:center}
.recovery-dash-card .rdl{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px}
.recovery-dash-card .rdv{font-size:22px;font-weight:800;margin-top:4px}
.rdv.green{color:#4ade80}
.rdv.copper{color:#c9956b}
.rdv.blue{color:#58a6ff}
.recovery-chart{display:flex;align-items:flex-end;gap:3px;height:80px;padding:8px 0}
.recovery-chart .rc-bar{flex:1;background:linear-gradient(180deg,#4ade80 0%,#166534 100%);border-radius:2px 2px 0 0;min-height:2px;position:relative}
.recovery-chart .rc-bar:hover::after{content:attr(data-tip);position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:#0d1117;color:#e6edf3;padding:2px 6px;border-radius:4px;font-size:10px;white-space:nowrap;border:1px solid #30363d}

/* SLA ENGINE */
.sla-widget{margin:12px 0;padding:16px;background:#0d1117;border:1px solid #1c2129;border-radius:10px}
.sla-widget h3{font-size:14px;color:#c9956b;margin:0 0 12px;font-weight:600}
.sla-summary{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap}
.sla-pill{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;background:#161b22;border:1px solid #21262d}
.sla-pill .sp-dot{width:8px;height:8px;border-radius:50%}
.sla-pill.on-track .sp-dot{background:#4ade80}
.sla-pill.at-risk .sp-dot{background:#fbbf24}
.sla-pill.breached .sp-dot{background:#f85149}
.sla-pill.on-track{color:#4ade80}.sla-pill.at-risk{color:#fbbf24}.sla-pill.breached{color:#f85149}
.sla-claims{max-height:220px;overflow-y:auto}
.sla-row{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#161b22;border-radius:6px;margin-bottom:4px;font-size:12px;cursor:pointer;transition:background .15s}
.sla-row:hover{background:#1c2129}
.sla-row .sr-id{color:#c9956b;font-weight:600;width:100px;flex-shrink:0}
.sla-row .sr-respondent{flex:1;color:#8b949e;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sla-row .sr-rule{color:#6e7681;font-size:11px;width:90px;flex-shrink:0}
.sla-bar-wrap{width:100px;flex-shrink:0}
.sla-bar{height:6px;background:#21262d;border-radius:3px;overflow:hidden}
.sla-bar .sb-fill{height:100%;border-radius:3px;transition:width .3s}
.sb-fill.on-track{background:#4ade80}
.sb-fill.at-risk{background:#fbbf24}
.sb-fill.breached{background:#f85149}
.sla-row .sr-remaining{width:60px;flex-shrink:0;text-align:right;font-weight:700}
.sr-remaining.on-track{color:#4ade80}
.sr-remaining.at-risk{color:#fbbf24}
.sr-remaining.breached{color:#f85149}
.sla-badge{display:inline-block;font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.3px;vertical-align:middle}
.sla-badge.on-track{background:rgba(74,222,128,.12);color:#4ade80}
.sla-badge.at-risk{background:rgba(251,191,36,.12);color:#fbbf24}
.sla-badge.breached{background:rgba(248,81,73,.15);color:#f85149;animation:pulse 1.5s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

/* ADVANCED FILTERS */
.filter-toggle{display:flex;align-items:center;gap:4px;cursor:pointer;padding:4px 10px;border-radius:6px;font-size:12px;color:#8b949e;background:#161b22;border:1px solid #21262d;transition:all .15s}
.filter-toggle:hover,.filter-toggle.active{color:#c9956b;border-color:#8B5E3C}
.filter-toggle .ft-count{background:#8B5E3C;color:#fff;border-radius:10px;padding:0 6px;font-size:10px;font-weight:700;margin-left:4px}
.filter-panel{display:none;padding:12px 16px;background:#0d1117;border:1px solid #1c2129;border-radius:10px;margin-bottom:10px;animation:fadeIn .2s ease}
.filter-panel.open{display:block}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:8px}
.filter-group{display:flex;flex-direction:column;gap:3px}
.filter-group label{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.4px}
.filter-group select,.filter-group input{background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:5px 8px;font-size:12px;font-family:inherit;min-width:130px}
.filter-group input[type="date"]{min-width:140px}
.filter-group input[type="number"]{width:100px}
.filter-actions{display:flex;gap:6px;align-items:flex-end}
.filter-actions .btn{padding:5px 12px;font-size:12px}
.saved-views-shelf{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.sv-chip{display:flex;align-items:center;gap:4px;padding:4px 10px;background:#161b22;border:1px solid #21262d;border-radius:16px;font-size:11px;color:#8b949e;cursor:pointer;transition:all .15s}
.sv-chip:hover{border-color:#8B5E3C;color:#c9956b}
.sv-chip.active{border-color:#8B5E3C;color:#c9956b;background:rgba(139,94,60,.1)}
.sv-chip .sv-del{color:#484f58;font-size:13px;margin-left:2px;cursor:pointer;line-height:1}
.sv-chip .sv-del:hover{color:#f85149}
.sort-header{cursor:pointer;user-select:none;white-space:nowrap}
.sort-header:hover{color:#c9956b}
.sort-header .sort-arrow{font-size:10px;margin-left:2px;color:#484f58}
.sort-header.asc .sort-arrow,.sort-header.desc .sort-arrow{color:#c9956b}
.filter-count-badge{font-size:11px;color:#c9956b;margin-left:6px;font-weight:600}

/* ESCALATION ENGINE */
.esc-widget{margin:12px 0;padding:16px;background:#0d1117;border:1px solid #1c2129;border-radius:10px}
.esc-widget h3{font-size:14px;color:#c9956b;margin:0 0 12px;font-weight:600}
.esc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.esc-header .esc-stats{display:flex;gap:10px}
.esc-stat{display:flex;align-items:center;gap:4px;font-size:12px;color:#8b949e}
.esc-stat .es-dot{width:6px;height:6px;border-radius:50%}
.esc-stat.critical .es-dot{background:#f85149}.esc-stat.critical{color:#f85149}
.esc-stat.high .es-dot{background:#f97316}.esc-stat.high{color:#f97316}
.esc-stat.medium .es-dot{background:#fbbf24}.esc-stat.medium{color:#fbbf24}
.esc-queue{max-height:260px;overflow-y:auto}
.esc-item{display:flex;align-items:center;gap:10px;padding:10px;background:#161b22;border-radius:8px;margin-bottom:6px;border-left:3px solid #21262d;transition:all .15s}
.esc-item.critical{border-left-color:#f85149}
.esc-item.high{border-left-color:#f97316}
.esc-item.medium{border-left-color:#fbbf24}
.esc-item:hover{background:#1c2129}
.esc-item .ei-info{flex:1;min-width:0}
.esc-item .ei-rule{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.esc-item.critical .ei-rule{color:#f85149}
.esc-item.high .ei-rule{color:#f97316}
.esc-item.medium .ei-rule{color:#fbbf24}
.esc-item .ei-claim{font-size:12px;color:#8b949e;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.esc-item .ei-claim strong{color:#c9956b}
.esc-item .ei-action{font-size:11px;color:#6e7681;margin-top:2px}
.esc-item .ei-actions{display:flex;gap:4px;flex-shrink:0}
.esc-item .btn-approve{background:#22c55e;color:#0a0e14;border:none;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700;cursor:pointer}
.esc-item .btn-approve:hover{background:#4ade80}
.esc-item .btn-dismiss{background:none;color:#6e7681;border:1px solid #30363d;padding:4px 8px;border-radius:4px;font-size:11px;cursor:pointer}
.esc-item .btn-dismiss:hover{color:#f85149;border-color:#f85149}

/* BATCH IMPORT */
.import-section{margin-top:24px;padding:20px;background:#0d1117;border:1px solid #1c2129;border-radius:10px}
.import-section h4{font-size:14px;color:#c9956b;margin:0 0 8px;font-weight:600}
.import-dropzone{border:2px dashed #30363d;border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:all .2s;background:#0d1117}
.import-dropzone:hover,.import-dropzone.dragover{border-color:#8B5E3C;background:rgba(139,94,60,.05)}
.import-dropzone .dz-icon{font-size:32px;margin-bottom:8px}
.import-dropzone .dz-text{font-size:13px;color:#8b949e}
.import-dropzone .dz-sub{font-size:11px;color:#484f58;margin-top:4px}
.import-preview{margin-top:12px;max-height:250px;overflow:auto}
.import-preview table{width:100%;font-size:11px;border-collapse:collapse}
.import-preview th{background:#161b22;color:#6e7681;padding:4px 8px;text-align:left;font-weight:600;text-transform:uppercase;letter-spacing:.3px;position:sticky;top:0}
.import-preview td{padding:4px 8px;border-bottom:1px solid #1c2129;color:#c9d1d9}
.import-preview tr.invalid td{color:#f85149;background:rgba(248,81,73,.05)}
.import-results{margin-top:12px}
.import-results .ir-row{display:flex;align-items:center;gap:8px;padding:4px 8px;font-size:12px;border-radius:4px;margin-bottom:2px}
.ir-row.imported{color:#4ade80;background:rgba(74,222,128,.05)}
.ir-row.skipped{color:#fbbf24;background:rgba(251,191,36,.05)}
.ir-row.failed{color:#f85149;background:rgba(248,81,73,.05)}
.import-summary{display:flex;gap:12px;padding:10px 14px;background:#161b22;border-radius:8px;margin-top:10px;font-size:13px}
.import-summary .is-item{display:flex;align-items:center;gap:4px}
.is-item.imported{color:#4ade80}.is-item.skipped{color:#fbbf24}.is-item.failed{color:#f85149}
/* â”€â”€ Outreach & Communication Engine â”€â”€ */
.outreach-section{margin-top:16px;border:1px solid #1c2129;border-radius:10px;padding:14px;background:#0d1117}
.outreach-section h4{font-size:13px;color:#c9956b;margin:0 0 10px;display:flex;align-items:center;gap:6px}
.outreach-log{max-height:200px;overflow-y:auto}
.outreach-entry{padding:8px 10px;margin:4px 0;background:#161b22;border:1px solid #1c2129;border-radius:6px;font-size:12px}
.outreach-entry .oe-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.outreach-entry .oe-subject{font-weight:600;color:#c9d1d9}
.outreach-entry .oe-meta{font-size:10px;color:#484f58;display:flex;gap:8px}
.outreach-entry .oe-channel{background:#1c2129;color:#8b949e;padding:1px 6px;border-radius:3px;font-size:10px;text-transform:uppercase}
.outreach-entry .oe-status{padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600;text-transform:uppercase}
.oe-status.sent{background:rgba(34,197,94,.15);color:#22c55e}
.oe-status.drafted{background:rgba(139,94,60,.15);color:#c9956b}
.oe-status.responded{background:rgba(88,166,255,.15);color:#58a6ff}
.oe-status.no_response{background:rgba(248,81,73,.15);color:#f85149}
.oe-status.bounced{background:rgba(248,81,73,.15);color:#f85149}
.outreach-compose{margin-top:10px;border:1px solid #30363d;border-radius:8px;padding:12px;background:#161b22}
.outreach-compose select,.outreach-compose input,.outreach-compose textarea{width:100%;background:#0d1117;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:6px 8px;font-size:12px;font-family:inherit;margin-bottom:6px}
.outreach-compose textarea{min-height:120px;resize:vertical;line-height:1.5}
.outreach-compose .oc-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:6px}
.outreach-dash{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.outreach-dash h3{font-size:14px;color:#c9956b;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.outreach-dash-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}
.outreach-dash-grid .od-card{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:10px 14px;text-align:center}
.od-card .od-num{font-size:22px;font-weight:700;color:#c9d1d9}
.od-card .od-label{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.outreach-recent{max-height:180px;overflow-y:auto}
.outreach-recent .or-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:4px;font-size:12px;border-bottom:1px solid #1c2129}
.or-item:hover{background:#161b22}
.tpl-preview{background:#0d1117;border:1px solid #30363d;border-radius:8px;padding:12px;margin-top:8px;white-space:pre-wrap;font-size:12px;color:#8b949e;line-height:1.6;max-height:200px;overflow-y:auto}
/* â”€â”€ Reports & Analytics â”€â”€ */
.report-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:linear-gradient(135deg,#161b22,#0d1117);border:1px solid #21262d;border-radius:12px;margin-bottom:16px}
.report-header h2{font-size:18px;color:#c9d1d9;margin:0;display:flex;align-items:center;gap:8px}
.report-header .rh-meta{font-size:11px;color:#6e7681}
.report-section{margin-bottom:20px}
.report-section h3{font-size:14px;color:#c9956b;margin:0 0 10px;padding-bottom:6px;border-bottom:1px solid #1c2129;display:flex;align-items:center;gap:6px}
.report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:16px}
.report-card{background:#161b22;border:1px solid #1c2129;border-radius:10px;padding:14px;text-align:center}
.report-card .rc-num{font-size:24px;font-weight:700;color:#c9d1d9}
.report-card .rc-label{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin-top:3px}
.report-card.green .rc-num{color:#22c55e}
.report-card.amber .rc-num{color:#f0ad4e}
.report-card.red .rc-num{color:#f85149}
.report-card.blue .rc-num{color:#58a6ff}
.report-card.copper .rc-num{color:#c9956b}
.report-bar-chart{display:flex;gap:6px;align-items:flex-end;height:80px;padding:8px 0}
.report-bar{background:#c9956b;border-radius:4px 4px 0 0;min-width:28px;position:relative;transition:height .3s}
.report-bar .rb-label{position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);font-size:9px;color:#6e7681;white-space:nowrap}
.report-bar .rb-val{position:absolute;top:-14px;left:50%;transform:translateX(-50%);font-size:9px;color:#c9d1d9;font-weight:600}
.scorecard-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
.scorecard{background:#161b22;border:1px solid #1c2129;border-radius:10px;padding:16px;position:relative;overflow:hidden}
.scorecard .sc-grade{position:absolute;top:10px;right:14px;font-size:28px;font-weight:800;opacity:.8}
.sc-grade.A{color:#22c55e}.sc-grade.B{color:#4ade80}.sc-grade.C{color:#f0ad4e}.sc-grade.D{color:#fb923c}.sc-grade.F{color:#f85149}
.scorecard .sc-entity{font-size:15px;font-weight:700;color:#c9d1d9;margin-bottom:2px;padding-right:40px}
.scorecard .sc-risk{font-size:10px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.scorecard .sc-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.scorecard .sc-metric{text-align:center}
.scorecard .sc-metric .sm-num{font-size:16px;font-weight:700;color:#c9d1d9}
.scorecard .sc-metric .sm-label{font-size:9px;color:#6e7681;text-transform:uppercase}
.sc-bar{height:4px;background:#21262d;border-radius:2px;margin-top:8px;overflow:hidden}
.sc-bar-fill{height:100%;border-radius:2px;transition:width .5s}
/* â”€â”€ Case Assignment & Workload â”€â”€ */
.workload-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.workload-widget h3{font-size:14px;color:#58a6ff;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.wl-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}
.wl-summary .wl-card{background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:10px 14px;text-align:center}
.wl-card .wl-num{font-size:22px;font-weight:700;color:#c9d1d9}
.wl-card .wl-label{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.wl-bar-row{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:6px;margin:3px 0;font-size:12px}
.wl-bar-row:hover{background:#161b22}
.wl-bar-row .wl-name{width:140px;color:#c9d1d9;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wl-bar-row .wl-role{font-size:9px;color:#6e7681;text-transform:uppercase;letter-spacing:.3px;width:80px}
.wl-bar-row .wl-track{flex:1;height:8px;background:#21262d;border-radius:4px;overflow:hidden}
.wl-bar-row .wl-fill{height:100%;border-radius:4px;transition:width .4s}
.wl-bar-row .wl-count{width:50px;text-align:right;color:#8b949e;font-size:11px}
.wl-bar-row .wl-pct{width:40px;text-align:right;font-weight:600;font-size:11px}
.assign-badge{display:inline-flex;align-items:center;gap:3px;background:rgba(88,166,255,.1);color:#58a6ff;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:600;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.assign-badge.unassigned{background:rgba(110,118,129,.1);color:#6e7681}
.assign-section{margin-top:12px;padding:10px 12px;background:#161b22;border:1px solid #1c2129;border-radius:8px}
.assign-section label{font-size:11px;color:#6e7681;margin-bottom:4px;display:block}
.assign-section select{width:100%;background:#0d1117;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:6px 8px;font-size:12px}
/* Settlement & Resolution */
.settlement-section{margin-top:14px;padding:12px;background:#161b22;border:1px solid #1c2129;border-radius:10px}
.settlement-section h4{font-size:12px;color:#d2a8ff;margin:0 0 10px;display:flex;align-items:center;gap:6px}
.stl-entry{padding:8px 10px;border:1px solid #21262d;border-radius:8px;margin-bottom:6px;background:#0d1117;position:relative}
.stl-entry .stl-type{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.stl-entry .stl-type.initial_offer{color:#58a6ff}
.stl-entry .stl-type.counteroffer{color:#f0ad4e}
.stl-entry .stl-type.final_offer{color:#f85149}
.stl-entry .stl-amount{font-size:16px;font-weight:700;color:#e6edf3;margin-bottom:3px}
.stl-entry .stl-by{font-size:10px;color:#6e7681;margin-bottom:2px}
.stl-entry .stl-terms{font-size:11px;color:#8b949e;margin-top:4px;padding-top:4px;border-top:1px solid #21262d}
.stl-status{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;padding:2px 6px;border-radius:4px;position:absolute;top:8px;right:8px}
.stl-status.pending{background:rgba(240,173,78,.15);color:#f0ad4e;border:1px solid rgba(240,173,78,.3)}
.stl-status.accepted{background:rgba(74,222,128,.15);color:#4ade80;border:1px solid rgba(74,222,128,.3)}
.stl-status.rejected{background:rgba(248,81,73,.15);color:#f85149;border:1px solid rgba(248,81,73,.3)}
.stl-status.expired{background:rgba(110,118,129,.15);color:#6e7681;border:1px solid rgba(110,118,129,.3)}
.stl-status.withdrawn{background:rgba(110,118,129,.15);color:#6e7681;border:1px solid rgba(110,118,129,.3)}
.stl-actions{display:flex;gap:6px;margin-top:6px}
.stl-actions button{flex:1;padding:4px 8px;font-size:10px;border:none;border-radius:4px;cursor:pointer;font-weight:600}
.stl-actions .stl-accept{background:rgba(74,222,128,.15);color:#4ade80;border:1px solid rgba(74,222,128,.3)}
.stl-actions .stl-reject{background:rgba(248,81,73,.15);color:#f85149;border:1px solid rgba(248,81,73,.3)}
.stl-compose{margin-top:8px;padding:10px;background:#0d1117;border:1px solid #21262d;border-radius:8px}
.stl-compose label{font-size:10px;color:#6e7681;display:block;margin-bottom:2px}
.stl-compose input,.stl-compose select,.stl-compose textarea{width:100%;background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:5px;padding:5px 8px;font-size:12px;margin-bottom:6px;box-sizing:border-box}
.stl-compose textarea{height:50px;resize:vertical;font-family:inherit}
.resolution-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;text-transform:uppercase}
.resolution-badge.resolved{background:rgba(74,222,128,.12);color:#4ade80;border:1px solid rgba(74,222,128,.25)}
.resolution-badge.partial{background:rgba(240,173,78,.12);color:#f0ad4e;border:1px solid rgba(240,173,78,.25)}
.resolution-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.resolution-widget h3{font-size:14px;color:#d2a8ff;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.res-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.res-summary .res-card{background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:8px;padding:10px;text-align:center}
.res-summary .res-card .res-val{font-size:18px;font-weight:800;color:#e6edf3}
.res-summary .res-card .res-label{font-size:10px;color:#6e7681;margin-top:2px}
.res-recent{margin-top:8px}
.res-recent-item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-bottom:1px solid #21262d;font-size:11px}
.res-recent-item:last-child{border-bottom:none}
/* Workflow Rules */
.wf-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.wf-widget h3{font-size:14px;color:#f0ad4e;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.wf-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
.wf-card{background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:8px;padding:10px;text-align:center}
.wf-card .wf-val{font-size:18px;font-weight:800;color:#e6edf3}
.wf-card .wf-label{font-size:10px;color:#6e7681;margin-top:2px}
.wf-rule-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid #21262d;border-radius:8px;margin-bottom:4px;background:#0d1117}
.wf-rule-item .wf-rule-name{font-size:12px;font-weight:600;color:#e6edf3}
.wf-rule-item .wf-rule-trigger{font-size:10px;color:#6e7681;font-family:monospace}
.wf-rule-item .wf-rule-count{font-size:10px;color:#484f58}
.wf-toggle{width:36px;height:20px;border-radius:10px;border:none;cursor:pointer;position:relative;transition:background .2s}
.wf-toggle.on{background:#4ade80}
.wf-toggle.off{background:#30363d}
.wf-toggle::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:2px;transition:left .2s}
.wf-toggle.on::after{left:18px}
.wf-toggle.off::after{left:2px}
.wf-exec-item{display:flex;align-items:center;gap:8px;padding:5px 8px;font-size:11px;border-bottom:1px solid #21262d}
.wf-exec-item:last-child{border-bottom:none}
.wf-exec-badge{display:inline-block;font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;text-transform:uppercase}
.wf-exec-badge.success{background:rgba(74,222,128,.12);color:#4ade80}
.wf-exec-badge.failed{background:rgba(248,81,73,.12);color:#f85149}
/* Document/Evidence Management */
.doc-widget{margin:20px 0;padding:16px;background:linear-gradient(135deg,#0d1117,#161b22);border:1px solid #1c2129;border-radius:12px}
.doc-widget h3{font-size:14px;color:#58a6ff;margin:0 0 12px;display:flex;align-items:center;gap:6px}
.doc-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
.doc-card{background:rgba(13,17,23,.6);border:1px solid #21262d;border-radius:8px;padding:10px;text-align:center}
.doc-card .doc-val{font-size:18px;font-weight:800;color:#e6edf3}
.doc-card .doc-label{font-size:10px;color:#6e7681;margin-top:2px}
.doc-recent{max-height:180px;overflow-y:auto}
.doc-entry{display:flex;align-items:center;gap:8px;padding:6px 8px;font-size:11px;border-bottom:1px solid #21262d}
.doc-entry:last-child{border-bottom:none}
.doc-entry .doc-icon{font-size:16px}
.doc-entry .doc-name{color:#e6edf3;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc-entry .doc-cat{font-size:9px;padding:1px 6px;border-radius:3px;background:rgba(88,166,255,.12);color:#58a6ff;text-transform:uppercase;font-weight:700}
.doc-entry .doc-size{font-size:10px;color:#6e7681}
/* Case drawer evidence panel */
.evidence-section{margin-top:14px;padding:12px;background:#161b22;border:1px solid #1c2129;border-radius:10px}
.evidence-section h4{font-size:12px;color:#58a6ff;margin:0 0 10px;display:flex;align-items:center;gap:6px}
.ev-list{max-height:200px;overflow-y:auto}
.ev-item{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid #21262d;border-radius:6px;margin-bottom:4px;background:#0d1117;font-size:11px}
.ev-item .ev-icon{font-size:14px;flex-shrink:0}
.ev-item .ev-info{flex:1;min-width:0}
.ev-item .ev-info .ev-name{color:#e6edf3;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
.ev-item .ev-info .ev-meta{color:#6e7681;font-size:10px}
.ev-item .ev-badge{font-size:9px;padding:1px 5px;border-radius:3px;text-transform:uppercase;font-weight:700;flex-shrink:0}
.ev-badge.evidence{background:rgba(88,166,255,.12);color:#58a6ff}
.ev-badge.receipt{background:rgba(74,222,128,.12);color:#4ade80}
.ev-badge.screenshot{background:rgba(210,168,255,.12);color:#d2a8ff}
.ev-badge.correspondence{background:rgba(240,173,78,.12);color:#f0ad4e}
.ev-badge.financial{background:rgba(255,215,0,.12);color:#ffd700}
.ev-badge.contract{background:rgba(139,148,158,.12);color:#8b949e}
.ev-badge.legal{background:rgba(248,81,73,.12);color:#f85149}
.ev-badge.identification{background:rgba(255,123,114,.12);color:#ff7b72}
.ev-badge.communication_log{background:rgba(121,192,255,.12);color:#79c0ff}
.ev-badge.other{background:rgba(110,118,129,.12);color:#6e7681}
.ev-item .ev-del{background:none;border:none;color:#484f58;cursor:pointer;font-size:14px;padding:2px;flex-shrink:0}
.ev-item .ev-del:hover{color:#f85149}
.ev-upload-form{margin-top:8px;padding:8px;background:#0d1117;border:1px dashed #30363d;border-radius:8px}
.ev-upload-form input,.ev-upload-form select,.ev-upload-form textarea{width:100%;padding:4px 6px;background:#161b22;border:1px solid #30363d;border-radius:4px;color:#e6edf3;font-size:11px;margin-bottom:4px;box-sizing:border-box}
.ev-upload-form .ev-upload-btn{width:100%;padding:6px;background:#238636;border:none;border-radius:4px;color:#fff;font-weight:600;cursor:pointer;font-size:11px;margin-top:4px}
.ev-upload-form .ev-upload-btn:hover{background:#2ea043}
/* â”€â”€ Feature #43: Satisfaction Surveys â”€â”€ */
.surv-widget{background:#0d1117;border:1px solid #30363d;border-radius:12px;padding:16px;margin-bottom:16px}
.surv-widget h3{font-size:14px;font-weight:700;color:#e6edf3;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.surv-stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px}
.surv-stat{background:#161b22;border-radius:8px;padding:10px 8px;text-align:center}
.surv-stat .ss-num{font-size:20px;font-weight:800;color:#58a6ff}
.surv-stat .ss-num.nps-pos{color:#3fb950}
.surv-stat .ss-num.nps-neg{color:#f85149}
.surv-stat .ss-lbl{font-size:10px;color:#484f58;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.surv-bar-row{display:flex;gap:3px;margin-bottom:12px;height:24px;border-radius:6px;overflow:hidden}
.surv-bar-seg{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#0a0e14;min-width:18px;transition:flex .3s}
.surv-bar-5{background:#3fb950}.surv-bar-4{background:#56d364}.surv-bar-3{background:#e3b341}
.surv-bar-2{background:#f0883e}.surv-bar-1{background:#f85149}
.surv-list{max-height:220px;overflow-y:auto}
.surv-card{background:#161b22;border:1px solid #21262d;border-radius:8px;padding:10px;margin-bottom:6px;display:flex;gap:10px;align-items:flex-start}
.surv-card .sc-rating{font-size:22px;font-weight:800;min-width:32px;text-align:center}
.surv-card .sc-rating.r5,.surv-card .sc-rating.r4{color:#3fb950}
.surv-card .sc-rating.r3{color:#e3b341}
.surv-card .sc-rating.r2,.surv-card .sc-rating.r1{color:#f85149}
.surv-card .sc-body{flex:1;min-width:0}
.surv-card .sc-meta{font-size:11px;color:#484f58;margin-bottom:3px}
.surv-card .sc-text{font-size:12px;color:#8b949e;line-height:1.4}
.surv-card .sc-trigger{font-size:10px;background:rgba(88,166,255,.12);color:#58a6ff;padding:1px 6px;border-radius:4px}
.surv-trend{height:60px;display:flex;align-items:flex-end;gap:2px;margin-bottom:8px}
.surv-trend-bar{background:linear-gradient(to top,#238636,#3fb950);border-radius:3px 3px 0 0;min-width:8px;flex:1;position:relative}
.surv-trend-bar:hover::after{content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#161b22;border:1px solid #30363d;padding:2px 6px;border-radius:4px;font-size:9px;color:#e6edf3;white-space:nowrap}
/* â”€â”€ Feature #44: Escalation Playbooks â”€â”€ */
.epb-widget{background:#0d1117;border:1px solid #30363d;border-radius:12px;padding:16px;margin-bottom:16px}
.epb-widget h3{font-size:14px;font-weight:700;color:#e6edf3;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.epb-stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.epb-stat{background:#161b22;border-radius:8px;padding:10px 8px;text-align:center}
.epb-stat .es-num{font-size:20px;font-weight:800;color:#58a6ff}
.epb-stat .es-num.rate-high{color:#3fb950}
.epb-stat .es-num.rate-low{color:#f85149}
.epb-stat .es-lbl{font-size:10px;color:#484f58;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.epb-list{max-height:260px;overflow-y:auto}
.epb-card{background:#161b22;border:1px solid #21262d;border-radius:8px;padding:12px;margin-bottom:6px;cursor:pointer;transition:border-color .2s}
.epb-card:hover{border-color:#58a6ff}
.epb-card .ec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.epb-card .ec-name{font-size:13px;font-weight:700;color:#e6edf3}
.epb-card .ec-badge{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.epb-card .ec-badge.active{background:rgba(63,185,80,.15);color:#3fb950}
.epb-card .ec-badge.inactive{background:rgba(110,118,129,.15);color:#6e7681}
.epb-card .ec-desc{font-size:11px;color:#8b949e;margin-bottom:6px}
.epb-card .ec-meta{display:flex;gap:12px;font-size:10px;color:#484f58}
.epb-card .ec-meta span{display:flex;align-items:center;gap:3px}
.epb-card .ec-trigger{font-size:10px;background:rgba(210,168,255,.12);color:#d2a8ff;padding:1px 6px;border-radius:4px}
.epb-exec{font-size:11px;color:#8b949e;margin-top:8px;padding-top:8px;border-top:1px solid #21262d}
.epb-exec-item{display:flex;gap:8px;align-items:center;padding:3px 0}
.epb-exec-item .exi-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.epb-exec-item .exi-status.completed{background:#3fb950}
.epb-exec-item .exi-status.failed{background:#f85149}
.epb-exec-item .exi-status.running{background:#58a6ff}
/* â”€â”€ Feature #45: Communication Channel Registry â”€â”€ */
.ccr-widget{background:#0d1117;border:1px solid #21262d;border-radius:8px;padding:16px;margin-top:16px}
.ccr-widget h3{margin:0 0 12px;font-size:14px;color:#e6edf3;display:flex;align-items:center;gap:8px}
.ccr-stats-row{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.ccr-stat{flex:1;min-width:90px;background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;text-align:center}
.ccr-stat .cs-num{font-size:20px;font-weight:700;line-height:1.2}
.ccr-stat .cs-lbl{font-size:10px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px}
.ccr-type-bar{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.ccr-type-chip{font-size:10px;padding:3px 10px;border-radius:12px;background:rgba(88,166,255,.1);color:#58a6ff;border:1px solid rgba(88,166,255,.2);cursor:pointer;transition:all .15s}
.ccr-type-chip:hover,.ccr-type-chip.active{background:rgba(88,166,255,.25);border-color:#58a6ff}
.ccr-list{max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
.ccr-card{background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;transition:border-color .15s}
.ccr-card:hover{border-color:#30363d}
.ccr-card .cc-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.ccr-card .cc-entity{font-size:13px;font-weight:700;color:#e6edf3}
.ccr-card .cc-type-badge{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.ccr-card .cc-type-badge.email{background:rgba(88,166,255,.15);color:#58a6ff}
.ccr-card .cc-type-badge.phone{background:rgba(63,185,80,.15);color:#3fb950}
.ccr-card .cc-type-badge.portal{background:rgba(210,168,255,.15);color:#d2a8ff}
.ccr-card .cc-type-badge.social{background:rgba(255,211,61,.15);color:#ffd33d}
.ccr-card .cc-type-badge.mail{background:rgba(248,81,73,.15);color:#f85149}
.ccr-card .cc-type-badge.other{background:rgba(110,118,129,.15);color:#6e7681}
.ccr-card .cc-contact{font-size:11px;color:#8b949e;margin-bottom:4px;word-break:break-all}
.ccr-card .cc-meta{display:flex;gap:12px;font-size:10px;color:#484f58}
.ccr-card .cc-meta span{display:flex;align-items:center;gap:3px}
.ccr-card .cc-primary{font-size:9px;background:rgba(63,185,80,.15);color:#3fb950;padding:1px 6px;border-radius:4px;margin-left:6px}
.ccr-card .cc-actions{display:flex;gap:4px;margin-top:6px}
.ccr-card .cc-actions button{font-size:10px;padding:2px 8px;border-radius:4px;border:1px solid #21262d;background:#161b22;color:#8b949e;cursor:pointer;transition:all .15s}
.ccr-card .cc-actions button:hover{background:#21262d;color:#e6edf3}
.ccr-card .cc-actions button.cc-success{color:#3fb950;border-color:rgba(63,185,80,.3)}
.ccr-card .cc-actions button.cc-fail{color:#f85149;border-color:rgba(248,81,73,.3)}
/* â”€â”€ Feature #46: Fee & Billing Tracker â”€â”€ */
.bil-widget{background:#0d1117;border:1px solid #21262d;border-radius:8px;padding:16px;margin-top:16px}
.bil-widget h3{margin:0 0 12px;font-size:14px;color:#e6edf3;display:flex;align-items:center;gap:8px}
.bil-stats-row{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.bil-stat{flex:1;min-width:100px;background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;text-align:center}
.bil-stat .bs-num{font-size:20px;font-weight:700;line-height:1.2}
.bil-stat .bs-lbl{font-size:10px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px}
.bil-meter{margin-bottom:14px}
.bil-meter-label{font-size:10px;color:#8b949e;margin-bottom:4px;display:flex;justify-content:space-between}
.bil-meter-bar{height:8px;background:#21262d;border-radius:4px;overflow:hidden}
.bil-meter-fill{height:100%;border-radius:4px;transition:width .4s;background:linear-gradient(90deg,#f85149,#ffd33d,#3fb950)}
.bil-filter-bar{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.bil-filter-chip{font-size:10px;padding:3px 10px;border-radius:12px;background:rgba(88,166,255,.1);color:#58a6ff;border:1px solid rgba(88,166,255,.2);cursor:pointer;transition:all .15s}
.bil-filter-chip:hover,.bil-filter-chip.active{background:rgba(88,166,255,.25);border-color:#58a6ff}
.bil-list{max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
.bil-card{background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;transition:border-color .15s}
.bil-card:hover{border-color:#30363d}
.bil-card .bc-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.bil-card .bc-desc{font-size:13px;font-weight:700;color:#e6edf3}
.bil-card .bc-status{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.bil-card .bc-status.pending{background:rgba(255,211,61,.15);color:#ffd33d}
.bil-card .bc-status.paid{background:rgba(63,185,80,.15);color:#3fb950}
.bil-card .bc-status.overdue{background:rgba(248,81,73,.15);color:#f85149}
.bil-card .bc-status.waived{background:rgba(110,118,129,.15);color:#6e7681}
.bil-card .bc-amount{font-size:16px;font-weight:700;color:#e6edf3}
.bil-card .bc-meta{display:flex;gap:12px;font-size:10px;color:#484f58;margin-top:4px}
.bil-card .bc-meta span{display:flex;align-items:center;gap:3px}
.bil-card .bc-type{font-size:9px;background:rgba(210,168,255,.12);color:#d2a8ff;padding:1px 6px;border-radius:4px}
.bil-card .bc-actions{display:flex;gap:4px;margin-top:6px}
.bil-card .bc-actions button{font-size:10px;padding:2px 8px;border-radius:4px;border:1px solid #21262d;background:#161b22;color:#8b949e;cursor:pointer;transition:all .15s}
.bil-card .bc-actions button:hover{background:#21262d;color:#e6edf3}
.bil-card .bc-actions button.bc-pay{color:#3fb950;border-color:rgba(63,185,80,.3)}
/* â”€â”€ Feature #47: Claim Dependencies & Linked Cases â”€â”€ */
.cdl-widget{background:#0d1117;border:1px solid #21262d;border-radius:8px;padding:16px;margin-top:16px}
.cdl-widget h3{margin:0 0 12px;font-size:14px;color:#e6edf3;display:flex;align-items:center;gap:8px}
.cdl-stats-row{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.cdl-stat{flex:1;min-width:90px;background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;text-align:center}
.cdl-stat .ds-num{font-size:20px;font-weight:700;line-height:1.2}
.cdl-stat .ds-lbl{font-size:10px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px}
.cdl-type-bar{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.cdl-type-chip{font-size:10px;padding:3px 10px;border-radius:12px;background:rgba(210,168,255,.1);color:#d2a8ff;border:1px solid rgba(210,168,255,.2);cursor:pointer;transition:all .15s}
.cdl-type-chip:hover,.cdl-type-chip.active{background:rgba(210,168,255,.25);border-color:#d2a8ff}
.cdl-list{max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
.cdl-card{background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;transition:border-color .15s}
.cdl-card:hover{border-color:#30363d}
.cdl-card .dl-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.cdl-card .dl-claims{font-size:12px;color:#e6edf3;font-weight:600}
.cdl-card .dl-claims .dl-arrow{color:#484f58;margin:0 6px}
.cdl-card .dl-type-badge{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.cdl-card .dl-type-badge.related{background:rgba(88,166,255,.15);color:#58a6ff}
.cdl-card .dl-type-badge.parent_child{background:rgba(210,168,255,.15);color:#d2a8ff}
.cdl-card .dl-type-badge.duplicate{background:rgba(255,211,61,.15);color:#ffd33d}
.cdl-card .dl-type-badge.supersedes{background:rgba(248,81,73,.15);color:#f85149}
.cdl-card .dl-type-badge.blocks{background:rgba(63,185,80,.15);color:#3fb950}
.cdl-card .dl-desc{font-size:11px;color:#8b949e;margin-top:2px}
.cdl-card .dl-meta{display:flex;gap:12px;font-size:10px;color:#484f58;margin-top:4px}
.cdl-card .dl-strength{font-size:9px;background:rgba(88,166,255,.12);color:#58a6ff;padding:1px 6px;border-radius:4px}
/* â”€â”€ Feature #48: Claim Evidence Vault â”€â”€ */
.cev-widget{background:#0d1117;border:1px solid #21262d;border-radius:8px;padding:16px;margin-top:16px}
.cev-widget h3{margin:0 0 12px;font-size:14px;color:#e6edf3;display:flex;align-items:center;gap:8px}
.cev-stats-row{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.cev-stat{flex:1;min-width:90px;background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;text-align:center}
.cev-stat .ev-num{font-size:20px;font-weight:700;line-height:1.2}
.cev-stat .ev-lbl{font-size:10px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px}
.cev-verify-bar{margin-bottom:14px}
.cev-verify-label{font-size:10px;color:#8b949e;margin-bottom:4px;display:flex;justify-content:space-between}
.cev-verify-track{height:8px;background:#21262d;border-radius:4px;overflow:hidden}
.cev-verify-fill{height:100%;border-radius:4px;transition:width .4s;background:linear-gradient(90deg,#58a6ff,#3fb950)}
.cev-type-bar{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.cev-type-chip{font-size:10px;padding:3px 10px;border-radius:12px;background:rgba(63,185,80,.1);color:#3fb950;border:1px solid rgba(63,185,80,.2);cursor:pointer;transition:all .15s}
.cev-type-chip:hover,.cev-type-chip.active{background:rgba(63,185,80,.25);border-color:#3fb950}
.cev-list{max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
.cev-card{background:#161b22;border:1px solid #21262d;border-radius:6px;padding:10px;transition:border-color .15s}
.cev-card:hover{border-color:#30363d}
.cev-card .ev-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.cev-card .ev-title{font-size:13px;font-weight:700;color:#e6edf3}
.cev-card .ev-type-badge{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.cev-card .ev-type-badge.screenshot{background:rgba(88,166,255,.15);color:#58a6ff}
.cev-card .ev-type-badge.email{background:rgba(210,168,255,.15);color:#d2a8ff}
.cev-card .ev-type-badge.receipt{background:rgba(63,185,80,.15);color:#3fb950}
.cev-card .ev-type-badge.contract{background:rgba(255,211,61,.15);color:#ffd33d}
.cev-card .ev-type-badge.bank_statement{background:rgba(248,81,73,.15);color:#f85149}
.cev-card .ev-type-badge.correspondence{background:rgba(121,192,255,.15);color:#79c0ff}
.cev-card .ev-type-badge.document,.cev-card .ev-type-badge.other{background:rgba(110,118,129,.15);color:#6e7681}
.cev-card .ev-desc{font-size:11px;color:#8b949e;margin-bottom:4px}
.cev-card .ev-meta{display:flex;gap:12px;font-size:10px;color:#484f58;margin-top:2px}
.cev-card .ev-verified{font-size:9px;background:rgba(63,185,80,.15);color:#3fb950;padding:1px 6px;border-radius:4px}
.cev-card .ev-pending{font-size:9px;background:rgba(255,211,61,.15);color:#ffd33d;padding:1px 6px;border-radius:4px}
.cev-card .ev-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.cev-card .ev-tag{font-size:9px;background:rgba(88,166,255,.1);color:#58a6ff;padding:1px 6px;border-radius:3px}
.cev-card .ev-actions{display:flex;gap:4px;margin-top:6px}
.cev-card .ev-actions button{font-size:10px;padding:2px 8px;border-radius:4px;border:1px solid #21262d;background:#161b22;color:#8b949e;cursor:pointer;transition:all .15s}
.cev-card .ev-actions button:hover{background:#21262d;color:#e6edf3}
.cev-card .ev-actions button.ev-verify-btn{color:#3fb950;border-color:rgba(63,185,80,.3)}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<div class="header">
  <div class="brand">
    <div class="logo">GL</div>
    <div>
      <h1>GhostLedger</h1>
      <div class="tagline">Payment Recovery Engine &bull; Independent Legal Fellowship</div>
      <div class="descriptor">System-assisted recovery coordination for unpaid wages, withheld funds, and platform disputes. Human oversight at every step. No recovery, no fee.</div>
      <div class="api-status">
        <span class="api-dot" id="apiDot"></span>
        <span id="apiLabel">Checking API...</span>
      </div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <button onclick="openSearchPalette()" class="btn btn-ghost btn-sm" title="Search (Ctrl+K)" style="font-size:12px;padding:6px 12px">&#x1F50D; Search <kbd style="font-size:9px;background:#0d1117;border:1px solid #30363d;border-radius:3px;padding:1px 4px;margin-left:4px;color:#484f58">Ctrl+K</kbd></button>
    <button class="notif-bell" onclick="toggleNotifPanel()" title="Notifications" id="notifBellBtn">&#x1F514;<span class="notif-dot" id="notifDot"></span><span class="notif-count" id="notifCount">0</span></button>
    <div class="timestamp" id="clockArea">
      <div id="liveDate"></div>
      <div id="liveTime"></div>
    </div>
  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-panel-header">
    <h3>&#x1F514; Notifications <span id="notifPanelCount" style="font-size:11px;color:#6e7681;font-weight:400"></span></h3>
    <div class="notif-actions">
      <button onclick="markAllNotifRead()">Mark all read</button>
      <button onclick="dismissAllNotifs()">Clear all</button>
      <button onclick="runNotifScan()">&#x1F50D; Scan</button>
    </div>
  </div>
  <div class="notif-panel-body" id="notifPanelBody">
    <div class="notif-empty">Loading notifications...</div>
  </div>
  <button class="notif-scan-btn" onclick="runNotifScan()">&#x1F50D; Scan for SLA &amp; Settlement Alerts</button>
</div>

<!-- TABS -->
<div class="tabs" id="tabBar">
  <button class="tab active" onclick="showTab('dashboard',this)">Dashboard</button>
  <button class="tab" onclick="showTab('cases',this)">Cases <span class="badge blue hidden" id="badgeCases">0</span></button>
  <button class="tab" onclick="showTab('submit',this)">Submit Claim</button>
  <button class="tab" onclick="showTab('followups',this)">Follow-Ups <span class="badge hidden" id="badgeFollowups">0</span></button>
  <button class="tab" onclick="showTab('templates',this)">Templates</button>
  <button class="tab" onclick="showTab('signals',this)">Signals <span class="badge hidden" id="badgeSignals">0</span></button>
  <button class="tab" onclick="showTab('outreach',this)">Outreach</button>
  <button class="tab" onclick="showTab('architecture',this)">Architecture</button>
  <button class="tab" onclick="showTab('ilf',this)">ILF Network <span class="badge hidden" id="badgeILF">0</span></button>
  <button class="tab" onclick="showTab('intel',this)">Intel <span class="badge hidden" id="badgeIntel">0</span></button>
  <button class="tab" onclick="showTab('activity',this)">Activity <span class="badge copper hidden" id="badgeActivity">0</span></button>
  <button class="tab" onclick="showTab('audit',this)">Audit Log</button>
  <button class="tab" onclick="showTab('reports',this)">&#x1F4CA; Reports</button>
</div>

<!-- ========== DASHBOARD ========== -->
<div id="dashboard" class="panel active">
  <div class="stats-grid">
    <div class="stat-card blue">
      <div class="stat-icon">&#x1F4CB;</div>
      <div class="stat-num" id="dTotal">0</div>
      <div class="stat-label">Total Claims</div>
    </div>
    <div class="stat-card copper">
      <div class="stat-icon">&#x1F4B0;</div>
      <div class="stat-num" id="dClaimed">$0</div>
      <div class="stat-label">Total Claimed</div>
    </div>
    <div class="stat-card green">
      <div class="stat-icon">&#x2705;</div>
      <div class="stat-num" id="dResolved">0</div>
      <div class="stat-label">Resolved</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-icon">&#x1F50D;</div>
      <div class="stat-num" id="dActive">0</div>
      <div class="stat-label">Active / In Review</div>
    </div>
    <div class="stat-card red">
      <div class="stat-icon">&#x1F514;</div>
      <div class="stat-num" id="dEscalated">0</div>
      <div class="stat-label">Escalated</div>
    </div>
    <div class="stat-card cyan">
      <div class="stat-icon">&#x1F4C8;</div>
      <div class="stat-num" id="dRate">0%</div>
      <div class="stat-label">Resolution Rate</div>
      <div style="font-size:10px;color:#484f58;margin-top:4px;line-height:1.3">Increases as cases mature</div>
    </div>
    <div class="stat-card green">
      <div class="stat-icon">&#x23F1;</div>
      <div class="stat-num" id="dAvgAge">â€”</div>
      <div class="stat-label">Avg Case Age (days)</div>
    </div>
    <div class="stat-card red">
      <div class="stat-icon">&#x1F4C5;</div>
      <div class="stat-num" id="dOldest">â€”</div>
      <div class="stat-label">Oldest Active (days)</div>
    </div>
  </div>

  <!-- SYSTEM HEALTH MONITOR -->
  <div class="health-banner" id="healthBanner" onclick="toggleHealthDetail()">
    <div class="health-score-ring" id="healthRing">â€”</div>
    <div class="health-info">
      <div class="health-title" id="healthTitle">System Health</div>
      <div class="health-sub" id="healthSub">Loading integrity checks...</div>
    </div>
    <div class="health-pills" id="healthPills"></div>
  </div>
  <div class="health-detail" id="healthDetail">
    <div class="health-checks" id="healthChecks"></div>
    <div style="margin-top:8px;font-size:10px;color:#484f58;text-align:right" id="healthTimestamp"></div>
  </div>

  <div class="section-hdr"><span class="section-icon">&#x1F4CA;</span><h3>CCE Intelligence</h3></div>
  <div id="cceBreakdown" class="cce-container"><div style="color:#484f58;text-align:center;padding:16px">Submit claims to see CCE classification breakdown</div></div>

  <!-- SLA COMPLIANCE -->
  <div class="sla-widget" id="slaWidget" style="display:none">
    <h3>&#x23F0; SLA Compliance</h3>
    <div class="sla-summary" id="slaSummary"></div>
    <div class="sla-claims" id="slaClaims"></div>
  </div>

  <!-- RECOVERY METRICS -->
  <!-- ESCALATION ENGINE -->
  <div class="esc-widget" id="escWidget" style="display:none">
    <div class="esc-header">
      <h3>&#x26A1; Escalation Queue</h3>
      <div class="esc-stats" id="escStats"></div>
    </div>
    <div class="esc-queue" id="escQueue"></div>
    <div style="display:flex;gap:6px;margin-top:8px" id="escBatchActions" style="display:none">
      <button class="btn btn-primary btn-sm" onclick="executeAllEscalations()" style="background:#22c55e;color:#0a0e14;font-weight:700">&#x2705; Execute All</button>
      <button class="btn btn-ghost btn-sm" onclick="fetchEscalationQueue()">&#x21BB; Re-evaluate</button>
    </div>
  </div>

  <!-- WORKLOAD DISTRIBUTION -->
  <div class="workload-widget" id="workloadWidget" style="display:none">
    <h3>&#x1F465; Team Workload Distribution</h3>
    <div class="wl-summary">
      <div class="wl-card"><div class="wl-num" id="wlAssigned">0</div><div class="wl-label">Assigned</div></div>
      <div class="wl-card"><div class="wl-num" id="wlUnassigned" style="color:#f0ad4e">0</div><div class="wl-label">Unassigned</div></div>
      <div class="wl-card"><div class="wl-num" id="wlRate" style="color:#58a6ff">0%</div><div class="wl-label">Assignment Rate</div></div>
      <div class="wl-card"><div class="wl-num" id="wlOperators" style="color:#4ade80">0</div><div class="wl-label">Active Operators</div></div>
    </div>
    <div id="workloadBars"></div>
  </div>

  <!-- RESOLUTION DASHBOARD -->
  <div class="resolution-widget" id="resolutionWidget" style="display:none">
    <h3>&#x2696;&#xFE0F; Settlement &amp; Resolution Tracker</h3>
    <div class="res-summary">
      <div class="res-card"><div class="res-val" id="resTotalResolved">0</div><div class="res-label">Total Resolved</div></div>
      <div class="res-card"><div class="res-val" id="resTotalSettled" style="color:#4ade80">$0</div><div class="res-label">Settled Amount</div></div>
      <div class="res-card"><div class="res-val" id="resAvgRatio" style="color:#58a6ff">0%</div><div class="res-label">Avg Settlement Ratio</div></div>
      <div class="res-card"><div class="res-val" id="resPendingOffers" style="color:#f0ad4e">0</div><div class="res-label">Pending Offers</div></div>
    </div>
    <div class="res-recent" id="resRecentList"></div>
  </div>

  <!-- WORKFLOW RULES DASHBOARD -->
  <div class="wf-widget" id="workflowWidget" style="display:none">
    <h3>&#x2699;&#xFE0F; Automated Workflow Rules</h3>
    <div class="wf-summary">
      <div class="wf-card"><div class="wf-val" id="wfTotal">0</div><div class="wf-label">Total Rules</div></div>
      <div class="wf-card"><div class="wf-val" id="wfActive" style="color:#4ade80">0</div><div class="wf-label">Active</div></div>
      <div class="wf-card"><div class="wf-val" id="wfExecs" style="color:#58a6ff">0</div><div class="wf-label">Executions</div></div>
      <div class="wf-card"><div class="wf-val" id="wfLastRun" style="color:#f0ad4e;font-size:11px">â€”</div><div class="wf-label">Last Triggered</div></div>
    </div>
    <div id="wfRulesList"></div>
    <div style="margin-top:8px;display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="runScheduledRules()" style="flex:1">&#x23F0; Run Scheduled Rules</button>
      <button class="btn btn-ghost btn-sm" onclick="fetchWorkflowRules()" style="flex:1">&#x1F504; Refresh</button>
    </div>
    <div id="wfRecentExecs" style="margin-top:10px"></div>
  </div>

  <!-- DOCUMENT/EVIDENCE DASHBOARD -->
  <div class="doc-widget" id="docWidget" style="display:none">
    <h3>&#x1F4CE; Document &amp; Evidence Tracker</h3>
    <div class="doc-summary">
      <div class="doc-card"><div class="doc-val" id="docTotal">0</div><div class="doc-label">Total Documents</div></div>
      <div class="doc-card"><div class="doc-val" id="docSize" style="color:#58a6ff">â€”</div><div class="doc-label">Total Size</div></div>
      <div class="doc-card"><div class="doc-val" id="docCoverage" style="color:#4ade80">0%</div><div class="doc-label">Claims w/ Docs</div></div>
      <div class="doc-card"><div class="doc-val" id="docTypes" style="color:#d2a8ff">0</div><div class="doc-label">File Types</div></div>
    </div>
    <div id="docCategoryBreakdown" style="margin-bottom:8px"></div>
    <div id="docRecentList" class="doc-recent"></div>
    <div style="margin-top:8px">
      <button class="btn btn-ghost btn-sm" onclick="fetchDocumentStats()" style="width:100%">&#x1F504; Refresh</button>
    </div>
  </div>

  <!-- CASE GROUPS DASHBOARD -->
  <div class="cg-widget" id="cgWidget" style="display:none">
    <h3>&#x1F517; Case Groups &amp; Linked Claims</h3>
    <div class="cg-summary">
      <div class="cg-card"><div class="cg-val" id="cgTotal">0</div><div class="cg-label">Total Groups</div></div>
      <div class="cg-card"><div class="cg-val" id="cgActive" style="color:#4ade80">0</div><div class="cg-label">Active</div></div>
      <div class="cg-card"><div class="cg-val" id="cgLinked" style="color:#79c0ff">0</div><div class="cg-label">Linked Claims</div></div>
      <div class="cg-card"><div class="cg-val" id="cgCoverage" style="color:#d2a8ff">0%</div><div class="cg-label">Coverage</div></div>
    </div>
    <div id="cgGroupsList" style="max-height:180px;overflow-y:auto"></div>
    <div style="margin-top:8px;display:flex;gap:6px">
      <button class="btn btn-primary btn-sm" onclick="autoCreateGroups()" style="flex:1;background:#79c0ff;color:#0a0e14;font-weight:700">&#x2728; Auto-Detect Groups</button>
      <button class="btn btn-ghost btn-sm" onclick="fetchCaseGroups()" style="flex:1">&#x1F504; Refresh</button>
    </div>
  </div>

  <!-- PRIORITY QUEUE & SMART TRIAGE -->
  <div class="triage-widget" id="triageWidget" style="display:none">
    <h3>&#x1F6A8; Priority Queue &amp; Smart Triage</h3>
    <div class="tri-summary">
      <div class="tri-card"><div class="tri-val" id="triTotal" style="color:#e6edf3">0</div><div class="tri-lbl">In Queue</div></div>
      <div class="tri-card"><div class="tri-val" id="triCritical" style="color:#f85149">0</div><div class="tri-lbl">Critical</div></div>
      <div class="tri-card"><div class="tri-val" id="triHigh" style="color:#f0883e">0</div><div class="tri-lbl">High</div></div>
      <div class="tri-card"><div class="tri-val" id="triMedium" style="color:#58a6ff">0</div><div class="tri-lbl">Medium</div></div>
      <div class="tri-card"><div class="tri-val" id="triAvg" style="color:#d2a8ff">0</div><div class="tri-lbl">Avg Score</div></div>
    </div>
    <div class="tri-filter-row">
      <button class="tri-filter-btn active" onclick="filterTriageQueue('all')">All</button>
      <button class="tri-filter-btn" onclick="filterTriageQueue('critical')">Critical</button>
      <button class="tri-filter-btn" onclick="filterTriageQueue('high')">High</button>
      <button class="tri-filter-btn" onclick="filterTriageQueue('medium')">Medium</button>
      <button class="tri-filter-btn" onclick="filterTriageQueue('low')">Low</button>
    </div>
    <div class="tri-queue" id="triQueue"><div style="color:#484f58;text-align:center;padding:12px;font-size:11px">Loading priority queue...</div></div>
    <div style="margin-top:8px">
      <button class="btn btn-ghost btn-sm" onclick="fetchTriageQueue()" style="width:100%">&#x1F504; Refresh Queue</button>
    </div>
  </div>

  <!-- WEBHOOKS & INTEGRATIONS -->
  <div class="wh-widget" id="webhookWidget" style="display:none">
    <h3>&#x1F517; Webhooks &amp; Integrations</h3>
    <div class="wh-summary">
      <div class="wh-card"><div class="wh-val" id="whTotal" style="color:#58a6ff">0</div><div class="wh-lbl">Webhooks</div></div>
      <div class="wh-card"><div class="wh-val" id="whActive" style="color:#4ade80">0</div><div class="wh-lbl">Active</div></div>
      <div class="wh-card"><div class="wh-val" id="whDeliveries" style="color:#d2a8ff">0</div><div class="wh-lbl">Deliveries</div></div>
      <div class="wh-card"><div class="wh-val" id="whRate" style="color:#ffd33d">0%</div><div class="wh-lbl">Success Rate</div></div>
    </div>
    <div class="wh-list" id="whList"><span style="color:#484f58;font-size:11px">No webhooks registered</span></div>
    <div class="wh-add-form">
      <input type="text" id="whNewUrl" placeholder="https://example.com/webhook" onkeydown="if(event.key==='Enter')registerWebhookFromWidget()">
      <button class="btn btn-primary btn-sm" onclick="registerWebhookFromWidget()" style="background:#1f6feb;color:#fff;border:none;font-weight:700;font-size:10px;padding:5px 12px;border-radius:4px">+ Add</button>
    </div>
  </div>

  <!-- FINANCIAL RECONCILIATION -->
  <div class="fin-widget" id="financialWidget" style="display:none">
    <h3>&#x1F4B0; Financial Reconciliation</h3>
    <div class="fin-kpis">
      <div class="fin-kpi"><div class="fin-kpi-val" id="finClaimed" style="color:#58a6ff">$0</div><div class="fin-kpi-lbl">Total Claimed</div></div>
      <div class="fin-kpi"><div class="fin-kpi-val" id="finRecovered" style="color:#4ade80">$0</div><div class="fin-kpi-lbl">Recovered</div></div>
      <div class="fin-kpi"><div class="fin-kpi-val" id="finSettled" style="color:#d2a8ff">$0</div><div class="fin-kpi-lbl">Settled</div></div>
      <div class="fin-kpi"><div class="fin-kpi-val" id="finGap" style="color:#f85149">$0</div><div class="fin-kpi-lbl">Outstanding</div></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span style="font-size:11px;color:#8b949e">Recovery Rate</span>
      <span style="font-size:13px;font-weight:700" id="finRate">0%</span>
    </div>
    <div class="fin-gap-bar" style="margin-bottom:16px"><div class="fin-gap-fill" id="finRateBar" style="width:0%;background:linear-gradient(90deg,#f85149 0%,#ffd33d 50%,#4ade80 100%)"></div></div>
    <div class="fin-section-title">Recovery by Method</div>
    <div id="finMethodBreakdown" style="margin-bottom:8px"></div>
    <div class="fin-section-title">Top Respondents by Exposure</div>
    <div style="max-height:250px;overflow-y:auto">
      <table class="fin-resp-table">
        <thead><tr><th>Respondent</th><th>Claimed</th><th>Recovered</th><th>Gap</th><th>Rate</th></tr></thead>
        <tbody id="finRespTable"></tbody>
      </table>
    </div>
  </div>

  <!-- COMPLIANCE & REGULATORY FRAMEWORK -->
  <div class="comp-widget" id="complianceWidget" style="display:none">
    <h3>&#x2696;&#xFE0F; Compliance & Regulatory</h3>
    <div class="comp-kpis">
      <div class="comp-kpi"><div class="comp-kpi-val" id="compRules" style="color:#58a6ff">0</div><div class="comp-kpi-lbl">Active Rules</div></div>
      <div class="comp-kpi"><div class="comp-kpi-val" id="compChecks" style="color:#4ade80">0</div><div class="comp-kpi-lbl">Checks Run</div></div>
      <div class="comp-kpi"><div class="comp-kpi-val" id="compOverdue" style="color:#f85149">0</div><div class="comp-kpi-lbl">Overdue</div></div>
      <div class="comp-kpi"><div class="comp-kpi-val" id="compClaims" style="color:#d2a8ff">0</div><div class="comp-kpi-lbl">Claims Checked</div></div>
    </div>
    <div class="comp-score-bar">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:12px;color:#8b949e;font-weight:600">Average Compliance Score</span>
        <span id="compScoreLabel" style="font-size:14px;font-weight:700;color:#4ade80">100%</span>
      </div>
      <div class="comp-score-track">
        <div class="comp-score-fill" id="compScoreFill" style="width:100%;background:linear-gradient(90deg,#238636,#4ade80)"></div>
      </div>
    </div>
    <button class="comp-add-btn" onclick="showCreateCompRuleModal()">+ New Rule</button>
    <div class="comp-section-title">Active Rules</div>
    <div class="comp-rules-list" id="compRulesList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No compliance rules yet</div>
    </div>
  </div>

  <!-- Create Compliance Rule Modal -->
  <div class="comp-modal" id="compRuleModal" onclick="if(event.target===this)this.style.display='none'">
    <div class="comp-modal-body">
      <h3 style="margin:0 0 16px;font-size:16px;color:#e6edf3">&#x2696;&#xFE0F; New Compliance Rule</h3>
      <div class="comp-form-group">
        <label>Rule Name</label>
        <input type="text" id="compRuleName" placeholder="e.g., Consumer Protection Act Filing Deadline">
      </div>
      <div class="comp-form-group">
        <label>Description</label>
        <textarea id="compRuleDesc" placeholder="Describe the regulatory requirement..."></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="comp-form-group">
          <label>Category</label>
          <select id="compRuleCat">
            <option value="general">General</option>
            <option value="consumer_protection">Consumer Protection</option>
            <option value="financial_regulation">Financial Regulation</option>
            <option value="data_privacy">Data Privacy</option>
            <option value="dispute_resolution">Dispute Resolution</option>
            <option value="reporting">Reporting</option>
            <option value="anti_fraud">Anti-Fraud</option>
            <option value="licensing">Licensing</option>
            <option value="cross_border">Cross-Border</option>
            <option value="aml_kyc">AML/KYC</option>
          </select>
        </div>
        <div class="comp-form-group">
          <label>Jurisdiction</label>
          <select id="compRuleJuris">
            <option value="global">Global</option>
            <option value="us_federal">US Federal</option>
            <option value="us_state">US State</option>
            <option value="eu">European Union</option>
            <option value="uk">United Kingdom</option>
            <option value="canada">Canada</option>
            <option value="australia">Australia</option>
            <option value="international">International</option>
          </select>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
        <div class="comp-form-group">
          <label>Severity</label>
          <select id="compRuleSev">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        <div class="comp-form-group">
          <label>Applies To</label>
          <select id="compRuleApplies">
            <option value="all_claims">All Claims</option>
            <option value="high_value">High Value ($10k+)</option>
            <option value="escalated">Escalated Only</option>
          </select>
        </div>
        <div class="comp-form-group">
          <label>Deadline (days)</label>
          <input type="number" id="compRuleDeadline" placeholder="e.g., 30" min="1">
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button style="flex:1;background:#238636;color:#fff;border:none;border-radius:6px;padding:10px;font-size:13px;font-weight:600;cursor:pointer" onclick="saveNewCompRule()">Create Rule</button>
        <button style="background:#21262d;color:#8b949e;border:1px solid #30363d;border-radius:6px;padding:10px 16px;font-size:13px;cursor:pointer" onclick="document.getElementById('compRuleModal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <!-- CLAIM SCORING & RISK ASSESSMENT -->
  <div class="risk-widget" id="riskWidget" style="display:none">
    <h3>&#x1F3AF; Risk Assessment</h3>
    <div class="risk-kpis">
      <div class="risk-kpi"><div class="risk-kpi-val" id="riskAssessed" style="color:#58a6ff">0</div><div class="risk-kpi-lbl">Assessed</div></div>
      <div class="risk-kpi"><div class="risk-kpi-val" id="riskAvgScore" style="color:#d29922">0</div><div class="risk-kpi-lbl">Avg Score</div></div>
      <div class="risk-kpi"><div class="risk-kpi-val" id="riskCritical" style="color:#f85149">0</div><div class="risk-kpi-lbl">Critical</div></div>
      <div class="risk-kpi"><div class="risk-kpi-val" id="riskHigh" style="color:#f0883e">0</div><div class="risk-kpi-lbl">High</div></div>
      <div class="risk-kpi"><div class="risk-kpi-val" id="riskLow" style="color:#3fb950">0</div><div class="risk-kpi-lbl">Low</div></div>
    </div>
    <div style="font-size:11px;color:#8b949e;margin-bottom:6px;font-weight:600">Risk Distribution</div>
    <div class="risk-heatmap" id="riskHeatmap"></div>
    <div class="risk-section-title">Highest Risk Claims</div>
    <div class="risk-list" id="riskTopList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading risk data...</div>
    </div>
  </div>

  <!-- CORRESPONDENCE & COMMUNICATION LOG -->
  <div class="corr-widget" id="corrWidget" style="display:none">
    <h3>&#x1F4E8; Correspondence</h3>
    <div class="corr-kpis">
      <div class="corr-kpi"><div class="corr-kpi-val" id="corrTotal" style="color:#58a6ff">0</div><div class="corr-kpi-lbl">Messages</div></div>
      <div class="corr-kpi"><div class="corr-kpi-val" id="corrSent" style="color:#4ade80">0</div><div class="corr-kpi-lbl">Sent</div></div>
      <div class="corr-kpi"><div class="corr-kpi-val" id="corrResponse" style="color:#d2a8ff">0</div><div class="corr-kpi-lbl">Response Rate</div></div>
      <div class="corr-kpi"><div class="corr-kpi-val" id="corrClaims" style="color:#ffd33d">0</div><div class="corr-kpi-lbl">Claims w/ Comms</div></div>
    </div>
    <div class="corr-channel-bar" id="corrChannelBar">
      <button class="corr-ch-btn active" onclick="filterCorrChannel('')">All</button>
    </div>
    <button class="corr-add-btn" onclick="showCreateCorrModal()">+ New Message</button>
    <div class="corr-list" id="corrList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No correspondence yet</div>
    </div>
  </div>

  <!-- Create Correspondence Modal -->
  <div class="corr-modal" id="corrModal" onclick="if(event.target===this)this.style.display='none'">
    <div class="corr-modal-body">
      <h3 style="margin:0 0 16px;font-size:16px;color:#e6edf3">&#x1F4E8; New Correspondence</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="corr-form-group">
          <label>Claim ID</label>
          <input type="text" id="corrClaimId" placeholder="CLM-...">
        </div>
        <div class="corr-form-group">
          <label>Direction</label>
          <select id="corrDirection">
            <option value="outbound">Outbound</option>
            <option value="inbound">Inbound</option>
          </select>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="corr-form-group">
          <label>Channel</label>
          <select id="corrChannel">
            <option value="email">Email</option>
            <option value="letter">Letter</option>
            <option value="phone">Phone</option>
            <option value="portal">Portal</option>
            <option value="sms">SMS</option>
            <option value="legal_notice">Legal Notice</option>
          </select>
        </div>
        <div class="corr-form-group">
          <label>Priority</label>
          <select id="corrPriority">
            <option value="normal">Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
      </div>
      <div class="corr-form-group">
        <label>Subject</label>
        <input type="text" id="corrSubject" placeholder="Re: Claim #... â€” Follow-up Notice">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="corr-form-group">
          <label>Sender</label>
          <input type="text" id="corrSender" placeholder="operations@ghostledger.io">
        </div>
        <div class="corr-form-group">
          <label>Recipient</label>
          <input type="text" id="corrRecipient" placeholder="respondent@example.com">
        </div>
      </div>
      <div class="corr-form-group">
        <label>Body</label>
        <textarea id="corrBody" placeholder="Message content..."></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button style="flex:1;background:#1f6feb;color:#fff;border:none;border-radius:6px;padding:10px;font-size:13px;font-weight:600;cursor:pointer" onclick="saveNewCorrespondence('draft')">Save Draft</button>
        <button style="flex:1;background:#238636;color:#fff;border:none;border-radius:6px;padding:10px;font-size:13px;font-weight:600;cursor:pointer" onclick="saveNewCorrespondence('sent')">Send Now</button>
        <button style="background:#21262d;color:#8b949e;border:1px solid #30363d;border-radius:6px;padding:10px 16px;font-size:13px;cursor:pointer" onclick="document.getElementById('corrModal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <!-- CLAIM WATCHLIST & OPERATOR BOOKMARKS -->
  <div class="wl-widget" id="watchlistWidget" style="display:none">
    <h3>&#x2B50; Watchlist</h3>
    <div class="wl-kpis">
      <div class="wl-kpi"><div class="wl-kpi-val" id="wlTotal" style="color:#ffd33d">0</div><div class="wl-kpi-lbl">Watching</div></div>
      <div class="wl-kpi"><div class="wl-kpi-val" id="wlUrgent" style="color:#f85149">0</div><div class="wl-kpi-lbl">Urgent</div></div>
      <div class="wl-kpi"><div class="wl-kpi-val" id="wlMostWatched" style="color:#d2a8ff">â€”</div><div class="wl-kpi-lbl">Most Watched</div></div>
    </div>
    <div class="wl-list" id="wlList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No claims on watchlist</div>
    </div>
  </div>

  <!-- SETTLEMENT NEGOTIATION TRACKER -->
  <div class="neg-widget" id="negWidget" style="display:none">
    <h3>&#x1F91D; Negotiations</h3>
    <div class="neg-kpis">
      <div class="neg-kpi"><div class="neg-kpi-val" id="negActive" style="color:#ffd33d">0</div><div class="neg-kpi-lbl">Active</div></div>
      <div class="neg-kpi"><div class="neg-kpi-val" id="negAccepted" style="color:#3fb950">0</div><div class="neg-kpi-lbl">Accepted</div></div>
      <div class="neg-kpi"><div class="neg-kpi-val" id="negAvgRounds" style="color:#58a6ff">0</div><div class="neg-kpi-lbl">Avg Rounds</div></div>
      <div class="neg-kpi"><div class="neg-kpi-val" id="negTotalAccepted" style="color:#4ade80">$0</div><div class="neg-kpi-lbl">Settled Value</div></div>
    </div>
    <div class="neg-section-title">Recent Negotiations</div>
    <div id="negRecentList" style="max-height:250px;overflow-y:auto">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No negotiations yet</div>
    </div>
  </div>

  <!-- TASK QUEUE & OPERATOR ASSIGNMENTS -->
  <div class="tq-widget" id="taskQueueWidget" style="display:none">
    <h3>&#x1F4CB; Task Queue</h3>
    <div class="tq-kpis">
      <div class="tq-kpi"><div class="tq-kpi-val" id="tqTotal" style="color:#58a6ff">0</div><div class="tq-kpi-lbl">Total</div></div>
      <div class="tq-kpi"><div class="tq-kpi-val" id="tqOpen" style="color:#d2a8ff">0</div><div class="tq-kpi-lbl">Open</div></div>
      <div class="tq-kpi"><div class="tq-kpi-val" id="tqInProgress" style="color:#ffd33d">0</div><div class="tq-kpi-lbl">In Progress</div></div>
      <div class="tq-kpi"><div class="tq-kpi-val" id="tqOverdue" style="color:#f85149">0</div><div class="tq-kpi-lbl">Overdue</div></div>
      <div class="tq-kpi"><div class="tq-kpi-val" id="tqCompleted" style="color:#3fb950">0</div><div class="tq-kpi-lbl">Done</div></div>
    </div>
    <div class="tq-filters">
      <button class="tq-filter-btn active" onclick="filterTasks('all')">All</button>
      <button class="tq-filter-btn" onclick="filterTasks('open')">Open</button>
      <button class="tq-filter-btn" onclick="filterTasks('in_progress')">In Progress</button>
      <button class="tq-filter-btn" onclick="filterTasks('overdue')">Overdue</button>
      <button class="tq-filter-btn" onclick="filterTasks('completed')">Completed</button>
    </div>
    <div id="taskQueueList" class="tq-list">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No tasks yet</div>
    </div>
    <div style="margin-top:10px;text-align:right">
      <button class="tq-add-btn" onclick="showCreateTaskModal()">+ New Task</button>
    </div>
  </div>

  <!-- OPERATOR PERFORMANCE SCORECARDS -->
  <div class="sc-widget" id="scorecardWidget" style="display:none">
    <h3>&#x1F3C6; Operator Scorecards</h3>
    <div class="sc-summary">
      <div class="sc-summary-card"><div class="sc-summary-val" id="scOpCount" style="color:#58a6ff">0</div><div class="sc-summary-lbl">Operators</div></div>
      <div class="sc-summary-card"><div class="sc-summary-val" id="scAvgScore" style="color:#3fb950">0</div><div class="sc-summary-lbl">Avg Score</div></div>
      <div class="sc-summary-card"><div class="sc-summary-val" id="scTasksDone" style="color:#d2a8ff">0</div><div class="sc-summary-lbl">Tasks Done</div></div>
      <div class="sc-summary-card"><div class="sc-summary-val" id="scOverdue" style="color:#f85149">0</div><div class="sc-summary-lbl">Overdue</div></div>
    </div>
    <div id="scorecardCards" class="sc-cards">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px;grid-column:1/-1">Loading scorecards...</div>
    </div>
  </div>

  <!-- EXPORT & DOWNLOAD CENTER -->
  <div class="exp-widget" id="exportWidget" style="display:none">
    <h3>&#x1F4E5; Export Center</h3>
    <div class="exp-kpis">
      <div class="exp-kpi"><div class="exp-kpi-val" id="expTotal" style="color:#58a6ff">0</div><div class="exp-kpi-lbl">Exports</div></div>
      <div class="exp-kpi"><div class="exp-kpi-val" id="expRecords" style="color:#3fb950">0</div><div class="exp-kpi-lbl">Records</div></div>
      <div class="exp-kpi"><div class="exp-kpi-val" id="expSize" style="color:#d2a8ff">0</div><div class="exp-kpi-lbl">Total Size</div></div>
      <div class="exp-kpi"><div class="exp-kpi-val" id="expTypes" style="color:#ffd33d">0</div><div class="exp-kpi-lbl">Types Used</div></div>
    </div>
    <div class="exp-buttons">
      <div class="exp-btn" onclick="runExport('claims','json')"><div class="exp-btn-icon">&#x1F4C4;</div><div class="exp-btn-label">Claims</div><div class="exp-btn-sub">JSON</div></div>
      <div class="exp-btn" onclick="runExport('claims','csv')"><div class="exp-btn-icon">&#x1F4C4;</div><div class="exp-btn-label">Claims</div><div class="exp-btn-sub">CSV</div></div>
      <div class="exp-btn" onclick="runExport('tasks','json')"><div class="exp-btn-icon">&#x1F4CB;</div><div class="exp-btn-label">Tasks</div><div class="exp-btn-sub">JSON</div></div>
      <div class="exp-btn" onclick="runExport('correspondence','json')"><div class="exp-btn-icon">&#x1F4E8;</div><div class="exp-btn-label">Corr.</div><div class="exp-btn-sub">JSON</div></div>
      <div class="exp-btn" onclick="runExport('audit_log','json')"><div class="exp-btn-icon">&#x1F4DD;</div><div class="exp-btn-label">Audit Log</div><div class="exp-btn-sub">JSON</div></div>
      <div class="exp-btn" onclick="runExport('scorecards','json')"><div class="exp-btn-icon">&#x1F3C6;</div><div class="exp-btn-label">Scorecards</div><div class="exp-btn-sub">JSON</div></div>
      <div class="exp-btn" onclick="runExport('analytics','json')"><div class="exp-btn-icon">&#x1F4CA;</div><div class="exp-btn-label">Analytics</div><div class="exp-btn-sub">JSON</div></div>
      <div class="exp-btn" onclick="runExport('negotiations','csv')"><div class="exp-btn-icon">&#x1F91D;</div><div class="exp-btn-label">Negotiations</div><div class="exp-btn-sub">CSV</div></div>
    </div>
    <div style="font-size:11px;color:#6e7681;margin-bottom:6px">Recent Exports</div>
    <div id="exportHistory" class="exp-history">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:12px">No exports yet</div>
    </div>
  </div>

  <!-- CASE MILESTONES & PROGRESS TRACKING -->
  <div class="ms-widget" id="milestoneWidget" style="display:none">
    <h3>&#x1F3AF; Case Milestones</h3>
    <div class="ms-kpis">
      <div class="ms-kpi"><div class="ms-kpi-val" id="msClaims" style="color:#58a6ff">0</div><div class="ms-kpi-lbl">Tracked</div></div>
      <div class="ms-kpi"><div class="ms-kpi-val" id="msCompleted" style="color:#3fb950">0</div><div class="ms-kpi-lbl">Completed</div></div>
      <div class="ms-kpi"><div class="ms-kpi-val" id="msAvgProgress" style="color:#d2a8ff">0%</div><div class="ms-kpi-lbl">Avg Progress</div></div>
      <div class="ms-kpi"><div class="ms-kpi-val" id="msOverdue" style="color:#f85149">0</div><div class="ms-kpi-lbl">Overdue</div></div>
    </div>
    <div class="ms-progress-bar">
      <div class="ms-progress-fill" id="msGlobalBar" style="width:0%"></div>
    </div>
    <div style="font-size:10px;color:#6e7681;text-align:right;margin-top:-8px;margin-bottom:8px" id="msGlobalPct">0% overall completion</div>
  </div>

  <!-- RESPONDENT PROFILE & HISTORY -->
  <div class="rp-widget" id="respondentProfileWidget" style="display:none">
    <h3>&#x1F50D; Respondent Profiles</h3>
    <input class="rp-search" type="text" placeholder="Search respondents..." oninput="filterRespondentProfiles(this.value)" id="rpSearch">
    <div id="respondentProfileList" class="rp-list">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading respondent profiles...</div>
    </div>
  </div>

  <!-- SATISFACTION SURVEYS (F43) -->
  <div class="surv-widget" id="surveyWidget" style="display:none">
    <h3>&#x2B50; Satisfaction Surveys <button class="btn btn-ghost btn-sm" onclick="fetchSurveyStats()" style="margin-left:auto">&#x21BB; Refresh</button></h3>
    <div class="surv-stats-row">
      <div class="surv-stat"><div class="ss-num" id="survAvgRating">â€”</div><div class="ss-lbl">Avg Rating</div></div>
      <div class="surv-stat"><div class="ss-num" id="survNPS">â€”</div><div class="ss-lbl">NPS Score</div></div>
      <div class="surv-stat"><div class="ss-num" id="survCompleted">0</div><div class="ss-lbl">Completed</div></div>
      <div class="surv-stat"><div class="ss-num" id="survPending">0</div><div class="ss-lbl">Pending</div></div>
      <div class="surv-stat"><div class="ss-num" id="survResponseRate">0%</div><div class="ss-lbl">Response Rate</div></div>
    </div>
    <div class="surv-bar-row" id="survRatingBar">
      <div class="surv-bar-seg surv-bar-5" style="flex:1" title="5 stars">5â˜…</div>
      <div class="surv-bar-seg surv-bar-4" style="flex:1" title="4 stars">4â˜…</div>
      <div class="surv-bar-seg surv-bar-3" style="flex:1" title="3 stars">3â˜…</div>
      <div class="surv-bar-seg surv-bar-2" style="flex:1" title="2 stars">2â˜…</div>
      <div class="surv-bar-seg surv-bar-1" style="flex:1" title="1 star">1â˜…</div>
    </div>
    <div class="surv-trend" id="survTrend"></div>
    <h3 style="font-size:12px;margin-top:8px">Recent Feedback</h3>
    <div class="surv-list" id="survFeedbackList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading survey data...</div>
    </div>
  </div>

  <!-- ESCALATION PLAYBOOKS (F44) -->
  <div class="epb-widget" id="playbookWidget" style="display:none">
    <h3>&#x1F3AF; Escalation Playbooks <button class="btn btn-ghost btn-sm" onclick="fetchPlaybookStats()" style="margin-left:auto">&#x21BB; Refresh</button></h3>
    <div class="epb-stats-row">
      <div class="epb-stat"><div class="es-num" id="pbTotal">0</div><div class="es-lbl">Playbooks</div></div>
      <div class="epb-stat"><div class="es-num" id="pbActive">0</div><div class="es-lbl">Active</div></div>
      <div class="epb-stat"><div class="es-num" id="pbExecutions">0</div><div class="es-lbl">Executions</div></div>
      <div class="epb-stat"><div class="es-num" id="pbSuccessRate">â€”</div><div class="es-lbl">Success Rate</div></div>
    </div>
    <div class="epb-list" id="playbookList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading playbooks...</div>
    </div>
    <div class="epb-exec" id="playbookExecLog">
      <div style="font-weight:700;margin-bottom:4px;color:#e6edf3;font-size:12px">Recent Executions</div>
      <div id="pbExecItems" style="color:#484f58;font-size:11px">No executions yet</div>
    </div>
  </div>

  <!-- COMMUNICATION CHANNEL REGISTRY (F45) -->
  <div class="ccr-widget" id="channelWidget" style="display:none">
    <h3>&#x1F4E1; Communication Channels <button class="btn btn-ghost btn-sm" onclick="fetchChannelStats()" style="margin-left:auto">&#x21BB; Refresh</button></h3>
    <div class="ccr-stats-row">
      <div class="ccr-stat"><div class="cs-num" id="chTotal">0</div><div class="cs-lbl">Channels</div></div>
      <div class="ccr-stat"><div class="cs-num" id="chEntities">0</div><div class="cs-lbl">Entities</div></div>
      <div class="ccr-stat"><div class="cs-num" id="chSuccess" style="color:#3fb950">0</div><div class="cs-lbl">Successes</div></div>
      <div class="ccr-stat"><div class="cs-num" id="chRate">â€”</div><div class="cs-lbl">Success Rate</div></div>
    </div>
    <div class="ccr-type-bar" id="chTypeBar">
      <span class="ccr-type-chip active" onclick="filterChannels('')">All</span>
    </div>
    <div class="ccr-list" id="channelList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading channels...</div>
    </div>
  </div>

  <!-- FEE & BILLING TRACKER (F46) -->
  <div class="bil-widget" id="billingWidget" style="display:none">
    <h3>&#x1F4B0; Fee &amp; Billing <button class="btn btn-ghost btn-sm" onclick="fetchBillingStats()" style="margin-left:auto">&#x21BB; Refresh</button></h3>
    <div class="bil-stats-row">
      <div class="bil-stat"><div class="bs-num" id="bilTotal">0</div><div class="bs-lbl">Entries</div></div>
      <div class="bil-stat"><div class="bs-num" id="bilBilled" style="color:#58a6ff">$0</div><div class="bs-lbl">Billed</div></div>
      <div class="bil-stat"><div class="bs-num" id="bilCollected" style="color:#3fb950">$0</div><div class="bs-lbl">Collected</div></div>
      <div class="bil-stat"><div class="bs-num" id="bilOutstanding" style="color:#ffd33d">$0</div><div class="bs-lbl">Outstanding</div></div>
      <div class="bil-stat"><div class="bs-num" id="bilOverdue" style="color:#f85149">0</div><div class="bs-lbl">Overdue</div></div>
    </div>
    <div class="bil-meter">
      <div class="bil-meter-label"><span>Collection Rate</span><span id="bilRate">0%</span></div>
      <div class="bil-meter-bar"><div class="bil-meter-fill" id="bilRateFill" style="width:0%"></div></div>
    </div>
    <div class="bil-filter-bar" id="bilFilterBar">
      <span class="bil-filter-chip active" onclick="filterBilling('')">All</span>
      <span class="bil-filter-chip" onclick="filterBilling('pending')">Pending</span>
      <span class="bil-filter-chip" onclick="filterBilling('paid')">Paid</span>
    </div>
    <div class="bil-list" id="billingList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading billing entries...</div>
    </div>
  </div>

  <!-- CLAIM DEPENDENCIES & LINKED CASES (F47) -->
  <div class="cdl-widget" id="claimLinksWidget" style="display:none">
    <h3>&#x1F517; Claim Dependencies <button class="btn btn-ghost btn-sm" onclick="fetchClaimLinkStats()" style="margin-left:auto">&#x21BB; Refresh</button></h3>
    <div class="cdl-stats-row">
      <div class="cdl-stat"><div class="ds-num" id="clTotal">0</div><div class="ds-lbl">Links</div></div>
      <div class="cdl-stat"><div class="ds-num" id="clClaims">0</div><div class="ds-lbl">Linked Claims</div></div>
      <div class="cdl-stat"><div class="ds-num" id="clStrength">â€”</div><div class="ds-lbl">Avg Strength</div></div>
      <div class="cdl-stat"><div class="ds-num" id="clTypes">0</div><div class="ds-lbl">Link Types</div></div>
    </div>
    <div class="cdl-type-bar" id="clTypeBar">
      <span class="cdl-type-chip active" onclick="filterClaimLinks('')">All</span>
    </div>
    <div class="cdl-list" id="claimLinkList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading claim links...</div>
    </div>
  </div>

  <!-- CLAIM EVIDENCE VAULT (F48) -->
  <div class="cev-widget" id="evidenceWidget" style="display:none">
    <h3>&#x1F512; Evidence Vault <button class="btn btn-ghost btn-sm" onclick="fetchEvidenceStats()" style="margin-left:auto">&#x21BB; Refresh</button></h3>
    <div class="cev-stats-row">
      <div class="cev-stat"><div class="ev-num" id="evTotal">0</div><div class="ev-lbl">Items</div></div>
      <div class="cev-stat"><div class="ev-num" id="evVerified" style="color:#3fb950">0</div><div class="ev-lbl">Verified</div></div>
      <div class="cev-stat"><div class="ev-num" id="evPending" style="color:#ffd33d">0</div><div class="ev-lbl">Pending</div></div>
      <div class="cev-stat"><div class="ev-num" id="evClaims">0</div><div class="ev-lbl">Claims</div></div>
    </div>
    <div class="cev-verify-bar">
      <div class="cev-verify-label"><span>Verification Rate</span><span id="evRate">0%</span></div>
      <div class="cev-verify-track"><div class="cev-verify-fill" id="evRateFill" style="width:0%"></div></div>
    </div>
    <div class="cev-type-bar" id="evTypeBar">
      <span class="cev-type-chip active" onclick="filterEvidence('')">All</span>
    </div>
    <div class="cev-list" id="evidenceList">
      <div style="text-align:center;color:#484f58;font-size:12px;padding:20px">Loading evidence...</div>
    </div>
  </div>

  <!-- KNOWLEDGE BASE & SOPs -->
  <div class="kb-widget" id="kbWidget" style="display:none">
    <h3>&#x1F4DA; Knowledge Base</h3>
    <div class="kb-summary">
      <div class="kb-card"><div class="kb-val" id="kbPublished" style="color:#58a6ff">0</div><div class="kb-lbl">Articles</div></div>
      <div class="kb-card"><div class="kb-val" id="kbViews" style="color:#4ade80">0</div><div class="kb-lbl">Views</div></div>
      <div class="kb-card"><div class="kb-val" id="kbVotes" style="color:#ffd33d">0</div><div class="kb-lbl">Helpful</div></div>
      <div class="kb-card"><div class="kb-val" id="kbCategories" style="color:#d2a8ff">0</div><div class="kb-lbl">Topics</div></div>
    </div>
    <div class="kb-search-bar">
      <input type="text" id="kbSearchInput" placeholder="Search articles, SOPs, guides..." onkeydown="if(event.key==='Enter')searchKB()">
      <button onclick="searchKB()">&#x1F50D; Search</button>
    </div>
    <div class="kb-cat-bar" id="kbCatBar">
      <button class="kb-cat-btn active" onclick="filterKBCategory('')">All</button>
    </div>
    <div class="kb-list" id="kbList"><span style="color:#484f58;font-size:11px">No articles yet</span></div>
    <button class="btn btn-primary btn-sm" onclick="showCreateArticleModal()" style="background:#238636;color:#fff;border:none;font-weight:700;font-size:11px;padding:6px 14px;border-radius:6px;margin-top:10px">+ New Article</button>
  </div>

  <!-- KB Article Viewer (slide-in panel) -->
  <div class="kb-viewer" id="kbViewer">
    <button class="kb-viewer-close" onclick="closeKBViewer()">&times;</button>
    <div id="kbViewerContent"></div>
  </div>

  <!-- KB Create Modal (hidden) -->
  <div id="kbCreateModal" style="display:none"></div>

  <!-- CLAIM TEMPLATES -->
  <div class="tpl-widget" id="templateWidget" style="display:none">
    <h3>&#x1F4CB; Claim Templates</h3>
    <div class="tpl-summary">
      <div class="tpl-card"><div class="tpl-val" id="tplActive" style="color:#58a6ff">0</div><div class="tpl-lbl">Templates</div></div>
      <div class="tpl-card"><div class="tpl-val" id="tplUses" style="color:#4ade80">0</div><div class="tpl-lbl">Claims Filed</div></div>
      <div class="tpl-card"><div class="tpl-val" id="tplCategories" style="color:#d2a8ff">0</div><div class="tpl-lbl">Categories</div></div>
    </div>
    <div class="tpl-grid" id="tplGrid"><span style="color:#484f58;font-size:11px">No templates yet</span></div>
    <button class="btn btn-primary btn-sm" onclick="showCreateTemplateModal()" style="background:#238636;color:#fff;border:none;font-weight:700;font-size:11px;padding:6px 14px;border-radius:6px;margin-top:6px">+ New Template</button>
  </div>

  <!-- Template Quick-File Modal (hidden) -->
  <div id="tplQuickFileModal" style="display:none"></div>
  <!-- Template Create Modal (hidden) -->
  <div id="tplCreateModal" style="display:none"></div>

  <!-- REMINDERS & FOLLOW-UP SCHEDULER -->
  <div class="rem-widget" id="reminderWidget" style="display:none">
    <h3>&#x23F0; Reminders &amp; Follow-ups</h3>
    <div class="rem-summary">
      <div class="rem-card"><div class="rem-val" id="remPending" style="color:#ffd33d">0</div><div class="rem-lbl">Pending</div></div>
      <div class="rem-card"><div class="rem-val rem-overdue-badge" id="remOverdue" style="color:#f85149">0</div><div class="rem-lbl">Overdue</div></div>
      <div class="rem-card"><div class="rem-val" id="remCompleted" style="color:#4ade80">0</div><div class="rem-lbl">Completed</div></div>
      <div class="rem-card"><div class="rem-val" id="remRate" style="color:#d2a8ff">0%</div><div class="rem-lbl">Rate</div></div>
    </div>
    <div class="rem-list" id="remList"><span style="color:#484f58;font-size:11px">No reminders</span></div>
    <div class="rem-add-row">
      <input type="text" id="remNewTitle" placeholder="Reminder title...">
      <select id="remNewPriority">
        <option value="normal">Normal</option>
        <option value="urgent">Urgent</option>
        <option value="high">High</option>
        <option value="low">Low</option>
      </select>
      <button class="btn btn-primary btn-sm" onclick="createReminderFromWidget()" style="background:#ffd33d;color:#0a0e14;border:none;font-weight:700;font-size:10px;padding:5px 12px;border-radius:4px;white-space:nowrap">+ Add</button>
    </div>
    <div class="rem-quick-btns">
      <button class="rem-quick-btn" onclick="createQuickReminder(1)">&#x23F0; Tomorrow</button>
      <button class="rem-quick-btn" onclick="createQuickReminder(3)">&#x1F4C5; In 3 days</button>
      <button class="rem-quick-btn" onclick="createQuickReminder(7)">&#x1F5D3; In 1 week</button>
      <button class="rem-quick-btn" onclick="generateIdleReminders()" style="border-color:#f85149;color:#f85149">&#x1F6A8; Flag idle claims</button>
    </div>
  </div>

  <!-- SAVED SEARCHES & SMART FILTERS -->
  <div class="ss-widget" id="savedSearchWidget" style="display:none">
    <h3>&#x1F50D; Saved Searches</h3>
    <div class="ss-summary">
      <div class="ss-card"><div class="ss-val" id="ssTotal" style="color:#58a6ff">0</div><div class="ss-lbl">Searches</div></div>
      <div class="ss-card"><div class="ss-val" id="ssPinned" style="color:#ffd33d">0</div><div class="ss-lbl">Pinned</div></div>
      <div class="ss-card"><div class="ss-val" id="ssTotalRuns" style="color:#4ade80">0</div><div class="ss-lbl">Total Runs</div></div>
    </div>
    <div class="ss-pinned" id="ssPinnedBar"></div>
    <div class="ss-list" id="ssList"><span style="color:#484f58;font-size:11px">No saved searches yet</span></div>
    <div class="ss-add-form">
      <div class="ss-add-row">
        <input type="text" id="ssNewName" placeholder="Search name (e.g. High-Value Open Claims)">
        <button class="btn btn-primary btn-sm" onclick="showSavedSearchBuilder()" style="background:#1f6feb;color:#fff;border:none;font-weight:700;font-size:10px;padding:5px 12px;border-radius:4px;white-space:nowrap">+ New Search</button>
      </div>
      <div id="ssFilterBuilder" style="display:none">
        <div class="ss-filter-row">
          <select id="ssFilterStatus"><option value="">Any Status</option><option value="filed">Filed</option><option value="under_review">Under Review</option><option value="investigation">Investigation</option><option value="escalated">Escalated</option><option value="resolved">Resolved</option><option value="dismissed">Dismissed</option></select>
          <select id="ssFilterHarm"><option value="">Any Harm Type</option><option value="financial_fraud">Financial Fraud</option><option value="service_failure">Service Failure</option><option value="data_breach">Data Breach</option><option value="harassment">Harassment</option><option value="unauthorized_charge">Unauthorized Charge</option></select>
          <select id="ssFilterVertical"><option value="">Any Vertical</option><option value="platform_dispute">Platform Dispute</option><option value="ecommerce">E-Commerce</option><option value="fintech">Fintech</option><option value="social_media">Social Media</option></select>
        </div>
        <div class="ss-filter-row" style="margin-top:6px">
          <input type="text" id="ssFilterRespondent" placeholder="Respondent contains..." style="flex:1">
          <input type="number" id="ssFilterMinAmt" placeholder="Min $" style="width:80px">
          <input type="number" id="ssFilterMaxAmt" placeholder="Max $" style="width:80px">
        </div>
        <div class="ss-add-row" style="margin-top:8px">
          <input type="text" id="ssNewDesc" placeholder="Description (optional)" style="flex:1">
          <button class="btn btn-primary btn-sm" onclick="createSavedSearchFromForm()" style="background:#238636;color:#fff;border:none;font-weight:700;font-size:10px;padding:5px 12px;border-radius:4px">Save Search</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('ssFilterBuilder').style.display='none'" style="font-size:10px;padding:5px 8px;border:1px solid #30363d;border-radius:4px;color:#8b949e;background:transparent;cursor:pointer">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTIVITY TIMELINE -->
  <div class="tl-widget" id="activityWidget" style="display:none">
    <div class="tl-header">
      <h3>&#x23F1; Activity Stream</h3>
      <div class="tl-filters">
        <button class="tl-filter-btn active" onclick="filterActivityFeed('')">All</button>
        <button class="tl-filter-btn" onclick="filterActivityFeed('note')">Notes</button>
        <button class="tl-filter-btn" onclick="filterActivityFeed('audit')">Changes</button>
        <button class="tl-filter-btn" onclick="filterActivityFeed('recovery')">Recoveries</button>
        <button class="tl-filter-btn" onclick="filterActivityFeed('settlement')">Settlements</button>
      </div>
    </div>
    <div class="tl-feed" id="activityFeed"><div class="tl-empty">Loading activity...</div></div>
  </div>

  <!-- DATA QUALITY & DEDUPLICATION -->
  <div class="dq-widget" id="dataQualityWidget" style="display:none">
    <h3>&#x1F50D; Data Quality &amp; Deduplication</h3>
    <div class="dq-summary">
      <div class="dq-card"><div class="dq-val" id="dqScore" style="color:#4ade80">--</div><div class="dq-lbl">Quality Score</div></div>
      <div class="dq-card"><div class="dq-val" id="dqDups" style="color:#f0883e">0</div><div class="dq-lbl">Duplicates</div></div>
      <div class="dq-card"><div class="dq-val" id="dqCompleteness" style="color:#58a6ff">--</div><div class="dq-lbl">Completeness</div></div>
      <div class="dq-card"><div class="dq-val" id="dqMerges" style="color:#d2a8ff">0</div><div class="dq-lbl">Merges</div></div>
    </div>
    <div class="dq-field-coverage" id="dqFieldCoverage"></div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
      <button class="dq-scan-btn" id="dqScanBtn" onclick="runDuplicateScan()">Scan for Duplicates</button>
      <span id="dqScanStatus" style="font-size:10px;color:#585e68"></span>
    </div>
    <div class="dq-dup-list" id="dqDupList"></div>
  </div>

  <!-- TAGS & CUSTOM FIELDS -->
  <div class="tags-widget" id="tagsWidget" style="display:none">
    <h3>&#x1F3F7; Tags &amp; Labels</h3>
    <div class="tw-summary">
      <div class="tw-card"><div class="tw-val" id="twTotal">0</div><div class="tw-lbl">Tags</div></div>
      <div class="tw-card"><div class="tw-val" id="twTagged" style="color:#ffd33d">0</div><div class="tw-lbl">Tagged Claims</div></div>
      <div class="tw-card"><div class="tw-val" id="twCoverage" style="color:#4ade80">0%</div><div class="tw-lbl">Coverage</div></div>
      <div class="tw-card"><div class="tw-val" id="twCategories" style="color:#d2a8ff">0</div><div class="tw-lbl">Categories</div></div>
    </div>
    <div class="tw-tag-list" id="twTagList"><span style="color:#484f58;font-size:11px">No tags yet</span></div>
    <div class="tw-add-form">
      <input type="text" id="twNewTag" placeholder="New tag name..." onkeydown="if(event.key==='Enter')createTagFromWidget()">
      <button class="btn btn-primary btn-sm" onclick="createTagFromWidget()" style="background:#ffd33d;color:#0a0e14;font-weight:700">+ Add</button>
      <button class="btn btn-ghost btn-sm" onclick="fetchTagStats()">&#x1F504;</button>
    </div>
  </div>

  <!-- ANALYTICS & PERFORMANCE DASHBOARD -->
  <div class="analytics-widget" id="analyticsWidget" style="display:none">
    <h3>&#x1F4CA; Analytics &amp; Performance</h3>

    <!-- Health Score -->
    <div class="an-health">
      <div class="an-score-ring" id="anScoreRing">
        <span id="anScoreVal">--</span>
        <span class="an-grade" id="anGrade">--</span>
      </div>
      <div class="an-factors" id="anFactors"></div>
    </div>

    <!-- Financial KPIs -->
    <div class="an-kpi-grid">
      <div class="an-kpi"><div class="an-kv" id="anClaimed" style="color:#58a6ff">$0</div><div class="an-kl">Total Claimed</div></div>
      <div class="an-kpi"><div class="an-kv" id="anRecovered" style="color:#4ade80">$0</div><div class="an-kl">Recovered</div></div>
      <div class="an-kpi"><div class="an-kv" id="anRecRate" style="color:#f0883e">0%</div><div class="an-kl">Recovery Rate</div></div>
      <div class="an-kpi"><div class="an-kv" id="anProjected" style="color:#d2a8ff">$0</div><div class="an-kl">Projected</div></div>
    </div>

    <!-- Pipeline Funnel -->
    <div class="an-section-label">Pipeline Funnel</div>
    <div class="an-funnel" id="anFunnel"></div>

    <!-- Operator Leaderboard -->
    <div class="an-section-label">Operator Leaderboard</div>
    <div class="an-ops" id="anOps"><div style="color:#484f58;text-align:center;padding:8px;font-size:11px">Loading...</div></div>

    <!-- Respondent Scorecards -->
    <div class="an-section-label">Respondent Scorecards</div>
    <div class="an-resp-cards" id="anResps"><div style="color:#484f58;text-align:center;padding:8px;font-size:11px">Loading...</div></div>

    <div style="margin-top:10px;display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="fetchAnalytics()" style="flex:1">&#x1F504; Refresh</button>
    </div>
  </div>

  <!-- OUTREACH DASHBOARD -->
  <div class="outreach-dash" id="outreachDash" style="display:none">
    <h3>&#x1F4E8; Outreach &amp; Communications</h3>
    <div class="outreach-dash-grid">
      <div class="od-card"><div class="od-num" id="odTotal">0</div><div class="od-label">Total Sent</div></div>
      <div class="od-card"><div class="od-num" id="odDrafted" style="color:#c9956b">0</div><div class="od-label">Drafts</div></div>
      <div class="od-card"><div class="od-num" id="odResponded" style="color:#58a6ff">0</div><div class="od-label">Responses</div></div>
      <div class="od-card"><div class="od-num" id="odTemplates" style="color:#4ade80">0</div><div class="od-label">Templates</div></div>
    </div>
    <div style="font-size:11px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Recent Outreach</div>
    <div class="outreach-recent" id="outreachRecentList"><div style="color:#484f58;text-align:center;padding:12px;font-size:12px">No outreach activity yet</div></div>
  </div>

  <div class="recovery-dash" id="recoveryDash" style="display:none">
    <h3>&#x1F4B0; Recovery Performance</h3>
    <div class="recovery-dash-grid">
      <div class="recovery-dash-card"><div class="rdl">Total Recovered</div><div class="rdv green" id="rdTotalRecovered">$0</div></div>
      <div class="recovery-dash-card"><div class="rdl">Recovery Rate ($)</div><div class="rdv green" id="rdRecoveryRate">0%</div></div>
      <div class="recovery-dash-card"><div class="rdl">Claims Recovered</div><div class="rdv blue" id="rdClaimsRecovered">0 / 0</div></div>
      <div class="recovery-dash-card"><div class="rdl">Claim Recovery Rate</div><div class="rdv copper" id="rdClaimRate">0%</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div style="background:#161b22;border-radius:8px;padding:12px">
        <h4 style="font-size:11px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin:0 0 8px">Recovery Timeline (30d)</h4>
        <div id="recoveryTimeline" class="recovery-chart"></div>
      </div>
      <div style="background:#161b22;border-radius:8px;padding:12px">
        <h4 style="font-size:11px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin:0 0 8px">Recovery by Method</h4>
        <div id="recoveryByMethod"></div>
      </div>
    </div>
  </div>

  <!-- ANALYTICS CHARTS -->
  <div class="section-hdr"><span class="section-icon">&#x1F4C8;</span><h3>Performance Analytics</h3></div>
  <div id="analyticsContainer" style="margin-bottom:20px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Claims Timeline Chart -->
      <div style="background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px">
        <h4 style="font-size:13px;color:#8b949e;margin-bottom:12px">Claims Filed (Last 30 Days)</h4>
        <div id="chartFiled" style="height:120px;display:flex;align-items:flex-end;gap:2px"></div>
      </div>
      <!-- Status Breakdown Chart -->
      <div style="background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px">
        <h4 style="font-size:13px;color:#8b949e;margin-bottom:12px">Status Breakdown</h4>
        <div id="chartStatus" style="min-height:120px"></div>
      </div>
      <!-- Top Respondents by Amount -->
      <div style="background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px">
        <h4 style="font-size:13px;color:#8b949e;margin-bottom:12px">Top Respondents by Amount</h4>
        <div id="chartRespondents" style="min-height:120px"></div>
      </div>
      <!-- Value Band Distribution -->
      <div style="background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px">
        <h4 style="font-size:13px;color:#8b949e;margin-bottom:12px">Value Band Distribution</h4>
        <div id="chartValueBands" style="min-height:120px"></div>
      </div>
    </div>
  </div>

  <div class="section-hdr"><span class="section-icon">&#x2699;</span><h3>System Architecture</h3></div>
  <div class="arch-flow">
    <div class="arch-box"><div class="arch-name">LITMUS</div><div class="arch-role">Signal Detection</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box"><div class="arch-name">LICO</div><div class="arch-role">Coordination</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box active-layer"><div class="arch-name">GhostLedger</div><div class="arch-role">Recovery</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box"><div class="arch-name">CCE</div><div class="arch-role">Classification</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box"><div class="arch-name">ILF</div><div class="arch-role">Professional Referral</div></div>
  </div>

  <div class="section-hdr"><span class="section-icon">&#x1F6E1;</span><h3>Design Doctrine</h3></div>
  <div class="rules-grid">
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Detect &#x2260; Accuse &mdash; LITMUS sees patterns, never names perpetrators</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Coordinate &#x2260; Enforce &mdash; LICO routes, never punishes</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Route &#x2260; Represent &mdash; ILF matches professionals, never practices law</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>No recovery, no fee &mdash; we only win when you win</div>
  </div>
</div>

<!-- ========== CASES ========== -->
<div id="cases" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center">
      <h3 style="font-size:16px">Claims</h3>
      <div class="view-toggle" id="viewToggle">
        <button class="active" onclick="switchView('table',this)" title="Table View">&#x2630; Table</button>
        <button onclick="switchView('pipeline',this)" title="Pipeline Board">&#x25A6; Pipeline</button>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="fetchClaims()">&#x21BB; Refresh</button>
      <div class="filter-toggle" id="filterToggleBtn" onclick="toggleFilterPanel()">&#x1F50D; Filters<span class="ft-count" id="filterCount" style="display:none">0</span></div>
      <span class="filter-count-badge" id="filterResultCount"></span>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-ghost btn-sm" onclick="reclassifyAll()">&#x1F504; Reclassify All</button>
      <span style="border-left:1px solid #21262d;height:20px;margin:0 2px"></span>
      <button class="btn btn-ghost btn-sm" onclick="exportClaims('csv')" title="Server-side export with checksum">&#x1F4E5; CSV</button>
      <button class="btn btn-ghost btn-sm" onclick="exportClaims('json')" title="Server-side export with checksum">&#x1F4E5; JSON</button>
    </div>
  </div>

  <!-- SAVED VIEWS SHELF -->
  <div class="saved-views-shelf" id="savedViewsShelf"></div>

  <!-- ADVANCED FILTER PANEL -->
  <div class="filter-panel" id="filterPanel">
    <div class="filter-row">
      <div class="filter-group">
        <label>Status</label>
        <select id="fStatus" onchange="applyFilters()">
          <option value="">All</option>
          <option value="filed">Filed</option>
          <option value="under_review">Under Review</option>
          <option value="escalated">Escalated</option>
          <option value="in_resolution">In Resolution</option>
          <option value="resolved">Resolved</option>
          <option value="closed">Closed</option>
          <option value="appealed">Appealed</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Respondent</label>
        <select id="fRespondent" onchange="applyFilters()">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Value Band</label>
        <select id="fValueBand" onchange="applyFilters()">
          <option value="">All</option>
          <option value="micro">Micro (&lt;$500)</option>
          <option value="small">Small ($500-5K)</option>
          <option value="medium">Medium ($5K-50K)</option>
          <option value="large">Large ($50K-250K)</option>
          <option value="strategic">Strategic ($250K+)</option>
        </select>
      </div>
      <div class="filter-group">
        <label>SLA Status</label>
        <select id="fSla" onchange="applyFilters()">
          <option value="">All</option>
          <option value="on_track">On Track</option>
          <option value="at_risk">At Risk</option>
          <option value="breached">Breached</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Recovery</label>
        <select id="fRecovery" onchange="applyFilters()">
          <option value="">All</option>
          <option value="has_recovery">Has Recovery</option>
          <option value="no_recovery">No Recovery</option>
          <option value="full">Fully Recovered (100%)</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Assigned To</label>
        <select id="fAssignee" onchange="applyFilters()">
          <option value="">All</option>
          <option value="__unassigned__">Unassigned</option>
        </select>
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-group">
        <label>Amount Min ($)</label>
        <input type="number" id="fAmtMin" placeholder="0" min="0" step="1" onchange="applyFilters()">
      </div>
      <div class="filter-group">
        <label>Amount Max ($)</label>
        <input type="number" id="fAmtMax" placeholder="Any" min="0" step="1" onchange="applyFilters()">
      </div>
      <div class="filter-group">
        <label>Filed After</label>
        <input type="date" id="fDateFrom" onchange="applyFilters()">
      </div>
      <div class="filter-group">
        <label>Filed Before</label>
        <input type="date" id="fDateTo" onchange="applyFilters()">
      </div>
      <div class="filter-actions">
        <button class="btn btn-ghost btn-sm" onclick="clearFilters()">&#x2717; Clear</button>
        <button class="btn btn-primary btn-sm" onclick="saveCurrentView()" style="font-size:11px">&#x1F4BE; Save View</button>
      </div>
    </div>
  </div>
  <div id="reclassifyStatus" style="display:none;padding:8px 12px;margin-bottom:8px;border-radius:8px;font-size:13px"></div>

  <!-- BULK ACTION BAR -->
  <div class="bulk-bar" id="bulkBar">
    <span class="bulk-count" id="bulkCount">0 selected</span>
    <span class="bulk-sep"></span>
    <button class="btn btn-ghost btn-sm" onclick="bulkStatusChange()">&#x1F504; Batch Status</button>
    <button class="btn btn-ghost btn-sm" onclick="showBulkModal('assign')">&#x1F464; Assign</button>
    <button class="btn btn-ghost btn-sm" onclick="showBulkModal('tag')">&#x1F3F7; Tag</button>
    <button class="btn btn-ghost btn-sm" onclick="showBulkModal('escalate')" style="color:#f0883e">&#x26A0; Escalate</button>
    <button class="btn btn-ghost btn-sm" onclick="bulkExportSelected()">&#x1F4E5; Export CSV</button>
    <span style="flex:1"></span>
    <button class="btn btn-ghost btn-sm" onclick="clearBulkSelection()" style="color:#f85149">&#x2717; Clear</button>
  </div>

  <!-- TABLE VIEW -->
  <div id="tableView">
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th style="width:32px"><input type="checkbox" class="bulk-check" id="bulkSelectAll" onchange="toggleSelectAll(this.checked)"></th>
          <th class="sort-header" onclick="toggleSort('claim_id')">ID<span class="sort-arrow" id="sort_claim_id"></span></th>
          <th>Claimant</th>
          <th class="sort-header" onclick="toggleSort('respondent_entity')">Respondent<span class="sort-arrow" id="sort_respondent_entity"></span></th>
          <th>Dispute Type</th>
          <th class="sort-header" onclick="toggleSort('amount_claimed_usd')" style="width:90px">Amount<span class="sort-arrow" id="sort_amount_claimed_usd"></span></th>
          <th class="sort-header" onclick="toggleSort('status')">Status<span class="sort-arrow" id="sort_status"></span></th>
          <th class="sort-header" onclick="toggleSort('filed_at')">Age<span class="sort-arrow" id="sort_filed_at"></span></th>
          <th>Band</th>
          <th>Recovery Path</th>
          <th>C</th>
          <th>Action</th>
          <th>Set Status</th>
        </tr></thead>
        <tbody id="casesTbody">
          <tr><td colspan="12" class="empty-row"><div class="empty-icon">&#x1F4CB;</div><span class="api-dot online" style="display:inline-block;margin-right:6px"></span>Loading claims from API...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- PIPELINE VIEW -->
  <div id="pipelineView" style="display:none">
    <div class="pipeline-board" id="pipelineBoard">
      <div class="pipeline-col filed">
        <div class="pipeline-col-header"><h4>Filed</h4><span class="col-count" id="pcFiled">0</span></div>
        <div class="pipeline-cards" id="pipelineFiled"></div>
      </div>
      <div class="pipeline-col under_review">
        <div class="pipeline-col-header"><h4>Under Review</h4><span class="col-count" id="pcUnderReview">0</span></div>
        <div class="pipeline-cards" id="pipelineUnderReview"></div>
      </div>
      <div class="pipeline-col escalated">
        <div class="pipeline-col-header"><h4>Escalated</h4><span class="col-count" id="pcEscalated">0</span></div>
        <div class="pipeline-cards" id="pipelineEscalated"></div>
      </div>
      <div class="pipeline-col in_resolution">
        <div class="pipeline-col-header"><h4>In Resolution</h4><span class="col-count" id="pcInResolution">0</span></div>
        <div class="pipeline-cards" id="pipelineInResolution"></div>
      </div>
      <div class="pipeline-col resolved">
        <div class="pipeline-col-header"><h4>Resolved</h4><span class="col-count" id="pcResolved">0</span></div>
        <div class="pipeline-cards" id="pipelineResolved"></div>
      </div>
      <div class="pipeline-col closed">
        <div class="pipeline-col-header"><h4>Closed</h4><span class="col-count" id="pcClosed">0</span></div>
        <div class="pipeline-cards" id="pipelineClosed"></div>
      </div>
    </div>
    <div style="margin-top:8px;font-size:10px;color:#484f58;text-align:right">
      Age indicators: <span style="color:#4ade80">&#x25CF;</span> &lt;3d &nbsp;
      <span style="color:#58a6ff">&#x25CF;</span> 3-7d &nbsp;
      <span style="color:#fbbf24">&#x25CF;</span> 7-21d &nbsp;
      <span style="color:#f85149">&#x25CF;</span> &gt;21d
    </div>
  </div>
</div>

<!-- ========== SUBMIT CLAIM ========== -->
<div id="submit" class="panel">
  <div class="section-hdr"><span class="section-icon">&#x2795;</span><h3>Submit New Claim</h3></div>
  <p style="color:#8b949e;font-size:13px;margin-bottom:16px">Submit your claim securely to GhostLedger for review. All fields marked * are required.</p>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
    <div><label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">Full Name *</label><input id="fName" placeholder="Full name"></div>
    <div>
      <label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">Email *</label>
      <input id="fEmail" placeholder="Email address" type="email">
      <div style="font-size:10px;color:#484f58;margin-top:3px">We never ask for passwords or bank login details.</div>
    </div>
    <div><label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">Phone</label><input id="fPhone" placeholder="Optional"></div>
    <div><label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">Platform / Company *</label><input id="fPlatform" placeholder="e.g. Stripe, PayPal, Uber"></div>
    <div><label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">Amount Owed (USD) *</label><input id="fAmount" type="number" placeholder="0.00"></div>
    <div><label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">Last Expected Payment</label><input id="fDate" type="date"></div>
  </div>
  <div style="margin-bottom:12px">
    <label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">What reason did the platform give? (If any)</label>
    <textarea id="fReason" rows="3" placeholder="Briefly describe what happened (1-3 sentences). Leave blank if no explanation was given."></textarea>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
    <div><label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">Contacted Support?</label>
      <select id="fSupport"><option value="No, not yet">No &mdash; not yet</option><option value="Yes, no response">Yes &mdash; no response</option><option value="Yes, but no resolution">Yes &mdash; response but unresolved</option><option value="Yes, still waiting">Yes &mdash; still waiting</option></select>
    </div>
    <div><label style="font-size:11px;color:#585e68;margin-bottom:4px;display:block">How did you hear about us?</label>
      <select id="fSource"><option value="Reddit">Reddit</option><option value="Twitter / X">Twitter / X</option><option value="Discord">Discord</option><option value="TikTok">TikTok</option><option value="Word of mouth">Word of mouth</option><option value="Other">Other</option></select>
    </div>
  </div>
  <div style="margin-bottom:16px;display:flex;align-items:flex-start;gap:8px">
    <input type="checkbox" id="fAuth" style="width:auto;margin-top:3px">
    <label for="fAuth" style="font-size:12px;color:#c9d1d9;line-height:1.5">I authorize GhostLedger to coordinate recovery efforts and share my information with independent professionals for review. I understand GhostLedger does not provide legal advice or legal representation, and I owe no fee unless funds are successfully recovered.</label>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-primary" onclick="submitClaim()">Submit Claim</button>
    <span id="submitStatus" style="font-size:13px;color:#8b949e;line-height:38px"></span>
  </div>

  <!-- BATCH IMPORT -->
  <div class="import-section">
    <h4>&#x1F4E5; Batch Import</h4>
    <p style="font-size:12px;color:#6e7681;margin:0 0 12px">Import multiple claims from a CSV file. Expected columns: <code style="color:#c9956b">full_name, email, platform, amount, reason</code> (optional: <code style="color:#8b949e">contacted_support, referral_source</code>)</p>

    <div class="import-dropzone" id="importDropzone" onclick="document.getElementById('importFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleImportDrop(event)">
      <div class="dz-icon">&#x1F4C4;</div>
      <div class="dz-text">Drop a CSV file here, or click to browse</div>
      <div class="dz-sub">Max 100 claims per batch &bull; Duplicates auto-detected</div>
    </div>
    <input type="file" id="importFileInput" accept=".csv,.json" style="display:none" onchange="handleImportFile(this.files[0])">

    <div id="importPreview" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <span style="font-size:12px;color:#8b949e" id="importPreviewCount">0 claims ready</span>
        <div style="display:flex;gap:6px">
          <label style="font-size:11px;color:#8b949e;display:flex;align-items:center;gap:4px"><input type="checkbox" id="importSkipDupes" checked style="width:auto;accent-color:#8B5E3C"> Skip duplicates</label>
          <button class="btn btn-ghost btn-sm" onclick="clearImport()">&#x2717; Clear</button>
          <button class="btn btn-primary btn-sm" onclick="executeImport()" style="background:#22c55e;color:#0a0e14;font-weight:700">&#x1F680; Import All</button>
        </div>
      </div>
      <div class="import-preview" id="importPreviewTable"></div>
    </div>

    <div id="importResults" style="display:none">
      <div class="import-summary" id="importSummary"></div>
      <div class="import-results" id="importResultsList"></div>
    </div>
  </div>
</div>

<!-- ========== FOLLOW-UPS ========== -->
<div id="followups" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center">
      <h3 style="font-size:16px">Follow-Ups</h3>
      <button class="btn btn-ghost btn-sm" onclick="fetchFollowups()">&#x21BB; Refresh</button>
    </div>
    <div class="toolbar-right">
      <div id="fuSummary" style="font-size:12px;color:#484f58"></div>
    </div>
  </div>
  <div id="fuContainer"></div>

  <div class="section-hdr" style="margin-top:28px"><span class="section-icon">&#x1F4CB;</span><h3>Escalation Timeline Reference</h3></div>
  <div class="table-wrap timeline-table">
    <table>
      <thead><tr><th>Day</th><th>Action</th><th>Template</th><th>Key Notes</th></tr></thead>
      <tbody>
        <tr><td><span class="status s-filed">Day 1-3</span></td><td>Initial Contact</td><td>Template 1</td><td>Professional, factual, zero emotion</td></tr>
        <tr><td><span class="status s-under_review">Day 5-10</span></td><td>Follow-Up Request</td><td>Template 2</td><td>Reference prior inquiry, request routing to senior support, ask for ticket number</td></tr>
        <tr><td><span class="status s-escalated">Day 10-21</span></td><td>Compliance Reference</td><td>Template 3</td><td>Reference applicable consumer protection frameworks (e.g. CFPB, FTC) without implying threats or filings</td></tr>
        <tr><td><span class="status s-in_resolution">Day 21+</span></td><td>ILF Routing</td><td>CCE Classification</td><td>Case routed to legal professionals via ILF network</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section-hdr" style="margin-top:28px"><span class="section-icon">&#x1F6E1;</span><h3>Rules of Engagement</h3></div>
  <div class="rules-grid">
    <div class="rule-item"><div class="rule-icon rule-dont">&#x2717;</div>Never threaten &mdash; cite policy and regulation calmly</div>
    <div class="rule-item"><div class="rule-icon rule-dont">&#x2717;</div>Never impersonate a lawyer or government official</div>
    <div class="rule-item"><div class="rule-icon rule-dont">&#x2717;</div>Never guarantee outcomes &mdash; use "if viable" language</div>
    <div class="rule-item"><div class="rule-icon rule-dont">&#x2717;</div>Never share client info without authorization</div>
    <div class="rule-item"><div class="rule-icon rule-dont">&#x2717;</div>Never say "we recover your money" or "we enforce accountability"</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Say "we coordinate recovery efforts"</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Say "independent professionals may engage"</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Document every interaction with dates and ticket IDs</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Follow up at reasonable intervals (typically 3&ndash;5 business days), adjusted for jurisdiction and response</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>If a case is not viable, close it honestly and quickly</div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Letters may reference rights and processes, never threats or filings</div>
  </div>
</div>

<!-- ========== SIGNAL SCOUTS ========== -->
<div id="signals" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <h3 style="font-size:16px">Signal Scouts</h3>
      <span style="font-size:11px;color:#484f58">Pattern Detection &amp; Signal Intelligence</span>
      <span style="font-size:9px;letter-spacing:.5px;color:#6e7681;border:1px solid #21262d;border-radius:4px;padding:2px 6px;text-transform:uppercase">Internal &bull; Non-Accusatory &bull; Non-Public</span>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-ghost btn-sm" onclick="fetchSignals()">&#x21BB; Scan Now</button>
      <span id="sigScanTime" style="font-size:11px;color:#484f58;line-height:34px"></span>
    </div>
  </div>

  <div id="sigSummary" class="signals-summary">
    <div class="sig-stat"><div class="sig-num total" id="sigTotal">â€”</div><div class="sig-lbl">Total Signals</div></div>
    <div class="sig-stat"><div class="sig-num critical" id="sigCritical">â€”</div><div class="sig-lbl">Critical</div></div>
    <div class="sig-stat"><div class="sig-num alert" id="sigAlerts">â€”</div><div class="sig-lbl">Alerts</div></div>
    <div class="sig-stat"><div class="sig-num warning" id="sigWarnings">â€”</div><div class="sig-lbl">Warnings</div></div>
    <div class="sig-stat"><div class="sig-num info" id="sigSystemic">â€”</div><div class="sig-lbl">Systemic Claims</div></div>
    <div class="sig-stat" title="Signals from claims older than 90 days. Severity auto-downgraded."><div class="sig-num info" id="sigStale" style="color:#484f58">â€”</div><div class="sig-lbl">Stale (Decayed)</div></div>
  </div>

  <div style="background:rgba(33,38,45,.4);border:1px solid #21262d;border-radius:8px;padding:10px 14px;margin:12px 0;font-size:12px;color:#8b949e;line-height:1.5">
    Signals reflect statistical patterns across submitted claims. They do not indicate wrongdoing, liability, or enforcement action. Signals may inform human review and case routing. Signals do not trigger actions automatically. Signals older than 90 days are automatically downgraded.
  </div>

  <div class="section-hdr"><span class="section-icon">&#x1F4CA;</span><h3>Top Signal Sources</h3><span style="font-size:11px;color:#6e7681;margin-left:8px">(weighted by recency)</span></div>
  <div id="sigThreats" class="threat-list"><div style="color:#484f58;text-align:center;padding:20px;grid-column:1/-1">Run a scan to detect signal sources</div></div>

  <div style="display:flex;align-items:center;justify-content:space-between">
    <div class="section-hdr"><span class="section-icon">&#x1F4E1;</span><h3>Detected Signals</h3></div>
    <label style="font-size:12px;color:#6e7681;cursor:pointer;display:flex;align-items:center;gap:6px"><input type="checkbox" id="showStaleToggle" checked onchange="toggleStaleSignals()" style="accent-color:#58a6ff"> Show stale signals</label>
  </div>
  <div id="sigContainer"><div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x1F50D;</div>Click "Scan Now" to run Signal Scouts analysis across all claims</div></div>
</div>

<!-- ========== TEMPLATES ========== -->
<div id="templates" class="panel">
  <div class="section-hdr"><span class="section-icon">&#x2709;</span><h3>Email Escalation Templates</h3></div>
  <div class="templates-grid">
    <div class="tpl-card">
      <div class="tpl-header" onclick="toggleTpl(this)"><h4>Template 1 &mdash; Initial Payment Inquiry</h4><span class="day-tag day-early">Day 1-3</span></div>
      <div class="tpl-body open">
<pre>Subject: Account Payment Status Inquiry â€” [CASE_REF]

Hello,

I am following up regarding an unpaid or withheld balance of $[AMOUNT] associated with account [ACCOUNT_ID] on the [PLATFORM_NAME] platform.

Relevant documentation has been provided for reference. At your convenience, please confirm:

1. The current status of the payment
2. Any reason provided for delay or rejection (if applicable)
3. An estimated timeline for next steps

Thank you for your time and attention.

Best regards,
[YOUR_NAME]
GhostLedger â€” Recovery Coordination (Non-Legal)</pre>
        <div class="tpl-actions"><button class="btn btn-ghost btn-sm" onclick="copyText(this)">Copy to clipboard</button></div>
      </div>
    </div>

    <div class="tpl-card">
      <div class="tpl-header" onclick="toggleTpl(this)"><h4>Template 2 &mdash; Follow-Up Request</h4><span class="day-tag day-mid">Day 5-10</span></div>
      <div class="tpl-body">
<pre>Subject: Follow-Up â€” Payment Status Inquiry â€” Ref: [TICKET_ID]

Hello,

I am following up on a previous inquiry (reference: [TICKET_ID]) regarding an unpaid balance of $[AMOUNT].

This inquiry was first submitted [X] days ago, and we have not yet received a substantive update. We understand that reviews can take time and appreciate your team's attention.

To help move this forward, we respectfully ask:

- Could this inquiry be routed to a senior support or payments team member?
- Is there a ticket or reference number we can use for future follow-ups?
- Is any additional documentation needed from the claimant?

We remain committed to resolving this through your standard support channels.

Best regards,
[YOUR_NAME]
GhostLedger â€” Recovery Coordination (Non-Legal)</pre>
        <div class="tpl-actions"><button class="btn btn-ghost btn-sm" onclick="copyText(this)">Copy to clipboard</button></div>
      </div>
    </div>

    <div class="tpl-card">
      <div class="tpl-header" onclick="toggleTpl(this)"><h4>Template 3 &mdash; Compliance Reference</h4><span class="day-tag day-late">Day 10-21</span></div>
      <div class="tpl-body">
<pre>Subject: Payment Status Follow-Up â€” Compliance Reference â€” Ref: [TICKET_ID]

Hello,

I am writing as a continued follow-up regarding a payment inquiry involving $[AMOUNT], first submitted on [DATE].

This inquiry has been open for [X] days. We have previously communicated through your standard support channels and have not yet received a substantive resolution or update.

For your reference, the following consumer protection frameworks may be applicable to disputes of this nature. We share these solely for informational purposes:

- Consumer Financial Protection Bureau (CFPB) â€” consumer complaint processes
- Federal Trade Commission (FTC) â€” unfair or deceptive practices guidance
- State consumer protection statutes and agencies
- Platform-published terms of service and payment policies

We are seeking clarity on how this situation aligns with your published policies and the processes referenced above. We are not filing or threatening any action â€” our goal remains to resolve this through direct communication.

Best regards,
[YOUR_NAME]
GhostLedger â€” Recovery Coordination (Non-Legal)</pre>
        <div class="tpl-actions"><button class="btn btn-ghost btn-sm" onclick="copyText(this)">Copy to clipboard</button></div>
      </div>
    </div>

    <div class="tpl-card">
      <div class="tpl-header" onclick="toggleTpl(this)"><h4>Outreach &mdash; Reddit / Discord</h4><span class="day-tag day-outreach">Acquisition</span></div>
      <div class="tpl-body">
<pre>Dealing with a payment delay or withheld balance on a platform? GhostLedger helps coordinate follow-ups and documentation so you don't have to navigate support alone. No fee unless your issue is resolved.

More info or intake form: [FORM_LINK]</pre>
        <div class="tpl-actions"><button class="btn btn-ghost btn-sm" onclick="copyText(this)">Copy to clipboard</button></div>
      </div>
    </div>

    <div class="tpl-card">
      <div class="tpl-header" onclick="toggleTpl(this)"><h4>Outreach &mdash; Direct Message</h4><span class="day-tag day-outreach">Acquisition</span></div>
      <div class="tpl-body">
<pre>Hey â€” I saw your post about a payment issue on [PLATFORM]. GhostLedger helps people coordinate follow-ups and documentation for situations like that.

No upfront cost â€” happy to take a look if you're interested.</pre>
        <div class="tpl-actions"><button class="btn btn-ghost btn-sm" onclick="copyText(this)">Copy to clipboard</button></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== OUTREACH ========== -->
<div id="outreach" class="panel">
  <div class="section-hdr"><span class="section-icon">&#x1F4E2;</span><h3>Outreach &amp; Public Channels</h3></div>
  <div style="background:#12171e;border:1px solid #1c2129;border-radius:10px;padding:16px;margin-bottom:20px;font-size:14px;line-height:2">
    <strong style="color:#e6edf3">Name:</strong> <span style="color:#c9d1d9">GhostLedger</span><br>
    <strong style="color:#e6edf3">Bio:</strong> <span style="color:#c9d1d9">Coordinating recovery of unpaid &amp; withheld funds. No recovery, no fee. Information only â€” not legal advice.</span><br>
    <strong style="color:#e6edf3">Location:</strong> <span style="color:#c9d1d9">Global</span><br>
    <strong style="color:#e6edf3">Link:</strong> <span style="color:#c9d1d9">Google Form intake link</span>
  </div>
  <div style="background:rgba(248,81,73,.06);border:1px solid rgba(248,81,73,.2);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#f0883e;line-height:1.5">
    <strong style="color:#f85149">&#x1F6E1; Outreach Policy:</strong> Public posts must remain informational and non-accusatory. GhostLedger does not encourage threats, coercion, or misuse of regulatory language. Content must never attribute intent, suggest adversarial framing, or name regulators as leverage.
  </div>
  <div class="section-hdr"><span class="section-icon">&#x1F4DD;</span><h3>Ready-to-Post (10 Tweets)</h3></div>
  <div id="tweetsContainer"></div>
</div>

<!-- ========== ARCHITECTURE ========== -->
<div id="architecture" class="panel">
  <div class="section-hdr"><span class="section-icon">&#x1F3D7;</span><h3>System Architecture</h3></div>

  <div class="arch-flow" style="margin-bottom:28px">
    <div class="arch-box"><div class="arch-name">LITMUS</div><div class="arch-role">Signal Detection</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box"><div class="arch-name">LICO</div><div class="arch-role">Coordination</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box active-layer"><div class="arch-name">GhostLedger</div><div class="arch-role">Claim Recovery</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box"><div class="arch-name">CCE</div><div class="arch-role">Case Classification</div></div>
    <span class="arch-arrow">&#x2192;</span>
    <div class="arch-box"><div class="arch-name">ILF Network</div><div class="arch-role">Professional Referral</div></div>
  </div>

  <div class="doctrine-card">
    <h4>LITMUS â€” Signal Layer</h4>
    <p>Passive intelligence that detects patterns, not guilt. Watches for complaint spikes, repeated fund freezes, coordinated nonpayment. Only says: "Something abnormal is happening here."</p>
  </div>
  <div class="doctrine-card">
    <h4>LICO â€” Coordination Layer</h4>
    <p>Legal Internet Traffic Control. Receives LITMUS signals, performs human validation, decides if an issue is isolated, systemic, or escalation-worthy. Never enforces, never accuses publicly.</p>
  </div>
  <div class="doctrine-card">
    <h4>GhostLedger â€” Recovery Layer (You Are Here)</h4>
    <p>Claimant-facing payment recovery coordination. Accepts user-initiated claims, handles proof-of-non-payment, seals evidence immutably, and supports escalation through platform dispute processes, arbitration, or referral to independent legal professionals, where appropriate. Contingency-based: no recovery, no fee.</p>
  </div>
  <div class="doctrine-card">
    <h4>CCE â€” Case Classification Engine</h4>
    <p>Five-dimensional routing: dispute type, jurisdiction, value band, complexity score, recovery path. Air traffic control, not autopilot. Never shown to users.</p>
  </div>
  <div class="doctrine-card">
    <h4>ILF â€” Independent Legal Fellowship</h4>
    <p>Routes classified cases to legal professionals. Lawyers opt in, never assigned. ILF exits the legal loop once engagement starts. Success-fee coordination only.</p>
  </div>

  <div class="section-hdr" style="margin-top:28px"><span class="section-icon">&#x1F512;</span><h3>Anti-Fragility Checklist</h3></div>
  <div class="rules-grid">
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Can treasury be liquidated? <strong style="color:#4ade80;margin-left:auto">NO</strong></div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Can founders rug governance? <strong style="color:#4ade80;margin-left:auto">NO</strong></div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Can politics affect operations? <strong style="color:#4ade80;margin-left:auto">NO</strong></div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Is token required to use product? <strong style="color:#4ade80;margin-left:auto">NO</strong></div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Would regulators find this boring? <strong style="color:#4ade80;margin-left:auto">YES</strong></div>
    <div class="rule-item"><div class="rule-icon rule-do">&#x2713;</div>Survives founder disappearance? <strong style="color:#4ade80;margin-left:auto">YES</strong></div>
  </div>
</div>

<!-- ========== ILF NETWORK ========== -->
<div id="ilf" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center">
      <h3 style="font-size:16px">ILF &mdash; Independent Legal Fellowship</h3>
      <span style="font-size:9px;letter-spacing:.5px;color:#6e7681;border:1px solid #21262d;border-radius:4px;padding:2px 6px;text-transform:uppercase">Referral Coordination &bull; Non-Representational</span>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-ghost btn-sm" onclick="fetchILFData()">&#x21BB; Refresh</button>
      <button class="btn btn-sm" style="background:#38bdf8;color:#0a0e14" onclick="document.getElementById('ilfRegisterModal').style.display='flex'">+ Register Legal Professional</button>
    </div>
  </div>
  <div style="background:rgba(33,38,45,.4);border:1px solid #21262d;border-radius:8px;padding:10px 14px;margin:12px 0;font-size:12px;color:#8b949e;line-height:1.5">
    The ILF connects claimants with independent legal professionals who may choose to assist independently, including on a voluntary or fee basis.
    GhostLedger does not provide legal advice, representation, or attorney-client relationships.
    Referrals are informational introductions only. Each attorney exercises independent professional judgment.
  </div>

  <!-- ILF Stats -->
  <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin:16px 0">
    <div class="stat-card blue"><div class="stat-value" id="ilfLawyersActive">0</div><div class="stat-label">Active Professionals</div></div>
    <div class="stat-card" style="border-color:#fbbf24"><div class="stat-value" id="ilfRefPending" style="color:#fbbf24">0</div><div class="stat-label">Pending Referrals</div></div>
    <div class="stat-card green"><div class="stat-value" id="ilfRefAccepted">0</div><div class="stat-label">Accepted</div></div>
    <div class="stat-card" style="border-color:#a78bfa"><div class="stat-value" id="ilfRefCompleted" style="color:#a78bfa">0</div><div class="stat-label">Completed</div></div>
  </div>

  <!-- Lawyers Table -->
  <div style="margin-top:20px">
    <h4 style="font-size:14px;color:#c9d1d9;margin-bottom:8px">&#x2696;&#xFE0F; Registered Legal Professionals</h4>
    <div id="ilfLawyersContainer" style="margin-top:8px"><div style="color:#484f58;text-align:center;padding:30px">Click Refresh to load ILF data</div></div>
  </div>

  <!-- Referrals Table -->
  <div style="margin-top:24px">
    <h4 style="font-size:14px;color:#c9d1d9;margin-bottom:8px">&#x1F4CB; Case Referrals</h4>
    <div class="toolbar-right" style="margin-bottom:8px">
      <select id="ilfRefFilter" onchange="fetchILFData()" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:4px 8px;border-radius:6px;font-size:12px">
        <option value="">All Referrals</option>
        <option value="pending">Pending</option>
        <option value="accepted">Accepted</option>
        <option value="declined">Declined</option>
        <option value="completed">Completed</option>
      </select>
    </div>
    <div id="ilfReferralsContainer" style="margin-top:8px"><div style="color:#484f58;text-align:center;padding:30px">No referrals yet</div></div>
  </div>
</div>

<!-- ILF Register Lawyer Modal -->
<div id="ilfRegisterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:999;align-items:center;justify-content:center">
  <div style="background:#161b22;border:1px solid #30363d;border-radius:12px;padding:24px;width:440px;max-width:90vw">
    <h3 style="font-size:16px;margin-bottom:16px;color:#c9d1d9">Register Legal Professional</h3>
    <div style="display:flex;flex-direction:column;gap:10px">
      <input id="ilfRegName" placeholder="Full Name" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
      <input id="ilfRegEmail" placeholder="Email" type="email" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
      <input id="ilfRegBar" placeholder="Bar Number (optional)" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
      <input id="ilfRegJurisdiction" placeholder="Jurisdiction (e.g. US-CA, US-NY)" value="US-General" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
      <input id="ilfRegSpecs" placeholder="Specializations (comma-separated)" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
      <input id="ilfRegCaseload" placeholder="Max Caseload" type="number" value="10" min="1" max="50" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
    </div>
    <div id="ilfRegStatus" style="font-size:12px;margin-top:8px;min-height:18px"></div>
    <div style="display:flex;gap:8px;margin-top:16px;justify-content:flex-end">
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('ilfRegisterModal').style.display='none'">Cancel</button>
      <button class="btn btn-sm" style="background:#38bdf8;color:#0a0e14" onclick="registerILFLawyer()">Register</button>
    </div>
  </div>
</div>

<!-- ILF Refer Case Modal -->
<div id="ilfReferModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:999;align-items:center;justify-content:center">
  <div style="background:#161b22;border:1px solid #30363d;border-radius:12px;padding:24px;width:440px;max-width:90vw">
    <h3 style="font-size:16px;margin-bottom:16px;color:#c9d1d9">Refer Case to Professional</h3>
    <div style="display:flex;flex-direction:column;gap:10px">
      <input id="ilfReferClaim" placeholder="Claim ID (e.g. clm_abc123)" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
      <select id="ilfReferLawyer" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:13px">
        <option value="">Select Professional...</option>
      </select>
    </div>
    <label style="display:flex;align-items:flex-start;gap:8px;font-size:12px;color:#8b949e;margin-top:6px;cursor:pointer">
      <input type="checkbox" id="ilfReferConsent" style="margin-top:2px">
      <span>Claimant has authorized sharing case details with an independent legal professional for potential assistance</span>
    </label>
    <div id="ilfReferStatus" style="font-size:12px;margin-top:8px;min-height:18px"></div>
    <div style="display:flex;gap:8px;margin-top:16px;justify-content:flex-end">
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('ilfReferModal').style.display='none'">Cancel</button>
      <button class="btn btn-sm" style="background:#f97316;color:#0a0e14" onclick="createILFReferral()">Create Referral</button>
    </div>
  </div>
</div>

<!-- ========== RESPONDENT INTELLIGENCE ========== -->
<div id="intel" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center">
      <h3 style="font-size:16px">&#x1F575; Respondent Intelligence</h3>
      <span style="font-size:9px;letter-spacing:.5px;color:#6e7681;border:1px solid #21262d;border-radius:4px;padding:2px 6px;text-transform:uppercase">Pattern Analysis &bull; Risk Profiles</span>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-ghost btn-sm" onclick="fetchRespondentIntel()">&#x21BB; Refresh</button>
    </div>
  </div>

  <!-- Intel Summary Stats -->
  <div class="intel-summary" id="intelSummary">
    <div class="intel-stat"><div class="is-num respondents" id="intelTotalResp">0</div><div class="is-lbl">Respondents</div></div>
    <div class="intel-stat"><div class="is-num claims" id="intelTotalClaims">0</div><div class="is-lbl">Total Claims</div></div>
    <div class="intel-stat"><div class="is-num critical" id="intelCritical">0</div><div class="is-lbl">Critical Risk</div></div>
    <div class="intel-stat"><div class="is-num high" id="intelHigh">0</div><div class="is-lbl">High Risk</div></div>
    <div class="intel-stat"><div class="is-num resolved" id="intelAvgResolution">0%</div><div class="is-lbl">Avg Resolution</div></div>
  </div>

  <!-- Intel Respondent Cards -->
  <div id="intelContainer">
    <div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x1F575;</div>Loading respondent intelligence...</div>
  </div>
</div>

<!-- ========== ACTIVITY FEED ========== -->
<div id="activity" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center">
      <h3 style="font-size:16px">Activity Feed</h3>
      <span style="font-size:11px;color:#484f58">Recent system events across all entities</span>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-ghost btn-sm" onclick="fetchActivityFeed()">&#x21BB; Refresh</button>
      <span id="feedLastUpdate" style="font-size:11px;color:#484f58;line-height:34px"></span>
    </div>
  </div>
  <div id="activityFeedContainer" style="background:#12171e;border:1px solid #1c2129;border-radius:10px;overflow:hidden">
    <div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x1F514;</div>Loading activity feed...</div>
  </div>
  <div style="margin-top:8px;font-size:10px;color:#484f58;text-align:right">All times shown in your local browser timezone. System timestamps stored in UTC.</div>
</div>

<!-- ========== AUDIT LOG ========== -->
<div id="audit" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center">
      <h3 style="font-size:16px">Audit Log</h3>
      <span style="font-size:9px;letter-spacing:.5px;color:#6e7681;border:1px solid #21262d;border-radius:4px;padding:2px 6px;text-transform:uppercase">Immutable &bull; Compliance Record</span>
    </div>
    <div class="toolbar-right">
      <select id="auditFilter" onchange="fetchAuditLog()" style="background:#0d1117;border:1px solid #21262d;color:#c9d1d9;padding:4px 8px;border-radius:6px;font-size:12px">
        <option value="">All Actions</option>
        <option value="signal.scan">Signal Scans</option>
        <option value="letter.generated">Letter Generation</option>
        <option value="status.changed">Status Changes</option>
        <option value="claim.intake">Claim Intake</option>
        <option value="claim.classified">Classifications</option>
        <option value="handoff.initiated">Handoffs</option>
        <option value="ilf.lawyer.registered">ILF Registrations</option>
        <option value="ilf.referral.updated">ILF Referral Updates</option>
        <option value="export.audit_log">Exports</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="fetchAuditLog()">&#x21BB; Refresh</button>
      <span style="border-left:1px solid #21262d;height:20px;margin:0 4px"></span>
      <button class="btn btn-ghost btn-sm" onclick="exportAuditLog('csv')" title="Download CSV">&#x1F4E5; CSV</button>
      <button class="btn btn-ghost btn-sm" onclick="exportAuditLog('json')" title="Download JSON">&#x1F4E5; JSON</button>
    </div>
  </div>
  <div style="background:rgba(33,38,45,.4);border:1px solid #21262d;border-radius:8px;padding:10px 14px;margin:12px 0;font-size:12px;color:#8b949e;line-height:1.5">
    Every system action is logged immutably. Entries cannot be edited or deleted. This log supports compliance review and operational transparency.
  </div>
  <div id="auditContainer" style="margin-top:12px"><div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x1F4CB;</div>Click Refresh to load audit entries</div></div>
</div>

<!-- ========== REPORTS ========== -->
<div id="reports" class="panel">
  <div class="toolbar">
    <div style="display:flex;gap:8px;align-items:center">
      <h3 style="font-size:16px">&#x1F4CA; Reports &amp; Analytics</h3>
      <span style="font-size:9px;letter-spacing:.5px;color:#6e7681;border:1px solid #21262d;border-radius:4px;padding:2px 6px;text-transform:uppercase">Operational Intelligence</span>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-ghost btn-sm" onclick="generateReport('executive')">&#x1F4CB; Executive Summary</button>
      <button class="btn btn-ghost btn-sm" onclick="generateReport('accountability')">&#x1F3E2; Respondent Accountability</button>
      <button class="btn btn-ghost btn-sm" onclick="exportClaimsData('csv')">&#x1F4E5; Export CSV</button>
      <button class="btn btn-ghost btn-sm" onclick="exportClaimsData('json')">&#x1F4E5; Export JSON</button>
    </div>
  </div>
  <div id="reportContent">
    <div style="text-align:center;padding:60px 20px">
      <div style="font-size:48px;margin-bottom:12px;opacity:.5">&#x1F4CA;</div>
      <div style="font-size:16px;color:#c9d1d9;margin-bottom:6px">Report Center</div>
      <div style="font-size:13px;color:#6e7681;max-width:400px;margin:0 auto;line-height:1.6">
        Generate comprehensive reports for stakeholder review, compliance audits, and operational analysis.
        Select a report type above to get started.
      </div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="generateReport('executive')" style="padding:10px 20px">&#x1F4CB; Executive Summary</button>
        <button class="btn btn-primary" onclick="generateReport('accountability')" style="background:#30363d;padding:10px 20px">&#x1F3E2; Respondent Scorecards</button>
      </div>
    </div>
  </div>
</div>

<!-- CASE DETAIL DRAWER -->
<div id="caseDrawer" class="drawer" onclick="if(event.target===this)closeDrawer()">
  <div class="drawer-content">
    <div class="drawer-header">
      <h3 id="drawerTitle">Case Detail</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeDrawer()">&times;</button>
    </div>
    <div id="drawerBody"></div>
  </div>
</div>

<div style="text-align:center;padding:20px 0 8px;border-top:1px solid #1c2129;margin-top:32px;font-size:11px;color:#484f58;line-height:1.6">GhostLedger coordinates recovery efforts and does not provide legal advice or legal representation.</div>

</div><!-- end .app -->

<div id="bulkModal" style="display:none"></div>

<script>
// Auto-detect: if served from the API, use relative paths; if from file://, use localhost
const API_BASE = location.protocol === 'file:' ? 'http://localhost:8081' : '';
const API = API_BASE + '/v1';
function authHeaders(){ return {'Authorization':'Bearer operator'}; }
let allClaims = [];

// ===== UTILITY HELPERS =====
function esc(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function showToast(msg, color){
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#161b22;border:1px solid '+(color||'#8B5E3C')+';color:'+(color||'#e6edf3')+';padding:12px 24px;border-radius:8px;font-size:13px;z-index:10000;animation:fadeIn .3s ease';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(()=>t.remove(),300); }, 3500);
}

// ===== CLOCK =====
function updateClock(){
  const now = new Date();
  document.getElementById('liveDate').textContent = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('liveTime').innerHTML = '<strong>' + now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) + '</strong>';
}
updateClock(); setInterval(updateClock, 1000);

// ===== TAB SWITCHING =====
function showTab(id, btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if(id==='cases') fetchClaims();
  if(id==='dashboard'){ updateDashboard(); fetchHealthCheck(); }
  if(id==='followups') fetchFollowups();
  if(id==='signals') fetchSignals();
  if(id==='intel') fetchRespondentIntel();
  if(id==='activity'){ fetchActivityFeed(); markActivitySeen(); }
  if(id==='reports' && !document.getElementById('reportContent').dataset.loaded) { /* Fresh state, show landing */ }
}

// ===== API HEALTH CHECK =====
async function checkAPI(){
  const dot = document.getElementById('apiDot');
  const label = document.getElementById('apiLabel');
  try {
    const r = await fetch(API_BASE + '/health', {signal: AbortSignal.timeout(3000)});
    if(r.ok){dot.className='api-dot online';label.textContent='System: Operational';label.style.color='#4ade80';}
    else throw new Error();
  } catch(e){
    dot.className='api-dot offline';
    label.textContent='API Offline â€” run: bash start.sh';
    label.style.color='#f85149';
  }
}
checkAPI(); setInterval(checkAPI, 15000);

// ===== FETCH CLAIMS =====
async function fetchClaims(){
  try {
    const r = await fetch(API_BASE + '/v1/claims');
    if(!r.ok) throw new Error();
    const data = await r.json();
    allClaims = data.claims || [];
    populateRespondentFilter();
    applyFilters(); // applies current filters + sort, renders both views
    updateDashboard();
    updateBadges();
    clearBulkSelection();
  } catch(e){
    document.getElementById('casesTbody').innerHTML =
      '<tr><td colspan="13" class="empty-row"><div class="empty-icon">&#x26A0;</div>Cannot reach API. Start the server with: bash start.sh</td></tr>';
  }
}

// ===== HELPERS =====
function maskName(fullName){
  if(!fullName || fullName === 'â€”') return 'â€”';
  const parts = fullName.trim().split(/\s+/);
  if(parts.length === 1) return parts[0].charAt(0) + '.';
  return parts[0] + ' ' + parts[parts.length-1].charAt(0) + '.';
}
function getCaseAge(filedAt){
  if(!filedAt) return 'â€”';
  const days = Math.floor((Date.now() - new Date(filedAt).getTime()) / 86400000);
  return days + 'd';
}
function getNeedsAction(claim){
  const status = claim.status || 'draft';
  const cc = claim.classification || {};
  if(cc.requires_human_triage) return {label:'Triage', cls:'color:#f85149'};
  if(status === 'filed') return {label:'Review', cls:'color:#58a6ff'};
  if(status === 'under_review') return {label:'Assign', cls:'color:#fbbf24'};
  if(status === 'escalated') return {label:'Escalate', cls:'color:#f97316'};
  if(status === 'in_resolution') return {label:'Monitor', cls:'color:#a78bfa'};
  if(status === 'resolved' || status === 'closed') return {label:'â€”', cls:'color:#6e7681'};
  return {label:'Await', cls:'color:#6e7681'};
}

// ===== RENDER CASES =====
function getValueBand(amount){
  if(amount < 500) return {label:'Micro',cls:'vb-micro'};
  if(amount < 5000) return {label:'Small',cls:'vb-small'};
  if(amount < 50000) return {label:'Medium',cls:'vb-medium'};
  if(amount < 250000) return {label:'Large',cls:'vb-large'};
  return {label:'Strategic',cls:'vb-strategic'};
}

function renderCases(claims){
  const tb = document.getElementById('casesTbody');
  if(!claims || !claims.length){
    tb.innerHTML = '<tr><td colspan="13" class="empty-row"><div class="empty-icon">&#x1F4CB;</div>No claims found. Submit one via the Submit Claim tab.</td></tr>';
    return;
  }
  tb.innerHTML = '';
  claims.forEach(c => {
    const amt = c.amount_claimed_usd || 0;
    const cc = c.classification || {};
    const vb = cc.value_band ? {label: cc.value_band.replace(/_/g,' '), cls: 'vb-'+cc.value_band} : getValueBand(amt);
    const disputeType = (cc.dispute_type || c.harm_type || 'â€”').replace(/_/g,' ');
    const recoveryPath = (cc.recovery_path || 'â€”').replace(/_/g,' ');
    const complexity = cc.complexity_score || 'â€”';
    const triage = cc.requires_human_triage ? ' title="Needs human triage" style="color:#f85149;cursor:help"' : '';
    const statusCls = 's-' + (c.status || 'draft').replace(/ /g,'_');
    const cid = c.claim_id || '';
    const age = getCaseAge(c.filed_at);
    const action = getNeedsAction(c);
    const recAmt = c.amount_recovered_usd || 0;
    const recPct = c.recovery_pct || 0;
    const recBadge = recAmt > 0 ? '<div style="font-size:10px;color:#4ade80;font-weight:600" title="'+recPct+'% recovered">&#x2705; $'+recAmt.toLocaleString()+'</div>' : '';
    tb.innerHTML +=
      '<tr>' +
      '<td><input type="checkbox" class="bulk-check" value="'+cid+'" onchange="updateBulkSelection()"></td>' +
      '<td><a href="#" onclick="openCase(\''+cid+'\');return false" style="color:#c9956b;text-decoration:none;font-weight:700">' + cid.substring(0,12) + '...</a></td>' +
      '<td title="'+(c.claimant_name||'')+'">' + maskName(c.claimant_name) + '</td>' +
      '<td><a href="#" onclick="openRespondentIntel(\'' + (c.respondent_entity||'').replace(/'/g,"\\'") + '\');return false" style="color:#e6edf3;text-decoration:none;border-bottom:1px dotted #30363d" title="View respondent intelligence">' + (c.respondent_entity||'â€”') + '</a></td>' +
      '<td>' + disputeType + '</td>' +
      '<td>$' + amt.toLocaleString(undefined,{minimumFractionDigits:2}) + recBadge + '</td>' +
      '<td><span class="status ' + statusCls + '">' + (c.status||'draft').replace(/_/g,' ') + '</span></td>' +
      '<td style="font-weight:600;font-size:12px;color:#8b949e">' + age + '</td>' +
      '<td><span class="vb ' + vb.cls + '">' + vb.label + '</span></td>' +
      '<td>' + recoveryPath + '</td>' +
      '<td' + triage + '>' + complexity + '</td>' +
      '<td style="font-weight:600;font-size:12px;'+action.cls+'">' + action.label + ' ' + getSlaIndicator(c) + (c.outreach_count > 0 ? ' <span style="background:rgba(201,149,107,.15);color:#c9956b;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600" title="'+c.outreach_count+' outreach communications">&#x2709; '+c.outreach_count+'</span>' : '') + (c.document_count > 0 ? ' <span style="background:rgba(88,166,255,.12);color:#58a6ff;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600" title="'+c.document_count+' documents attached">&#x1F4CE; '+c.document_count+'</span>' : '') + (c.assigned_name ? ' <span class="assign-badge" title="Assigned to '+esc(c.assigned_name)+'">&#x1F464; '+esc(c.assigned_name.split(' ')[0])+'</span>' : '') + '</td>' +
      '<td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openTransitionModal(\''+cid+'\')" style="font-size:10px;padding:4px 8px">&#x1F504; Change</button></td>' +
      '</tr>';
  });
}

// ===== STATUS TRANSITION (WITH VALIDATION + REASON) =====
let tmClaimId = '';
let tmSelectedStatus = '';

async function openTransitionModal(claimId){
  tmClaimId = claimId;
  tmSelectedStatus = '';
  document.getElementById('tmReason').value = '';
  document.getElementById('tmError').style.display = 'none';

  // Fetch valid transitions from API
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/transitions');
    if(!r.ok) throw new Error();
    const data = await r.json();

    document.getElementById('tmClaimId').textContent = claimId.substring(0, 14) + '...';
    document.getElementById('tmRespondent').textContent = data.respondent || 'Unknown';
    const curStatus = data.current_status || 'filed';
    document.getElementById('tmCurrentStatus').textContent = curStatus.replace(/_/g, ' ');
    document.getElementById('tmCurrentStatus').className = 'status s-' + curStatus;

    const allowed = data.allowed_transitions || [];
    const labels = {filed:'Filed',under_review:'Under Review',escalated:'Escalated',in_resolution:'In Resolution',resolved:'Resolved',closed:'Closed',appealed:'Appealed',draft:'Draft'};
    let opts = '';
    if(!allowed.length){
      opts = '<div style="color:#484f58;font-size:13px;padding:10px;text-align:center">No valid transitions from this status</div>';
    }
    allowed.forEach(s => {
      opts += '<div class="transition-opt" onclick="selectTransition(this,\'' + s + '\')">';
      opts += '<span class="to-dot ' + s + '"></span>';
      opts += '<span>' + (labels[s] || s.replace(/_/g,' ')) + '</span>';
      opts += '</div>';
    });
    document.getElementById('tmOptions').innerHTML = opts;
    document.getElementById('transitionModal').classList.add('open');
  } catch(e){
    console.error('Failed to load transitions', e);
  }
}

function selectTransition(el, status){
  tmSelectedStatus = status;
  document.querySelectorAll('.transition-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
}

function closeTransitionModal(){
  document.getElementById('transitionModal').classList.remove('open');
  tmClaimId = '';
  tmSelectedStatus = '';
}

async function confirmTransition(){
  const reason = document.getElementById('tmReason').value.trim();
  const errEl = document.getElementById('tmError');

  if(!tmSelectedStatus){
    errEl.textContent = 'Please select a target status.';
    errEl.style.display = 'block';
    return;
  }
  if(!reason){
    errEl.textContent = 'A reason is required for the audit trail.';
    errEl.style.display = 'block';
    return;
  }
  errEl.style.display = 'none';

  try {
    const r = await fetch(API_BASE + '/v1/claims/' + tmClaimId + '/status', {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({status: tmSelectedStatus, reason: reason})
    });
    if(!r.ok){
      const err = await r.json();
      errEl.textContent = err.detail?.message || 'Transition failed';
      errEl.style.display = 'block';
      return;
    }
    closeTransitionModal();
    fetchClaims();
  } catch(e){
    errEl.textContent = 'Network error. Check API.';
    errEl.style.display = 'block';
  }
}

// Legacy wrapper for any direct calls
async function changeStatus(claimId, newStatus){
  openTransitionModal(claimId);
}

// ===== BULK OPERATIONS =====
let bulkSelected = new Set();

function toggleSelectAll(checked){
  const checkboxes = document.querySelectorAll('#claimTableBody .bulk-check');
  checkboxes.forEach(cb => { cb.checked = checked; });
  bulkSelected.clear();
  if(checked){
    checkboxes.forEach(cb => { if(cb.value) bulkSelected.add(cb.value); });
  }
  refreshBulkBar();
}

function updateBulkSelection(){
  bulkSelected.clear();
  const checkboxes = document.querySelectorAll('#claimTableBody .bulk-check:checked');
  checkboxes.forEach(cb => { bulkSelected.add(cb.value); });
  // Sync "select all" checkbox
  const allCbs = document.querySelectorAll('#claimTableBody .bulk-check');
  const selAll = document.getElementById('bulkSelectAll');
  if(selAll) selAll.checked = allCbs.length > 0 && allCbs.length === checkboxes.length;
  refreshBulkBar();
}

function refreshBulkBar(){
  const bar = document.getElementById('bulkBar');
  const countEl = document.getElementById('bulkCount');
  if(bulkSelected.size > 0){
    bar.classList.add('active');
    countEl.textContent = bulkSelected.size + ' selected';
  } else {
    bar.classList.remove('active');
  }
}

function clearBulkSelection(){
  bulkSelected.clear();
  document.querySelectorAll('.bulk-check').forEach(cb => { cb.checked = false; });
  refreshBulkBar();
}

// -- Bulk Status Change (uses a simplified modal approach) --
async function bulkStatusChange(){
  if(bulkSelected.size === 0) return;
  if(bulkSelected.size > 50){
    alert('Maximum 50 claims per batch. Please reduce your selection.');
    return;
  }

  // Build a mini-modal reusing the transition modal pattern
  const labels = {filed:'Filed',under_review:'Under Review',escalated:'Escalated',in_resolution:'In Resolution',resolved:'Resolved',closed:'Closed',appealed:'Appealed',draft:'Draft'};
  const statuses = ['filed','under_review','escalated','in_resolution','resolved','closed','appealed'];

  let opts = '';
  statuses.forEach(s => {
    opts += '<div class="transition-opt" onclick="selectTransition(this,\'' + s + '\')">';
    opts += '<span class="to-dot ' + s + '"></span>';
    opts += '<span>' + (labels[s] || s) + '</span>';
    opts += '</div>';
  });

  tmClaimId = '__bulk__';
  tmSelectedStatus = '';
  document.getElementById('tmReason').value = '';
  document.getElementById('tmError').style.display = 'none';
  document.getElementById('tmClaimId').textContent = bulkSelected.size + ' claims';
  document.getElementById('tmRespondent').textContent = 'Multiple';
  document.getElementById('tmCurrentStatus').textContent = 'various';
  document.getElementById('tmCurrentStatus').className = 'status';
  document.getElementById('tmOptions').innerHTML = opts;
  document.getElementById('transitionModal').classList.add('open');
}

// Override confirmTransition to handle bulk mode
const _origConfirmTransition = confirmTransition;
confirmTransition = async function(){
  if(tmClaimId !== '__bulk__'){
    return _origConfirmTransition();
  }

  const reason = document.getElementById('tmReason').value.trim();
  const errEl = document.getElementById('tmError');

  if(!tmSelectedStatus){
    errEl.textContent = 'Please select a target status.';
    errEl.style.display = 'block';
    return;
  }
  if(!reason){
    errEl.textContent = 'A reason is required for the audit trail.';
    errEl.style.display = 'block';
    return;
  }
  errEl.style.display = 'none';

  try {
    const r = await fetch(API_BASE + '/v1/claims/bulk/status', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        claim_ids: Array.from(bulkSelected),
        status: tmSelectedStatus,
        reason: reason
      })
    });
    if(!r.ok){
      const err = await r.json();
      errEl.textContent = err.detail || 'Bulk operation failed';
      errEl.style.display = 'block';
      return;
    }
    const result = await r.json();
    closeTransitionModal();
    clearBulkSelection();
    fetchClaims();
    // Show result summary
    const s = result.summary || {};
    const msg = 'Batch complete: ' + (s.success||0) + ' updated, ' + (s.skipped||0) + ' skipped, ' + (s.failed||0) + ' failed';
    const banner = document.createElement('div');
    banner.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#161b22;border:1px solid #8B5E3C;color:#e6edf3;padding:12px 24px;border-radius:8px;font-size:13px;z-index:10000;animation:fadeIn .3s ease';
    banner.textContent = msg;
    document.body.appendChild(banner);
    setTimeout(() => banner.remove(), 4000);
  } catch(e){
    errEl.textContent = 'Network error. Check API.';
    errEl.style.display = 'block';
  }
};

// -- Bulk Export --
function bulkExport(format){
  if(bulkSelected.size === 0) return;
  const selected = allClaims.filter(c => bulkSelected.has(c.claim_id));
  if(!selected.length) return;

  let content, filename, mime;
  if(format === 'csv'){
    const headers = ['claim_id','claimant_name','respondent_entity','harm_type','amount_claimed_usd','status','filed_at'];
    const rows = selected.map(c => headers.map(h => {
      let v = c[h] ?? '';
      if(typeof v === 'string' && (v.includes(',') || v.includes('"'))) v = '"' + v.replace(/"/g,'""') + '"';
      return v;
    }).join(','));
    content = headers.join(',') + '\n' + rows.join('\n');
    filename = 'ghostledger_export_' + new Date().toISOString().slice(0,10) + '.csv';
    mime = 'text/csv';
  } else {
    content = JSON.stringify(selected, null, 2);
    filename = 'ghostledger_export_' + new Date().toISOString().slice(0,10) + '.json';
    mime = 'application/json';
  }

  const blob = new Blob([content], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== ADVANCED FILTERING & SAVED VIEWS =====
let currentSort = {field: 'filed_at', dir: 'desc'};
let savedViews = [];
let activeViewId = null;

function filterCases(){
  applyFilters();
}

function toggleFilterPanel(){
  const panel = document.getElementById('filterPanel');
  const btn = document.getElementById('filterToggleBtn');
  panel.classList.toggle('open');
  btn.classList.toggle('active');
}

function getActiveFilters(){
  const f = {};
  const status = document.getElementById('fStatus').value;
  const respondent = document.getElementById('fRespondent').value;
  const valueBand = document.getElementById('fValueBand').value;
  const sla = document.getElementById('fSla').value;
  const recovery = document.getElementById('fRecovery').value;
  const amtMin = document.getElementById('fAmtMin').value;
  const amtMax = document.getElementById('fAmtMax').value;
  const dateFrom = document.getElementById('fDateFrom').value;
  const dateTo = document.getElementById('fDateTo').value;

  if(status) f.status = status;
  if(respondent) f.respondent = respondent;
  if(valueBand) f.valueBand = valueBand;
  if(sla) f.sla = sla;
  if(recovery) f.recovery = recovery;
  if(amtMin) f.amtMin = parseFloat(amtMin);
  if(amtMax) f.amtMax = parseFloat(amtMax);
  if(dateFrom) f.dateFrom = dateFrom;
  if(dateTo) f.dateTo = dateTo;
  const assignee = document.getElementById('fAssignee') ? document.getElementById('fAssignee').value : '';
  if(assignee) f.assignee = assignee;
  return f;
}

function countActiveFilters(){
  return Object.keys(getActiveFilters()).length;
}

function applyFilters(){
  const f = getActiveFilters();
  let filtered = allClaims.slice();

  if(f.status) filtered = filtered.filter(c => c.status === f.status);
  if(f.respondent) filtered = filtered.filter(c => (c.respondent_entity||'') === f.respondent);
  if(f.valueBand) filtered = filtered.filter(c => {
    const cc = c.classification || {};
    return cc.value_band === f.valueBand;
  });
  if(f.sla) filtered = filtered.filter(c => c.sla_status === f.sla);
  if(f.recovery === 'has_recovery') filtered = filtered.filter(c => (c.amount_recovered_usd||0) > 0);
  else if(f.recovery === 'no_recovery') filtered = filtered.filter(c => !(c.amount_recovered_usd||0));
  else if(f.recovery === 'full') filtered = filtered.filter(c => (c.recovery_pct||0) >= 100);
  if(f.amtMin !== undefined) filtered = filtered.filter(c => (c.amount_claimed_usd||0) >= f.amtMin);
  if(f.amtMax !== undefined) filtered = filtered.filter(c => (c.amount_claimed_usd||0) <= f.amtMax);
  if(f.dateFrom) filtered = filtered.filter(c => (c.filed_at||'') >= f.dateFrom);
  if(f.dateTo) filtered = filtered.filter(c => (c.filed_at||'').substring(0,10) <= f.dateTo);
  if(f.assignee === '__unassigned__') filtered = filtered.filter(c => !c.assigned_to);
  else if(f.assignee) filtered = filtered.filter(c => c.assigned_to === f.assignee);

  // Apply sort
  filtered = sortClaims(filtered);

  // Update count badges
  const cnt = countActiveFilters();
  const cntEl = document.getElementById('filterCount');
  if(cnt > 0){ cntEl.textContent = cnt; cntEl.style.display = 'inline'; }
  else { cntEl.style.display = 'none'; }
  document.getElementById('filterResultCount').textContent = filtered.length + ' of ' + allClaims.length + ' claims';

  renderCases(filtered);
  renderPipeline(filtered);
}

function sortClaims(claims){
  const {field, dir} = currentSort;
  const mult = dir === 'asc' ? 1 : -1;
  return claims.sort((a, b) => {
    let av = a[field], bv = b[field];
    if(av == null) av = '';
    if(bv == null) bv = '';
    if(typeof av === 'number' && typeof bv === 'number') return (av - bv) * mult;
    return String(av).localeCompare(String(bv)) * mult;
  });
}

function toggleSort(field){
  if(currentSort.field === field){
    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.field = field;
    currentSort.dir = field === 'amount_claimed_usd' ? 'desc' : 'asc';
  }
  // Update header arrows
  document.querySelectorAll('.sort-header').forEach(th => {
    th.classList.remove('asc','desc');
    const arrow = th.querySelector('.sort-arrow');
    if(arrow) arrow.textContent = '';
  });
  const active = document.getElementById('sort_' + field);
  if(active){
    active.parentElement.classList.add(currentSort.dir);
    active.textContent = currentSort.dir === 'asc' ? ' â–²' : ' â–¼';
  }
  applyFilters();
}

function clearFilters(){
  document.getElementById('fStatus').value = '';
  document.getElementById('fRespondent').value = '';
  document.getElementById('fValueBand').value = '';
  document.getElementById('fSla').value = '';
  document.getElementById('fRecovery').value = '';
  document.getElementById('fAmtMin').value = '';
  document.getElementById('fAmtMax').value = '';
  document.getElementById('fDateFrom').value = '';
  document.getElementById('fDateTo').value = '';
  activeViewId = null;
  renderSavedViewsShelf();
  applyFilters();
}

function populateRespondentFilter(){
  const sel = document.getElementById('fRespondent');
  const current = sel.value;
  const respondents = [...new Set(allClaims.map(c => c.respondent_entity).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">All</option>';
  respondents.forEach(r => {
    sel.innerHTML += '<option value="'+r.replace(/"/g,'&quot;')+'">'+r+'</option>';
  });
  sel.value = current;
}

// Saved Views
async function loadSavedViews(){
  try {
    const r = await fetch(API_BASE + '/v1/views');
    if(!r.ok) return;
    const data = await r.json();
    savedViews = data.views || [];
    renderSavedViewsShelf();
  } catch(e){}
}

function renderSavedViewsShelf(){
  const shelf = document.getElementById('savedViewsShelf');
  if(!savedViews.length){ shelf.innerHTML = ''; return; }
  let html = '';
  savedViews.forEach(v => {
    const active = v.view_id === activeViewId ? ' active' : '';
    html += '<div class="sv-chip'+active+'" onclick="loadView(\''+v.view_id+'\')">';
    html += '<span>'+v.name+'</span>';
    html += '<span class="sv-del" onclick="event.stopPropagation();deleteView(\''+v.view_id+'\')" title="Delete view">&times;</span>';
    html += '</div>';
  });
  shelf.innerHTML = html;
}

function loadView(viewId){
  const v = savedViews.find(sv => sv.view_id === viewId);
  if(!v) return;
  activeViewId = viewId;

  // Apply saved filters to form
  const f = v.filters || {};
  document.getElementById('fStatus').value = f.status || '';
  document.getElementById('fRespondent').value = f.respondent || '';
  document.getElementById('fValueBand').value = f.valueBand || '';
  document.getElementById('fSla').value = f.sla || '';
  document.getElementById('fRecovery').value = f.recovery || '';
  document.getElementById('fAmtMin').value = f.amtMin || '';
  document.getElementById('fAmtMax').value = f.amtMax || '';
  document.getElementById('fDateFrom').value = f.dateFrom || '';
  document.getElementById('fDateTo').value = f.dateTo || '';

  // Apply saved sort
  if(v.sort_by) currentSort.field = v.sort_by;
  if(v.sort_dir) currentSort.dir = v.sort_dir;

  renderSavedViewsShelf();
  applyFilters();

  // Open filter panel to show active filters
  if(!document.getElementById('filterPanel').classList.contains('open')){
    toggleFilterPanel();
  }
}

async function saveCurrentView(){
  const name = prompt('Name this saved view:');
  if(!name || !name.trim()) return;

  const filters = getActiveFilters();
  try {
    const r = await fetch(API_BASE + '/v1/views', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name: name.trim(), filters: filters, sort_by: currentSort.field, sort_dir: currentSort.dir})
    });
    if(!r.ok) return;
    const v = await r.json();
    activeViewId = v.view_id;
    loadSavedViews();
  } catch(e){}
}

async function deleteView(viewId){
  try {
    await fetch(API_BASE + '/v1/views/' + viewId, {method: 'DELETE'});
    if(activeViewId === viewId) activeViewId = null;
    loadSavedViews();
  } catch(e){}
}

// ===== VIEW TOGGLE (TABLE / PIPELINE) =====
let currentView = 'table';

function switchView(view, btn){
  currentView = view;
  document.querySelectorAll('#viewToggle button').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');

  const tableEl = document.getElementById('tableView');
  const pipelineEl = document.getElementById('pipelineView');

  if(view === 'table'){
    tableEl.style.display = 'block';
    pipelineEl.style.display = 'none';
  } else {
    tableEl.style.display = 'none';
    pipelineEl.style.display = 'block';
    // Re-render pipeline with current filter
    const val = document.getElementById('filterStatus').value;
    const filtered = val === 'all' ? allClaims : allClaims.filter(c => c.status === val);
    renderPipeline(filtered);
  }
}

function renderPipeline(claims){
  if(!claims) claims = allClaims;
  const now = Date.now();

  // Status to column mapping
  const columns = {
    'filed':         {el: 'pipelineFiled',       count: 'pcFiled',       items: []},
    'under_review':  {el: 'pipelineUnderReview',  count: 'pcUnderReview', items: []},
    'escalated':     {el: 'pipelineEscalated',    count: 'pcEscalated',   items: []},
    'in_resolution': {el: 'pipelineInResolution',count: 'pcInResolution',items: []},
    'resolved':      {el: 'pipelineResolved',     count: 'pcResolved',    items: []},
    'closed':        {el: 'pipelineClosed',       count: 'pcClosed',      items: []},
  };

  // Sort claims into columns
  (claims || []).forEach(c => {
    const st = c.status || 'filed';
    // Map draft/appealed to closest column
    const mapped = st === 'draft' ? 'filed' : st === 'appealed' ? 'escalated' : st;
    if(columns[mapped]) columns[mapped].items.push(c);
    else if(columns['filed']) columns['filed'].items.push(c);
  });

  // Render each column
  Object.entries(columns).forEach(([status, col]) => {
    const container = document.getElementById(col.el);
    const countEl = document.getElementById(col.count);
    if(!container) return;

    countEl.textContent = col.items.length;

    if(!col.items.length){
      container.innerHTML = '<div class="pipeline-empty">No claims</div>';
      return;
    }

    // Sort by amount descending within each column
    col.items.sort((a,b) => (b.amount_claimed_usd||0) - (a.amount_claimed_usd||0));

    let html = '';
    col.items.forEach(c => {
      const amt = c.amount_claimed_usd || 0;
      const cc = c.classification || {};
      const vb = cc.value_band || '';
      const ht = (c.harm_type || '').replace(/_/g,' ');
      const cid = c.claim_id || '';

      // Age + SLA indicator
      let ageDays = 0;
      let ageClass = 'fresh';
      if(c.filed_at){
        ageDays = Math.floor((now - new Date(c.filed_at).getTime()) / 86400000);
        if(ageDays > 21) ageClass = 'overdue';
        else if(ageDays > 7) ageClass = 'aging';
        else if(ageDays > 3) ageClass = 'normal';
      }

      html += '<div class="pipeline-card" onclick="openCase(\'' + cid + '\')">';
      html += '<div class="pc-respondent" title="' + (c.respondent_entity||'') + '">' + (c.respondent_entity||'Unknown') + '</div>';
      html += '<div class="pc-amount">$' + amt.toLocaleString() + '</div>';
      html += '<div class="pc-meta">';
      html += '<span class="pc-id">' + cid.substring(0,10) + '</span>';
      html += '<span class="pc-age ' + ageClass + '">' + ageDays + 'd</span>';
      html += '</div>';
      // Tags row
      let tags = '';
      if(vb) tags += '<span class="pc-tag vb">' + vb.replace(/_/g,' ') + '</span>';
      if(ht && ht !== 'â€”') tags += '<span class="pc-tag harm">' + ht + '</span>';
      if(cc.requires_human_triage) tags += '<span class="pc-tag" style="background:rgba(248,81,73,.12);color:#f85149">TRIAGE</span>';
      const recAmt = c.amount_recovered_usd || 0;
      if(recAmt > 0) tags += '<span class="pc-tag" style="background:rgba(74,222,128,.12);color:#4ade80">&#x2705; $'+recAmt.toLocaleString()+'</span>';
      // SLA indicator
      const slaSt = c.sla_status;
      if(slaSt === 'breached') tags += '<span class="pc-tag" style="background:rgba(248,81,73,.15);color:#f85149;font-weight:700">SLA BREACH</span>';
      else if(slaSt === 'at_risk') tags += '<span class="pc-tag" style="background:rgba(251,191,36,.12);color:#fbbf24">SLA RISK</span>';
      if(tags) html += '<div class="pc-tags">' + tags + '</div>';
      html += '</div>';
    });

    container.innerHTML = html;
  });
}

// ===== SUBMIT CLAIM =====
async function submitClaim(){
  const status = document.getElementById('submitStatus');
  if(!document.getElementById('fAuth').checked){
    status.textContent = 'Please check the authorization box.';
    status.style.color = '#f85149';
    return;
  }
  const name = document.getElementById('fName').value.trim();
  const email = document.getElementById('fEmail').value.trim();
  if(!name || !email){
    status.textContent = 'Name and email are required.';
    status.style.color = '#f85149';
    return;
  }

  const payload = {
    full_name: name,
    email: email,
    phone: document.getElementById('fPhone').value.trim() || null,
    platform_or_company: document.getElementById('fPlatform').value.trim(),
    estimated_amount_usd: parseFloat(document.getElementById('fAmount').value) || 0,
    last_expected_payment: document.getElementById('fDate').value || null,
    platform_reason: document.getElementById('fReason').value.trim() || 'No explanation given',
    contacted_support: document.getElementById('fSupport').value,
    referral_source: document.getElementById('fSource').value,
    authorization: true
  };

  status.textContent = 'Submitting...';
  status.style.color = '#fbbf24';

  try {
    const r = await fetch(API_BASE + '/v1/intake/submissions', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(r.ok){
      status.innerHTML = 'Claim received: <strong>' + (data.claim_id||'').substring(0,12) + '...</strong><br><span style="font-size:11px;color:#8b949e">If additional information is needed, you will be contacted. Timing varies by case complexity and jurisdiction.</span>';
      status.style.color = '#4ade80';
      // Clear form
      ['fName','fEmail','fPhone','fPlatform','fAmount','fDate','fReason'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('fAuth').checked = false;
    } else {
      const msg = Array.isArray(data.detail) ? data.detail.map(e => e.msg || e.message || JSON.stringify(e)).join('; ') : (typeof data.detail === 'string' ? data.detail : JSON.stringify(data));
      status.textContent = 'Error: ' + msg;
      status.style.color = '#f85149';
    }
  } catch(e){
    status.textContent = 'Cannot reach API. Is the server running?';
    status.style.color = '#f85149';
  }
}

// ===== BATCH IMPORT ENGINE =====
let importParsedData = [];
let importRawCsv = null;

function handleImportDrop(event){
  const f = event.dataTransfer.files[0];
  if(f) handleImportFile(f);
}

function handleImportFile(file){
  if(!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if(!['csv','json'].includes(ext)){
    showToast('Unsupported file type. Please use CSV or JSON.','#f85149');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    try {
      if(ext === 'json'){
        let parsed = JSON.parse(text);
        if(!Array.isArray(parsed)){
          if(parsed.claims && Array.isArray(parsed.claims)) parsed = parsed.claims;
          else { showToast('JSON must be an array of claims or {claims:[...]}','#f85149'); return; }
        }
        importParsedData = parsed.slice(0, 100);
        importRawCsv = null;
      } else {
        importRawCsv = text;
        const lines = text.trim().split('\n');
        if(lines.length < 2){ showToast('CSV has no data rows','#f85149'); return; }
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g,'').toLowerCase());
        importParsedData = [];
        for(let i = 1; i < Math.min(lines.length, 101); i++){
          const vals = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((h, idx) => { row[h] = (vals[idx]||'').trim(); });
          importParsedData.push(row);
        }
      }
      renderImportPreview();
    } catch(err){
      showToast('Failed to parse file: ' + err.message, '#f85149');
    }
  };
  reader.readAsText(file);
}

function parseCSVLine(line){
  const result = [];
  let current = '';
  let inQuotes = false;
  for(let i = 0; i < line.length; i++){
    const ch = line[i];
    if(inQuotes){
      if(ch === '"' && line[i+1] === '"'){ current += '"'; i++; }
      else if(ch === '"'){ inQuotes = false; }
      else { current += ch; }
    } else {
      if(ch === '"'){ inQuotes = true; }
      else if(ch === ','){ result.push(current); current = ''; }
      else { current += ch; }
    }
  }
  result.push(current);
  return result;
}

function renderImportPreview(){
  document.getElementById('importPreview').style.display = '';
  document.getElementById('importResults').style.display = 'none';
  document.getElementById('importPreviewCount').textContent = importParsedData.length + ' claims ready';
  const fieldMap = {
    'full_name': ['full_name','name','claimant_name','claimant','consumer_name'],
    'email': ['email','claimant_email','email_address','consumer_email'],
    'platform': ['platform','respondent','respondent_name','company'],
    'amount': ['amount','claimed_amount','amount_usd','claim_amount'],
    'reason': ['reason','description','claim_reason','narrative']
  };
  function findField(row, candidates){
    for(const c of candidates){ if(row[c] !== undefined && row[c] !== '') return row[c]; }
    const lowerKeys = Object.keys(row).reduce((m,k)=>{ m[k.toLowerCase().replace(/[\s_-]+/g,'_')]=k; return m; },{});
    for(const c of candidates){ if(lowerKeys[c]) return row[lowerKeys[c]]; }
    return '';
  }
  let html = '<table><thead><tr><th>#</th><th>Name</th><th>Email</th><th>Platform</th><th>Amount</th><th>Reason</th><th>Status</th></tr></thead><tbody>';
  importParsedData.forEach((row, i) => {
    const name = findField(row, fieldMap.full_name);
    const email = findField(row, fieldMap.email);
    const platform = findField(row, fieldMap.platform);
    const amount = findField(row, fieldMap.amount);
    const reason = findField(row, fieldMap.reason);
    const errors = [];
    if(!name) errors.push('name');
    if(!email) errors.push('email');
    if(!platform) errors.push('platform');
    if(!amount || isNaN(parseFloat(amount))) errors.push('amount');
    const cls = errors.length > 0 ? ' class="invalid"' : '';
    const statusTd = errors.length > 0
      ? '<span style="color:#f85149;font-size:11px">Missing: ' + errors.join(', ') + '</span>'
      : '<span style="color:#22c55e;font-size:11px">&#x2713; Valid</span>';
    html += '<tr' + cls + '><td>' + (i+1) + '</td><td>' + esc(name) + '</td><td>' + esc(email) + '</td><td>' + esc(platform) + '</td><td>' + esc(amount) + '</td><td>' + esc((reason||'').substring(0,50)) + '</td><td>' + statusTd + '</td></tr>';
  });
  html += '</tbody></table>';
  document.getElementById('importPreviewTable').innerHTML = html;
}

function clearImport(){
  importParsedData = [];
  importRawCsv = null;
  document.getElementById('importPreview').style.display = 'none';
  document.getElementById('importResults').style.display = 'none';
  document.getElementById('importPreviewTable').innerHTML = '';
  document.getElementById('importResultsList').innerHTML = '';
  document.getElementById('importSummary').innerHTML = '';
  document.getElementById('importFileInput').value = '';
}

async function executeImport(){
  if(importParsedData.length === 0){ showToast('No data to import','#f85149'); return; }
  const skipDupes = document.getElementById('importSkipDupes').checked;
  const btn = document.querySelector('#importPreview .btn-primary');
  if(btn){ btn.disabled = true; btn.textContent = 'Importing...'; }
  try {
    let url, body;
    if(importRawCsv){
      url = API_BASE + '/v1/import/csv';
      body = { csv_content: importRawCsv, skip_duplicates: skipDupes };
    } else {
      url = API_BASE + '/v1/import/batch';
      body = { claims: importParsedData, skip_duplicates: skipDupes };
    }
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer operator'}, body:JSON.stringify(body) });
    const data = await r.json();
    if(!r.ok){ showToast('Import failed: ' + (data.detail || 'Unknown error'), '#f85149'); return; }
    renderImportResults(data);
    showToast(data.summary.imported + ' of ' + data.summary.total + ' claims imported!', '#22c55e');
    fetchClaims();
  } catch(e){
    showToast('Import request failed: ' + e.message, '#f85149');
  } finally {
    if(btn){ btn.disabled = false; btn.textContent = '\u{1F680} Import All'; }
  }
}

function renderImportResults(data){
  document.getElementById('importPreview').style.display = 'none';
  document.getElementById('importResults').style.display = '';
  const s = data.summary;
  document.getElementById('importSummary').innerHTML =
    '<div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">' +
    '<div style="padding:8px 14px;background:#161b22;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#c9d1d9">'+s.total+'</div><div style="font-size:10px;color:#6e7681;text-transform:uppercase">Total</div></div>' +
    '<div style="padding:8px 14px;background:#0b2212;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#22c55e">'+s.imported+'</div><div style="font-size:10px;color:#22c55e;text-transform:uppercase">Imported</div></div>' +
    (s.skipped ? '<div style="padding:8px 14px;background:#1c1500;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#f0ad4e">'+s.skipped+'</div><div style="font-size:10px;color:#f0ad4e;text-transform:uppercase">Skipped</div></div>' : '') +
    (s.failed ? '<div style="padding:8px 14px;background:#200b0b;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#f85149">'+s.failed+'</div><div style="font-size:10px;color:#f85149;text-transform:uppercase">Failed</div></div>' : '') +
    '</div>';
  let html = '';
  (data.results || []).forEach((r, i) => {
    const st = r.result || r.status || 'unknown';
    const color = st === 'imported' ? '#22c55e' : st === 'skipped' ? '#f0ad4e' : '#f85149';
    const icon = st === 'imported' ? '&#x2713;' : st === 'skipped' ? '&#x23ED;' : '&#x2717;';
    const detail = r.claim_id || (r.errors ? r.errors.join(', ') : '') || r.reason || '';
    html += '<div class="ir-row" style="background:' + color + '10">' +
      '<span style="color:'+color+';font-weight:700;width:20px;text-align:center">'+icon+'</span>' +
      '<span style="color:#c9d1d9;flex:1">#'+(i+1)+' '+esc(detail)+'</span>' +
      '<span style="color:'+color+';font-size:11px;text-transform:uppercase">'+st+'</span>' +
    '</div>';
  });
  document.getElementById('importResultsList').innerHTML = html;
}

// ===== DASHBOARD (pulls from /v1/stats) =====
async function updateDashboard(){
  try {
    const r = await fetch(API_BASE + '/v1/stats');
    if(!r.ok) throw new Error();
    const s = await r.json();
    document.getElementById('dTotal').textContent = s.total_claims;
    document.getElementById('dClaimed').textContent = '$' + s.total_claimed_usd.toLocaleString();
    document.getElementById('dResolved').textContent = s.resolved;
    document.getElementById('dActive').textContent = s.active;
    document.getElementById('dEscalated').textContent = s.escalated;
    document.getElementById('dRate').textContent = s.resolution_rate + '%';

    // Compute case age metrics from local claims data
    const now = Date.now();
    const activeClaims = allClaims.filter(c => !['resolved','closed'].includes(c.status) && c.filed_at);
    if(activeClaims.length > 0){
      const ages = activeClaims.map(c => Math.floor((now - new Date(c.filed_at).getTime()) / 86400000));
      const avgAge = Math.round(ages.reduce((a,b) => a+b, 0) / ages.length);
      const oldest = Math.max(...ages);
      document.getElementById('dAvgAge').textContent = avgAge;
      document.getElementById('dOldest').textContent = oldest;
    } else {
      document.getElementById('dAvgAge').textContent = 'â€”';
      document.getElementById('dOldest').textContent = 'â€”';
    }

    // Render CCE breakdown panel
    const bp = document.getElementById('cceBreakdown');
    if(bp && s.total_claims > 0){
      let html = '<div class="cce-grid">';
      // Value bands
      html += '<div class="cce-section"><h4>Value Bands</h4>';
      Object.entries(s.value_bands||{}).forEach(([k,v])=>{
        html += '<div class="cce-row"><span class="vb vb-'+k+'">'+k.replace(/_/g,' ')+'</span><strong>'+v+'</strong></div>';
      });
      html += '</div>';
      // Dispute types
      html += '<div class="cce-section"><h4>Dispute Types</h4>';
      Object.entries(s.dispute_types||{}).forEach(([k,v])=>{
        html += '<div class="cce-row"><span style="color:#8b949e">'+k.replace(/_/g,' ')+'</span><strong>'+v+'</strong></div>';
      });
      html += '</div>';
      // Recovery paths
      html += '<div class="cce-section"><h4>Recovery Paths</h4>';
      Object.entries(s.recovery_paths||{}).forEach(([k,v])=>{
        html += '<div class="cce-row"><span style="color:#8b949e">'+k.replace(/_/g,' ')+'</span><strong>'+v+'</strong></div>';
      });
      html += '</div>';
      // Top respondents
      if(Object.keys(s.top_respondents||{}).length > 0){
        html += '<div class="cce-section"><h4>Most Referenced Platforms</h4>';
        html += '<div style="font-size:10px;color:#484f58;margin-bottom:6px;font-style:italic">By claim count. Presence does not imply wrongdoing.</div>';
        Object.entries(s.top_respondents).forEach(([k,v])=>{
          html += '<div class="cce-row"><span style="color:#c9956b">'+k+'</span><strong>'+v+'</strong></div>';
        });
        html += '</div>';
      }
      html += '</div>';
      if(s.triage_queue > 0) html += '<div class="triage-alert" style="display:flex;justify-content:space-between;align-items:center">&#x26A0; '+s.triage_queue+' case(s) need human triage <button class="btn btn-sm" style="background:rgba(248,81,73,.2);color:#f85149;border:1px solid rgba(248,81,73,.4);margin-left:12px;white-space:nowrap" onclick="showTab(\'cases\',document.querySelectorAll(\'.tab\')[1]);document.getElementById(\'filterStatus\').value=\'under_review\';filterCases()">Review Queue</button></div>';
      bp.innerHTML = html;
    }
    // Fetch analytics charts + recovery + SLA in parallel
    fetchAnalytics();
    fetchRecoveryDashboard();
    fetchSlaStatus();
    fetchEscalationQueue();
    fetchOutreachDashboard();
    fetchWorkload();
    fetchResolutionDashboard();
    fetchWorkflowRules();
    fetchDocumentStats();
    fetchNotifBadge();
    fetchCaseGroups();
    fetchAnalytics();
    fetchTriageQueue();
    fetchTagStats();
    fetchDataQuality();
    fetchActivityFeed();
    fetchWebhookStats();
    fetchSavedSearches();
    fetchReminderStats();
    fetchTemplateStats();
    fetchKBStats();
    fetchFinancialDashboard();
    fetchComplianceStats();
    fetchRiskDashboard();
    fetchCorrespondenceStats();
    fetchWatchlist();
    fetchNegotiationStats();
    fetchTaskStats();
    fetchScorecards();
    fetchExportStats();
    fetchMilestoneStats();
    fetchRespondentProfiles();
    fetchSurveyStats();
    fetchPlaybookStats();
    fetchChannelStats();
    fetchBillingStats();
    fetchClaimLinkStats();
    fetchEvidenceStats();
  } catch(e){
    // Fallback: compute from local claims
    const total = allClaims.length;
    const claimed = allClaims.reduce((s,c) => s + (c.amount_claimed_usd||0), 0);
    document.getElementById('dTotal').textContent = total;
    document.getElementById('dClaimed').textContent = '$' + claimed.toLocaleString();
  }
}

// ===== BADGES =====
function updateBadges(){
  const active = allClaims.filter(c => c.status !== 'closed' && c.status !== 'resolved').length;
  const esc = allClaims.filter(c => c.status === 'escalated').length;
  setBadge('badgeCases', allClaims.length, 'blue');
  const needsAction = allClaims.filter(c => !['resolved','closed','draft'].includes(c.status)).length;
  setBadge('badgeFollowups', needsAction, 'copper');
}
function setBadge(id, count, cls){
  const el = document.getElementById(id);
  if(!el) return;
  if(count > 0){el.textContent=count;el.className='badge'+(cls?' '+cls:'');}
  else {el.className='badge hidden';}
}

// ===== SYSTEM HEALTH MONITOR =====
async function fetchHealthCheck(){
  try {
    const r = await fetch(API_BASE + '/v1/health/integrity');
    if(!r.ok) throw new Error();
    const data = await r.json();
    renderHealthBanner(data);
    renderHealthChecks(data);
  } catch(e){
    document.getElementById('healthTitle').textContent = 'System Health';
    document.getElementById('healthSub').textContent = 'Unable to run integrity checks';
    document.getElementById('healthRing').textContent = '?';
    document.getElementById('healthRing').className = 'health-score-ring warning';
  }
}

function renderHealthBanner(data){
  const ring = document.getElementById('healthRing');
  const title = document.getElementById('healthTitle');
  const sub = document.getElementById('healthSub');
  const pills = document.getElementById('healthPills');

  ring.textContent = data.score;
  ring.className = 'health-score-ring ' + data.overall;

  const labels = {healthy:'Healthy',good:'Good',warning:'Warning',degraded:'Degraded'};
  title.textContent = 'System Health: ' + (labels[data.overall] || data.overall);
  sub.textContent = data.summary.total + ' checks run \u2022 ' + data.total_claims + ' claims \u2022 ' + data.total_audit_entries + ' audit entries';

  let ph = '';
  if(data.summary.pass > 0) ph += '<span class="health-pill pass">' + data.summary.pass + ' pass</span>';
  if(data.summary.warn > 0) ph += '<span class="health-pill warn">' + data.summary.warn + ' warn</span>';
  if(data.summary.fail > 0) ph += '<span class="health-pill fail">' + data.summary.fail + ' fail</span>';
  pills.innerHTML = ph;
}

function renderHealthChecks(data){
  const container = document.getElementById('healthChecks');
  const ts = document.getElementById('healthTimestamp');

  const icons = {pass:'\u2713', warn:'\u26A0', fail:'\u2717'};
  let html = '';
  (data.checks || []).forEach(c => {
    html += '<div class="hc-item">';
    html += '<div class="hc-icon ' + c.status + '">' + (icons[c.status]||'?') + '</div>';
    html += '<div class="hc-body">';
    html += '<div class="hc-name">' + c.name + '</div>';
    html += '<div class="hc-desc">' + c.description + '</div>';
    html += '<div class="hc-detail">' + c.detail + '</div>';
    // Show issues if any
    const issues = c.issues || c.missing || [];
    if(issues.length > 0){
      html += '<div style="margin-top:4px;font-size:10px;color:#f85149">';
      issues.slice(0, 3).forEach(iss => {
        if(typeof iss === 'string') html += iss + ' ';
        else if(iss.claim_id) html += iss.claim_id.substring(0,12) + '... ';
        else if(iss.referral_id) html += iss.referral_id.substring(0,12) + '... ';
      });
      if(issues.length > 3) html += '(+' + (issues.length - 3) + ' more)';
      html += '</div>';
    }
    html += '</div></div>';
  });
  container.innerHTML = html;
  ts.textContent = 'Last checked: ' + new Date(data.checked_at).toLocaleString() + ' \u2022 Click banner to ' + (document.getElementById('healthDetail').classList.contains('open') ? 'collapse' : 'expand');
}

function toggleHealthDetail(){
  const detail = document.getElementById('healthDetail');
  detail.classList.toggle('open');
  const ts = document.getElementById('healthTimestamp');
  if(ts) ts.textContent = ts.textContent.replace(/Click banner to \w+/, 'Click banner to ' + (detail.classList.contains('open') ? 'collapse' : 'expand'));
}

// ===== TEMPLATES =====
function toggleTpl(header){ header.nextElementSibling.classList.toggle('open'); }
function copyText(btn){
  if(!confirm('Before copying, confirm:\n\n\u2714 This message does not threaten, impersonate, or guarantee outcomes\n\u2714 It is sent solely to request information or clarification\n\nProceed?')) return;
  const pre = btn.closest('.tpl-body').querySelector('pre');
  navigator.clipboard.writeText(pre.textContent).then(()=>{
    btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy to clipboard',2000);
    console.log('[AUDIT] Template copied to clipboard ts='+new Date().toISOString());
  });
}

// ===== TWEETS =====
const TWEETS = [
  "If a platform shows \"payment pending\" for extended periods, it's important to document the delay and follow up through formal support channels.",
  "Many unresolved disputes stall after initial support contact. Keeping records and following up consistently often makes the difference.",
  "Documentation and calm escalation beat arguing every single time. Save every screenshot. Log every ticket number. Process wins.",
  "Consistent, documented follow-up often leads to clearer responses than one-off messages. Set reminders. Stay organized.",
  "Deactivated accounts may still have balances pending review. Understanding platform policies helps users ask better questions about held funds.",
  "\"3\u20135 business days\" is common language in support timelines. Tracking when those windows pass helps guide your next steps.",
  "Understanding consumer protection frameworks can help users communicate more clearly and professionally when resolving disputes.",
  "Chargebacks are one option, but many payment disputes resolve through internal escalation \u2014 if you know the right steps and stay calm.",
  "Periodically reviewing held balances can help merchants catch issues early. If you process payments, audit your reserves quarterly.",
  "Persistence and organization are often the deciding factors in complex support processes. Stay patient. Stay documented."
];
function renderTweets(){
  const c = document.getElementById('tweetsContainer');
  TWEETS.forEach((t,i)=>{
    c.innerHTML +=
      '<div class="tweet-card"><div class="tweet-num">#'+(i+1)+'</div>' +
      '<div class="handle">@GhostLedger</div>' +
      '<div class="tweet-text">'+t+'</div>' +
      '<div class="tweet-meta"><span class="char-count">'+t.length+'/280</span>' +
      '<button class="btn btn-ghost btn-sm" onclick="copyTweet(this)">Copy</button></div></div>';
  });
}
function copyTweet(btn){
  if(!confirm('Before posting, confirm:\n\n\u2714 This content is informational and non-accusatory\n\u2714 It does not attribute intent or name regulators as leverage\n\nProceed?')) return;
  const text = btn.closest('.tweet-card').querySelector('.tweet-text').textContent;
  navigator.clipboard.writeText(text).then(()=>{
    btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',2000);
    console.log('[AUDIT] Tweet copied to clipboard ts='+new Date().toISOString());
  });
}

// ===== GENERATE LETTER (with compliance checklist) =====
let _pendingLetterClaimId = null;
let _pendingLetterTemplate = null;

function generateLetter(claimId, template){
  _pendingLetterClaimId = claimId;
  _pendingLetterTemplate = template;
  const labels = {initial:'Initial Payment Inquiry', second:'Follow-Up Request', compliance:'Compliance Reference'};
  const label = labels[template] || template;
  document.getElementById('complianceLetterLabel').textContent = label;
  // Reset all checkboxes
  document.querySelectorAll('#complianceModal input[type=checkbox]').forEach(cb => cb.checked = false);
  document.getElementById('complianceGenBtn').disabled = true;
  document.getElementById('complianceGenBtn').style.opacity = '0.4';
  document.getElementById('complianceModal').style.display = 'flex';
}

function complianceCheckChanged(){
  const boxes = document.querySelectorAll('#complianceModal input[type=checkbox]');
  const allChecked = Array.from(boxes).every(cb => cb.checked);
  const btn = document.getElementById('complianceGenBtn');
  btn.disabled = !allChecked;
  btn.style.opacity = allChecked ? '1' : '0.4';
}

function complianceConfirm(){
  if(!_pendingLetterClaimId || !_pendingLetterTemplate) return;
  const url = API_BASE + '/v1/claims/' + _pendingLetterClaimId + '/letter/' + _pendingLetterTemplate;
  console.log('[AUDIT] Letter generated: claim='+_pendingLetterClaimId+' template='+_pendingLetterTemplate+' compliance_checklist=passed ts='+new Date().toISOString());
  window.open(url, '_blank');
  document.getElementById('complianceModal').style.display = 'none';
  _pendingLetterClaimId = null;
  _pendingLetterTemplate = null;
}

function complianceCancel(){
  document.getElementById('complianceModal').style.display = 'none';
  _pendingLetterClaimId = null;
  _pendingLetterTemplate = null;
}

// ===== RECLASSIFY ALL =====
async function reclassifyAll(){
  if(!confirm('This will reclassify all '+allClaims.length+' claims through the CCE engine. Existing classifications will be overwritten.\n\nProceed?')) return;
  const el = document.getElementById('reclassifyStatus');
  el.style.display='block'; el.style.background='rgba(251,191,36,.1)'; el.style.color='#fbbf24';
  el.textContent = 'Reclassifying all claims...';
  try {
    const r = await fetch(API_BASE + '/v1/reclassify-all', {method:'POST'});
    const data = await r.json();
    el.style.background='rgba(74,222,128,.1)'; el.style.color='#4ade80';
    el.textContent = data.message;
    fetchClaims();
    setTimeout(()=>{el.style.display='none'},4000);
  } catch(e){
    el.style.background='rgba(248,81,73,.1)'; el.style.color='#f85149';
    el.textContent = 'Reclassification failed';
  }
}

// ===== CASE DETAIL DRAWER =====
async function openCase(claimId){
  const drawer = document.getElementById('caseDrawer');
  const body = document.getElementById('drawerBody');
  document.getElementById('drawerTitle').textContent = claimId;
  body.innerHTML = '<div style="color:#484f58;text-align:center;padding:40px">Loading...</div>';
  drawer.classList.add('open');
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/timeline');
    const data = await r.json();
    const c = data.claim;
    const cc = c.classification || {};

    // === STATUS EXPLAINERS ===
    const statusExplainers = {
      draft: 'Draft â€” not yet submitted.',
      filed: 'Filed â€” claim received and awaiting professional review.',
      under_review: 'Under Review â€” being evaluated by the coordination team.',
      awaiting_review: 'Awaiting Review â€” queued for independent professional assessment.',
      escalated: 'Escalated â€” elevated for additional follow-up or professional referral.',
      in_resolution: 'In Resolution â€” active negotiation or dispute process underway.',
      resolved: 'Resolved â€” outcome reached and documented.',
      closed: 'Closed â€” case finalized.',
      appealed: 'Appealed â€” outcome contested, under re-evaluation.'
    };

    // === EMAIL MASKING ===
    function maskEmail(email){
      if(!email || email === 'â€”') return 'â€”';
      const parts = email.split('@');
      if(parts.length !== 2) return '***';
      return parts[0].charAt(0) + '***@' + parts[1];
    }

    let html = '<div class="detail-grid">';
    html += '<div class="detail-item"><div class="label">Claimant</div><div class="value">'+(c.claimant_name||'â€”')+'</div></div>';
    // Masked email with reveal toggle
    const rawEmail = c.claimant_email || 'â€”';
    const masked = maskEmail(rawEmail);
    html += '<div class="detail-item"><div class="label">Email</div><div class="value"><span id="emailDisplay">'+masked+'</span> <button class="btn-sm" style="background:none;border:1px solid #30363d;color:#6e7681;padding:2px 6px;font-size:10px;border-radius:4px;cursor:pointer;margin-left:4px" onclick="var el=document.getElementById(\'emailDisplay\');if(el.textContent.includes(\'***\')){el.textContent=\''+rawEmail.replace(/'/g,"\\'")+'\';this.textContent=\'Hide\'}else{el.textContent=\''+masked.replace(/'/g,"\\'")+'\';this.textContent=\'Reveal\'}">Reveal</button></div></div>';
    html += '<div class="detail-item"><div class="label">Respondent</div><div class="value">'+(c.respondent_entity||'â€”')+'</div></div>';
    html += '<div class="detail-item"><div class="label">Amount</div><div class="value">$'+(c.amount_claimed_usd||0).toLocaleString()+'</div></div>';
    // Status with explainer
    const st = c.status || 'draft';
    html += '<div class="detail-item"><div class="label">Status</div><div class="value"><span class="status s-'+st+'">'+st.replace(/_/g,' ')+'</span><div style="font-size:10px;color:#484f58;margin-top:4px;line-height:1.3">'+(statusExplainers[st]||'Status reflects system state, not legal outcome.')+'</div></div></div>';
    html += '<div class="detail-item"><div class="label">Filed</div><div class="value">'+(c.filed_at ? new Date(c.filed_at).toLocaleString() : 'â€”')+'</div></div>';
    // SLA Deadline
    if(c.sla_status && c.sla_status !== 'n/a'){
      const slaColors = {on_track:'#4ade80',at_risk:'#fbbf24',breached:'#f85149'};
      const slaLabels = {on_track:'On Track',at_risk:'At Risk',breached:'Breached'};
      const slaColor = slaColors[c.sla_status] || '#6e7681';
      const slaRemaining = c.sla_days_remaining;
      const remText = slaRemaining > 0 ? slaRemaining.toFixed(1)+' days remaining' : Math.abs(slaRemaining).toFixed(1)+' days overdue';
      const barPct = Math.min(((c.sla_max_days - (slaRemaining > 0 ? slaRemaining : 0)) / c.sla_max_days * 100), 100);
      html += '<div class="detail-item"><div class="label">SLA Deadline</div><div class="value">';
      html += '<span style="font-weight:700;color:'+slaColor+'">'+slaLabels[c.sla_status]+'</span> â€” '+remText;
      html += '<div style="height:6px;background:#21262d;border-radius:3px;margin-top:4px;overflow:hidden"><div style="height:100%;width:'+barPct+'%;background:'+slaColor+';border-radius:3px"></div></div>';
      html += '<div style="font-size:10px;color:#484f58;margin-top:3px">Target: '+c.sla_max_days+' days in <em>'+st.replace(/_/g,' ')+'</em> status</div>';
      html += '</div></div>';
    }
    // CCE Classification
    if(cc.value_band){
      html += '<div class="detail-item"><div class="label">Value Band</div><div class="value"><span class="vb vb-'+cc.value_band+'">'+cc.value_band.replace(/_/g,' ')+'</span></div></div>';
      html += '<div class="detail-item"><div class="label">Dispute Type</div><div class="value">'+(cc.dispute_type||'â€”').replace(/_/g,' ')+'</div></div>';
      html += '<div class="detail-item"><div class="label">Initial Routing Assessment</div><div class="value">'+(cc.recovery_path||'â€”').replace(/_/g,' ')+'<div style="font-size:10px;color:#484f58;margin-top:3px;line-height:1.3;font-style:italic">Non-binding. May change after professional review.</div></div></div>';
      html += '<div class="detail-item"><div class="label">Complexity</div><div class="value">'+(cc.complexity_score||'â€”')+'/5'+(cc.requires_human_triage?' <span style="color:#f85149">(TRIAGE)</span>':'')+'</div></div>';
    }
    html += '<div class="detail-item full"><div class="label">Description</div><div class="value" style="font-size:13px;color:#8b949e">'+(c.description||'â€”')+'</div></div>';
    // Assignment
    html += '<div class="detail-item"><div class="label">Assigned To</div><div class="value"><span id="assignDisplay">'+(c.assigned_name ? '<span class="assign-badge">&#x1F464; '+esc(c.assigned_name)+'</span>' : '<span class="assign-badge unassigned">Unassigned</span>')+'</span></div></div>';
    html += '</div>';

    // Assignment controls
    html += '<div class="assign-section"><label>Assign / Reassign Case</label>';
    html += '<div style="display:flex;gap:6px;align-items:center">';
    html += '<select id="assignSelect" style="flex:1"><option value="">â€” Select operator â€”</option></select>';
    html += '<button class="btn btn-primary btn-sm" onclick="assignClaim(\''+claimId+'\')" style="white-space:nowrap">Assign</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="autoAssignClaim(\''+claimId+'\')" title="Auto-assign to operator with most capacity" style="white-space:nowrap">&#x26A1; Auto</button>';
    if(c.assigned_to) html += '<button class="btn btn-ghost btn-sm" onclick="unassignClaim(\''+claimId+'\')" style="white-space:nowrap;color:#f85149">&#x2717;</button>';
    html += '</div></div>';
    // Action buttons (confirmations handled in generateLetter)
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px">';
    html += '<button class="btn btn-ghost btn-sm" onclick="openTransitionModal(\''+claimId+'\')">&#x1F504; Change Status</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="reclassifySingle(\''+claimId+'\')">&#x1F504; Reclassify</button>';
    html += '<button class="btn btn-primary btn-sm" onclick="generateLetter(\''+claimId+'\',\'initial\')">&#x1F4E8; Payment Inquiry</button>';
    html += '<button class="btn btn-primary btn-sm" style="background:#fbbf24;color:#0a0e14" onclick="generateLetter(\''+claimId+'\',\'second\')">&#x1F4E8; Follow-Up</button>';
    html += '<button class="btn btn-primary btn-sm" style="background:#f85149" onclick="generateLetter(\''+claimId+'\',\'compliance\')">&#x1F4E8; Compliance Ref</button>';
    html += '<button class="btn btn-primary btn-sm" style="background:#38bdf8;color:#0a0e14" onclick="closeDrawer();openReferModal(\''+claimId+'\')">&#x1F91D; Refer to ILF</button>';
    html += '</div>';

    // Recovery Tracking Panel
    html += '<div class="recovery-section"><h4>&#x1F4B0; Recovery Tracking</h4><div id="recoveryPanel"><div style="color:#484f58;text-align:center;padding:12px;font-size:12px">Loading recovery data...</div></div></div>';

    // Outreach & Communication Panel
    html += '<div class="outreach-section"><h4>&#x1F4E8; Outreach &amp; Communications</h4>';
    html += '<div class="outreach-log" id="outreachLog"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading outreach history...</div></div>';
    html += '<div style="margin-top:8px"><button class="btn btn-primary btn-sm" onclick="openOutreachComposer(\''+claimId+'\')" style="width:100%;background:#c9956b;color:#0a0e14;font-weight:700">&#x270F; Compose Outreach</button></div>';
    html += '<div id="outreachComposer" style="display:none"></div>';
    html += '</div>';

    // Settlement & Resolution Panel
    html += '<div class="settlement-section"><h4>&#x2696;&#xFE0F; Settlement &amp; Resolution</h4>';
    html += '<div id="settlementPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading settlement data...</div></div>';
    html += '<div style="margin-top:8px;display:flex;gap:6px">';
    html += '<button class="btn btn-primary btn-sm" onclick="openSettlementForm(\''+claimId+'\')" style="flex:1;background:#d2a8ff;color:#0a0e14;font-weight:700">&#x1F4DD; Record Offer</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="openDirectResolve(\''+claimId+'\')" style="flex:1">&#x2705; Resolve Directly</button>';
    html += '</div>';
    html += '<div id="settlementForm" style="display:none"></div>';
    html += '<div id="resolveForm" style="display:none"></div>';
    html += '</div>';

    // Tags Panel
    html += '<div class="group-section"><h4>&#x1F3F7; Tags</h4>';
    html += '<div id="claimTagsPanel"><div style="color:#484f58;text-align:center;padding:6px;font-size:11px">Loading tags...</div></div>';
    html += '<div class="tw-add-form" style="margin-top:6px">';
    html += '<input type="text" id="claimTagInput" placeholder="Add tag..." onkeydown="if(event.key===\'Enter\')addTagToClaim(\''+claimId+'\')">';
    html += '<button class="btn btn-primary btn-sm" onclick="addTagToClaim(\''+claimId+'\')" style="background:#ffd33d;color:#0a0e14;font-weight:700;font-size:10px">+ Tag</button>';
    html += '</div></div>';

    // Priority Score Panel
    html += '<div class="group-section"><h4>&#x1F6A8; Priority Score</h4>';
    html += '<div id="claimPriorityPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Computing priority...</div></div>';
    html += '</div>';

    // Case Groups Panel
    html += '<div class="group-section"><h4>&#x1F517; Case Groups</h4>';
    html += '<div id="claimGroupsPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading groups...</div></div>';
    html += '</div>';

    // Watchlist toggle button
    html += '<div style="margin-bottom:8px;text-align:right"><button id="watchToggleBtn" data-claim="'+claimId+'" style="background:rgba(255,211,61,.1);color:#ffd33d;border:1px solid rgba(255,211,61,.3);border-radius:6px;padding:5px 12px;font-size:11px;font-weight:600;cursor:pointer" onclick="toggleWatchClaim(\''+claimId+'\')">&#x2B50; Watch</button></div>';

    // Activity Timeline Panel
    html += '<div class="group-section"><h4>&#x23F1; Activity Timeline</h4>';
    html += '<div id="claimTimelinePanel" class="drawer-tl"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading timeline...</div></div>';
    html += '</div>';

    // Reminders Panel (in drawer)
    html += '<div class="drawer-rem"><h4>&#x23F0; Reminders</h4>';
    html += '<div id="claimRemindersPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading reminders...</div></div>';
    html += '<div style="margin-top:8px;display:flex;gap:6px">';
    html += '<button class="rem-quick-btn" onclick="createClaimReminder(\''+claimId+'\',1)">Tomorrow</button>';
    html += '<button class="rem-quick-btn" onclick="createClaimReminder(\''+claimId+'\',3)">3 days</button>';
    html += '<button class="rem-quick-btn" onclick="createClaimReminder(\''+claimId+'\',7)">1 week</button>';
    html += '<button class="rem-quick-btn" onclick="createClaimReminder(\''+claimId+'\',30)">1 month</button>';
    html += '</div>';
    html += '</div>';

    // Compliance Checks Panel (in drawer)
    html += '<div class="comp-drawer"><h4 style="margin:0 0 8px;font-size:13px;color:#e6edf3">&#x2696;&#xFE0F; Compliance Checks</h4>';
    html += '<div id="claimCompliancePanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading compliance...</div></div>';
    html += '<div style="margin-top:8px;display:flex;gap:6px">';
    html += '<button style="background:#1f6feb;color:#fff;border:none;border-radius:4px;padding:4px 10px;font-size:10px;font-weight:600;cursor:pointer" onclick="runClaimComplianceCheck(\''+claimId+'\')">Run Checks</button>';
    html += '</div>';
    html += '</div>';

    // Risk Assessment Panel (in drawer)
    html += '<div style="background:#0d1117;border:1px solid #1c2129;border-radius:8px;padding:12px;margin-top:10px">';
    html += '<h4 style="margin:0 0 8px;font-size:13px;color:#e6edf3">&#x1F3AF; Risk Score</h4>';
    html += '<div id="claimRiskPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading risk...</div></div>';
    html += '</div>';

    // Negotiation Panel (in drawer)
    html += '<div class="neg-drawer"><h4 style="margin:0 0 8px;font-size:13px;color:#e6edf3">&#x1F91D; Negotiations</h4>';
    html += '<div id="claimNegPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading negotiations...</div></div>';
    html += '<div style="margin-top:8px"><button class="neg-add-btn" onclick="promptNewNegotiation(\''+claimId+'\')">+ New Offer</button></div>';
    html += '</div>';

    // Correspondence Panel (in drawer)
    html += '<div class="corr-drawer"><h4 style="margin:0 0 8px;font-size:13px;color:#e6edf3">&#x1F4E8; Correspondence</h4>';
    html += '<div id="claimCorrPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading correspondence...</div></div>';
    html += '<div style="margin-top:8px"><button style="background:#1f6feb;color:#fff;border:none;border-radius:4px;padding:4px 10px;font-size:10px;font-weight:600;cursor:pointer" onclick="showCreateCorrModalForClaim(\''+claimId+'\')">+ New Message</button></div>';
    html += '</div>';

    // Task Queue Panel (in drawer)
    html += '<div class="tq-drawer"><h4 style="margin:0 0 8px;font-size:13px;color:#e6edf3">&#x1F4CB; Tasks</h4>';
    html += '<div id="claimTaskPanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading tasks...</div></div>';
    html += '<div style="margin-top:8px"><button class="tq-add-btn" onclick="promptNewTaskForClaim(\''+claimId+'\')">+ Add Task</button></div>';
    html += '</div>';

    // Milestones Panel (in drawer)
    html += '<div class="ms-drawer"><h4 style="margin:0 0 8px;font-size:13px;color:#e6edf3">&#x1F3AF; Milestones</h4>';
    html += '<div id="claimMilestonePanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading milestones...</div></div>';
    html += '</div>';

    // Evidence & Documents Panel
    html += '<div class="evidence-section"><h4>&#x1F4CE; Evidence &amp; Documents</h4>';
    html += '<div id="evidencePanel"><div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Loading documents...</div></div>';
    html += '<div style="margin-top:8px;display:flex;gap:6px">';
    html += '<button class="btn btn-primary btn-sm" onclick="openUploadForm(\''+claimId+'\')" style="flex:1;background:#58a6ff;color:#0a0e14;font-weight:700">&#x1F4CE; Upload Document</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="loadClaimDocuments(\''+claimId+'\')" style="flex:1">&#x1F504; Refresh</button>';
    html += '</div>';
    html += '<div id="uploadForm" style="display:none"></div>';
    html += '</div>';

    // Timeline with letter event deduplication/versioning
    html += '<h4 style="margin-top:20px;font-size:13px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px">Event Timeline ('+data.total_events+' events)</h4>';
    html += '<div class="timeline">';

    // Count letter versions for versioning display
    const letterVersions = {};
    ((data.timeline||data.events)||[]).forEach(rawEv => {
      const ev = {topic: rawEv.topic||rawEv.summary||rawEv.event_type, timestamp: rawEv.timestamp, payload: rawEv.payload||rawEv.detail||{}};
      if(ev.topic && ev.topic.includes('letter.generated')){
        const tpl = (ev.payload && ev.payload.template) || 'unknown';
        letterVersions[tpl] = (letterVersions[tpl] || 0) + 1;
      }
    });
    const letterSeen = {};

    ((data.timeline||data.events)||[]).forEach(rawEv2 => {
      const ev = {topic: rawEv2.topic||rawEv2.summary||rawEv2.event_type, timestamp: rawEv2.timestamp, payload: rawEv2.payload||rawEv2.detail||{}};
      const isLetter = ev.topic && ev.topic.includes('letter.generated');
      const tpl = isLetter ? ((ev.payload && ev.payload.template) || 'unknown') : null;

      // For letter events: version them, skip older duplicates
      if(isLetter){
        letterSeen[tpl] = (letterSeen[tpl] || 0) + 1;
        // Show all but label with version
        const vNum = letterSeen[tpl];
        const vTotal = letterVersions[tpl] || 1;
        var topicLabel = 'letter.generated (' + tpl + ' v' + vNum + (vTotal > 1 ? '/' + vTotal : '') + ')';
      }

      const cls = ev.topic.includes('intake') ? 'intake' : ev.topic.includes('status') ? 'status' : ev.topic.includes('classified') ? 'classified' : '';
      const time = new Date(ev.timestamp).toLocaleString();
      const topicShort = isLetter ? topicLabel : ev.topic.split('.').slice(-2).join('.');
      let detail = '';
      if(ev.payload.old_status) detail = ev.payload.old_status + ' &rarr; ' + ev.payload.new_status;
      else if(ev.payload.classification) detail = 'Band: ' + (ev.payload.classification.value_band||'') + ' | Path: ' + (ev.payload.classification.recovery_path||'');
      else if(ev.payload.amount) detail = '$' + ev.payload.amount.toLocaleString() + ' vs ' + (ev.payload.platform||ev.payload.respondent||'');
      else if(isLetter) detail = 'Template: ' + tpl;
      html += '<div class="tl-event '+cls+'"><span class="tl-time">'+time+'</span><div class="tl-topic">'+topicShort+'</div><div class="tl-detail">'+detail+'</div></div>';
    });
    if(!(data.timeline||data.events)||!(data.timeline||data.events).length) html += '<div style="color:#484f58;padding:12px">No events recorded yet.</div>';
    html += '</div>';

    // Notes section with structured categories
    html += '<h4 style="margin-top:20px;font-size:13px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px">Case Notes</h4>';
    html += '<div id="notesSection" data-claim="'+claimId+'"></div>';
    html += '<div style="margin-top:10px">';
    html += '<div style="display:flex;gap:6px;margin-bottom:6px">';
    html += '<select id="noteCategory" style="width:180px;background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:4px 8px;font-size:11px">';
    html += '<option value="">(no tag)</option>';
    html += '<option value="INTAKE">INTAKE</option>';
    html += '<option value="REVIEW">REVIEW</option>';
    html += '<option value="OUTREACH">OUTREACH</option>';
    html += '<option value="ESCALATION">ESCALATION</option>';
    html += '<option value="PROFESSIONAL FEEDBACK">PROFESSIONAL FEEDBACK</option>';
    html += '<option value="INTERNAL">INTERNAL</option>';
    html += '</select>';
    html += '</div>';
    html += '<textarea id="noteInput" placeholder="Add a note..." style="width:100%;background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:8px;font-size:13px;resize:vertical;min-height:60px;font-family:inherit"></textarea>';
    html += '</div>';
    html += '<button class="btn btn-primary" style="margin-top:6px;width:100%" onclick="addNote(\''+claimId+'\')">Add Note</button>';

    body.innerHTML = html;
    loadNotes(claimId);
    loadClaimRecoveries(claimId);
    loadClaimOutreach(claimId);
    loadClaimSettlements(claimId);
    loadClaimDocuments(claimId);
    loadClaimGroups(claimId);
    loadClaimPriority(claimId);
    loadClaimTags(claimId);
    loadClaimTimeline(claimId);
    loadClaimReminders(claimId);
    loadClaimCompliance(claimId);
    loadClaimRisk(claimId);
    loadClaimCorrespondence(claimId);
    checkWatchStatus(claimId);
    loadClaimNegotiations(claimId);
    loadClaimTasks(claimId);
    loadClaimMilestones(claimId);
    populateAssignSelects();
  } catch(e){
    body.innerHTML = '<div style="color:#f85149;text-align:center;padding:40px">Failed to load case details</div>';
  }
}

async function reclassifySingle(claimId){
  try {
    await fetch(API_BASE + '/v1/claims/' + claimId + '/reclassify', {method:'POST'});
    openCase(claimId); // reload
    fetchClaims(); // refresh table
  } catch(e){ console.error('Reclassify failed', e); }
}

async function loadNotes(claimId){
  const el = document.getElementById('notesSection');
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/notes');
    const data = await r.json();
    if(!data.notes || !data.notes.length){
      el.innerHTML = '<div style="color:#484f58;padding:8px;font-size:13px">No notes yet.</div>';
      return;
    }
    let html = '';
    data.notes.forEach(n => {
      const time = new Date(n.created_at).toLocaleString();
      html += '<div style="padding:8px 10px;margin:6px 0;background:#161b22;border:1px solid #1c2129;border-radius:6px">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:11px;color:#c9956b;font-weight:600">'+n.author+'</span><span style="font-size:10px;color:#484f58">'+time+'</span></div>';
      html += '<div style="font-size:13px;color:#c9d1d9;line-height:1.5">'+n.content+'</div></div>';
    });
    el.innerHTML = html;
  } catch(e){ el.innerHTML = '<div style="color:#f85149;font-size:13px">Failed to load notes</div>'; }
}

async function addNote(claimId){
  const input = document.getElementById('noteInput');
  const catEl = document.getElementById('noteCategory');
  const rawContent = input.value.trim();
  if(!rawContent) return;
  const tag = catEl ? catEl.value : '';
  const content = tag ? '[' + tag + '] ' + rawContent : rawContent;
  try {
    await fetch(API_BASE + '/v1/claims/' + claimId + '/notes', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({content: content, author: 'operator'})
    });
    input.value = '';
    if(catEl) catEl.value = '';
    loadNotes(claimId);
  } catch(e){ console.error('Add note failed', e); }
}

function closeDrawer(){ document.getElementById('caseDrawer').classList.remove('open'); }

// ===== OUTREACH & COMMUNICATION ENGINE =====
let outreachTemplates = [];

async function loadClaimOutreach(claimId){
  const el = document.getElementById('outreachLog');
  if(!el) return;
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/outreach');
    const data = await r.json();
    if(!data.outreach || !data.outreach.length){
      el.innerHTML = '<div style="color:#484f58;padding:8px;font-size:12px">No outreach communications yet. Click below to compose.</div>';
      return;
    }
    let html = '';
    data.outreach.forEach(o => {
      const time = new Date(o.created_at).toLocaleString();
      const statusCls = o.status || 'drafted';
      html += '<div class="outreach-entry">' +
        '<div class="oe-header">' +
          '<span class="oe-subject">' + esc(o.subject || '(No subject)') + '</span>' +
          '<span class="oe-status ' + statusCls + '">' + statusCls.replace(/_/g,' ') + '</span>' +
        '</div>' +
        '<div class="oe-meta">' +
          '<span class="oe-channel">' + esc(o.channel) + '</span>' +
          (o.recipient ? '<span>To: ' + esc(o.recipient) + '</span>' : '') +
          '<span>' + time + '</span>' +
        '</div>' +
      '</div>';
    });
    el.innerHTML = html;
  } catch(e){
    el.innerHTML = '<div style="color:#f85149;font-size:12px">Failed to load outreach history</div>';
  }
}

async function openOutreachComposer(claimId){
  const container = document.getElementById('outreachComposer');
  if(!container) return;
  if(container.style.display !== 'none'){
    container.style.display = 'none';
    return;
  }
  container.style.display = '';

  // Load templates if not cached
  if(!outreachTemplates.length){
    try {
      const r = await fetch(API_BASE + '/v1/outreach/templates');
      const data = await r.json();
      outreachTemplates = data.templates || [];
    } catch(e){ outreachTemplates = []; }
  }

  let tplOptions = '<option value="">â€” Select a template â€”</option>';
  outreachTemplates.forEach(t => {
    tplOptions += '<option value="' + t.template_id + '">' + esc(t.name) + ' (' + t.category.replace(/_/g,' ') + ')</option>';
  });

  container.innerHTML = '<div class="outreach-compose">' +
    '<label style="font-size:11px;color:#6e7681;margin-bottom:2px;display:block">Template</label>' +
    '<select id="ocTemplate" onchange="renderOutreachTemplate(\'' + claimId + '\')">' + tplOptions + '</select>' +
    '<label style="font-size:11px;color:#6e7681;margin-bottom:2px;display:block">Channel</label>' +
    '<select id="ocChannel"><option value="email">Email</option><option value="letter">Formal Letter</option><option value="phone">Phone Call</option><option value="portal">Platform Portal</option></select>' +
    '<label style="font-size:11px;color:#6e7681;margin-bottom:2px;display:block">Recipient</label>' +
    '<input type="text" id="ocRecipient" placeholder="e.g., support@company.com">' +
    '<label style="font-size:11px;color:#6e7681;margin-bottom:2px;display:block">Subject</label>' +
    '<input type="text" id="ocSubject" placeholder="Subject line...">' +
    '<label style="font-size:11px;color:#6e7681;margin-bottom:2px;display:block">Body</label>' +
    '<textarea id="ocBody" placeholder="Select a template to auto-fill, or type your message..."></textarea>' +
    '<div id="ocPreview"></div>' +
    '<div class="oc-actions">' +
      '<button class="btn btn-ghost btn-sm" onclick="document.getElementById(\'outreachComposer\').style.display=\'none\'">Cancel</button>' +
      '<button class="btn btn-primary btn-sm" onclick="sendOutreach(\'' + claimId + '\',\'drafted\')" style="background:#30363d;color:#c9d1d9">Save Draft</button>' +
      '<button class="btn btn-primary btn-sm" onclick="sendOutreach(\'' + claimId + '\',\'sent\')" style="background:#22c55e;color:#0a0e14;font-weight:700">&#x2709; Mark as Sent</button>' +
    '</div>' +
  '</div>';
}

async function renderOutreachTemplate(claimId){
  const tplId = document.getElementById('ocTemplate').value;
  if(!tplId){ document.getElementById('ocSubject').value = ''; document.getElementById('ocBody').value = ''; return; }
  try {
    const r = await fetch(API_BASE + '/v1/outreach/render', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({template_id: tplId, claim_id: claimId})
    });
    const data = await r.json();
    document.getElementById('ocSubject').value = data.subject || '';
    document.getElementById('ocBody').value = data.body || '';
  } catch(e){
    showToast('Failed to render template', '#f85149');
  }
}

async function sendOutreach(claimId, status){
  const tplEl = document.getElementById('ocTemplate');
  const channel = document.getElementById('ocChannel').value;
  const recipient = document.getElementById('ocRecipient').value.trim();
  const subject = document.getElementById('ocSubject').value.trim();
  const body = document.getElementById('ocBody').value.trim();
  if(!body){ showToast('Outreach body is required', '#f85149'); return; }
  try {
    const r = await fetch(API_BASE + '/v1/outreach/send', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({
        claim_id: claimId,
        template_id: tplEl ? tplEl.value : null,
        channel: channel,
        recipient: recipient,
        subject: subject,
        body: body,
        status: status
      })
    });
    if(!r.ok) throw new Error();
    document.getElementById('outreachComposer').style.display = 'none';
    showToast(status === 'sent' ? 'Outreach marked as sent!' : 'Draft saved!', status === 'sent' ? '#22c55e' : '#c9956b');
    loadClaimOutreach(claimId);
    fetchOutreachDashboard();
  } catch(e){
    showToast('Failed to send outreach', '#f85149');
  }
}

async function fetchOutreachDashboard(){
  try {
    const [statsR, tplR] = await Promise.all([
      fetch(API_BASE + '/v1/outreach/stats'),
      fetch(API_BASE + '/v1/outreach/templates')
    ]);
    const stats = await statsR.json();
    const tplData = await tplR.json();

    const dash = document.getElementById('outreachDash');
    if(stats.total > 0 || tplData.total > 0) dash.style.display = '';

    document.getElementById('odTotal').textContent = stats.sent || 0;
    document.getElementById('odDrafted').textContent = stats.drafted || 0;
    const responded = stats.by_channel ? Object.values(stats.by_channel).reduce((s,v)=>s+v,0) - (stats.sent||0) - (stats.drafted||0) : 0;
    document.getElementById('odResponded').textContent = Math.max(0, responded);
    document.getElementById('odTemplates').textContent = tplData.total || 0;

    // Recent outreach list
    const recentEl = document.getElementById('outreachRecentList');
    if(!stats.recent || !stats.recent.length){
      recentEl.innerHTML = '<div style="color:#484f58;text-align:center;padding:8px;font-size:12px">No outreach activity yet. Compose from a case drawer.</div>';
    } else {
      let html = '';
      stats.recent.forEach(o => {
        const time = new Date(o.created_at).toLocaleString();
        const statusCls = o.status || 'drafted';
        html += '<div class="or-item" onclick="openCase(\'' + o.claim_id + '\')" style="cursor:pointer">' +
          '<span class="oe-status ' + statusCls + '">' + statusCls.replace(/_/g,' ') + '</span>' +
          '<span style="flex:1;color:#c9d1d9;font-size:12px">' + esc(o.subject || '(No subject)') + '</span>' +
          '<span style="font-size:10px;color:#484f58">' + o.claim_id.substring(0,12) + '</span>' +
          '<span style="font-size:10px;color:#484f58">' + time + '</span>' +
        '</div>';
      });
      recentEl.innerHTML = html;
    }
  } catch(e){
    console.log('Outreach dashboard load failed', e);
  }
}

// ===== REPORTS & EXPORT ENGINE =====

async function generateReport(type){
  const container = document.getElementById('reportContent');
  container.innerHTML = '<div style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px">&#x23F3;</div><div style="color:#8b949e;font-size:13px">Generating report...</div></div>';
  try {
    let url;
    if(type === 'executive') url = API_BASE + '/v1/reports/executive';
    else if(type === 'accountability') url = API_BASE + '/v1/reports/respondent-accountability';
    else { container.innerHTML = '<div style="color:#f85149;text-align:center;padding:40px">Unknown report type</div>'; return; }

    const r = await fetch(url, {headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error('Failed to fetch report');
    const data = await r.json();

    if(type === 'executive') renderExecutiveReport(data, container);
    else if(type === 'accountability') renderAccountabilityReport(data, container);
    container.dataset.loaded = '1';
  } catch(e){
    container.innerHTML = '<div style="color:#f85149;text-align:center;padding:40px">Failed to generate report: ' + e.message + '</div>';
  }
}

function renderExecutiveReport(data, container){
  const ts = new Date(data.generated_at).toLocaleString();
  const o = data.overview;
  let html = '';

  // Header
  html += '<div class="report-header"><h2>&#x1F4CB; Executive Summary Report</h2><div class="rh-meta">Generated: ' + ts + '</div></div>';

  // Overview KPIs
  html += '<div class="report-section"><h3>&#x1F4CA; Key Performance Indicators</h3>';
  html += '<div class="report-grid">' +
    '<div class="report-card"><div class="rc-num">' + o.total_claims + '</div><div class="rc-label">Total Claims</div></div>' +
    '<div class="report-card"><div class="rc-num">$' + formatAmount(o.total_claimed_usd) + '</div><div class="rc-label">Total Value at Stake</div></div>' +
    '<div class="report-card blue"><div class="rc-num">' + o.active_claims + '</div><div class="rc-label">Active Claims</div></div>' +
    '<div class="report-card green"><div class="rc-num">' + o.resolved_claims + '</div><div class="rc-label">Resolved</div></div>' +
    '<div class="report-card copper"><div class="rc-num">' + o.resolution_rate + '%</div><div class="rc-label">Resolution Rate</div></div>' +
    '<div class="report-card"><div class="rc-num">' + o.total_respondents + '</div><div class="rc-label">Respondents</div></div>' +
  '</div></div>';

  // SLA Compliance
  const sla = data.sla_compliance;
  html += '<div class="report-section"><h3>&#x23F0; SLA Compliance</h3>';
  html += '<div class="report-grid">' +
    '<div class="report-card green"><div class="rc-num">' + sla.compliance_rate + '%</div><div class="rc-label">Compliance Rate</div></div>' +
    '<div class="report-card green"><div class="rc-num">' + sla.on_track + '</div><div class="rc-label">On Track</div></div>' +
    '<div class="report-card amber"><div class="rc-num">' + sla.at_risk + '</div><div class="rc-label">At Risk</div></div>' +
    '<div class="report-card red"><div class="rc-num">' + sla.breached + '</div><div class="rc-label">Breached</div></div>' +
  '</div></div>';

  // Recovery Performance
  const rec = data.recovery_performance;
  html += '<div class="report-section"><h3>&#x1F4B0; Recovery Performance</h3>';
  html += '<div class="report-grid">' +
    '<div class="report-card green"><div class="rc-num">$' + formatAmount(rec.total_recovered) + '</div><div class="rc-label">Total Recovered</div></div>' +
    '<div class="report-card"><div class="rc-num">$' + formatAmount(rec.total_claimed) + '</div><div class="rc-label">Total Claimed</div></div>' +
    '<div class="report-card green"><div class="rc-num">' + rec.recovery_rate + '%</div><div class="rc-label">Recovery Rate</div></div>' +
    '<div class="report-card blue"><div class="rc-num">' + rec.claims_with_recovery + '</div><div class="rc-label">Claims w/ Recovery</div></div>' +
  '</div></div>';

  // Status Distribution
  html += '<div class="report-section"><h3>&#x1F4CA; Status Distribution</h3>';
  const statuses = data.status_distribution;
  const maxStatusCount = Math.max(...Object.values(statuses), 1);
  html += '<div class="report-bar-chart">';
  Object.entries(statuses).forEach(([st, cnt]) => {
    const h = Math.max(Math.round((cnt / maxStatusCount) * 70), 4);
    const colors = {filed:'#58a6ff',under_review:'#c9956b',escalated:'#f0ad4e',in_resolution:'#a855f7',resolved:'#22c55e',closed:'#6e7681',rejected:'#f85149',appealed:'#f472b6'};
    html += '<div class="report-bar" style="height:'+h+'px;background:'+(colors[st]||'#c9956b')+';flex:1">' +
      '<div class="rb-val">'+cnt+'</div><div class="rb-label">'+st.replace(/_/g,' ')+'</div></div>';
  });
  html += '</div></div>';

  // Age Distribution
  html += '<div class="report-section" style="margin-top:30px"><h3>&#x1F4C5; Claims Age Distribution</h3>';
  const ages = data.age_distribution;
  const maxAge = Math.max(...Object.values(ages), 1);
  html += '<div class="report-bar-chart">';
  Object.entries(ages).forEach(([bucket, cnt]) => {
    const h = Math.max(Math.round((cnt / maxAge) * 70), 4);
    html += '<div class="report-bar" style="height:'+h+'px;flex:1"><div class="rb-val">'+cnt+'</div><div class="rb-label">'+bucket+'</div></div>';
  });
  html += '</div></div>';

  // Value Distribution
  html += '<div class="report-section" style="margin-top:30px"><h3>&#x1F4B5; Value Distribution</h3>';
  const vals = data.value_distribution;
  const maxVal = Math.max(...Object.values(vals), 1);
  const valLabels = {under_100:'<$100','100_500':'$100-500','500_1k':'$500-1K','1k_5k':'$1K-5K','5k_10k':'$5K-10K','10k_plus':'$10K+'};
  html += '<div class="report-bar-chart">';
  Object.entries(vals).forEach(([band, cnt]) => {
    const h = Math.max(Math.round((cnt / maxVal) * 70), 4);
    html += '<div class="report-bar" style="height:'+h+'px;flex:1;background:#58a6ff"><div class="rb-val">'+cnt+'</div><div class="rb-label">'+(valLabels[band]||band)+'</div></div>';
  });
  html += '</div></div>';

  // Escalation & Outreach
  const esc = data.escalation_status;
  const out = data.outreach_activity;
  html += '<div class="report-section" style="margin-top:30px"><h3>&#x26A1; Operational Activity</h3>';
  html += '<div class="report-grid">' +
    '<div class="report-card red"><div class="rc-num">' + esc.total_recommendations + '</div><div class="rc-label">Escalation Recs</div></div>' +
    '<div class="report-card red"><div class="rc-num">' + esc.critical + '</div><div class="rc-label">Critical Escalations</div></div>' +
    '<div class="report-card copper"><div class="rc-num">' + out.total + '</div><div class="rc-label">Total Outreach</div></div>' +
    '<div class="report-card green"><div class="rc-num">' + out.sent + '</div><div class="rc-label">Outreach Sent</div></div>' +
  '</div></div>';

  // Top Risk Respondents
  html += '<div class="report-section"><h3>&#x26A0; Top Risk Respondents</h3>';
  if(data.top_risk_respondents.length > 0){
    html += '<table style="width:100%;font-size:12px;border-collapse:collapse">' +
      '<thead><tr style="border-bottom:1px solid #21262d"><th style="text-align:left;padding:6px 8px;color:#6e7681;font-size:10px;text-transform:uppercase">Entity</th><th style="text-align:center;color:#6e7681;font-size:10px;text-transform:uppercase">Risk</th><th style="text-align:center;color:#6e7681;font-size:10px;text-transform:uppercase">Claims</th><th style="text-align:center;color:#6e7681;font-size:10px;text-transform:uppercase">Total $</th><th style="text-align:center;color:#6e7681;font-size:10px;text-transform:uppercase">Resolution</th></tr></thead><tbody>';
    data.top_risk_respondents.forEach(r => {
      const riskColors = {critical:'#f85149',high:'#f0ad4e',medium:'#c9956b',low:'#4ade80'};
      html += '<tr style="border-bottom:1px solid #1c2129">' +
        '<td style="padding:8px;color:#c9d1d9;font-weight:600">' + esc(r.entity) + '</td>' +
        '<td style="text-align:center"><span style="background:'+(riskColors[r.risk_level]||'#6e7681')+'20;color:'+(riskColors[r.risk_level]||'#6e7681')+';padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600">' + r.risk_score + ' ' + r.risk_level + '</span></td>' +
        '<td style="text-align:center;color:#c9d1d9">' + r.total_claims + '</td>' +
        '<td style="text-align:center;color:#c9d1d9">$' + formatAmount(r.total_amount) + '</td>' +
        '<td style="text-align:center;color:#c9d1d9">' + r.resolution_rate + '%</td>' +
      '</tr>';
    });
    html += '</tbody></table>';
  } else {
    html += '<div style="color:#484f58;text-align:center;padding:12px">No respondent data available</div>';
  }
  html += '</div>';

  // Risk distribution
  const riskDist = data.respondent_count_by_risk;
  html += '<div class="report-section"><h3>&#x1F3E2; Respondent Risk Distribution</h3>';
  html += '<div class="report-grid">' +
    '<div class="report-card red"><div class="rc-num">' + (riskDist.critical||0) + '</div><div class="rc-label">Critical Risk</div></div>' +
    '<div class="report-card amber"><div class="rc-num">' + (riskDist.high||0) + '</div><div class="rc-label">High Risk</div></div>' +
    '<div class="report-card copper"><div class="rc-num">' + (riskDist.medium||0) + '</div><div class="rc-label">Medium Risk</div></div>' +
    '<div class="report-card green"><div class="rc-num">' + (riskDist.low||0) + '</div><div class="rc-label">Low Risk</div></div>' +
  '</div></div>';

  container.innerHTML = html;
}

function renderAccountabilityReport(data, container){
  const ts = new Date(data.generated_at).toLocaleString();
  let html = '';

  // Header
  html += '<div class="report-header"><h2>&#x1F3E2; Respondent Accountability Report</h2><div class="rh-meta">Generated: ' + ts + ' &bull; ' + data.total_respondents + ' respondents</div></div>';

  // Grade Distribution
  html += '<div class="report-section"><h3>&#x1F3C6; Compliance Grade Distribution</h3>';
  const gd = data.grade_distribution;
  html += '<div class="report-grid">' +
    '<div class="report-card green"><div class="rc-num">' + (gd.A||0) + '</div><div class="rc-label">Grade A</div></div>' +
    '<div class="report-card green"><div class="rc-num">' + (gd.B||0) + '</div><div class="rc-label">Grade B</div></div>' +
    '<div class="report-card amber"><div class="rc-num">' + (gd.C||0) + '</div><div class="rc-label">Grade C</div></div>' +
    '<div class="report-card amber"><div class="rc-num">' + (gd.D||0) + '</div><div class="rc-label">Grade D</div></div>' +
    '<div class="report-card red"><div class="rc-num">' + (gd.F||0) + '</div><div class="rc-label">Grade F</div></div>' +
  '</div></div>';

  // Scorecards
  html += '<div class="report-section"><h3>&#x1F4DD; Individual Scorecards</h3>';
  html += '<div class="scorecard-grid">';
  (data.scorecards || []).forEach(s => {
    const riskColors = {critical:'#f85149',high:'#f0ad4e',medium:'#c9956b',low:'#4ade80'};
    const gradeColor = {A:'#22c55e',B:'#4ade80',C:'#f0ad4e',D:'#fb923c',F:'#f85149'}[s.grade] || '#6e7681';

    html += '<div class="scorecard">' +
      '<div class="sc-grade ' + s.grade + '">' + s.grade + '</div>' +
      '<div class="sc-entity">' + esc(s.entity) + '</div>' +
      '<div class="sc-risk" style="color:' + (riskColors[s.risk_level]||'#6e7681') + '">' + s.risk_level + ' risk &bull; Score: ' + s.composite_score + '/100</div>' +

      '<div class="sc-metrics">' +
        '<div class="sc-metric"><div class="sm-num">' + s.total_claims + '</div><div class="sm-label">Claims</div></div>' +
        '<div class="sc-metric"><div class="sm-num" style="color:#22c55e">' + s.resolution_rate + '%</div><div class="sm-label">Resolution</div></div>' +
        '<div class="sc-metric"><div class="sm-num">$' + formatAmount(s.total_amount) + '</div><div class="sm-label">Value</div></div>' +
      '</div>' +

      '<div class="sc-metrics" style="margin-top:6px">' +
        '<div class="sc-metric"><div class="sm-num" style="color:' + (s.sla_compliance_rate >= 80 ? '#22c55e' : s.sla_compliance_rate >= 50 ? '#f0ad4e' : '#f85149') + '">' + s.sla_compliance_rate + '%</div><div class="sm-label">SLA Compliance</div></div>' +
        '<div class="sc-metric"><div class="sm-num" style="color:#22c55e">' + s.recovery_rate + '%</div><div class="sm-label">Recovery Rate</div></div>' +
        '<div class="sc-metric"><div class="sm-num">' + s.avg_age_days + 'd</div><div class="sm-label">Avg Age</div></div>' +
      '</div>' +

      '<div class="sc-bar"><div class="sc-bar-fill" style="width:' + Math.min(s.composite_score, 100) + '%;background:' + gradeColor + '"></div></div>' +

      '<div style="margin-top:8px;display:flex;justify-content:space-between;font-size:10px;color:#484f58">' +
        '<span>Outreach: ' + s.outreach_count + '</span>' +
        '<span>SLA Breaches: ' + s.sla_breached + '</span>' +
        '<span>' + esc(s.top_harm_type).replace(/_/g,' ') + '</span>' +
      '</div>' +
    '</div>';
  });
  html += '</div></div>';

  container.innerHTML = html;
}

async function exportClaimsData(format){
  try {
    const url = API_BASE + '/v1/reports/export/claims?format=' + format;
    const r = await fetch(url, {headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error('Export failed');

    if(format === 'csv'){
      const text = await r.text();
      const blob = new Blob([text], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ghostledger_claims_' + new Date().toISOString().substring(0,10) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('CSV exported successfully!', '#22c55e');
    } else {
      const data = await r.json();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ghostledger_claims_' + new Date().toISOString().substring(0,10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('JSON exported successfully!', '#22c55e');
    }
  } catch(e){
    showToast('Export failed: ' + e.message, '#f85149');
  }
}

// ===== CASE ASSIGNMENT & WORKLOAD =====
let operatorsList = [];

async function fetchWorkload(){
  try {
    const [wlR, opR] = await Promise.all([
      fetch(API_BASE + '/v1/workload', {headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE + '/v1/operators', {headers:{'Authorization':'Bearer operator'}})
    ]);
    const wl = await wlR.json();
    const opData = await opR.json();
    operatorsList = opData.operators || [];

    const widget = document.getElementById('workloadWidget');
    widget.style.display = '';

    document.getElementById('wlAssigned').textContent = wl.total_assigned;
    document.getElementById('wlUnassigned').textContent = wl.unassigned;
    document.getElementById('wlRate').textContent = wl.assignment_rate + '%';
    document.getElementById('wlOperators').textContent = (wl.workloads || []).length;

    // Workload bars
    const barsEl = document.getElementById('workloadBars');
    let html = '';
    (wl.workloads || []).forEach(w => {
      const pct = Math.min(w.utilization_pct, 100);
      const color = pct >= 90 ? '#f85149' : pct >= 70 ? '#f0ad4e' : pct >= 40 ? '#58a6ff' : '#4ade80';
      html += '<div class="wl-bar-row">' +
        '<div class="wl-name">' + esc(w.name) + '</div>' +
        '<div class="wl-role">' + w.role + '</div>' +
        '<div class="wl-track"><div class="wl-fill" style="width:' + pct + '%;background:' + color + '"></div></div>' +
        '<div class="wl-count">' + w.current_cases + '/' + w.max_caseload + '</div>' +
        '<div class="wl-pct" style="color:' + color + '">' + pct + '%</div>' +
      '</div>';
    });
    barsEl.innerHTML = html || '<div style="color:#484f58;text-align:center;padding:8px;font-size:12px">No operators configured</div>';

    // Populate assign selects in any open drawer
    populateAssignSelects();
  } catch(e){
    console.log('Workload fetch failed', e);
  }
}

function populateAssignSelects(){
  // Drawer assign dropdown
  const sel = document.getElementById('assignSelect');
  if(sel){
    const current = sel.value;
    let html = '<option value="">â€” Select operator â€”</option>';
    operatorsList.forEach(op => {
      html += '<option value="' + op.operator_id + '">' + esc(op.name) + ' (' + op.role + ')</option>';
    });
    sel.innerHTML = html;
    if(current) sel.value = current;
  }
  // Filter panel assignee dropdown
  const fSel = document.getElementById('fAssignee');
  if(fSel){
    const curFilter = fSel.value;
    let fHtml = '<option value="">All</option><option value="__unassigned__">Unassigned</option>';
    operatorsList.forEach(op => {
      fHtml += '<option value="' + op.operator_id + '">' + esc(op.name) + '</option>';
    });
    fSel.innerHTML = fHtml;
    if(curFilter) fSel.value = curFilter;
  }
}

async function assignClaim(claimId){
  const sel = document.getElementById('assignSelect');
  if(!sel || !sel.value){ showToast('Select an operator first', '#f85149'); return; }
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/assign', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({operator_id: sel.value})
    });
    if(!r.ok) throw new Error();
    const opName = operatorsList.find(o => o.operator_id === sel.value)?.name || 'Operator';
    document.getElementById('assignDisplay').innerHTML = '<span class="assign-badge">&#x1F464; ' + esc(opName) + '</span>';
    showToast('Assigned to ' + opName, '#58a6ff');
    fetchWorkload();
    fetchClaims();
  } catch(e){
    showToast('Assignment failed', '#f85149');
  }
}

async function autoAssignClaim(claimId){
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/auto-assign', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer operator'}
    });
    if(!r.ok){ const d = await r.json(); showToast(d.detail || 'Auto-assign failed', '#f85149'); return; }
    const data = await r.json();
    const opName = operatorsList.find(o => o.operator_id === data.operator_id)?.name || 'Operator';
    document.getElementById('assignDisplay').innerHTML = '<span class="assign-badge">&#x1F464; ' + esc(opName) + '</span>';
    showToast('Auto-assigned to ' + opName, '#58a6ff');
    fetchWorkload();
    fetchClaims();
  } catch(e){
    showToast('Auto-assign failed', '#f85149');
  }
}

async function unassignClaim(claimId){
  try {
    await fetch(API_BASE + '/v1/claims/' + claimId + '/assign', {
      method: 'DELETE',
      headers: {'Authorization':'Bearer operator'}
    });
    document.getElementById('assignDisplay').innerHTML = '<span class="assign-badge unassigned">Unassigned</span>';
    showToast('Claim unassigned', '#6e7681');
    fetchWorkload();
    fetchClaims();
  } catch(e){
    showToast('Unassign failed', '#f85149');
  }
}

async function bulkAssignSelected(){
  if(bulkSelected.size === 0){ showToast('No claims selected', '#f85149'); return; }
  const opId = prompt('Enter operator ID (e.g., op_lead):');
  if(!opId) return;
  try {
    const r = await fetch(API_BASE + '/v1/claims/bulk/assign', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({claim_ids: Array.from(bulkSelected), operator_id: opId})
    });
    if(!r.ok) throw new Error();
    const data = await r.json();
    showToast(data.assigned + ' claims assigned!', '#58a6ff');
    fetchWorkload();
    fetchClaims();
  } catch(e){
    showToast('Bulk assign failed', '#f85149');
  }
}

// ===== SETTLEMENT & RESOLUTION =====
async function loadClaimSettlements(claimId){
  const panel = document.getElementById('settlementPanel');
  if(!panel) return;
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/settlements', {headers:{'Authorization':'Bearer operator'}});
    const data = await r.json();
    const settlements = data.settlements || [];
    const resolution = data.resolution;
    let html = '';

    // Show resolution banner if exists
    if(resolution){
      const ratio = (resolution.settlement_ratio * 100).toFixed(1);
      const isPartial = resolution.resolution_type.includes('partial');
      html += '<div class="resolution-badge ' + (isPartial ? 'partial' : 'resolved') + '" style="margin-bottom:8px;padding:8px 10px;width:100%;box-sizing:border-box;justify-content:space-between">';
      html += '<span>&#x2705; ' + resolution.resolution_type.replace(/_/g,' ').toUpperCase() + '</span>';
      html += '<span>$' + (resolution.amount_settled||0).toLocaleString() + ' / $' + (resolution.amount_claimed||0).toLocaleString() + ' (' + ratio + '%)</span>';
      html += '</div>';
      if(resolution.terms_summary) html += '<div style="font-size:11px;color:#8b949e;padding:4px 0 8px;border-bottom:1px solid #21262d;margin-bottom:8px"><strong>Terms:</strong> ' + esc(resolution.terms_summary) + '</div>';
    }

    // Show settlement offers/counteroffers
    if(settlements.length === 0 && !resolution){
      html += '<div style="color:#484f58;text-align:center;padding:10px;font-size:12px">No settlement offers yet</div>';
    } else {
      settlements.forEach(s => {
        html += '<div class="stl-entry">';
        html += '<span class="stl-status ' + s.status + '">' + s.status + '</span>';
        html += '<div class="stl-type ' + s.offer_type + '">' + s.offer_type.replace(/_/g,' ') + '</div>';
        html += '<div class="stl-amount">$' + (s.amount_offered||0).toLocaleString() + '</div>';
        html += '<div class="stl-by">By: ' + esc(s.offered_by) + ' &bull; ' + new Date(s.created_at).toLocaleDateString() + '</div>';
        if(s.terms) html += '<div class="stl-terms">' + esc(s.terms) + '</div>';
        if(s.status === 'pending'){
          html += '<div class="stl-actions">';
          html += '<button class="stl-accept" onclick="respondSettlement(\'' + s.settlement_id + '\',\'accepted\',\'' + claimId + '\')">&#x2705; Accept</button>';
          html += '<button class="stl-reject" onclick="respondSettlement(\'' + s.settlement_id + '\',\'rejected\',\'' + claimId + '\')">&#x274C; Reject</button>';
          html += '</div>';
        }
        html += '</div>';
      });
    }
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#f85149;font-size:11px">Failed to load settlements</div>';
  }
}

function openSettlementForm(claimId){
  const form = document.getElementById('settlementForm');
  if(!form) return;
  if(form.style.display !== 'none'){ form.style.display = 'none'; return; }
  form.style.display = '';
  form.innerHTML = '<div class="stl-compose">' +
    '<label>Offer Type</label>' +
    '<select id="stlOfferType"><option value="initial_offer">Initial Offer</option><option value="counteroffer">Counteroffer</option><option value="final_offer">Final Offer</option></select>' +
    '<label>Offered By</label>' +
    '<select id="stlOfferedBy"><option value="respondent">Respondent</option><option value="claimant">Claimant</option><option value="mediator">Mediator</option><option value="platform">Platform</option></select>' +
    '<label>Amount Offered ($)</label>' +
    '<input type="number" id="stlAmount" placeholder="0.00" step="0.01">' +
    '<label>Terms / Conditions</label>' +
    '<textarea id="stlTerms" placeholder="Describe settlement terms..."></textarea>' +
    '<label>Response Deadline (optional)</label>' +
    '<input type="date" id="stlDeadline">' +
    '<div style="display:flex;gap:6px;margin-top:4px">' +
    '<button class="btn btn-primary btn-sm" style="flex:1;background:#d2a8ff;color:#0a0e14" onclick="submitSettlement(\'' + claimId + '\')">Submit Offer</button>' +
    '<button class="btn btn-ghost btn-sm" onclick="document.getElementById(\'settlementForm\').style.display=\'none\'">Cancel</button>' +
    '</div></div>';
}

async function submitSettlement(claimId){
  const offerType = document.getElementById('stlOfferType').value;
  const offeredBy = document.getElementById('stlOfferedBy').value;
  const amount = parseFloat(document.getElementById('stlAmount').value) || 0;
  const terms = document.getElementById('stlTerms').value;
  const deadline = document.getElementById('stlDeadline').value || null;
  if(amount <= 0){ showToast('Amount must be greater than 0', '#f85149'); return; }
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/settlements', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({offer_type: offerType, offered_by: offeredBy, amount_offered: amount, terms: terms, response_deadline: deadline})
    });
    if(!r.ok) throw new Error();
    showToast('Settlement offer recorded', '#d2a8ff');
    document.getElementById('settlementForm').style.display = 'none';
    loadClaimSettlements(claimId);
    fetchResolutionDashboard();
  } catch(e){
    showToast('Failed to record offer', '#f85149');
  }
}

async function respondSettlement(settlementId, newStatus, claimId){
  const action = newStatus === 'accepted' ? 'accept' : 'reject';
  if(!confirm('Are you sure you want to ' + action + ' this settlement offer?')) return;
  try {
    const r = await fetch(API_BASE + '/v1/settlements/' + settlementId, {
      method:'PATCH',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({status: newStatus})
    });
    if(!r.ok) throw new Error();
    const msg = newStatus === 'accepted' ? 'Settlement accepted! Claim resolved.' : 'Settlement rejected.';
    const color = newStatus === 'accepted' ? '#4ade80' : '#f85149';
    showToast(msg, color);
    loadClaimSettlements(claimId);
    fetchResolutionDashboard();
    fetchClaims();
  } catch(e){
    showToast('Failed to update settlement', '#f85149');
  }
}

function openDirectResolve(claimId){
  const form = document.getElementById('resolveForm');
  if(!form) return;
  if(form.style.display !== 'none'){ form.style.display = 'none'; return; }
  form.style.display = '';
  form.innerHTML = '<div class="stl-compose">' +
    '<div style="font-size:11px;color:#d2a8ff;margin-bottom:6px;font-weight:700">Direct Resolution (no formal settlement)</div>' +
    '<label>Resolution Type</label>' +
    '<select id="resType"><option value="full_settlement">Full Settlement</option><option value="partial_settlement">Partial Settlement</option><option value="mediated">Mediated</option><option value="arbitrated">Arbitrated</option><option value="withdrawn">Withdrawn by Claimant</option><option value="dismissed">Dismissed</option></select>' +
    '<label>Amount Settled ($)</label>' +
    '<input type="number" id="resAmount" placeholder="0.00" step="0.01">' +
    '<label>Terms Summary</label>' +
    '<textarea id="resTerms" placeholder="Summarize resolution terms..."></textarea>' +
    '<label>Resolution Notes</label>' +
    '<textarea id="resNotes" placeholder="Additional notes..."></textarea>' +
    '<div style="display:flex;gap:6px;margin-top:4px">' +
    '<button class="btn btn-primary btn-sm" style="flex:1;background:#4ade80;color:#0a0e14" onclick="submitDirectResolve(\'' + claimId + '\')">&#x2705; Resolve Claim</button>' +
    '<button class="btn btn-ghost btn-sm" onclick="document.getElementById(\'resolveForm\').style.display=\'none\'">Cancel</button>' +
    '</div></div>';
}

async function submitDirectResolve(claimId){
  const resType = document.getElementById('resType').value;
  const amount = parseFloat(document.getElementById('resAmount').value) || 0;
  const terms = document.getElementById('resTerms').value;
  const notes = document.getElementById('resNotes').value;
  if(!confirm('Resolve this claim as "' + resType.replace(/_/g,' ') + '"?')) return;
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/resolve', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({resolution_type: resType, amount_settled: amount, terms_summary: terms, resolution_notes: notes})
    });
    if(!r.ok){ const err = await r.json(); showToast(err.detail || 'Failed', '#f85149'); return; }
    showToast('Claim resolved!', '#4ade80');
    document.getElementById('resolveForm').style.display = 'none';
    loadClaimSettlements(claimId);
    fetchResolutionDashboard();
    fetchClaims();
  } catch(e){
    showToast('Failed to resolve claim', '#f85149');
  }
}

async function fetchResolutionDashboard(){
  try {
    const r = await fetch(API_BASE + '/v1/resolution-dashboard', {headers:{'Authorization':'Bearer operator'}});
    const data = await r.json();
    const widget = document.getElementById('resolutionWidget');
    widget.style.display = '';
    document.getElementById('resTotalResolved').textContent = data.total_resolved || 0;
    document.getElementById('resTotalSettled').textContent = '$' + ((data.total_settled_usd||0)/1000).toFixed(1) + 'k';
    document.getElementById('resAvgRatio').textContent = ((data.overall_ratio||0) * 100).toFixed(0) + '%';
    document.getElementById('resPendingOffers').textContent = data.pending_offers || 0;

    // Recent resolutions
    const listEl = document.getElementById('resRecentList');
    let html = '';
    (data.recent || []).slice(0, 5).forEach(r => {
      const ratio = ((r.settlement_ratio||0) * 100).toFixed(0);
      html += '<div class="res-recent-item">';
      html += '<span style="color:#58a6ff;font-family:monospace;cursor:pointer" onclick="openCase(\'' + r.claim_id + '\')">' + r.claim_id.slice(0,12) + '</span>';
      html += '<span style="color:#8b949e">' + esc(r.respondent || '?') + '</span>';
      html += '<span style="color:#4ade80;font-weight:700">$' + (r.amount_settled||0).toLocaleString() + '</span>';
      html += '<span class="resolution-badge ' + (r.resolution_type.includes('partial') ? 'partial' : 'resolved') + '">' + r.resolution_type.replace(/_/g,' ') + '</span>';
      html += '</div>';
    });
    listEl.innerHTML = html || '<div style="color:#484f58;text-align:center;padding:8px;font-size:12px">No resolutions yet</div>';
  } catch(e){
    console.log('Resolution dashboard fetch failed', e);
  }
}

// ===== WORKFLOW RULES =====
async function fetchWorkflowRules(){
  try {
    const [rulesR, execsR] = await Promise.all([
      fetch(API_BASE + '/v1/workflow/rules', {headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE + '/v1/workflow/executions?limit=10', {headers:{'Authorization':'Bearer operator'}})
    ]);
    const rulesData = await rulesR.json();
    const execsData = await execsR.json();
    const rules = rulesData.rules || [];
    const execs = execsData.executions || [];

    const widget = document.getElementById('workflowWidget');
    widget.style.display = '';

    document.getElementById('wfTotal').textContent = rules.length;
    document.getElementById('wfActive').textContent = rules.filter(r => r.enabled).length;
    const totalExecs = rules.reduce((s, r) => s + (r.execution_count || 0), 0);
    document.getElementById('wfExecs').textContent = totalExecs;

    // Last triggered
    const lastExec = execs.length > 0 ? execs[0] : null;
    document.getElementById('wfLastRun').textContent = lastExec ? new Date(lastExec.executed_at).toLocaleString() : 'â€”';

    // Rules list
    const listEl = document.getElementById('wfRulesList');
    let html = '';
    rules.forEach(r => {
      const toggleCls = r.enabled ? 'on' : 'off';
      html += '<div class="wf-rule-item">';
      html += '<div style="flex:1;min-width:0">';
      html += '<div class="wf-rule-name">' + esc(r.name) + '</div>';
      html += '<div class="wf-rule-trigger">' + r.trigger_event + ' &bull; <span class="wf-rule-count">' + (r.execution_count || 0) + ' runs</span></div>';
      html += '</div>';
      html += '<button class="wf-toggle ' + toggleCls + '" onclick="toggleWorkflowRule(\'' + r.rule_id + '\',' + (!r.enabled) + ')" title="' + (r.enabled ? 'Disable' : 'Enable') + '"></button>';
      html += '</div>';
    });
    listEl.innerHTML = html || '<div style="color:#484f58;text-align:center;padding:8px;font-size:12px">No workflow rules configured</div>';

    // Recent executions
    const execsEl = document.getElementById('wfRecentExecs');
    if(execs.length > 0){
      let eHtml = '<div style="font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Recent Executions</div>';
      execs.slice(0, 5).forEach(e => {
        const badgeCls = e.status === 'success' ? 'success' : 'failed';
        eHtml += '<div class="wf-exec-item">';
        eHtml += '<span class="wf-exec-badge ' + badgeCls + '">' + e.status + '</span>';
        eHtml += '<span style="color:#58a6ff;font-family:monospace">' + (e.claim_id||'').slice(0,12) + '</span>';
        eHtml += '<span style="color:#8b949e;flex:1">' + esc(e.rule_name || e.rule_id) + '</span>';
        eHtml += '<span style="color:#484f58">' + new Date(e.executed_at).toLocaleTimeString() + '</span>';
        eHtml += '</div>';
      });
      execsEl.innerHTML = eHtml;
    } else {
      execsEl.innerHTML = '';
    }
  } catch(e){
    console.log('Workflow rules fetch failed', e);
  }
}

async function toggleWorkflowRule(ruleId, enabled){
  try {
    await fetch(API_BASE + '/v1/workflow/rules/' + ruleId + '/toggle', {
      method:'PATCH',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body: JSON.stringify({enabled: enabled})
    });
    showToast('Rule ' + (enabled ? 'enabled' : 'disabled'), enabled ? '#4ade80' : '#6e7681');
    fetchWorkflowRules();
  } catch(e){
    showToast('Failed to toggle rule', '#f85149');
  }
}

async function runScheduledRules(){
  try {
    const r = await fetch(API_BASE + '/v1/workflow/run-scheduled', {
      method:'POST',
      headers:{'Authorization':'Bearer operator'}
    });
    const data = await r.json();
    showToast('Scheduled rules: ' + (data.total_executions || 0) + ' actions executed', '#f0ad4e');
    fetchWorkflowRules();
  } catch(e){
    showToast('Scheduled run failed', '#f85149');
  }
}

// ===== NOTIFICATION CENTER =====
const NOTIF_ICONS = {sla_breach:'&#x1F6A8;',sla_warning:'&#x23F0;',escalation:'&#x26A0;',settlement_deadline:'&#x2696;',settlement_response:'&#x1F4B0;',workflow_triggered:'&#x2699;',claim_filed:'&#x1F4CB;',status_changed:'&#x1F504;',document_uploaded:'&#x1F4CE;',assignment:'&#x1F464;',system:'&#x2699;'};
let notifPanelOpen = false;

function toggleNotifPanel(){
  const panel = document.getElementById('notifPanel');
  notifPanelOpen = !notifPanelOpen;
  panel.classList.toggle('open', notifPanelOpen);
  if(notifPanelOpen) loadNotifications();
}

// Close panel on outside click
document.addEventListener('click', function(e){
  const panel = document.getElementById('notifPanel');
  const btn = document.getElementById('notifBellBtn');
  if(notifPanelOpen && panel && !panel.contains(e.target) && !btn.contains(e.target)){
    notifPanelOpen = false;
    panel.classList.remove('open');
  }
});

async function fetchNotifBadge(){
  try {
    const r = await fetch(API_BASE + '/v1/notifications/summary', {headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    const countEl = document.getElementById('notifCount');
    const dotEl = document.getElementById('notifDot');
    if(d.unread > 0){
      countEl.textContent = d.unread > 99 ? '99+' : d.unread;
      countEl.classList.add('active');
      dotEl.classList.add('active');
    } else {
      countEl.classList.remove('active');
      dotEl.classList.remove('active');
    }
  } catch(e){}
}

function relativeTime(iso){
  const now = Date.now();
  const t = new Date(iso).getTime();
  const diff = Math.floor((now - t) / 1000);
  if(diff < 60) return 'just now';
  if(diff < 3600) return Math.floor(diff/60) + 'm ago';
  if(diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return Math.floor(diff/86400) + 'd ago';
}

async function loadNotifications(){
  const body = document.getElementById('notifPanelBody');
  const countLabel = document.getElementById('notifPanelCount');
  try {
    const r = await fetch(API_BASE + '/v1/notifications?limit=30', {headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    const notifs = d.notifications || [];
    countLabel.textContent = d.unread > 0 ? '(' + d.unread + ' unread)' : '';
    if(!notifs.length){
      body.innerHTML = '<div class="notif-empty"><div style="font-size:24px;margin-bottom:8px">&#x2705;</div>No notifications. Run a scan to check for SLA &amp; settlement alerts.</div>';
      return;
    }
    let html = '';
    notifs.forEach(n => {
      const icon = NOTIF_ICONS[n.type] || '&#x1F514;';
      const unread = !n.read ? ' unread' : '';
      html += '<div class="notif-item'+unread+'" onclick="handleNotifClick(\''+n.notification_id+'\',\''+n.claim_id+'\')">';
      html += '<div class="ni-sev '+n.severity+'"></div>';
      html += '<span class="ni-icon">'+icon+'</span>';
      html += '<div class="ni-content"><div class="ni-title">'+n.title+'</div>';
      if(n.message) html += '<div class="ni-msg">'+n.message+'</div>';
      html += '<div class="ni-time">'+relativeTime(n.created_at)+' &bull; '+n.type.replace(/_/g,' ')+'</div></div>';
      html += '<button class="ni-dismiss" title="Dismiss" onclick="event.stopPropagation();dismissNotif(\''+n.notification_id+'\')">&times;</button>';
      html += '</div>';
    });
    body.innerHTML = html;
  } catch(e){
    body.innerHTML = '<div class="notif-empty" style="color:#f85149">Failed to load notifications</div>';
  }
}

async function handleNotifClick(notifId, claimId){
  // Mark as read
  try {
    await fetch(API_BASE + '/v1/notifications/'+notifId+'/read', {method:'PATCH',headers:{'Authorization':'Bearer operator'}});
  } catch(e){}
  // Navigate to claim if present
  if(claimId && claimId !== 'null' && claimId !== 'undefined'){
    notifPanelOpen = false;
    document.getElementById('notifPanel').classList.remove('open');
    openCase(claimId);
  }
  fetchNotifBadge();
  loadNotifications();
}

async function dismissNotif(notifId){
  try {
    await fetch(API_BASE + '/v1/notifications/'+notifId, {method:'DELETE',headers:{'Authorization':'Bearer operator'}});
    loadNotifications();
    fetchNotifBadge();
  } catch(e){}
}

async function markAllNotifRead(){
  try {
    await fetch(API_BASE + '/v1/notifications/read-all', {method:'POST',headers:{'Authorization':'Bearer operator'}});
    showToast('All notifications marked as read', '#58a6ff');
    loadNotifications();
    fetchNotifBadge();
  } catch(e){}
}

async function dismissAllNotifs(){
  try {
    await fetch(API_BASE + '/v1/notifications/dismiss-all', {method:'POST',headers:{'Authorization':'Bearer operator'}});
    showToast('All notifications cleared', '#f0ad4e');
    loadNotifications();
    fetchNotifBadge();
  } catch(e){}
}

async function runNotifScan(){
  try {
    showToast('Scanning for alerts...', '#58a6ff');
    const r = await fetch(API_BASE + '/v1/notifications/scan', {method:'POST',headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    showToast('Scan: '+d.total_generated+' alert'+(d.total_generated!==1?'s':'')+' generated', d.total_generated > 0 ? '#f0ad4e' : '#4ade80');
    loadNotifications();
    fetchNotifBadge();
  } catch(e){
    showToast('Scan failed', '#f85149');
  }
}

// Poll notification badge every 30s
setInterval(fetchNotifBadge, 30000);

// ===== CASE GROUPS & MULTI-CLAIM LINKING =====
const CG_ICONS = {respondent:'&#x1F3E2;',incident:'&#x26A1;',pattern:'&#x1F50D;',class_action:'&#x2696;',geographic:'&#x1F30D;',custom:'&#x1F517;'};

async function fetchCaseGroups(){
  try {
    const [gr, ar] = await Promise.all([
      fetch(API_BASE + '/v1/case-groups', {headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE + '/v1/case-groups/analytics', {headers:{'Authorization':'Bearer operator'}})
    ]);
    const groups = await gr.json();
    const analytics = await ar.json();
    const w = document.getElementById('cgWidget');
    if(!w) return;
    w.style.display = 'block';
    document.getElementById('cgTotal').textContent = analytics.total_groups || 0;
    document.getElementById('cgActive').textContent = analytics.active_groups || 0;
    document.getElementById('cgLinked').textContent = analytics.total_linked_claims || 0;
    document.getElementById('cgCoverage').textContent = (analytics.linking_coverage_pct||0)+'%';
    const list = document.getElementById('cgGroupsList');
    const items = groups.groups || [];
    if(!items.length){
      list.innerHTML = '<div style="text-align:center;color:#484f58;padding:12px;font-size:11px">No case groups yet. Use Auto-Detect to find related claims.</div>';
      return;
    }
    let html = '';
    items.slice(0,10).forEach(g => {
      const icon = CG_ICONS[g.group_type] || '&#x1F517;';
      html += '<div class="cg-group-item" onclick="viewCaseGroup(\''+g.group_id+'\')">';
      html += '<span>'+icon+'</span>';
      html += '<span class="cg-name">'+g.name+'</span>';
      html += '<span class="cg-type">'+g.group_type.replace(/_/g,' ')+'</span>';
      html += '<span class="cg-count">'+g.claim_count+' claims</span>';
      html += '</div>';
    });
    list.innerHTML = html;
  } catch(e){ console.warn('CG fetch error:', e) }
}

async function autoCreateGroups(){
  try {
    showToast('Detecting related claims...', '#79c0ff');
    const r = await fetch(API_BASE + '/v1/case-groups/auto-create', {
      method:'POST',
      headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({min_claims:2})
    });
    const d = await r.json();
    if(d.created > 0){
      showToast(d.created+' case group'+(d.created!==1?'s':'')+' created!', '#4ade80');
    } else {
      showToast('No new groups detected (claims may already be grouped)', '#f0ad4e');
    }
    fetchCaseGroups();
  } catch(e){
    showToast('Auto-detect failed', '#f85149');
  }
}

async function viewCaseGroup(groupId){
  try {
    const r = await fetch(API_BASE + '/v1/case-groups/'+groupId, {headers:{'Authorization':'Bearer operator'}});
    const g = await r.json();
    let html = '<div style="padding:16px">';
    html += '<h3 style="color:#79c0ff;margin:0 0 8px">'+(CG_ICONS[g.group_type]||'&#x1F517;')+' '+g.name+'</h3>';
    html += '<div style="font-size:11px;color:#8b949e;margin-bottom:8px">'+g.description+'</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px">';
    html += '<div style="text-align:center;background:#0d1117;padding:8px;border-radius:6px"><div style="font-size:16px;font-weight:800;color:#e6edf3">'+g.claim_count+'</div><div style="font-size:9px;color:#6e7681">Claims</div></div>';
    html += '<div style="text-align:center;background:#0d1117;padding:8px;border-radius:6px"><div style="font-size:16px;font-weight:800;color:#4ade80">$'+g.total_claimed_usd.toLocaleString()+'</div><div style="font-size:9px;color:#6e7681">Total Claimed</div></div>';
    html += '<div style="text-align:center;background:#0d1117;padding:8px;border-radius:6px"><div style="font-size:16px;font-weight:800;color:#f0ad4e">$'+g.total_recovered_usd.toLocaleString()+'</div><div style="font-size:9px;color:#6e7681">Recovered</div></div>';
    html += '</div>';
    if(g.strategy_notes) html += '<div style="font-size:11px;color:#d2a8ff;background:rgba(210,168,255,.05);padding:6px 8px;border-radius:6px;margin-bottom:8px"><strong>Strategy:</strong> '+g.strategy_notes+'</div>';
    html += '<div style="font-size:11px;font-weight:600;color:#6e7681;margin-bottom:4px">LINKED CLAIMS</div>';
    (g.members||[]).forEach(m => {
      html += '<div style="display:flex;align-items:center;gap:6px;padding:5px 8px;border:1px solid #21262d;border-radius:6px;margin-bottom:3px;background:#0d1117;cursor:pointer" onclick="openDrawer(\''+m.claim_id+'\')">';
      html += '<span style="font-size:9px;color:#79c0ff;text-transform:uppercase;font-weight:700">'+m.role+'</span>';
      html += '<span style="font-size:11px;color:#e6edf3;flex:1">'+m.claimant_name+' vs '+m.respondent+'</span>';
      html += '<span style="font-size:10px;color:#6e7681">$'+m.amount_claimed_usd.toLocaleString()+'</span>';
      html += '<span class="status s-'+m.status+'" style="font-size:9px">'+m.status.replace(/_/g,' ')+'</span>';
      html += '</div>';
    });
    html += '</div>';
    showToast('', ''); // Clear any toast
    // Show in a modal-like overlay
    let modal = document.getElementById('cgModal');
    if(!modal){ modal = document.createElement('div'); modal.id='cgModal'; modal.style.cssText='position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center'; modal.onclick=function(e){if(e.target===this)this.style.display='none'}; document.body.appendChild(modal); }
    modal.innerHTML = '<div style="background:#161b22;border:1px solid #30363d;border-radius:12px;max-width:520px;width:95%;max-height:80vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.5)">'+html+'</div>';
    modal.style.display = 'flex';
  } catch(e){ showToast('Failed to load group', '#f85149') }
}

async function loadClaimGroups(claimId){
  const panel = document.getElementById('claimGroupsPanel');
  if(!panel) return;
  try {
    const r = await fetch(API_BASE + '/v1/claims/'+claimId+'/groups', {headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    const groups = d.groups || [];
    if(!groups.length){
      panel.innerHTML = '<div style="color:#484f58;font-size:11px;text-align:center;padding:6px">Not linked to any case group</div>';
      return;
    }
    let html = '';
    groups.forEach(g => {
      html += '<span class="grp-tag" onclick="viewCaseGroup(\''+g.group_id+'\')" style="cursor:pointer" title="'+g.name+'">';
      html += (CG_ICONS[g.group_type]||'&#x1F517;')+' '+g.name;
      html += ' <span class="grp-role">'+g.role+'</span>';
      html += ' <span style="font-size:9px;color:#484f58">'+g.claim_count+' claims</span>';
      html += '</span>';
    });
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#f85149;font-size:11px">Failed to load groups</div>';
  }
}

// ===== FINANCIAL RECONCILIATION =====

function fmtUSD(n){ return '$'+Number(n||0).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0}); }

async function fetchFinancialDashboard(){
  try {
    const [sumR, respR] = await Promise.all([
      fetch(API_BASE+'/v1/financial/summary',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/financial/by-respondent?limit=10',{headers:{'Authorization':'Bearer operator'}})
    ]);
    if(!sumR.ok || !respR.ok) throw new Error();
    const summary = await sumR.json();
    const respondents = await respR.json();
    const widget = document.getElementById('financialWidget');
    if(widget) widget.style.display = 'block';

    // KPIs
    document.getElementById('finClaimed').textContent = fmtUSD(summary.total_claimed_usd);
    document.getElementById('finRecovered').textContent = fmtUSD(summary.total_recovered_usd);
    document.getElementById('finSettled').textContent = fmtUSD(summary.total_settled_usd);
    document.getElementById('finGap').textContent = fmtUSD(summary.outstanding_gap_usd);
    document.getElementById('finRate').textContent = summary.overall_recovery_rate_pct + '%';
    document.getElementById('finRateBar').style.width = Math.min(summary.overall_recovery_rate_pct, 100) + '%';

    // Recovery by method
    const methods = summary.recovery_by_method || {};
    const methodDiv = document.getElementById('finMethodBreakdown');
    const methodEntries = Object.entries(methods);
    if(methodEntries.length === 0){
      methodDiv.innerHTML = '<span style="color:#484f58;font-size:11px">No recoveries recorded yet</span>';
    } else {
      const maxAmt = Math.max(...methodEntries.map(([k,v]) => v.amount));
      methodDiv.innerHTML = methodEntries.map(([method, data]) => {
        const pct = maxAmt > 0 ? (data.amount / maxAmt * 100) : 0;
        return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">' +
          '<span style="font-size:10px;color:#8b949e;min-width:100px;text-transform:capitalize">'+method.replace(/_/g,' ')+'</span>' +
          '<div style="flex:1;height:8px;background:#21262d;border-radius:4px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,#1f6feb,#4ade80);border-radius:4px"></div></div>' +
          '<span style="font-size:10px;color:#e6edf3;min-width:70px;text-align:right">'+fmtUSD(data.amount)+'</span>' +
          '<span style="font-size:9px;color:#585e68;min-width:25px">'+data.count+'x</span>' +
        '</div>';
      }).join('');
    }

    // Respondent table
    const tbody = document.getElementById('finRespTable');
    if(respondents.length === 0){
      tbody.innerHTML = '<tr><td colspan="5" style="color:#484f58;text-align:center">No data</td></tr>';
    } else {
      tbody.innerHTML = respondents.map(r => {
        const rateColor = r.recovery_rate_pct >= 75 ? '#4ade80' : (r.recovery_rate_pct >= 25 ? '#ffd33d' : '#f85149');
        return '<tr>' +
          '<td style="font-weight:600;color:#e6edf3">'+escapeHtml(r.respondent_entity)+' <span style="font-size:9px;color:#585e68">('+r.claim_count+')</span></td>' +
          '<td>'+fmtUSD(r.total_claimed_usd)+'</td>' +
          '<td style="color:#4ade80">'+fmtUSD(r.total_recovered_usd + r.total_settled_usd)+'</td>' +
          '<td style="color:#f85149">'+fmtUSD(r.outstanding_gap_usd)+'</td>' +
          '<td><span style="color:'+rateColor+';font-weight:700">'+r.recovery_rate_pct+'%</span></td>' +
        '</tr>';
      }).join('');
    }
  } catch(e){
    console.error('Failed to load financial dashboard:', e);
  }
}

// ===== COMPLIANCE & REGULATORY FRAMEWORK =====

const COMP_SEV_COLORS = {critical:'#f85149',high:'#f0883e',medium:'#d29922',low:'#3fb950'};

async function fetchComplianceStats(){
  try {
    const [statsRes, rulesRes] = await Promise.all([
      fetch(API+'/compliance/stats', {headers:authHeaders()}),
      fetch(API+'/compliance/rules', {headers:authHeaders()})
    ]);
    if(!statsRes.ok || !rulesRes.ok) return;
    const stats = await statsRes.json();
    const rulesData = await rulesRes.json();
    const w = document.getElementById('complianceWidget');
    if(w) w.style.display = 'block';
    document.getElementById('compRules').textContent = stats.active_rules || 0;
    document.getElementById('compChecks').textContent = stats.total_checks || 0;
    document.getElementById('compOverdue').textContent = stats.overdue_checks || 0;
    document.getElementById('compClaims').textContent = stats.claims_checked || 0;
    // Score bar
    const score = stats.avg_compliance_score || 100;
    const scoreColor = score >= 80 ? '#4ade80' : score >= 50 ? '#d29922' : '#f85149';
    document.getElementById('compScoreLabel').textContent = score + '%';
    document.getElementById('compScoreLabel').style.color = scoreColor;
    const fill = document.getElementById('compScoreFill');
    fill.style.width = score + '%';
    fill.style.background = score >= 80 ? 'linear-gradient(90deg,#238636,#4ade80)' : score >= 50 ? 'linear-gradient(90deg,#9e6a03,#d29922)' : 'linear-gradient(90deg,#da3633,#f85149)';
    // Rules list
    const list = document.getElementById('compRulesList');
    const rules = rulesData.rules || [];
    if(rules.length === 0){
      list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No compliance rules yet</div>';
    } else {
      list.innerHTML = rules.map(r => {
        const sevColor = COMP_SEV_COLORS[r.severity] || '#8b949e';
        const jLabel = (r.jurisdiction||'global').replace(/_/g,' ');
        const catLabel = (r.category||'general').replace(/_/g,' ');
        return '<div class="comp-rule">' +
          '<div class="comp-sev '+r.severity+'" title="'+r.severity+'"></div>' +
          '<div class="comp-rule-info">' +
            '<div class="comp-rule-name">'+r.name+'</div>' +
            '<div class="comp-rule-meta">'+catLabel+' &middot; '+jLabel+(r.deadline_days ? ' &middot; '+r.deadline_days+'d deadline' : '')+'</div>' +
          '</div>' +
          '<span class="comp-rule-badge active" style="color:'+sevColor+';background:'+sevColor+'20">'+r.severity+'</span>' +
          '<button onclick="deleteCompRule(\''+r.rule_id+'\')" style="background:none;border:none;color:#484f58;cursor:pointer;font-size:14px" title="Delete">&times;</button>' +
        '</div>';
      }).join('');
    }
  } catch(e){
    console.error('Failed to load compliance stats:', e);
  }
}

function showCreateCompRuleModal(){
  document.getElementById('compRuleName').value = '';
  document.getElementById('compRuleDesc').value = '';
  document.getElementById('compRuleCat').value = 'general';
  document.getElementById('compRuleJuris').value = 'global';
  document.getElementById('compRuleSev').value = 'medium';
  document.getElementById('compRuleApplies').value = 'all_claims';
  document.getElementById('compRuleDeadline').value = '';
  document.getElementById('compRuleModal').style.display = 'flex';
}

async function saveNewCompRule(){
  const name = document.getElementById('compRuleName').value.trim();
  if(!name) return alert('Rule name is required');
  const body = {
    name: name,
    description: document.getElementById('compRuleDesc').value.trim(),
    category: document.getElementById('compRuleCat').value,
    jurisdiction: document.getElementById('compRuleJuris').value,
    severity: document.getElementById('compRuleSev').value,
    applies_to: document.getElementById('compRuleApplies').value,
  };
  const dl = document.getElementById('compRuleDeadline').value;
  if(dl) body.deadline_days = parseInt(dl);
  try {
    const res = await fetch(API+'/compliance/rules', {method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'}, body:JSON.stringify(body)});
    if(!res.ok) throw new Error('Failed');
    document.getElementById('compRuleModal').style.display = 'none';
    fetchComplianceStats();
  } catch(e){
    alert('Failed to create rule: '+e.message);
  }
}

async function deleteCompRule(ruleId){
  if(!confirm('Deactivate this compliance rule?')) return;
  try {
    await fetch(API+'/compliance/rules/'+ruleId, {method:'DELETE', headers:authHeaders()});
    fetchComplianceStats();
  } catch(e){ console.error(e); }
}

async function runClaimComplianceCheck(claimId){
  try {
    const res = await fetch(API+'/compliance/check/'+claimId, {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({checked_by:'operator'})
    });
    if(!res.ok) throw new Error('Failed');
    const data = await res.json();
    loadClaimCompliance(claimId);
    alert('Compliance check complete: '+data.total+' rules evaluated');
  } catch(e){
    alert('Failed to run compliance check: '+e.message);
  }
}

async function loadClaimCompliance(claimId){
  const panel = document.getElementById('claimCompliancePanel');
  if(!panel) return;
  try {
    const res = await fetch(API+'/compliance/claim/'+claimId, {headers:authHeaders()});
    if(!res.ok){ panel.innerHTML='<div style="color:#484f58;font-size:11px">No checks</div>'; return; }
    const data = await res.json();
    if(!data.checks || data.checks.length === 0){
      panel.innerHTML = '<div style="color:#484f58;font-size:11px;text-align:center">No compliance checks run yet</div>';
      return;
    }
    const scoreColor = data.compliance_score >= 80 ? '#4ade80' : data.compliance_score >= 50 ? '#d29922' : '#f85149';
    let html = '<div style="margin-bottom:8px;font-size:11px;color:#8b949e">Score: <strong style="color:'+scoreColor+'">'+data.compliance_score+'%</strong> &middot; '+data.passed+' passed, '+data.failed+' failed, '+data.pending+' pending</div>';
    html += data.checks.map(c => {
      return '<div class="comp-check-item">' +
        '<span class="comp-check-status '+c.status+'">'+c.status+'</span>' +
        '<span style="flex:1;font-size:11px;color:#c9d1d9;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+c.rule_name+'</span>' +
        (c.status === 'pending' ? '<button onclick="resolveCompCheck(\''+c.check_id+'\',\'passed\')" style="background:#238636;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer">Pass</button><button onclick="resolveCompCheck(\''+c.check_id+'\',\'failed\')" style="background:#da3633;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer">Fail</button>' : '') +
      '</div>';
    }).join('');
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#484f58;font-size:11px">Error loading compliance</div>';
  }
}

async function resolveCompCheck(checkId, status){
  try {
    await fetch(API+'/compliance/checks/'+checkId, {
      method:'PATCH', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({status:status, resolved_by:'operator'})
    });
    // Refresh the claim drawer compliance panel
    const drawerClaimId = document.querySelector('.drawer-overlay.open .group-section h4');
    if(drawerClaimId){
      const panel = document.getElementById('claimCompliancePanel');
      if(panel) panel.innerHTML = '<div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Refreshing...</div>';
    }
    fetchComplianceStats();
    // Try to reload claim compliance
    const openDrawer = document.querySelector('.drawer-overlay.open');
    if(openDrawer){
      const claimEl = openDrawer.querySelector('[data-claim-id]');
      if(claimEl) loadClaimCompliance(claimEl.dataset.claimId);
    }
  } catch(e){ console.error(e); }
}

// ===== CLAIM SCORING & RISK ASSESSMENT =====

const TIER_COLORS = {critical:'#f85149',high:'#f0883e',medium:'#d29922',low:'#3fb950'};
const TIER_BG = {critical:'rgba(248,81,73,.15)',high:'rgba(240,136,62,.15)',medium:'rgba(210,153,34,.15)',low:'rgba(63,185,80,.15)'};

async function fetchRiskDashboard(){
  try {
    const res = await fetch(API+'/risk/dashboard', {headers:authHeaders()});
    if(!res.ok) return;
    const data = await res.json();
    const w = document.getElementById('riskWidget');
    if(w) w.style.display = 'block';
    document.getElementById('riskAssessed').textContent = data.total_assessed || 0;
    document.getElementById('riskAvgScore').textContent = data.avg_risk_score || 0;
    const dist = data.tier_distribution || {};
    document.getElementById('riskCritical').textContent = dist.critical || 0;
    document.getElementById('riskHigh').textContent = dist.high || 0;
    document.getElementById('riskLow').textContent = (dist.low || 0) + (dist.medium || 0);
    // Heatmap bar
    const total = data.total_assessed || 1;
    const hm = document.getElementById('riskHeatmap');
    const segs = [
      {tier:'critical',count:dist.critical||0,color:'#f85149'},
      {tier:'high',count:dist.high||0,color:'#f0883e'},
      {tier:'medium',count:dist.medium||0,color:'#d29922'},
      {tier:'low',count:dist.low||0,color:'#3fb950'}
    ];
    hm.innerHTML = segs.filter(s=>s.count>0).map(s => {
      const pct = Math.max((s.count/total)*100, 8);
      return '<div class="risk-heat-seg" style="flex:'+pct+';background:'+s.color+'">'+s.count+'</div>';
    }).join('');
    // Top risks list
    const list = document.getElementById('riskTopList');
    const top = data.top_risks || [];
    if(top.length === 0){
      list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No open claims to assess</div>';
    } else {
      list.innerHTML = top.map(r => {
        const tc = TIER_COLORS[r.tier]||'#8b949e';
        const bg = TIER_BG[r.tier]||'rgba(139,148,158,.15)';
        const amt = r.amount_claimed_usd ? '$'+r.amount_claimed_usd.toLocaleString('en-US',{minimumFractionDigits:2}) : '$0';
        return '<div class="risk-item" onclick="openCaseDrawer(\''+r.claim_id+'\')">' +
          '<div class="risk-score-badge" style="background:'+tc+'">'+r.score+'</div>' +
          '<div class="risk-item-info">' +
            '<div class="risk-item-title">'+r.claim_id+' â€” '+(r.respondent_entity||'Unknown')+'</div>' +
            '<div class="risk-item-meta">'+amt+' &middot; '+r.status+' &middot; '+r.factors.length+' risk factors</div>' +
          '</div>' +
          '<span class="risk-tier-badge" style="color:'+tc+';background:'+bg+'">'+r.tier+'</span>' +
        '</div>';
      }).join('');
    }
  } catch(e){
    console.error('Failed to load risk dashboard:', e);
  }
}

async function loadClaimRisk(claimId){
  const panel = document.getElementById('claimRiskPanel');
  if(!panel) return;
  try {
    const res = await fetch(API+'/risk/claim/'+claimId, {headers:authHeaders()});
    if(!res.ok){ panel.innerHTML='<div style="color:#484f58;font-size:11px">Unable to assess</div>'; return; }
    const data = await res.json();
    const tc = TIER_COLORS[data.tier]||'#8b949e';
    let html = '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">';
    html += '<div style="width:48px;height:48px;border-radius:50%;background:'+tc+';display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#fff">'+data.score+'</div>';
    html += '<div><div style="font-size:14px;font-weight:700;color:'+tc+';text-transform:uppercase">'+data.tier+' Risk</div>';
    html += '<div style="font-size:10px;color:#6e7681">'+data.factors.length+' contributing factors</div></div>';
    html += '</div>';
    if(data.factors && data.factors.length > 0){
      html += '<div class="risk-factors">';
      html += data.factors.map(f => {
        const barW = Math.min(f.points * 4, 100);
        return '<div class="risk-factor">' +
          '<div class="risk-factor-pts" style="color:'+tc+'">+'+f.points+'</div>' +
          '<div class="risk-factor-bar" style="width:'+barW+'px;background:'+tc+'"></div>' +
          '<span>'+f.detail+'</span>' +
        '</div>';
      }).join('');
      html += '</div>';
    }
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#484f58;font-size:11px">Risk assessment error</div>';
  }
}

// ===== CORRESPONDENCE & COMMUNICATION LOG =====

let corrChannelFilter = '';
const CORR_DIR_ICONS = {outbound:'&#x2197;&#xFE0F;', inbound:'&#x2199;&#xFE0F;'};
const CORR_CH_ICONS = {email:'&#x2709;&#xFE0F;',letter:'&#x1F4E8;',phone:'&#x1F4DE;',portal:'&#x1F310;',sms:'&#x1F4F1;',in_person:'&#x1F91D;',legal_notice:'&#x2696;&#xFE0F;'};

async function fetchCorrespondenceStats(){
  try {
    const [statsRes, msgsRes] = await Promise.all([
      fetch(API+'/correspondence/stats', {headers:authHeaders()}),
      fetch(API+'/correspondence/messages?limit=30'+(corrChannelFilter ? '&channel='+corrChannelFilter : ''), {headers:authHeaders()})
    ]);
    if(!statsRes.ok || !msgsRes.ok) return;
    const stats = await statsRes.json();
    const msgsData = await msgsRes.json();
    const w = document.getElementById('corrWidget');
    if(w) w.style.display = 'block';
    document.getElementById('corrTotal').textContent = stats.total_messages || 0;
    const sent = (stats.by_status?.sent||0) + (stats.by_status?.delivered||0) + (stats.by_status?.responded||0);
    document.getElementById('corrSent').textContent = sent;
    document.getElementById('corrResponse').textContent = stats.response_rate_pct + '%';
    document.getElementById('corrClaims').textContent = stats.claims_with_correspondence || 0;
    // Channel filter bar
    const channels = Object.keys(stats.by_channel || {});
    const bar = document.getElementById('corrChannelBar');
    bar.innerHTML = '<button class="corr-ch-btn '+(corrChannelFilter===''?'active':'')+'" onclick="filterCorrChannel(\'\')">All</button>' +
      channels.map(ch => '<button class="corr-ch-btn '+(corrChannelFilter===ch?'active':'')+'" onclick="filterCorrChannel(\''+ch+'\')">'+ch.replace(/_/g,' ')+' ('+stats.by_channel[ch]+')</button>').join('');
    // Messages list
    const list = document.getElementById('corrList');
    const msgs = msgsData.messages || [];
    if(msgs.length === 0){
      list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No correspondence yet</div>';
    } else {
      list.innerHTML = msgs.map(m => {
        const dirIcon = CORR_DIR_ICONS[m.direction] || '&#x27A1;&#xFE0F;';
        const chIcon = CORR_CH_ICONS[m.channel] || '&#x1F4E7;';
        const subj = m.subject || '(No subject)';
        const timeStr = m.created_at ? new Date(m.created_at).toLocaleDateString() : '';
        return '<div class="corr-item">' +
          '<div class="corr-dir '+m.direction+'" title="'+m.direction+'">'+dirIcon+'</div>' +
          '<div class="corr-item-info">' +
            '<div class="corr-item-subj">'+chIcon+' '+subj+'</div>' +
            '<div class="corr-item-meta">'+m.claim_id+' &middot; '+(m.recipient||m.sender||'â€”')+' &middot; '+timeStr+'</div>' +
          '</div>' +
          '<span class="corr-status-badge '+m.status+'">'+m.status+'</span>' +
        '</div>';
      }).join('');
    }
  } catch(e){
    console.error('Failed to load correspondence:', e);
  }
}

function filterCorrChannel(ch){
  corrChannelFilter = ch;
  fetchCorrespondenceStats();
}

function showCreateCorrModal(){
  document.getElementById('corrClaimId').value = '';
  document.getElementById('corrDirection').value = 'outbound';
  document.getElementById('corrChannel').value = 'email';
  document.getElementById('corrPriority').value = 'normal';
  document.getElementById('corrSubject').value = '';
  document.getElementById('corrSender').value = '';
  document.getElementById('corrRecipient').value = '';
  document.getElementById('corrBody').value = '';
  document.getElementById('corrModal').style.display = 'flex';
}

function showCreateCorrModalForClaim(claimId){
  showCreateCorrModal();
  document.getElementById('corrClaimId').value = claimId;
}

async function saveNewCorrespondence(status){
  const claimId = document.getElementById('corrClaimId').value.trim();
  if(!claimId) return alert('Claim ID is required');
  const body = {
    claim_id: claimId,
    direction: document.getElementById('corrDirection').value,
    channel: document.getElementById('corrChannel').value,
    priority: document.getElementById('corrPriority').value,
    subject: document.getElementById('corrSubject').value.trim(),
    sender: document.getElementById('corrSender').value.trim(),
    recipient: document.getElementById('corrRecipient').value.trim(),
    body: document.getElementById('corrBody').value.trim(),
    status: status,
  };
  try {
    const res = await fetch(API+'/correspondence/messages', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const err = await res.json();
      throw new Error(err.detail || 'Failed');
    }
    document.getElementById('corrModal').style.display = 'none';
    fetchCorrespondenceStats();
  } catch(e){
    alert('Failed: '+e.message);
  }
}

async function loadClaimCorrespondence(claimId){
  const panel = document.getElementById('claimCorrPanel');
  if(!panel) return;
  try {
    const res = await fetch(API+'/correspondence/claim/'+claimId, {headers:authHeaders()});
    if(!res.ok){ panel.innerHTML='<div style="color:#484f58;font-size:11px">No messages</div>'; return; }
    const data = await res.json();
    if(!data.messages || data.messages.length === 0){
      panel.innerHTML = '<div style="color:#484f58;font-size:11px;text-align:center">No correspondence for this claim</div>';
      return;
    }
    let html = '<div style="margin-bottom:6px;font-size:10px;color:#6e7681">'+data.total+' messages &middot; '+data.outbound+' out &middot; '+data.inbound+' in &middot; '+data.responded+' responded</div>';
    html += data.messages.slice(0, 8).map(m => {
      const dirIcon = m.direction === 'outbound' ? '&#x2197;&#xFE0F;' : '&#x2199;&#xFE0F;';
      const subj = m.subject || '(No subject)';
      return '<div class="corr-tl-item">' +
        '<span>'+dirIcon+'</span>' +
        '<span style="flex:1;color:#c9d1d9;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+subj+'</span>' +
        '<span class="corr-status-badge '+m.status+'" style="font-size:9px">'+m.status+'</span>' +
      '</div>';
    }).join('');
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#484f58;font-size:11px">Error loading correspondence</div>';
  }
}

// ===== CLAIM WATCHLIST & OPERATOR BOOKMARKS =====

const WL_CURRENT_OPERATOR = 'op_analyst_1';

async function fetchWatchlist(){
  try {
    const [statsRes, listRes] = await Promise.all([
      fetch(API+'/watchlist/stats?operator_id='+WL_CURRENT_OPERATOR, {headers:authHeaders()}),
      fetch(API+'/watchlist/'+WL_CURRENT_OPERATOR, {headers:authHeaders()})
    ]);
    if(!statsRes.ok || !listRes.ok) return;
    const stats = await statsRes.json();
    const listData = await listRes.json();
    const w = document.getElementById('watchlistWidget');
    if(w) w.style.display = 'block';
    document.getElementById('wlTotal').textContent = stats.total_watched || 0;
    document.getElementById('wlUrgent').textContent = (stats.by_priority?.urgent || 0) + (stats.by_priority?.high || 0);
    const mw = stats.most_watched || [];
    document.getElementById('wlMostWatched').textContent = mw.length > 0 ? mw[0].watchers : 'â€”';
    // Watchlist items
    const list = document.getElementById('wlList');
    const items = listData.watchlist || [];
    if(items.length === 0){
      list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No claims on watchlist â€” click &#x2B50; Watch on any claim</div>';
    } else {
      list.innerHTML = items.map(item => {
        const amt = item.amount_claimed_usd ? '$'+item.amount_claimed_usd.toLocaleString('en-US',{minimumFractionDigits:2}) : '$0';
        const priClass = item.priority || 'normal';
        return '<div class="wl-item" style="border-left-color:'+item.color+'" onclick="openCaseDrawer(\''+item.claim_id+'\')">' +
          '<div class="wl-item-info">' +
            '<div class="wl-item-title">'+item.claim_id+' â€” '+(item.respondent_entity||'Unknown')+'</div>' +
            '<div class="wl-item-meta">'+amt+' &middot; '+item.status+(item.label ? '' : '')+'</div>' +
            (item.label ? '<div class="wl-item-label">'+item.label+'</div>' : '') +
          '</div>' +
          '<span class="wl-pri '+priClass+'">'+priClass+'</span>' +
          '<button class="wl-rm-btn" onclick="event.stopPropagation();removeWatch(\''+item.watch_id+'\')" title="Unwatch">&times;</button>' +
        '</div>';
      }).join('');
    }
  } catch(e){
    console.error('Failed to load watchlist:', e);
  }
}

async function toggleWatchClaim(claimId){
  try {
    const checkRes = await fetch(API+'/watchlist/check/'+claimId+'?operator_id='+WL_CURRENT_OPERATOR, {headers:authHeaders()});
    if(!checkRes.ok) return;
    const check = await checkRes.json();
    const btn = document.getElementById('watchToggleBtn');
    if(check.watching){
      // Remove
      await fetch(API+'/watchlist/item/'+check.watch_id, {method:'DELETE', headers:authHeaders()});
      if(btn){ btn.innerHTML = '&#x2B50; Watch'; btn.style.background = 'rgba(255,211,61,.1)'; btn.style.borderColor = 'rgba(255,211,61,.3)'; }
    } else {
      // Add
      await fetch(API+'/watchlist', {
        method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
        body:JSON.stringify({claim_id:claimId, operator_id:WL_CURRENT_OPERATOR, priority:'normal'})
      });
      if(btn){ btn.innerHTML = '&#x2B50; Watching'; btn.style.background = 'rgba(255,211,61,.25)'; btn.style.borderColor = '#ffd33d'; }
    }
    fetchWatchlist();
  } catch(e){ console.error(e); }
}

async function checkWatchStatus(claimId){
  try {
    const res = await fetch(API+'/watchlist/check/'+claimId+'?operator_id='+WL_CURRENT_OPERATOR, {headers:authHeaders()});
    if(!res.ok) return;
    const data = await res.json();
    const btn = document.getElementById('watchToggleBtn');
    if(btn && data.watching){
      btn.innerHTML = '&#x2B50; Watching';
      btn.style.background = 'rgba(255,211,61,.25)';
      btn.style.borderColor = '#ffd33d';
    }
  } catch(e){}
}

async function removeWatch(watchId){
  try {
    await fetch(API+'/watchlist/item/'+watchId, {method:'DELETE', headers:authHeaders()});
    fetchWatchlist();
  } catch(e){ console.error(e); }
}

// ===== SETTLEMENT NEGOTIATION TRACKER =====

async function fetchNegotiationStats(){
  try {
    const res = await fetch(API+'/negotiations/stats', {headers:authHeaders()});
    if(!res.ok) return;
    const stats = await res.json();
    const w = document.getElementById('negWidget');
    if(w) w.style.display = 'block';
    document.getElementById('negActive').textContent = stats.active_negotiations || 0;
    document.getElementById('negAccepted').textContent = stats.accepted_claims || 0;
    document.getElementById('negAvgRounds').textContent = stats.avg_rounds_per_claim || 0;
    document.getElementById('negTotalAccepted').textContent = '$' + (stats.total_accepted_usd || 0).toLocaleString('en-US', {minimumFractionDigits:0});
    // Show status breakdown in recent list
    const list = document.getElementById('negRecentList');
    const bs = stats.by_status || {};
    if(stats.total_rounds === 0){
      list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No negotiations yet â€” open a claim and start an offer</div>';
    } else {
      let html = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px">';
      const statuses = [['pending','Pending','#d29922'],['countered','Countered','#58a6ff'],['accepted','Accepted','#3fb950'],['rejected','Rejected','#f85149'],['expired','Expired','#6e7681'],['withdrawn','Withdrawn','#8b949e']];
      statuses.forEach(([s, label, color]) => {
        const cnt = bs[s] || 0;
        if(cnt > 0){
          html += '<div style="background:#12171e;border:1px solid #1c2129;border-radius:6px;padding:8px;text-align:center"><div style="font-size:18px;font-weight:800;color:'+color+'">'+cnt+'</div><div style="font-size:9px;color:#585e68;text-transform:uppercase">'+label+'</div></div>';
        }
      });
      html += '</div>';
      html += '<div style="text-align:center;font-size:11px;color:#6e7681">Total: '+stats.total_rounds+' rounds &middot; $'+stats.total_offered_usd.toLocaleString('en-US')+' offered</div>';
      list.innerHTML = html;
    }
  } catch(e){
    console.error('Failed to load negotiation stats:', e);
  }
}

async function loadClaimNegotiations(claimId){
  const panel = document.getElementById('claimNegPanel');
  if(!panel) return;
  try {
    const res = await fetch(API+'/negotiations/claim/'+claimId, {headers:authHeaders()});
    if(!res.ok){ panel.innerHTML='<div style="color:#484f58;font-size:11px">No negotiations</div>'; return; }
    const data = await res.json();
    if(!data.rounds || data.rounds.length === 0){
      panel.innerHTML = '<div style="color:#484f58;font-size:11px;text-align:center">No negotiation rounds yet</div>';
      return;
    }
    let html = '<div style="margin-bottom:6px;font-size:10px;color:#6e7681">'+data.total_rounds+' round(s) &middot; Claimed: $'+(data.amount_claimed||0).toLocaleString('en-US',{minimumFractionDigits:2})+' &middot; Latest: '+data.current_status+'</div>';
    html += data.rounds.map(r => {
      const offerStr = '$' + (r.offer_amount||0).toLocaleString('en-US',{minimumFractionDigits:2});
      const counterStr = r.counter_amount ? ' â†’ $'+r.counter_amount.toLocaleString('en-US',{minimumFractionDigits:2}) : '';
      return '<div class="neg-drawer-round">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
          '<span class="neg-round-num">Round '+r.round_number+' ('+r.initiated_by+')</span>' +
          '<span class="neg-round-status '+r.status+'">'+r.status+'</span>' +
        '</div>' +
        '<div class="neg-amounts"><span class="neg-offer">Offer: '+offerStr+'</span>'+(counterStr ? '<span class="neg-counter">Counter: '+counterStr+'</span>' : '')+'</div>' +
        (r.terms ? '<div class="neg-terms">'+r.terms+'</div>' : '') +
        (r.status === 'pending' ? '<div style="margin-top:4px;display:flex;gap:4px"><button onclick="counterNeg(\''+r.negotiation_id+'\')" style="background:#1f6feb;color:#fff;border:none;border-radius:3px;padding:2px 8px;font-size:9px;cursor:pointer">Counter</button><button onclick="resolveNeg(\''+r.negotiation_id+'\',\'accepted\')" style="background:#238636;color:#fff;border:none;border-radius:3px;padding:2px 8px;font-size:9px;cursor:pointer">Accept</button><button onclick="resolveNeg(\''+r.negotiation_id+'\',\'rejected\')" style="background:#da3633;color:#fff;border:none;border-radius:3px;padding:2px 8px;font-size:9px;cursor:pointer">Reject</button></div>' : '') +
        (r.status === 'countered' ? '<div style="margin-top:4px;display:flex;gap:4px"><button onclick="resolveNeg(\''+r.negotiation_id+'\',\'accepted\')" style="background:#238636;color:#fff;border:none;border-radius:3px;padding:2px 8px;font-size:9px;cursor:pointer">Accept Counter</button><button onclick="resolveNeg(\''+r.negotiation_id+'\',\'rejected\')" style="background:#da3633;color:#fff;border:none;border-radius:3px;padding:2px 8px;font-size:9px;cursor:pointer">Reject</button></div>' : '') +
      '</div>';
    }).join('');
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#484f58;font-size:11px">Error loading negotiations</div>';
  }
}

async function promptNewNegotiation(claimId){
  const amount = prompt('Enter offer amount ($):');
  if(!amount || isNaN(parseFloat(amount))) return;
  const terms = prompt('Terms (optional):', '') || '';
  const initiator = prompt('Initiated by (claimant/respondent/mediator):', 'claimant') || 'claimant';
  try {
    const res = await fetch(API+'/negotiations', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({claim_id:claimId, offer_amount:parseFloat(amount), terms:terms, initiated_by:initiator})
    });
    if(!res.ok){ const err = await res.json(); throw new Error(err.detail||'Failed'); }
    loadClaimNegotiations(claimId);
    fetchNegotiationStats();
  } catch(e){ alert('Failed: '+e.message); }
}

async function counterNeg(negId){
  const amount = prompt('Enter counter-offer amount ($):');
  if(!amount || isNaN(parseFloat(amount))) return;
  const note = prompt('Response note (optional):', '') || '';
  try {
    await fetch(API+'/negotiations/'+negId+'/counter', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({counter_amount:parseFloat(amount), response_note:note, responded_by:'respondent'})
    });
    // Refresh
    const panel = document.getElementById('claimNegPanel');
    if(panel) panel.innerHTML = '<div style="color:#484f58;text-align:center;padding:8px;font-size:12px">Refreshing...</div>';
    fetchNegotiationStats();
  } catch(e){ alert('Failed: '+e.message); }
}

async function resolveNeg(negId, status){
  const note = prompt('Note (optional):', '') || '';
  try {
    await fetch(API+'/negotiations/'+negId+'/resolve', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({status:status, response_note:note, responded_by:'operator'})
    });
    fetchNegotiationStats();
  } catch(e){ alert('Failed: '+e.message); }
}

// ===== TASK QUEUE & OPERATOR ASSIGNMENTS =====

let tqCurrentFilter = 'all';
const TQ_PRI_COLORS = {critical:'#f85149',urgent:'#f0883e',high:'#d29922',normal:'#58a6ff',low:'#3fb950'};

async function fetchTaskStats(){
  try {
    const r = await fetch(API+'/tasks/stats', {headers:authHeaders()});
    const d = await r.json();
    document.getElementById('tqTotal').textContent = d.total_tasks||0;
    document.getElementById('tqOpen').textContent = (d.by_status?.open||0)+(d.by_status?.blocked||0);
    document.getElementById('tqInProgress').textContent = d.by_status?.in_progress||0;
    document.getElementById('tqOverdue').textContent = d.overdue||0;
    document.getElementById('tqCompleted').textContent = d.completed||0;
    document.getElementById('taskQueueWidget').style.display='block';
    fetchTaskList();
  } catch(e){ console.warn('Task stats error:', e); }
}

async function fetchTaskList(){
  try {
    let url = API+'/tasks?limit=50';
    if(tqCurrentFilter==='overdue') url = API+'/tasks?overdue=true&limit=50';
    else if(tqCurrentFilter!=='all') url = API+'/tasks?status='+tqCurrentFilter+'&limit=50';
    const r = await fetch(url, {headers:authHeaders()});
    const d = await r.json();
    const list = document.getElementById('taskQueueList');
    if(!d.tasks||!d.tasks.length){
      list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No tasks match the filter</div>';
      return;
    }
    const now = new Date();
    list.innerHTML = d.tasks.map(t => {
      const overdue = t.due_at && new Date(t.due_at) < now && !['completed','cancelled'].includes(t.status);
      const dueStr = t.due_at ? new Date(t.due_at).toLocaleDateString() : '';
      const assignee = t.assigned_to ? ' &middot; '+t.assigned_to : '';
      return '<div class="tq-item" onclick="viewTaskDetail(\''+t.task_id+'\')">'+
        '<div class="tq-pri '+(t.priority||'normal')+'"></div>'+
        '<div class="tq-item-body">'+
          '<div class="tq-item-title">'+t.title+'</div>'+
          '<div class="tq-item-meta">'+t.task_type+assignee+(dueStr?' &middot; Due: '+dueStr:'')+(overdue?' <span class="tq-overdue">OVERDUE</span>':'')+'</div>'+
        '</div>'+
        '<span class="tq-status-badge '+t.status+'">'+t.status.replace('_',' ')+'</span>'+
      '</div>';
    }).join('');
  } catch(e){ console.warn('Task list error:', e); }
}

function filterTasks(filter){
  tqCurrentFilter = filter;
  document.querySelectorAll('.tq-filter-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  fetchTaskList();
}

function showCreateTaskModal(claimId){
  const cid = claimId||'';
  const title = prompt('Task title:');
  if(!title) return;
  const type = prompt('Type (manual/follow_up/review/outreach/escalation/compliance/investigation):', 'manual')||'manual';
  const priority = prompt('Priority (low/normal/high/urgent/critical):', 'normal')||'normal';
  const assignee = prompt('Assign to (op_lead/op_analyst_1/op_analyst_2/op_escalation or leave blank):', '')||null;
  const dueIn = prompt('Due in how many days? (blank for no deadline):', '');
  let due_at = null;
  if(dueIn && !isNaN(parseInt(dueIn))){
    const d = new Date(); d.setDate(d.getDate()+parseInt(dueIn));
    due_at = d.toISOString();
  }
  const body = {title, task_type:type, priority, assigned_to:assignee, due_at};
  if(cid) body.claim_id = cid;
  fetch(API+'/tasks', {
    method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
    body:JSON.stringify(body)
  }).then(()=>{ fetchTaskStats(); }).catch(e=>alert('Failed: '+e.message));
}

function promptNewTaskForClaim(claimId){
  showCreateTaskModal(claimId);
}

async function viewTaskDetail(taskId){
  const action = prompt('Action for '+taskId+':\n1) Start (in_progress)\n2) Complete\n3) Cancel\n4) Block\n5) Assign\n\nEnter number or cancel:', '');
  if(!action) return;
  const actionMap = {'1':'in_progress','2':'completed','3':'cancelled','4':'blocked'};
  if(action==='5'){
    const op = prompt('Assign to:', 'op_analyst_1');
    if(!op) return;
    await fetch(API+'/tasks/'+taskId+'/assign', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({assigned_to:op})
    });
  } else if(actionMap[action]){
    await fetch(API+'/tasks/'+taskId+'/transition', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({status:actionMap[action]})
    });
  }
  fetchTaskStats();
}

async function loadClaimTasks(claimId){
  const panel = document.getElementById('claimTaskPanel');
  if(!panel) return;
  try {
    const r = await fetch(API+'/tasks/claim/'+claimId, {headers:authHeaders()});
    const d = await r.json();
    if(!d.tasks||!d.tasks.length){
      panel.innerHTML = '<div style="color:#484f58;text-align:center;padding:8px;font-size:11px">No tasks for this claim</div>';
      return;
    }
    panel.innerHTML = '<div style="font-size:10px;color:#6e7681;margin-bottom:6px">'+d.open+' open / '+d.completed+' done</div>'+
      d.tasks.map(t => {
        const overdue = t.due_at && new Date(t.due_at) < new Date() && !['completed','cancelled'].includes(t.status);
        return '<div class="tq-drawer-item">'+
          '<div class="tq-pri '+(t.priority||'normal')+'" style="height:20px"></div>'+
          '<div style="flex:1;min-width:0">'+
            '<div style="font-weight:600;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+t.title+'</div>'+
            '<div style="font-size:10px;color:#6e7681">'+t.task_type+(t.assigned_to?' &middot; '+t.assigned_to:'')+(overdue?' <span class="tq-overdue">OVERDUE</span>':'')+'</div>'+
          '</div>'+
          '<span class="tq-status-badge '+t.status+'" style="font-size:8px">'+t.status.replace('_',' ')+'</span>'+
          (t.status==='open'?'<button style="background:#1f6feb;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer;margin-left:4px" onclick="event.stopPropagation();quickTransitionTask(\''+t.task_id+'\',\'in_progress\',\''+claimId+'\')">Start</button>':'')+
          (t.status==='in_progress'?'<button style="background:#238636;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:9px;cursor:pointer;margin-left:4px" onclick="event.stopPropagation();quickTransitionTask(\''+t.task_id+'\',\'completed\',\''+claimId+'\')">Done</button>':'')+
        '</div>';
      }).join('');
  } catch(e){ panel.innerHTML = '<div style="color:#f85149;font-size:11px">Error loading tasks</div>'; }
}

async function quickTransitionTask(taskId, status, claimId){
  try {
    await fetch(API+'/tasks/'+taskId+'/transition', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({status:status})
    });
    loadClaimTasks(claimId);
    fetchTaskStats();
  } catch(e){ alert('Failed: '+e.message); }
}

// ===== OPERATOR PERFORMANCE SCORECARDS =====

const SC_GRADE_COLORS = {A:'#3fb950',B:'#58a6ff',C:'#d29922',D:'#f0883e',F:'#f85149'};
const SC_AVATAR_COLORS = ['#1f6feb','#8b5cf6','#d2a8ff','#f0883e','#3fb950','#58a6ff','#f85149','#d29922'];

async function fetchScorecards(){
  try {
    const r = await fetch(API+'/scorecards', {headers:authHeaders()});
    const d = await r.json();
    const s = d.summary||{};
    document.getElementById('scOpCount').textContent = s.total_operators||0;
    document.getElementById('scAvgScore').textContent = s.avg_score||0;
    document.getElementById('scTasksDone').textContent = s.total_tasks_completed||0;
    document.getElementById('scOverdue').textContent = s.total_overdue||0;
    document.getElementById('scorecardWidget').style.display='block';
    const container = document.getElementById('scorecardCards');
    if(!d.scorecards||!d.scorecards.length){
      container.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px;grid-column:1/-1">No operator data available</div>';
      return;
    }
    container.innerHTML = d.scorecards.map((sc, i) => {
      const initials = (sc.name||'??').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
      const avatarColor = SC_AVATAR_COLORS[i % SC_AVATAR_COLORS.length];
      const gradeColor = SC_GRADE_COLORS[sc.grade]||'#6e7681';
      const taskRate = sc.tasks?.completion_rate||0;
      const barColor = taskRate >= 70 ? '#3fb950' : taskRate >= 40 ? '#d29922' : '#f85149';
      return '<div class="sc-card" onclick="showOperatorDetail(\''+sc.operator_id+'\')">'+
        '<div class="sc-card-header">'+
          '<div class="sc-avatar" style="background:'+avatarColor+'">'+initials+'</div>'+
          '<div><div class="sc-card-name">'+sc.name+'</div><div class="sc-card-role">'+sc.role+'</div></div>'+
          '<div class="sc-score-circle sc-grade-'+sc.grade+'">'+sc.grade+'</div>'+
        '</div>'+
        '<div class="sc-metrics">'+
          '<div class="sc-metric"><div class="sc-metric-val">'+sc.claims.assigned+'</div><div class="sc-metric-lbl">Claims</div></div>'+
          '<div class="sc-metric"><div class="sc-metric-val">'+sc.tasks.completed+'</div><div class="sc-metric-lbl">Tasks Done</div></div>'+
          '<div class="sc-metric"><div class="sc-metric-val" style="color:'+(sc.tasks.overdue>0?'#f85149':'#3fb950')+'">'+sc.tasks.overdue+'</div><div class="sc-metric-lbl">Overdue</div></div>'+
        '</div>'+
        '<div class="sc-bar"><div class="sc-bar-fill" style="width:'+taskRate+'%;background:'+barColor+'"></div></div>'+
        '<div style="font-size:9px;color:#585e68;margin-top:3px;text-align:right">Task completion: '+taskRate+'%</div>'+
      '</div>';
    }).join('');
  } catch(e){ console.warn('Scorecards error:', e); }
}

async function showOperatorDetail(opId){
  try {
    const r = await fetch(API+'/scorecards/'+opId, {headers:authHeaders()});
    const sc = await r.json();
    const msg = `--- ${sc.name} (${sc.role}) ---
Score: ${sc.overall_score} (${sc.grade})

Claims: ${sc.claims.assigned} / ${sc.claims.max_caseload} (${sc.claims.utilization_pct}% utilization)

Tasks: ${sc.tasks.total} total, ${sc.tasks.completed} done, ${sc.tasks.open} open, ${sc.tasks.overdue} overdue
Completion Rate: ${sc.tasks.completion_rate}%
Avg Time: ${sc.tasks.avg_completion_minutes} min

Correspondence: ${sc.correspondence.sent} sent, ${sc.correspondence.responded} responded
Compliance: ${sc.compliance.checks_performed} checks, ${sc.compliance.passed} passed
Negotiations: ${sc.negotiations.created} started, ${sc.negotiations.accepted} accepted
Activity: ${sc.activity.actions_30d} actions (30d), ${sc.activity.watchlist_items} watching`;
    alert(msg);
  } catch(e){ alert('Failed to load scorecard: '+e.message); }
}

// ===== EXPORT & DOWNLOAD CENTER =====

function formatBytes(bytes){
  if(bytes===0) return '0 B';
  const k=1024, sizes=['B','KB','MB','GB'];
  const i=Math.floor(Math.log(bytes)/Math.log(k));
  return parseFloat((bytes/Math.pow(k,i)).toFixed(1))+' '+sizes[i];
}

async function fetchExportStats(){
  try {
    const r = await fetch(API+'/exports/stats', {headers:authHeaders()});
    const d = await r.json();
    document.getElementById('expTotal').textContent = d.total_exports||0;
    document.getElementById('expRecords').textContent = (d.total_records_exported||0).toLocaleString();
    document.getElementById('expSize').textContent = formatBytes(d.total_size_bytes||0);
    document.getElementById('expTypes').textContent = Object.keys(d.by_type||{}).length;
    document.getElementById('exportWidget').style.display='block';
    // Recent exports
    const hist = document.getElementById('exportHistory');
    if(!d.recent_exports||!d.recent_exports.length){
      hist.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:12px">No exports yet</div>';
      return;
    }
    hist.innerHTML = d.recent_exports.map(e => {
      const date = new Date(e.created_at).toLocaleString();
      return '<div class="exp-hist-item">'+
        '<span class="exp-fmt '+e.format+'">'+e.format+'</span>'+
        '<span style="color:#e6edf3;font-weight:600;flex:1">'+e.export_type+'</span>'+
        '<span style="color:#6e7681">'+e.record_count+' records</span>'+
        '<span style="color:#585e68">'+formatBytes(e.file_size_bytes)+'</span>'+
        '<span style="color:#484f58;font-size:10px">'+date+'</span>'+
      '</div>';
    }).join('');
  } catch(e){ console.warn('Export stats error:', e); }
}

async function runExport(type, format){
  try {
    const r = await fetch(API+'/exports', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({export_type:type, format:format})
    });
    if(format==='csv'){
      const text = await r.text();
      const blob = new Blob([text], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = type+'_export.csv'; a.click();
      URL.revokeObjectURL(url);
      alert('CSV export downloaded: '+type);
    } else {
      const d = await r.json();
      // Download as JSON file
      const blob = new Blob([JSON.stringify(d.data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = type+'_export.json'; a.click();
      URL.revokeObjectURL(url);
      alert('JSON export: '+d.record_count+' records ('+formatBytes(d.file_size_bytes)+')');
    }
    fetchExportStats();
  } catch(e){ alert('Export failed: '+e.message); }
}

// ===== CASE MILESTONES & PROGRESS TRACKING =====

const MS_STATUS_ICONS = {pending:'\u23F3',in_progress:'\u25B6',completed:'\u2705',skipped:'\u23ED',blocked:'\u26D4'};

async function fetchMilestoneStats(){
  try {
    const r = await fetch(API+'/milestones/stats', {headers:authHeaders()});
    const d = await r.json();
    document.getElementById('msClaims').textContent = d.claims_with_milestones||0;
    document.getElementById('msCompleted').textContent = d.by_status?.completed||0;
    document.getElementById('msAvgProgress').textContent = (d.avg_progress_pct||0)+'%';
    document.getElementById('msOverdue').textContent = d.overdue||0;
    const pct = d.completion_rate||0;
    document.getElementById('msGlobalBar').style.width = pct+'%';
    document.getElementById('msGlobalPct').textContent = pct+'% overall completion';
    document.getElementById('milestoneWidget').style.display='block';
  } catch(e){ console.warn('Milestone stats error:', e); }
}

async function loadClaimMilestones(claimId){
  const panel = document.getElementById('claimMilestonePanel');
  if(!panel) return;
  try {
    const r = await fetch(API+'/milestones/claim/'+claimId, {headers:authHeaders()});
    const d = await r.json();
    if(!d.milestones||!d.milestones.length){
      panel.innerHTML = '<div style="text-align:center;padding:8px">'+
        '<div style="color:#484f58;font-size:11px;margin-bottom:8px">No milestones set up yet</div>'+
        '<button class="ms-init-btn" onclick="initMilestones(\''+claimId+'\')">Initialize Default Milestones</button>'+
      '</div>';
      return;
    }
    let html = '<div style="font-size:10px;color:#6e7681;margin-bottom:6px">Progress: '+d.progress_pct+'% ('+d.completed+'/'+d.total+')</div>';
    html += '<div class="ms-progress-bar"><div class="ms-progress-fill" style="width:'+d.progress_pct+'%"></div></div>';
    html += '<div class="ms-timeline">';
    d.milestones.forEach(m => {
      const icon = MS_STATUS_ICONS[m.status]||'\u23F3';
      const dateStr = m.completed_at ? new Date(m.completed_at).toLocaleDateString() : (m.target_date ? 'Due: '+new Date(m.target_date).toLocaleDateString() : '');
      html += '<div class="ms-step '+m.status+'">'+
        '<div class="ms-step-title">'+icon+' '+m.title+'</div>'+
        '<div class="ms-step-meta">'+m.category+(dateStr?' &middot; '+dateStr:'')+'</div>';
      if(m.status==='pending'||m.status==='in_progress'){
        html += '<button style="background:#238636;color:#fff;border:none;border-radius:3px;padding:2px 8px;font-size:9px;cursor:pointer;margin-top:3px" onclick="event.stopPropagation();completeMilestone(\''+m.milestone_id+'\',\''+claimId+'\')">Complete</button>';
      }
      html += '</div>';
    });
    html += '</div>';
    panel.innerHTML = html;
  } catch(e){ panel.innerHTML = '<div style="color:#f85149;font-size:11px">Error loading milestones</div>'; }
}

async function initMilestones(claimId){
  try {
    await fetch(API+'/milestones/initialize/'+claimId, {method:'POST', headers:authHeaders()});
    loadClaimMilestones(claimId);
    fetchMilestoneStats();
  } catch(e){ alert('Failed: '+e.message); }
}

async function completeMilestone(msId, claimId){
  try {
    await fetch(API+'/milestones/'+msId+'/complete', {
      method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'},
      body:JSON.stringify({completed_by:'operator'})
    });
    loadClaimMilestones(claimId);
    fetchMilestoneStats();
  } catch(e){ alert('Failed: '+e.message); }
}

// ===== RESPONDENT PROFILE & HISTORY =====

let rpAllProfiles = [];
const RP_TIER_COLORS = {critical:'#f85149',high:'#f0883e',medium:'#d29922',low:'#3fb950'};

async function fetchRespondentProfiles(){
  try {
    const r = await fetch(API+'/respondent-profiles?limit=100', {headers:authHeaders()});
    const d = await r.json();
    rpAllProfiles = d.respondents||[];
    document.getElementById('respondentProfileWidget').style.display='block';
    renderRespondentList(rpAllProfiles);
  } catch(e){ console.warn('Respondent profiles error:', e); }
}

function renderRespondentList(profiles){
  const list = document.getElementById('respondentProfileList');
  if(!profiles||!profiles.length){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No respondent data</div>';
    return;
  }
  list.innerHTML = profiles.map(p => {
    const tierColor = RP_TIER_COLORS[p.risk_tier]||'#6e7681';
    return '<div class="rp-card" onclick="showRespondentDetail(\''+encodeURIComponent(p.respondent_entity)+'\')">'+
      '<div class="rp-card-header">'+
        '<span class="rp-card-name">'+p.respondent_entity+'</span>'+
        '<span class="rp-risk '+p.risk_tier+'">'+p.risk_tier+'</span>'+
      '</div>'+
      '<div class="rp-card-stats">'+
        '<div class="rp-stat"><div class="rp-stat-val">'+p.claim_count+'</div><div class="rp-stat-lbl">Claims</div></div>'+
        '<div class="rp-stat"><div class="rp-stat-val">$'+(p.total_claimed_usd||0).toLocaleString()+'</div><div class="rp-stat-lbl">Claimed</div></div>'+
        '<div class="rp-stat"><div class="rp-stat-val">'+p.resolved+'</div><div class="rp-stat-lbl">Resolved</div></div>'+
        '<div class="rp-stat"><div class="rp-stat-val" style="color:'+tierColor+'">'+p.risk_score+'</div><div class="rp-stat-lbl">Risk</div></div>'+
      '</div>'+
    '</div>';
  }).join('');
}

function filterRespondentProfiles(query){
  if(!query){
    renderRespondentList(rpAllProfiles);
    return;
  }
  const q = query.toLowerCase();
  const filtered = rpAllProfiles.filter(p => p.respondent_entity.toLowerCase().includes(q));
  renderRespondentList(filtered);
}

async function showRespondentDetail(encodedEntity){
  const entity = decodeURIComponent(encodedEntity);
  try {
    const r = await fetch(API+'/respondent-profiles/'+encodedEntity, {headers:authHeaders()});
    const p = await r.json();
    const msg = `--- ${p.respondent_entity} ---
Risk: ${p.risk_tier.toUpperCase()} (score: ${p.risk_score})

CLAIMS: ${p.claims.total} total
  By status: ${Object.entries(p.claims.by_status).map(([k,v])=>k+': '+v).join(', ')}
  Harm types: ${Object.entries(p.claims.harm_types).map(([k,v])=>k+': '+v).join(', ')}
  Total claimed: $${p.financial.total_claimed.toLocaleString()}

FINANCIAL:
  Offered: $${p.financial.total_offered.toLocaleString()}
  Accepted: $${p.financial.total_accepted.toLocaleString()}
  Recovered: $${p.financial.total_recovered.toLocaleString()}
  Recovery rate: ${p.financial.recovery_rate}%

Negotiations: ${p.negotiations.total_rounds} rounds, ${p.negotiations.accepted} accepted
Correspondence: ${p.correspondence.total_messages} messages
Compliance: ${p.compliance.total_checks} checks, ${p.compliance.failures} failures
Settlements: ${p.settlements.total} total, ${p.settlements.accepted} accepted

First claim: ${p.claims.first_claim||'N/A'}
Last claim: ${p.claims.last_claim||'N/A'}`;
    alert(msg);
  } catch(e){ alert('Failed to load profile: '+e.message); }
}

// ===== KNOWLEDGE BASE & SOPs =====

let kbCurrentCategory = '';

async function fetchKBStats(){
  try {
    const [statsR, listR] = await Promise.all([
      fetch(API_BASE+'/v1/kb/stats',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/kb/articles',{headers:{'Authorization':'Bearer operator'}})
    ]);
    if(!statsR.ok || !listR.ok) throw new Error();
    const stats = await statsR.json();
    const articles = await listR.json();
    const widget = document.getElementById('kbWidget');
    if(widget) widget.style.display = 'block';

    document.getElementById('kbPublished').textContent = stats.published;
    document.getElementById('kbViews').textContent = stats.total_views;
    document.getElementById('kbVotes').textContent = stats.total_votes;
    document.getElementById('kbCategories').textContent = Object.keys(stats.by_category).length;

    // Category filter bar
    const catBar = document.getElementById('kbCatBar');
    const cats = Object.keys(stats.by_category);
    let catHtml = '<button class="kb-cat-btn '+(kbCurrentCategory===''?'active':'')+'" onclick="filterKBCategory(\'\')">All</button>';
    cats.forEach(c => {
      catHtml += '<button class="kb-cat-btn '+(kbCurrentCategory===c?'active':'')+'" onclick="filterKBCategory(\''+c+'\')">'+c.replace(/_/g,' ')+'</button>';
    });
    catBar.innerHTML = catHtml;

    renderKBArticles(articles);
  } catch(e){
    console.error('Failed to load KB:', e);
  }
}

function renderKBArticles(articles){
  const list = document.getElementById('kbList');
  if(!articles || articles.length === 0){
    list.innerHTML = '<span style="color:#484f58;font-size:11px">No articles found</span>';
    return;
  }
  const KB_CAT_ICONS = {
    'general':'&#x1F4D6;','sop':'&#x1F4CB;','claim_handling':'&#x1F4C2;','escalation':'&#x1F6A8;',
    'recovery':'&#x1F4B0;','settlement':'&#x1F91D;','compliance':'&#x2696;','onboarding':'&#x1F393;',
    'faq':'&#x2753;','policy':'&#x1F4DC;'
  };
  list.innerHTML = articles.map(a => {
    const icon = KB_CAT_ICONS[a.category] || '&#x1F4D6;';
    const tags = (a.tags||[]).map(t => '<span class="kb-article-tag">'+escapeHtml(t)+'</span>').join('');
    return '<div class="kb-article" onclick="openKBArticle(\''+a.article_id+'\')">' +
      '<div class="kb-article-title">'+icon+' '+escapeHtml(a.title)+'</div>' +
      '<div class="kb-article-preview">'+escapeHtml(a.content)+'</div>' +
      '<div class="kb-article-meta">' +
        '<span>'+a.category.replace(/_/g,' ')+'</span>' +
        '<span>&#x1F441; '+a.view_count+'</span>' +
        '<span>&#x1F44D; '+a.helpful_votes+'</span>' +
        (tags ? '<div class="kb-article-tags">'+tags+'</div>' : '') +
      '</div>' +
    '</div>';
  }).join('');
}

async function filterKBCategory(cat){
  kbCurrentCategory = cat;
  try {
    const url = cat ? API_BASE+'/v1/kb/articles?category='+cat : API_BASE+'/v1/kb/articles';
    const r = await fetch(url,{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const articles = await r.json();
    renderKBArticles(articles);
    // Update active button
    document.querySelectorAll('.kb-cat-btn').forEach(b => {
      b.classList.toggle('active', b.textContent.toLowerCase().replace(/ /g,'_') === cat || (!cat && b.textContent === 'All'));
    });
  } catch(e){ console.error('Filter KB failed:', e); }
}

async function searchKB(){
  const q = document.getElementById('kbSearchInput').value.trim();
  if(!q) { fetchKBStats(); return; }
  try {
    const r = await fetch(API_BASE+'/v1/kb/search?q='+encodeURIComponent(q),{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const articles = await r.json();
    renderKBArticles(articles);
  } catch(e){ console.error('KB search failed:', e); }
}

async function openKBArticle(articleId){
  try {
    const r = await fetch(API_BASE+'/v1/kb/articles/'+articleId,{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const a = await r.json();
    const viewer = document.getElementById('kbViewer');
    const content = document.getElementById('kbViewerContent');
    const tags = (a.tags||[]).map(t => '<span class="kb-article-tag">'+escapeHtml(t)+'</span>').join(' ');
    content.innerHTML = '<h2>'+escapeHtml(a.title)+'</h2>' +
      '<div class="kb-viewer-meta">' +
        '<span>By '+escapeHtml(a.author)+'</span> &middot; ' +
        '<span>'+a.category.replace(/_/g,' ')+'</span> &middot; ' +
        '<span>&#x1F441; '+a.view_count+' views</span> &middot; ' +
        '<span>&#x1F44D; '+a.helpful_votes+' helpful</span>' +
        (tags ? '<div style="margin-top:6px">'+tags+'</div>' : '') +
      '</div>' +
      '<div class="kb-viewer-content">'+escapeHtml(a.content)+'</div>' +
      '<div class="kb-viewer-actions">' +
        '<button onclick="voteKBArticle(\''+articleId+'\')" style="background:rgba(255,211,61,.1);border-color:#ffd33d;color:#ffd33d">&#x1F44D; Helpful</button>' +
        '<button onclick="deleteKBArticle(\''+articleId+'\');" style="color:#f85149;border-color:#f85149">&#x1F5D1; Delete</button>' +
      '</div>';
    viewer.classList.add('open');
  } catch(e){ alert('Failed to load article'); }
}

function closeKBViewer(){
  document.getElementById('kbViewer').classList.remove('open');
}

async function voteKBArticle(articleId){
  try {
    const r = await fetch(API_BASE+'/v1/kb/articles/'+articleId+'/vote',{
      method:'POST', headers:{'Authorization':'Bearer operator'}
    });
    if(!r.ok) throw new Error();
    const data = await r.json();
    openKBArticle(articleId);
    fetchKBStats();
  } catch(e){ alert('Failed to vote'); }
}

async function deleteKBArticle(articleId){
  if(!confirm('Delete this article?')) return;
  try {
    await fetch(API_BASE+'/v1/kb/articles/'+articleId,{
      method:'DELETE', headers:{'Authorization':'Bearer operator'}
    });
    closeKBViewer();
    fetchKBStats();
  } catch(e){ alert('Failed to delete'); }
}

function showCreateArticleModal(){
  const modal = document.getElementById('kbCreateModal');
  modal.innerHTML = '<div class="tpl-modal" onclick="if(event.target===this)this.parentElement.style.display=\'none\'">' +
    '<div class="tpl-modal-box">' +
      '<h3>&#x1F4DA; New Knowledge Base Article</h3>' +
      '<div class="tpl-form-group"><label>Title</label><input type="text" id="kbNewTitle" placeholder="e.g. How to Handle Unauthorized Charge Claims"></div>' +
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">' +
        '<div class="tpl-form-group"><label>Category</label><select id="kbNewCategory">' +
          '<option value="general">General</option><option value="sop">SOP</option>' +
          '<option value="claim_handling">Claim Handling</option><option value="escalation">Escalation</option>' +
          '<option value="recovery">Recovery</option><option value="settlement">Settlement</option>' +
          '<option value="compliance">Compliance</option><option value="onboarding">Onboarding</option>' +
          '<option value="faq">FAQ</option><option value="policy">Policy</option>' +
        '</select></div>' +
        '<div class="tpl-form-group"><label>Priority (0-10)</label><input type="number" id="kbNewPriority" value="0" min="0" max="10"></div>' +
      '</div>' +
      '<div class="tpl-form-group"><label>Tags (comma-separated)</label><input type="text" id="kbNewTags" placeholder="e.g. chargeback, credit-card, dispute"></div>' +
      '<div class="tpl-form-group"><label>Content</label><textarea id="kbNewContent" style="height:200px" placeholder="Write the article content here..."></textarea></div>' +
      '<div class="tpl-form-actions">' +
        '<button onclick="saveNewArticle()" style="background:#238636;color:#fff">Publish Article</button>' +
        '<button onclick="document.getElementById(\'kbCreateModal\').style.display=\'none\'" style="background:#21262d;color:#8b949e">Cancel</button>' +
      '</div>' +
    '</div></div>';
  modal.style.display = 'block';
}

async function saveNewArticle(){
  const title = document.getElementById('kbNewTitle').value.trim();
  const content = document.getElementById('kbNewContent').value.trim();
  if(!title){ alert('Title is required'); return; }
  if(!content){ alert('Content is required'); return; }
  const tagsStr = document.getElementById('kbNewTags').value.trim();
  const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
  try {
    const r = await fetch(API_BASE+'/v1/kb/articles',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({
        title: title,
        content: content,
        category: document.getElementById('kbNewCategory').value,
        priority: parseInt(document.getElementById('kbNewPriority').value) || 0,
        tags: tags
      })
    });
    if(!r.ok){ const e = await r.json(); throw new Error(e.detail||'Failed'); }
    document.getElementById('kbCreateModal').style.display = 'none';
    await fetchKBStats();
  } catch(e){ alert('Failed to create article: '+e.message); }
}

// ===== CLAIM TEMPLATES =====

const TPL_ICONS = {
  'financial_fraud': '&#x1F4B0;', 'service_failure': '&#x26A0;', 'data_breach': '&#x1F512;',
  'harassment': '&#x1F6AB;', 'unauthorized_charge': '&#x1F4B3;', 'ecommerce': '&#x1F6D2;',
  'fintech': '&#x1F3E6;', 'general': '&#x1F4CB;', 'custom': '&#x2699;'
};

async function fetchTemplateStats(){
  try {
    const [statsR, listR] = await Promise.all([
      fetch(API_BASE+'/v1/templates/stats',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/templates',{headers:{'Authorization':'Bearer operator'}})
    ]);
    if(!statsR.ok || !listR.ok) throw new Error();
    const stats = await statsR.json();
    const templates = await listR.json();
    const widget = document.getElementById('templateWidget');
    if(widget) widget.style.display = 'block';

    document.getElementById('tplActive').textContent = stats.active;
    document.getElementById('tplUses').textContent = stats.total_uses;
    document.getElementById('tplCategories').textContent = Object.keys(stats.by_category).length;

    const grid = document.getElementById('tplGrid');
    if(templates.length === 0){
      grid.innerHTML = '<span style="color:#484f58;font-size:11px">No templates yet â€” create one to speed up claim filing</span>';
      return;
    }
    grid.innerHTML = templates.map(t => {
      const icon = TPL_ICONS[t.category] || TPL_ICONS['general'];
      const badge = t.use_count >= 5 ? '<span class="tpl-tile-badge popular">Popular</span>' : '';
      return '<div class="tpl-tile" onclick="showQuickFileModal(\''+t.template_id+'\')">' +
        badge +
        '<div class="tpl-tile-icon">'+icon+'</div>' +
        '<div class="tpl-tile-name">'+escapeHtml(t.name)+'</div>' +
        '<div class="tpl-tile-desc">'+escapeHtml(t.description || t.category)+'</div>' +
        '<div class="tpl-tile-meta"><span>'+t.use_count+' uses</span><span>'+t.category+'</span></div>' +
      '</div>';
    }).join('');
  } catch(e){
    console.error('Failed to load templates:', e);
  }
}

function showCreateTemplateModal(){
  const modal = document.getElementById('tplCreateModal');
  modal.innerHTML = '<div class="tpl-modal" onclick="if(event.target===this)this.parentElement.style.display=\'none\'">' +
    '<div class="tpl-modal-box">' +
      '<h3>&#x1F4CB; Create Claim Template</h3>' +
      '<div class="tpl-form-group"><label>Template Name</label><input type="text" id="tplName" placeholder="e.g. Unauthorized Credit Card Charge"></div>' +
      '<div class="tpl-form-group"><label>Description</label><textarea id="tplDesc" placeholder="Brief description of when to use this template"></textarea></div>' +
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">' +
        '<div class="tpl-form-group"><label>Category</label><select id="tplCategory">' +
          '<option value="general">General</option><option value="financial_fraud">Financial Fraud</option>' +
          '<option value="service_failure">Service Failure</option><option value="data_breach">Data Breach</option>' +
          '<option value="harassment">Harassment</option><option value="unauthorized_charge">Unauthorized Charge</option>' +
          '<option value="ecommerce">E-Commerce</option><option value="fintech">Fintech</option><option value="custom">Custom</option>' +
        '</select></div>' +
        '<div class="tpl-form-group"><label>Harm Type</label><select id="tplHarmType">' +
          '<option value="">Not Set</option><option value="financial_fraud">Financial Fraud</option>' +
          '<option value="service_failure">Service Failure</option><option value="data_breach">Data Breach</option>' +
          '<option value="harassment">Harassment</option><option value="unauthorized_charge">Unauthorized Charge</option>' +
        '</select></div>' +
      '</div>' +
      '<h4 style="font-size:12px;color:#8b949e;margin:14px 0 8px">Default Field Values</h4>' +
      '<div class="tpl-form-group"><label>Respondent Entity</label><input type="text" id="tplDefRespondent" placeholder="e.g. PayPal"></div>' +
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">' +
        '<div class="tpl-form-group"><label>Default Amount ($)</label><input type="number" id="tplDefAmount" placeholder="0"></div>' +
        '<div class="tpl-form-group"><label>Vertical</label><select id="tplDefVertical">' +
          '<option value="platform_dispute">Platform Dispute</option><option value="ecommerce">E-Commerce</option>' +
          '<option value="fintech">Fintech</option><option value="social_media">Social Media</option>' +
        '</select></div>' +
      '</div>' +
      '<div class="tpl-form-group"><label>Default Description</label><textarea id="tplDefDesc" placeholder="Template description that will pre-fill new claims"></textarea></div>' +
      '<div class="tpl-form-actions">' +
        '<button onclick="saveNewTemplate()" style="background:#238636;color:#fff">Create Template</button>' +
        '<button onclick="document.getElementById(\'tplCreateModal\').style.display=\'none\'" style="background:#21262d;color:#8b949e">Cancel</button>' +
      '</div>' +
    '</div></div>';
  modal.style.display = 'block';
}

async function saveNewTemplate(){
  const name = document.getElementById('tplName').value.trim();
  if(!name){ alert('Template name is required'); return; }
  const body = {
    name: name,
    description: document.getElementById('tplDesc').value.trim(),
    category: document.getElementById('tplCategory').value,
    harm_type: document.getElementById('tplHarmType').value,
    vertical: document.getElementById('tplDefVertical').value,
    default_fields: {}
  };
  const resp = document.getElementById('tplDefRespondent').value.trim();
  const amt = document.getElementById('tplDefAmount').value;
  const desc = document.getElementById('tplDefDesc').value.trim();
  if(resp) body.default_fields.respondent_entity = resp;
  if(amt) body.default_fields.amount_claimed_usd = parseFloat(amt);
  if(desc) body.default_fields.description = desc;
  body.default_fields.vertical = body.vertical;
  body.default_fields.harm_type = body.harm_type;
  try {
    const r = await fetch(API_BASE+'/v1/templates',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify(body)
    });
    if(!r.ok){ const e = await r.json(); throw new Error(e.detail||'Failed'); }
    document.getElementById('tplCreateModal').style.display = 'none';
    await fetchTemplateStats();
  } catch(e){ alert('Failed to create template: '+e.message); }
}

async function showQuickFileModal(templateId){
  try {
    const r = await fetch(API_BASE+'/v1/templates/'+templateId,{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const tpl = await r.json();
    const df = tpl.default_fields || {};
    const icon = TPL_ICONS[tpl.category] || TPL_ICONS['general'];

    const modal = document.getElementById('tplQuickFileModal');
    modal.innerHTML = '<div class="tpl-modal" onclick="if(event.target===this)this.parentElement.style.display=\'none\'">' +
      '<div class="tpl-modal-box">' +
        '<h3>'+icon+' Quick File: '+escapeHtml(tpl.name)+'</h3>' +
        '<p style="font-size:11px;color:#8b949e;margin:0 0 16px">'+escapeHtml(tpl.description || 'Fill in claimant details to file a new claim from this template')+'</p>' +
        '<div class="tpl-form-group"><label>Claimant Name *</label><input type="text" id="qfName" placeholder="Full name"></div>' +
        '<div class="tpl-form-group"><label>Claimant Email</label><input type="text" id="qfEmail" placeholder="email@example.com"></div>' +
        '<div class="tpl-form-group"><label>Respondent</label><input type="text" id="qfRespondent" value="'+escapeHtml(df.respondent_entity||'')+'"></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">' +
          '<div class="tpl-form-group"><label>Amount ($)</label><input type="number" id="qfAmount" value="'+(df.amount_claimed_usd||'')+'"></div>' +
          '<div class="tpl-form-group"><label>Harm Type</label><input type="text" id="qfHarm" value="'+escapeHtml(tpl.harm_type||'')+'" readonly style="opacity:.7"></div>' +
        '</div>' +
        '<div class="tpl-form-group"><label>Description</label><textarea id="qfDesc">'+(escapeHtml(df.description||''))+'</textarea></div>' +
        '<div class="tpl-form-actions">' +
          '<button onclick="submitQuickFile(\''+templateId+'\')" style="background:#1f6feb;color:#fff">&#x26A1; File Claim</button>' +
          '<button onclick="document.getElementById(\'tplQuickFileModal\').style.display=\'none\'" style="background:#21262d;color:#8b949e">Cancel</button>' +
        '</div>' +
      '</div></div>';
    modal.style.display = 'block';
  } catch(e){ alert('Failed to load template'); }
}

async function submitQuickFile(templateId){
  const name = document.getElementById('qfName').value.trim();
  if(!name){ alert('Claimant name is required'); return; }
  const overrides = { claimant_name: name };
  const email = document.getElementById('qfEmail').value.trim();
  const resp = document.getElementById('qfRespondent').value.trim();
  const amt = document.getElementById('qfAmount').value;
  const desc = document.getElementById('qfDesc').value.trim();
  if(email) overrides.claimant_email = email;
  if(resp) overrides.respondent_entity = resp;
  if(amt) overrides.amount_claimed_usd = parseFloat(amt);
  if(desc) overrides.description = desc;
  try {
    const r = await fetch(API_BASE+'/v1/templates/'+templateId+'/instantiate',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({overrides: overrides})
    });
    if(!r.ok){ const e = await r.json(); throw new Error(e.detail||'Failed'); }
    const data = await r.json();
    document.getElementById('tplQuickFileModal').style.display = 'none';
    const notif = document.createElement('div');
    notif.style.cssText = 'position:fixed;top:60px;right:20px;background:#238636;color:#fff;padding:12px 20px;border-radius:8px;z-index:9999;font-size:12px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.4)';
    notif.textContent = 'Claim '+data.claim_id+' filed from template "'+data.template_name+'"';
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 4000);
    await updateDashboard();
  } catch(e){ alert('Failed to file claim: '+e.message); }
}

// ===== REMINDERS & FOLLOW-UP SCHEDULER =====

async function fetchReminderStats(){
  try {
    const r = await fetch(API_BASE+'/v1/reminders/stats',{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const stats = await r.json();
    const widget = document.getElementById('reminderWidget');
    if(widget) widget.style.display = 'block';

    document.getElementById('remPending').textContent = stats.pending;
    document.getElementById('remOverdue').textContent = stats.overdue;
    document.getElementById('remCompleted').textContent = stats.completed;
    document.getElementById('remRate').textContent = stats.completion_rate_pct + '%';

    // Render upcoming reminders list
    const list = document.getElementById('remList');
    const items = stats.upcoming || [];
    if(items.length === 0){
      list.innerHTML = '<span style="color:#484f58;font-size:11px">No pending reminders</span>';
      return;
    }
    const now = new Date();
    list.innerHTML = items.map(rem => {
      const due = new Date(rem.due_at);
      const isOverdue = due < now && rem.status === 'pending';
      const isSnoozed = rem.status === 'snoozed';
      const dotClass = isOverdue ? 'overdue' : (isSnoozed ? 'snoozed' : 'pending');
      const itemClass = isOverdue ? 'overdue' : (rem.priority === 'urgent' ? 'urgent' : (isSnoozed ? 'snoozed' : ''));
      const dueStr = isOverdue ? 'OVERDUE â€” ' + timeAgo(rem.due_at) : 'Due ' + timeAgo(rem.due_at);
      const claimLink = rem.claim_id ? ' <span class="rem-claim-link" onclick="openDrawer(\''+rem.claim_id+'\')">'+rem.claim_id+'</span>' : '';
      return '<div class="rem-item '+itemClass+'">' +
        '<div class="rem-dot '+dotClass+'"></div>' +
        '<div class="rem-info">' +
          '<div class="rem-title">'+escapeHtml(rem.title)+'</div>' +
          '<div class="rem-meta">'+dueStr+' &middot; '+rem.priority+claimLink+'</div>' +
        '</div>' +
        '<div class="rem-actions">' +
          '<button onclick="completeReminder(\''+rem.reminder_id+'\')" title="Complete">&#x2705;</button>' +
          '<button onclick="snoozeReminderQuick(\''+rem.reminder_id+'\')" title="Snooze 1 day">&#x1F4A4;</button>' +
          '<button onclick="dismissReminder(\''+rem.reminder_id+'\')" title="Dismiss" style="color:#f85149">&#x2716;</button>' +
        '</div>' +
      '</div>';
    }).join('');
  } catch(e){
    console.error('Failed to load reminder stats:', e);
  }
}

async function createReminderFromWidget(){
  const title = document.getElementById('remNewTitle').value.trim();
  if(!title){ alert('Enter a reminder title'); return; }
  const priority = document.getElementById('remNewPriority').value;
  const due = new Date(Date.now() + 86400000).toISOString();
  try {
    const r = await fetch(API_BASE+'/v1/reminders',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({title:title, due_at:due, priority:priority})
    });
    if(!r.ok) throw new Error();
    document.getElementById('remNewTitle').value = '';
    await fetchReminderStats();
  } catch(e){ alert('Failed to create reminder'); }
}

async function createQuickReminder(days){
  const due = new Date(Date.now() + days*86400000).toISOString();
  const title = prompt('Reminder title:');
  if(!title) return;
  try {
    await fetch(API_BASE+'/v1/reminders',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({title:title, due_at:due, priority:'normal'})
    });
    await fetchReminderStats();
  } catch(e){ alert('Failed to create reminder'); }
}

async function createClaimReminder(claimId, days){
  const due = new Date(Date.now() + days*86400000).toISOString();
  const title = 'Follow up on ' + claimId;
  try {
    const r = await fetch(API_BASE+'/v1/reminders',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({title:title, due_at:due, claim_id:claimId, reminder_type:'follow_up', priority:'normal'})
    });
    if(!r.ok) throw new Error();
    loadClaimReminders(claimId);
    const notif = document.createElement('div');
    notif.style.cssText = 'position:fixed;top:60px;right:20px;background:#ffd33d;color:#0a0e14;padding:10px 18px;border-radius:8px;z-index:9999;font-size:12px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.4)';
    notif.textContent = 'Reminder set for '+days+' day'+(days>1?'s':'');
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2500);
  } catch(e){ alert('Failed to create reminder'); }
}

async function loadClaimReminders(claimId){
  const panel = document.getElementById('claimRemindersPanel');
  if(!panel) return;
  try {
    const r = await fetch(API_BASE+'/v1/reminders?claim_id='+claimId,{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const reminders = await r.json();
    if(reminders.length === 0){
      panel.innerHTML = '<div style="color:#484f58;font-size:11px">No reminders for this claim</div>';
      return;
    }
    const now = new Date();
    panel.innerHTML = reminders.slice(0,5).map(rem => {
      const due = new Date(rem.due_at);
      const isOverdue = due < now && rem.status === 'pending';
      const icon = rem.status === 'completed' ? '&#x2705;' : (isOverdue ? '&#x1F534;' : '&#x1F7E1;');
      return '<div style="padding:4px 0;font-size:11px;border-bottom:1px solid #21262d;display:flex;align-items:center;gap:6px">' +
        '<span>'+icon+'</span>' +
        '<span style="flex:1;color:#e6edf3">'+escapeHtml(rem.title)+'</span>' +
        '<span style="color:#585e68;font-size:10px">'+timeAgo(rem.due_at)+'</span>' +
        (rem.status === 'pending' ? '<button onclick="completeReminder(\''+rem.reminder_id+'\');loadClaimReminders(\''+claimId+'\')" style="background:none;border:none;cursor:pointer;color:#4ade80;font-size:12px" title="Complete">&#x2714;</button>' : '') +
      '</div>';
    }).join('');
  } catch(e){
    panel.innerHTML = '<div style="color:#f85149;font-size:11px">Failed to load reminders</div>';
  }
}

async function completeReminder(reminderId){
  try {
    await fetch(API_BASE+'/v1/reminders/'+reminderId+'/complete',{
      method:'POST', headers:{'Authorization':'Bearer operator'}
    });
    await fetchReminderStats();
  } catch(e){ alert('Failed to complete reminder'); }
}

async function snoozeReminderQuick(reminderId){
  const until = new Date(Date.now() + 86400000).toISOString();
  try {
    await fetch(API_BASE+'/v1/reminders/'+reminderId+'/snooze',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({snooze_until:until})
    });
    await fetchReminderStats();
  } catch(e){ alert('Failed to snooze reminder'); }
}

async function dismissReminder(reminderId){
  try {
    await fetch(API_BASE+'/v1/reminders/'+reminderId+'/dismiss',{
      method:'POST', headers:{'Authorization':'Bearer operator'}
    });
    await fetchReminderStats();
  } catch(e){ alert('Failed to dismiss reminder'); }
}

async function generateIdleReminders(){
  try {
    const r = await fetch(API_BASE+'/v1/reminders/generate-idle',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({idle_days:14})
    });
    if(!r.ok) throw new Error();
    const data = await r.json();
    alert('Generated '+data.reminders_created+' idle claim reminders');
    await fetchReminderStats();
  } catch(e){ alert('Failed to generate idle reminders'); }
}

// ===== SAVED SEARCHES & SMART FILTERS =====

async function fetchSavedSearches(){
  try {
    const r = await fetch(API_BASE+'/v1/saved-searches',{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const searches = await r.json();
    const widget = document.getElementById('savedSearchWidget');
    if(widget) widget.style.display = 'block';

    // Summary KPIs
    const pinned = searches.filter(s => s.is_pinned);
    const totalRuns = searches.reduce((sum, s) => sum + (s.use_count||0), 0);
    document.getElementById('ssTotal').textContent = searches.length;
    document.getElementById('ssPinned').textContent = pinned.length;
    document.getElementById('ssTotalRuns').textContent = totalRuns;

    // Pinned quick-access bar
    const pinnedBar = document.getElementById('ssPinnedBar');
    if(pinned.length > 0){
      pinnedBar.innerHTML = pinned.map(s => {
        const fc = Object.keys(s.filters||{}).filter(k => s.filters[k]).length;
        return '<button class="ss-pin-btn" onclick="executeSavedSearch(\''+s.search_id+'\')">' +
          '<span class="pin-icon">&#x1F4CC;</span> '+escapeHtml(s.name)+
          (fc ? ' <span class="pin-count">'+fc+' filters</span>' : '') +
          '</button>';
      }).join('');
    } else {
      pinnedBar.innerHTML = '<span style="color:#484f58;font-size:10px">Pin searches for quick access</span>';
    }

    // Full list
    const list = document.getElementById('ssList');
    if(searches.length === 0){
      list.innerHTML = '<span style="color:#484f58;font-size:11px">No saved searches yet</span>';
      return;
    }
    list.innerHTML = searches.map(s => {
      const filterTags = Object.entries(s.filters||{})
        .filter(([k,v]) => v)
        .map(([k,v]) => '<span class="ss-filter-tag">'+escapeHtml(k)+': '+escapeHtml(String(v))+'</span>')
        .join('');
      const lastUsed = s.last_used ? 'Used '+timeAgo(s.last_used) : 'Never used';
      return '<div class="ss-item">' +
        '<div class="ss-item-info" onclick="executeSavedSearch(\''+s.search_id+'\')">' +
          '<div class="ss-item-name">'+(s.is_pinned?'&#x1F4CC; ':'')+escapeHtml(s.name)+'</div>' +
          '<div class="ss-item-meta">'+lastUsed+' &middot; '+s.use_count+' runs</div>' +
          (filterTags ? '<div class="ss-item-filters">'+filterTags+'</div>' : '') +
        '</div>' +
        '<div class="ss-item-actions">' +
          '<button onclick="togglePinSearch(\''+s.search_id+'\')" title="'+(s.is_pinned?'Unpin':'Pin')+'">'+(s.is_pinned?'&#x1F4CC;':'&#x1F4CD;')+'</button>' +
          '<button onclick="deleteSavedSearch(\''+s.search_id+'\')" title="Delete" style="color:#f85149">&#x1F5D1;</button>' +
        '</div>' +
      '</div>';
    }).join('');
  } catch(e){
    console.error('Failed to load saved searches:', e);
  }
}

function timeAgo(dateStr){
  const d = new Date(dateStr);
  const now = new Date();
  const secs = Math.floor((now - d) / 1000);
  if(secs < 60) return 'just now';
  if(secs < 3600) return Math.floor(secs/60)+'m ago';
  if(secs < 86400) return Math.floor(secs/3600)+'h ago';
  return Math.floor(secs/86400)+'d ago';
}

function showSavedSearchBuilder(){
  const builder = document.getElementById('ssFilterBuilder');
  builder.style.display = builder.style.display === 'none' ? 'block' : 'none';
}

async function createSavedSearchFromForm(){
  const name = document.getElementById('ssNewName').value.trim();
  if(!name){ alert('Please enter a search name'); return; }
  const filters = {};
  const status = document.getElementById('ssFilterStatus').value;
  const harm = document.getElementById('ssFilterHarm').value;
  const vertical = document.getElementById('ssFilterVertical').value;
  const respondent = document.getElementById('ssFilterRespondent').value.trim();
  const minAmt = document.getElementById('ssFilterMinAmt').value;
  const maxAmt = document.getElementById('ssFilterMaxAmt').value;
  if(status) filters.status = status;
  if(harm) filters.harm_type = harm;
  if(vertical) filters.vertical = vertical;
  if(respondent) filters.respondent = respondent;
  if(minAmt) filters.min_amount = parseFloat(minAmt);
  if(maxAmt) filters.max_amount = parseFloat(maxAmt);
  const desc = document.getElementById('ssNewDesc').value.trim();
  try {
    const r = await fetch(API_BASE+'/v1/saved-searches',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({name:name, description:desc, filters:filters})
    });
    if(!r.ok){ const e = await r.json(); throw new Error(e.detail||'Failed'); }
    // Reset form
    document.getElementById('ssNewName').value = '';
    document.getElementById('ssNewDesc').value = '';
    document.getElementById('ssFilterStatus').value = '';
    document.getElementById('ssFilterHarm').value = '';
    document.getElementById('ssFilterVertical').value = '';
    document.getElementById('ssFilterRespondent').value = '';
    document.getElementById('ssFilterMinAmt').value = '';
    document.getElementById('ssFilterMaxAmt').value = '';
    document.getElementById('ssFilterBuilder').style.display = 'none';
    await fetchSavedSearches();
  } catch(e){ alert('Failed to create saved search: '+e.message); }
}

async function executeSavedSearch(searchId){
  try {
    const r = await fetch(API_BASE+'/v1/saved-searches/'+searchId+'/execute',{
      method:'POST',
      headers:{'Authorization':'Bearer operator'}
    });
    if(!r.ok) throw new Error();
    const data = await r.json();
    // Apply results to claims list
    if(data.claims && Array.isArray(data.claims)){
      allClaims = data.claims;
      renderClaims(allClaims);
      // Switch to claims tab
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const claimsTab = document.querySelector('[onclick*="claims"]');
      if(claimsTab) claimsTab.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      const claimsPanel = document.getElementById('panel-claims');
      if(claimsPanel) claimsPanel.classList.add('active');
      // Show notification
      const notif = document.createElement('div');
      notif.style.cssText = 'position:fixed;top:60px;right:20px;background:#238636;color:#fff;padding:10px 18px;border-radius:8px;z-index:9999;font-size:12px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.4)';
      notif.textContent = '\"'+data.name+'\" â€” '+data.total_results+' claims found';
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }
    await fetchSavedSearches();
  } catch(e){ alert('Failed to execute search'); }
}

async function togglePinSearch(searchId){
  try {
    await fetch(API_BASE+'/v1/saved-searches/'+searchId+'/pin',{
      method:'POST',
      headers:{'Authorization':'Bearer operator'}
    });
    await fetchSavedSearches();
  } catch(e){ alert('Failed to toggle pin'); }
}

async function deleteSavedSearch(searchId){
  if(!confirm('Delete this saved search?')) return;
  try {
    await fetch(API_BASE+'/v1/saved-searches/'+searchId,{
      method:'DELETE',
      headers:{'Authorization':'Bearer operator'}
    });
    await fetchSavedSearches();
  } catch(e){ alert('Failed to delete saved search'); }
}

// ===== WEBHOOKS & INTEGRATIONS =====

async function fetchWebhookStats(){
  try {
    const [statsR, listR] = await Promise.all([
      fetch(API_BASE+'/v1/webhooks/stats',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/webhooks',{headers:{'Authorization':'Bearer operator'}})
    ]);
    if(!statsR.ok || !listR.ok) throw new Error();
    const stats = await statsR.json();
    const list = await listR.json();

    const w = document.getElementById('webhookWidget');
    w.style.display = '';

    document.getElementById('whTotal').textContent = stats.total_webhooks;
    document.getElementById('whActive').textContent = stats.active_webhooks;
    document.getElementById('whDeliveries').textContent = stats.total_deliveries;
    document.getElementById('whRate').textContent = stats.delivery_rate + '%';

    const hooks = list.webhooks || [];
    const container = document.getElementById('whList');
    if(!hooks.length){
      container.innerHTML = '<span style="color:#484f58;font-size:11px">No webhooks registered. Add one below.</span>';
      return;
    }
    let html = '';
    for(const h of hooks){
      const statusCls = h.status === 'active' ? 'active' : h.status === 'paused' ? 'paused' : 'disabled';
      const evts = Array.isArray(h.events) ? h.events.join(', ') : '*';
      const lastFired = h.last_triggered ? new Date(h.last_triggered).toLocaleString() : 'never';
      html += `<div class="wh-item">
        <div class="wh-status-dot ${statusCls}"></div>
        <div class="wh-info">
          <div class="wh-url">${escapeHtml(h.url)}</div>
          <div class="wh-meta">${evts} Â· Last: ${lastFired}</div>
        </div>
        <div class="wh-actions">
          <button onclick="toggleWebhook('${h.webhook_id}','${h.status}')">${h.status==='active'?'Pause':'Activate'}</button>
          <button onclick="testWebhook('${h.webhook_id}')" style="color:#58a6ff">Test</button>
          <button onclick="deleteWebhook('${h.webhook_id}')" style="color:#f85149">Del</button>
        </div>
      </div>`;
    }
    container.innerHTML = html;
  } catch(e){
    console.warn('Webhook stats failed:', e);
  }
}

async function registerWebhookFromWidget(){
  const input = document.getElementById('whNewUrl');
  const url = input.value.trim();
  if(!url){ alert('Enter a webhook URL'); return; }
  try {
    const r = await fetch(API_BASE+'/v1/webhooks',{
      method:'POST',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({url, events:['*'], description:'Added from dashboard'})
    });
    if(!r.ok){ const e = await r.json(); throw new Error(e.detail||'Failed'); }
    input.value = '';
    await fetchWebhookStats();
  } catch(e){ alert('Failed to register webhook: '+e.message); }
}

async function toggleWebhook(id, currentStatus){
  const newStatus = currentStatus === 'active' ? 'paused' : 'active';
  try {
    await fetch(API_BASE+'/v1/webhooks/'+id,{
      method:'PATCH',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({status:newStatus})
    });
    await fetchWebhookStats();
  } catch(e){ alert('Failed to toggle webhook'); }
}

async function testWebhook(id){
  try {
    const r = await fetch(API_BASE+'/v1/webhooks/test',{
      method:'POST',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({webhook_id:id, event:'test.ping', payload:{message:'Test from dashboard'}})
    });
    if(!r.ok) throw new Error();
    const d = await r.json();
    alert('Test fired! Webhooks triggered: ' + d.webhooks_fired);
  } catch(e){ alert('Test failed'); }
}

async function deleteWebhook(id){
  if(!confirm('Delete this webhook?')) return;
  try {
    await fetch(API_BASE+'/v1/webhooks/'+id,{
      method:'DELETE',headers:{'Authorization':'Bearer operator'}
    });
    await fetchWebhookStats();
  } catch(e){ alert('Failed to delete webhook'); }
}


// ===== BULK OPERATIONS (Enhanced) =====

function showBulkModal(action){
  const modal = document.getElementById('bulkModal');
  const n = bulkSelected.size;
  let html = '<div class="bulk-modal" onclick="if(event.target===this)closeBulkModal()"><div class="bulk-modal-box">';
  if(action === 'status'){
    html += `<h4>Change Status (${n} claims)</h4>`;
    html += '<label>New Status</label>';
    html += '<select id="bulkStatusVal"><option value="open">Open</option><option value="under_review">Under Review</option><option value="in_progress">In Progress</option><option value="escalated">Escalated</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select>';
    html += '<div class="bulk-modal-actions"><button class="bulk-btn" onclick="closeBulkModal()">Cancel</button><button class="bulk-btn primary" onclick="executeBulkStatus()">Apply</button></div>';
  } else if(action === 'assign'){
    html += `<h4>Assign Operator (${n} claims)</h4>`;
    html += '<label>Operator ID</label>';
    html += '<input type="text" id="bulkAssignVal" placeholder="e.g. op_001">';
    html += '<div class="bulk-modal-actions"><button class="bulk-btn" onclick="closeBulkModal()">Cancel</button><button class="bulk-btn primary" onclick="executeBulkAssign()">Assign</button></div>';
  } else if(action === 'tag'){
    html += `<h4>Apply Tag (${n} claims)</h4>`;
    html += '<label>Tag Name</label>';
    html += '<input type="text" id="bulkTagVal" placeholder="e.g. priority-review">';
    html += '<div class="bulk-modal-actions"><button class="bulk-btn" onclick="closeBulkModal()">Cancel</button><button class="bulk-btn primary" onclick="executeBulkTag()">Tag All</button></div>';
  } else if(action === 'escalate'){
    html += `<h4>Escalate (${n} claims)</h4>`;
    html += '<label>Reason (optional)</label>';
    html += '<input type="text" id="bulkEscReason" placeholder="Escalation reason...">';
    html += '<div class="bulk-modal-actions"><button class="bulk-btn" onclick="closeBulkModal()">Cancel</button><button class="bulk-btn danger" onclick="executeBulkEscalate()">Escalate All</button></div>';
  }
  html += '</div></div>';
  modal.innerHTML = html;
  modal.style.display = '';
}

function closeBulkModal(){
  document.getElementById('bulkModal').style.display = 'none';
  document.getElementById('bulkModal').innerHTML = '';
}

async function executeBulkStatus(){
  const ids = Array.from(bulkSelected);
  const st = document.getElementById('bulkStatusVal').value;
  closeBulkModal();
  try {
    const r = await fetch(API_BASE+'/v1/bulk/status',{method:'POST',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},body:JSON.stringify({claim_ids:ids,status:st})});
    if(!r.ok) throw new Error();
    const d = await r.json();
    alert(`Updated: ${d.updated}, Skipped: ${d.skipped}`);
    clearBulkSelection();
    updateDashboard();
  } catch(e){ alert('Bulk status update failed'); }
}

async function executeBulkAssign(){
  const ids = Array.from(bulkSelected);
  const op = document.getElementById('bulkAssignVal').value.trim();
  if(!op){ alert('Enter an operator ID'); return; }
  closeBulkModal();
  try {
    const r = await fetch(API_BASE+'/v1/bulk/assign',{method:'POST',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},body:JSON.stringify({claim_ids:ids,operator_id:op})});
    if(!r.ok) throw new Error();
    const d = await r.json();
    alert(`Assigned: ${d.assigned}, Skipped: ${d.skipped}`);
    clearBulkSelection();
    updateDashboard();
  } catch(e){ alert('Bulk assign failed'); }
}

async function executeBulkTag(){
  const ids = Array.from(bulkSelected);
  const tag = document.getElementById('bulkTagVal').value.trim();
  if(!tag){ alert('Enter a tag name'); return; }
  closeBulkModal();
  try {
    const r = await fetch(API_BASE+'/v1/bulk/tag',{method:'POST',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},body:JSON.stringify({claim_ids:ids,tag_name:tag})});
    if(!r.ok) throw new Error();
    const d = await r.json();
    alert(`Tagged: ${d.tagged}, Skipped: ${d.skipped}`);
    clearBulkSelection();
    fetchTagStats();
  } catch(e){ alert('Bulk tag failed'); }
}

async function executeBulkEscalate(){
  const ids = Array.from(bulkSelected);
  const reason = document.getElementById('bulkEscReason').value.trim();
  closeBulkModal();
  try {
    const r = await fetch(API_BASE+'/v1/bulk/escalate',{method:'POST',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},body:JSON.stringify({claim_ids:ids,reason:reason})});
    if(!r.ok) throw new Error();
    const d = await r.json();
    alert(`Escalated: ${d.escalated}, Skipped: ${d.skipped}`);
    clearBulkSelection();
    updateDashboard();
  } catch(e){ alert('Bulk escalate failed'); }
}

async function bulkExportSelected(){
  const ids = Array.from(bulkSelected);
  try {
    const r = await fetch(API_BASE+'/v1/bulk/export',{method:'POST',headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},body:JSON.stringify({claim_ids:ids.length?ids:null})});
    if(!r.ok) throw new Error();
    const d = await r.json();
    // Create download
    const blob = new Blob([d.csv_data], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `ghostledger_export_${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch(e){ alert('Export failed'); }
}


// ===== ACTIVITY TIMELINE =====

const TL_ICONS = {note:'\u270F',audit:'\u2699',recovery:'\uD83D\uDCB0',settlement:'\u2696',outreach:'\uD83D\uDCE8',triage:'\uD83D\uDEA8',tag_added:'\uD83C\uDFF7',document:'\uD83D\uDCCE',group_added:'\uD83D\uDD17',merge_received:'\u2B05'};
let currentActivityFilter = '';

async function fetchActivityFeed(){
  try {
    const r = await fetch(API_BASE+'/v1/activity/feed?limit=40&hours=168'+(currentActivityFilter?'&event_type='+currentActivityFilter:''),{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const d = await r.json();
    const w = document.getElementById('activityWidget');
    w.style.display = '';
    renderActivityFeed(d.events || []);
  } catch(e){
    console.warn('Activity feed failed:', e);
  }
}

function renderActivityFeed(events){
  const feed = document.getElementById('activityFeed');
  if(!events.length){
    feed.innerHTML = '<div class="tl-empty">No recent activity</div>';
    return;
  }
  let html = '';
  for(const ev of events){
    const icon = TL_ICONS[ev.event_type] || '\u26A1';
    const t = ev.timestamp ? new Date(ev.timestamp).toLocaleString() : '';
    html += `<div class="tl-event">
      <div class="tl-dot ${ev.icon||ev.event_type}">${icon}</div>
      <div class="tl-body">
        <div class="tl-summary">${escapeHtml(ev.summary||'')}</div>
        <div class="tl-meta">${escapeHtml(ev.actor||'')} \u00B7 ${t}${ev.claim_name ? ' \u00B7 <span class="tl-claim-link" onclick="openDrawer(\''+ev.claim_id+'\')">'+escapeHtml(ev.claim_name)+'</span>' : ''}</div>
      </div>
    </div>`;
  }
  feed.innerHTML = html;
}

function filterActivityFeed(type){
  currentActivityFilter = type;
  document.querySelectorAll('.tl-filter-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  fetchActivityFeed();
}

async function loadClaimTimeline(claimId){
  const panel = document.getElementById('claimTimelinePanel');
  if(!panel) return;
  try {
    const r = await fetch(API_BASE+'/v1/claims/'+claimId+'/timeline?limit=30',{headers:{'Authorization':'Bearer operator'}});
    if(!r.ok) throw new Error();
    const d = await r.json();
    const events = d.events || [];
    if(!events.length){
      panel.innerHTML = '<div style="color:#484f58;text-align:center;padding:8px;font-size:11px">No activity yet</div>';
      return;
    }
    let html = '';
    for(const ev of events){
      const icon = TL_ICONS[ev.event_type] || '\u26A1';
      const t = ev.timestamp ? new Date(ev.timestamp).toLocaleString() : '';
      html += `<div class="tl-event">
        <div class="tl-dot ${ev.icon||ev.event_type}" style="width:22px;height:22px;font-size:10px">${icon}</div>
        <div class="tl-body">
          <div class="tl-summary" style="font-size:11px">${escapeHtml(ev.summary||'')}</div>
          <div class="tl-meta">${escapeHtml(ev.actor||'')} \u00B7 ${t}</div>
        </div>
      </div>`;
    }
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#f85149;font-size:11px;text-align:center">Failed to load timeline</div>';
  }
}

function escapeHtml(s){
  if(typeof s !== 'string') return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}


// ===== DATA QUALITY & DEDUPLICATION =====

async function fetchDataQuality(){
  try {
    const [reportR, dupsR] = await Promise.all([
      fetch(API_BASE+'/v1/data-quality/report',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/data-quality/duplicates?status=pending',{headers:{'Authorization':'Bearer operator'}})
    ]);
    if(!reportR.ok || !dupsR.ok) throw new Error();
    const report = await reportR.json();
    const dups = await dupsR.json();

    const w = document.getElementById('dataQualityWidget');
    w.style.display = '';

    // KPIs
    const avgScore = report.completeness?.average_score || 0;
    document.getElementById('dqScore').textContent = Math.round(avgScore)+'%';
    document.getElementById('dqScore').style.color = avgScore >= 80 ? '#4ade80' : avgScore >= 60 ? '#ffd33d' : '#f85149';
    document.getElementById('dqDups').textContent = report.duplicates?.pending || dups.total || 0;
    document.getElementById('dqCompleteness').textContent = Math.round(avgScore)+'%';
    const mergeCount = report.duplicates?.merged || 0;
    document.getElementById('dqMerges').textContent = mergeCount;

    // Field coverage bars
    const fc = report.completeness?.field_coverage || {};
    let fcHtml = '';
    for(const [field, pct] of Object.entries(fc)){
      const color = pct >= 80 ? '#4ade80' : pct >= 50 ? '#ffd33d' : '#f85149';
      fcHtml += `<div class="dq-field-row"><span class="dq-fname">${field}</span><div class="dq-fbar"><div class="dq-ffill" style="width:${pct}%;background:${color}"></div></div><span class="dq-fpct">${Math.round(pct)}%</span></div>`;
    }
    document.getElementById('dqFieldCoverage').innerHTML = fcHtml;

    // Duplicate pairs list
    renderDuplicatePairs(dups.duplicate_pairs || []);
  } catch(e){
    console.warn('Data quality fetch failed:', e);
  }
}

function renderDuplicatePairs(pairs){
  const list = document.getElementById('dqDupList');
  if(!pairs.length){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:11px;padding:12px">No pending duplicates</div>';
    return;
  }
  let html = '';
  for(const p of pairs){
    const simPct = Math.round(p.similarity*100);
    const simColor = simPct >= 90 ? '#f85149' : simPct >= 75 ? '#f0883e' : '#ffd33d';
    const nameA = p.claim_a_name || p.claim_id_a?.slice(0,8);
    const nameB = p.claim_b_name || p.claim_id_b?.slice(0,8);
    const fields = (p.match_fields||'').split(',').filter(Boolean).join(', ');
    html += `<div class="dq-dup-item" data-pair-id="${p.pair_id}">
      <div class="dq-dup-sim" style="border:2px solid ${simColor};color:${simColor}">${simPct}%</div>
      <div class="dq-dup-info">
        <div class="dq-name">${nameA} &harr; ${nameB}</div>
        <div class="dq-meta">Match: ${fields || 'multiple fields'}</div>
      </div>
      <div class="dq-dup-actions">
        <button class="dq-btn-dismiss" onclick="resolveDuplicate('${p.pair_id}','dismiss')">Dismiss</button>
        <button class="dq-btn-merge" onclick="promptMergeClaims('${p.claim_id_a}','${p.claim_id_b}','${p.pair_id}')">Merge</button>
      </div>
    </div>`;
  }
  list.innerHTML = html;
}

async function runDuplicateScan(){
  const btn = document.getElementById('dqScanBtn');
  const status = document.getElementById('dqScanStatus');
  btn.disabled = true;
  status.textContent = 'Scanning...';
  try {
    const r = await fetch(API_BASE+'/v1/data-quality/scan',{
      method:'POST', headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({threshold:0.7})
    });
    if(!r.ok) throw new Error();
    const d = await r.json();
    status.textContent = `Found ${d.new_pairs||0} new duplicate pairs`;
    await fetchDataQuality();
  } catch(e){
    status.textContent = 'Scan failed';
  } finally {
    btn.disabled = false;
  }
}

async function resolveDuplicate(pairId, action){
  try {
    const r = await fetch(API_BASE+'/v1/data-quality/duplicates/'+pairId,{
      method:'PATCH', headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({action})
    });
    if(!r.ok) throw new Error();
    await fetchDataQuality();
  } catch(e){
    alert('Failed to resolve duplicate');
  }
}

async function promptMergeClaims(sourceId, targetId, pairId){
  if(!confirm('Merge these claims? All data from claim A will transfer to claim B, and claim A will be closed.')) return;
  try {
    const r = await fetch(API_BASE+'/v1/data-quality/merge',{
      method:'POST', headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({source_claim_id:sourceId, target_claim_id:targetId})
    });
    if(!r.ok){ const e = await r.json(); throw new Error(e.detail||'Merge failed'); }
    if(pairId){
      await fetch(API_BASE+'/v1/data-quality/duplicates/'+pairId,{
        method:'PATCH', headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
        body:JSON.stringify({action:'confirm'})
      });
    }
    await fetchDataQuality();
    await updateDashboard();
  } catch(e){
    alert('Merge failed: '+e.message);
  }
}


// ===== TAGS & CUSTOM FIELDS =====
const TAG_COLORS = ['#58a6ff','#f85149','#4ade80','#f0883e','#d2a8ff','#79c0ff','#ffd33d','#ff7b72','#7ee787','#a5d6ff'];

async function fetchTagStats(){
  try {
    const [statsR, tagsR] = await Promise.all([
      fetch(API_BASE+'/v1/tags/stats',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/tags',{headers:{'Authorization':'Bearer operator'}})
    ]);
    const stats = await statsR.json();
    const tagsData = await tagsR.json();
    const w = document.getElementById('tagsWidget');
    if(!w) return;
    w.style.display = 'block';

    document.getElementById('twTotal').textContent = stats.total_tags || 0;
    document.getElementById('twTagged').textContent = stats.total_tagged_claims || 0;
    document.getElementById('twCoverage').textContent = (stats.coverage_pct||0)+'%';
    document.getElementById('twCategories').textContent = Object.keys(stats.by_category||{}).length;

    const tags = tagsData.tags || [];
    let html = '';
    if(!tags.length) html = '<span style="color:#484f58;font-size:11px">No tags yet â€” create one below</span>';
    tags.forEach(t => {
      html += '<span class="tw-tag" style="background:'+t.color+'20;color:'+t.color+';border-color:'+t.color+'40">';
      html += t.name;
      if(t.usage_count > 0) html += ' <span class="tw-tag-count">'+t.usage_count+'</span>';
      html += '</span>';
    });
    document.getElementById('twTagList').innerHTML = html;
  } catch(e){
    const w = document.getElementById('tagsWidget');
    if(w) w.style.display = 'block';
  }
}

async function createTagFromWidget(){
  const input = document.getElementById('twNewTag');
  const name = input.value.trim();
  if(!name) return;
  const color = TAG_COLORS[Math.floor(Math.random()*TAG_COLORS.length)];
  try {
    await fetch(API_BASE+'/v1/tags',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({name:name, color:color})
    });
    input.value = '';
    fetchTagStats();
  } catch(e){ console.error('Create tag error:', e); }
}

async function loadClaimTags(claimId){
  const panel = document.getElementById('claimTagsPanel');
  if(!panel) return;
  try {
    const r = await fetch(API_BASE+'/v1/claims/'+claimId+'/tags',{headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    const tags = d.tags || [];
    if(!tags.length){
      panel.innerHTML = '<div style="color:#484f58;font-size:11px;text-align:center;padding:4px">No tags</div>';
      return;
    }
    let html = '<div style="display:flex;flex-wrap:wrap;gap:3px">';
    tags.forEach(t => {
      html += '<span class="claim-tag" style="background:'+t.color+'20;color:'+t.color+';border-color:'+t.color+'40">';
      html += t.name;
      html += ' <button class="ct-x" onclick="removeTagFromClaim(\''+claimId+'\',\''+t.tag_id+'\')">x</button>';
      html += '</span>';
    });
    html += '</div>';
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#f85149;font-size:11px">Failed to load tags</div>';
  }
}

async function addTagToClaim(claimId){
  const input = document.getElementById('claimTagInput');
  if(!input) return;
  const name = input.value.trim();
  if(!name) return;
  const color = TAG_COLORS[Math.floor(Math.random()*TAG_COLORS.length)];
  try {
    await fetch(API_BASE+'/v1/claims/'+claimId+'/tags',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
      body:JSON.stringify({tag_name:name, color:color})
    });
    input.value = '';
    loadClaimTags(claimId);
    fetchTagStats();
  } catch(e){ console.error('Add tag error:', e); }
}

async function removeTagFromClaim(claimId, tagId){
  try {
    await fetch(API_BASE+'/v1/claims/'+claimId+'/tags/'+tagId,{
      method:'DELETE',
      headers:{'Authorization':'Bearer operator'}
    });
    loadClaimTags(claimId);
    fetchTagStats();
  } catch(e){ console.error('Remove tag error:', e); }
}

// ===== PRIORITY QUEUE & SMART TRIAGE =====
const TRI_COLORS = {critical:'#f85149',high:'#f0883e',medium:'#58a6ff',low:'#8b949e',minimal:'#484f58'};
let currentTriageFilter = 'all';

async function fetchTriageQueue(filterLevel){
  if(filterLevel !== undefined) currentTriageFilter = filterLevel;
  try {
    const params = currentTriageFilter !== 'all' ? '?triage_level='+currentTriageFilter : '';
    const r = await fetch(API_BASE+'/v1/triage/queue'+params, {headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    const w = document.getElementById('triageWidget');
    if(!w) return;
    w.style.display = 'block';

    const byLevel = d.by_triage_level || {};
    document.getElementById('triTotal').textContent = d.total_in_queue || 0;
    document.getElementById('triCritical').textContent = byLevel.critical || 0;
    document.getElementById('triHigh').textContent = byLevel.high || 0;
    document.getElementById('triMedium').textContent = byLevel.medium || 0;
    document.getElementById('triAvg').textContent = d.avg_priority || 0;

    const queue = d.queue || [];
    let html = '';
    if(!queue.length){
      html = '<div style="color:#484f58;text-align:center;padding:12px;font-size:11px">Queue is empty</div>';
    }
    queue.forEach((item, i) => {
      const color = TRI_COLORS[item.triage_level] || '#8b949e';
      html += '<div class="tri-item" onclick="openCase(\''+item.claim_id+'\')">';
      html += '<span class="tri-score" style="border-color:'+color+';color:'+color+'">'+Math.round(item.priority_score)+'</span>';
      html += '<span class="tri-info">';
      html += '<span class="tri-name">'+item.claimant_name+' vs '+item.respondent+'</span>';
      html += '<span class="tri-meta">$'+(item.amount_claimed_usd||0).toLocaleString()+' &middot; '+item.status.replace(/_/g,' ')+'</span>';
      html += '</span>';
      html += '<span class="tri-level '+item.triage_level+'">'+item.triage_level+'</span>';
      html += '</div>';
    });
    document.getElementById('triQueue').innerHTML = html;
  } catch(e){
    console.error('Triage fetch error:', e);
    const w = document.getElementById('triageWidget');
    if(w) w.style.display = 'block';
  }
}

function filterTriageQueue(level){
  document.querySelectorAll('.tri-filter-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  fetchTriageQueue(level);
}

async function loadClaimPriority(claimId){
  const panel = document.getElementById('claimPriorityPanel');
  if(!panel) return;
  try {
    const r = await fetch(API_BASE+'/v1/claims/'+claimId+'/priority', {headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    const color = TRI_COLORS[d.triage_level] || '#8b949e';
    let html = '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">';
    html += '<div style="width:48px;height:48px;border-radius:50%;border:3px solid '+color+';display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:'+color+'">'+Math.round(d.priority_score)+'</div>';
    html += '<div><div style="font-size:13px;font-weight:700;color:'+color+';text-transform:uppercase">'+d.triage_level+'</div>';
    html += '<div style="font-size:11px;color:#8b949e">'+d.triage_description+'</div>';
    if(d.override_active) html += '<div style="font-size:10px;color:#f0883e;margin-top:2px">&#x26A0; Manual override active</div>';
    html += '</div></div>';

    // Factor breakdown
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">';
    const fLabels = {amount:'Amount',age:'Age',sla:'SLA',evidence:'Evidence',respondent:'Respondent',settlement:'Settlement'};
    Object.entries(d.factors||{}).forEach(([k,v]) => {
      const fc = v.score >= 70 ? '#f85149' : (v.score >= 40 ? '#f0883e' : '#4ade80');
      html += '<div style="display:flex;justify-content:space-between;font-size:10px;padding:2px 4px;background:#0d1117;border-radius:3px">';
      html += '<span style="color:#8b949e">'+(fLabels[k]||k)+'</span>';
      html += '<span style="font-weight:700;color:'+fc+'">'+v.score+'/100</span>';
      html += '</div>';
    });
    html += '</div>';

    // Override button
    html += '<div style="margin-top:8px"><button class="btn btn-ghost btn-sm" onclick="promptTriageOverride(\''+claimId+'\','+d.priority_score+')" style="width:100%;font-size:10px">&#x270F; Override Priority</button></div>';
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#f85149;font-size:11px">Failed to load priority</div>';
  }
}

function promptTriageOverride(claimId, currentScore){
  const newScore = prompt('Override priority score (0-100). Current: '+currentScore, currentScore);
  if(newScore === null) return;
  const reason = prompt('Reason for override:', '');
  fetch(API_BASE+'/v1/claims/'+claimId+'/triage', {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer operator'},
    body:JSON.stringify({action_type:'priority_override',new_value:newScore,reason:reason||'Manual override'})
  }).then(r=>r.json()).then(()=>{
    loadClaimPriority(claimId);
    fetchTriageQueue();
  });
}

// ===== ANALYTICS & PERFORMANCE DASHBOARD =====
const FUNNEL_COLORS = {filed:'#58a6ff',under_review:'#79c0ff',in_resolution:'#d2a8ff',escalated:'#f85149',resolved:'#4ade80',closed:'#8b949e',withdrawn:'#484f58',rejected:'#f85149'};
const SCORE_COLORS = {A:'#4ade80',B:'#79c0ff',C:'#f0883e',D:'#f85149',F:'#f85149'};

async function fetchAnalytics(){
  try {
    const [healthR, finR, pipeR, opsR, respR] = await Promise.all([
      fetch(API_BASE+'/v1/analytics/health-score',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/analytics/financial',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/analytics/pipeline',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/analytics/operators?days=90',{headers:{'Authorization':'Bearer operator'}}),
      fetch(API_BASE+'/v1/analytics/respondent-scorecards?limit=10',{headers:{'Authorization':'Bearer operator'}})
    ]);
    const health = await healthR.json();
    const fin = await finR.json();
    const pipe = await pipeR.json();
    const ops = await opsR.json();
    const resp = await respR.json();

    const w = document.getElementById('analyticsWidget');
    if(!w) return;
    w.style.display = 'block';

    // Health Score
    const score = health.health_score || 0;
    const grade = health.grade || '--';
    const ring = document.getElementById('anScoreRing');
    ring.style.borderColor = SCORE_COLORS[grade] || '#21262d';
    document.getElementById('anScoreVal').textContent = score;
    document.getElementById('anGrade').textContent = 'Grade: '+grade;

    // Health factors
    const factors = health.factors || {};
    let fhtml = '';
    const fLabels = {resolution_rate:'Resolution',recovery_effectiveness:'Recovery',sla_compliance:'SLA Compliance',assignment_coverage:'Assigned',documentation_rate:'Documented'};
    Object.entries(factors).forEach(([k,v])=>{
      fhtml += '<div class="an-factor"><span>'+(fLabels[k]||k)+'</span><span class="an-fv">'+v.value+'%</span></div>';
    });
    document.getElementById('anFactors').innerHTML = fhtml;

    // Financial KPIs
    const fmtK = v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'k' : '$'+v.toFixed(0);
    document.getElementById('anClaimed').textContent = fmtK(fin.total_claimed_usd||0);
    document.getElementById('anRecovered').textContent = fmtK(fin.total_recovered_usd||0);
    document.getElementById('anRecRate').textContent = (fin.overall_recovery_rate_pct||0)+'%';
    document.getElementById('anProjected').textContent = fmtK(fin.projected_recovery_usd||0);

    // Pipeline Funnel
    const funnel = pipe.funnel || [];
    const maxCount = Math.max(...funnel.map(f=>f.count),1);
    let funnelHtml = '';
    funnel.forEach(f=>{
      const pct = Math.round(f.count / maxCount * 100);
      const color = FUNNEL_COLORS[f.stage] || '#58a6ff';
      funnelHtml += '<div class="an-funnel-bar">';
      funnelHtml += '<span class="an-fb-label">'+f.label+'</span>';
      funnelHtml += '<span class="an-fb-track"><span class="an-fb-fill" style="width:'+pct+'%;background:'+color+'"></span></span>';
      funnelHtml += '<span class="an-fb-val">'+f.count+'</span>';
      funnelHtml += '</div>';
    });
    document.getElementById('anFunnel').innerHTML = funnelHtml;

    // Operator Leaderboard
    const operators = ops.operators || [];
    let opsHtml = '';
    if(!operators.length) opsHtml = '<div style="color:#484f58;text-align:center;padding:8px;font-size:11px">No operators</div>';
    operators.forEach(op=>{
      opsHtml += '<div class="an-op-row">';
      opsHtml += '<span class="an-op-rank">#'+op.rank+'</span>';
      opsHtml += '<span class="an-op-name">'+op.name+'</span>';
      opsHtml += '<span class="an-op-stat">'+op.resolved+' resolved &middot; '+op.recovery_rate_pct+'% rec</span>';
      opsHtml += '<span class="an-op-score">'+op.efficiency_score+'</span>';
      opsHtml += '</div>';
    });
    document.getElementById('anOps').innerHTML = opsHtml;

    // Respondent Scorecards
    const scorecards = resp.scorecards || [];
    let rhtml = '';
    if(!scorecards.length) rhtml = '<div style="color:#484f58;text-align:center;padding:8px;font-size:11px">No respondents</div>';
    scorecards.forEach(s=>{
      rhtml += '<div class="an-resp">';
      rhtml += '<span class="an-r-name" title="'+s.respondent+'">'+s.respondent+'</span>';
      rhtml += '<span class="an-r-badge '+s.rating+'">'+s.rating+'</span>';
      rhtml += '<span class="an-r-score">'+s.cooperation_score+'</span>';
      rhtml += '</div>';
    });
    document.getElementById('anResps').innerHTML = rhtml;

  } catch(e){
    console.error('Analytics fetch error:', e);
    const w = document.getElementById('analyticsWidget');
    if(w) w.style.display = 'block';
  }
}

// ===== DOCUMENT / EVIDENCE MANAGEMENT =====
const DOC_ICONS = {pdf:'&#x1F4C4;',image:'&#x1F5BC;',document:'&#x1F4DD;',spreadsheet:'&#x1F4CA;',text:'&#x1F4C3;',email:'&#x2709;',archive:'&#x1F4E6;',other:'&#x1F4CE;'};
function docIcon(ft){return DOC_ICONS[ft]||'&#x1F4CE;'}
function humanSize(b){if(!b)return '0 B';const u=['B','KB','MB','GB'];let i=0;while(b>=1024&&i<u.length-1){b/=1024;i++}return b.toFixed(i?1:0)+' '+u[i]}

async function fetchDocumentStats(){
  try {
    const r = await fetch(API_BASE + '/v1/documents/stats/overview', {headers:{'Authorization':'Bearer operator'}});
    const d = await r.json();
    const w = document.getElementById('docWidget');
    if(!w) return;
    w.style.display = 'block';
    document.getElementById('docTotal').textContent = d.total_documents || 0;
    document.getElementById('docSize').textContent = d.total_size_human || '0 B';
    document.getElementById('docCoverage').textContent = (d.coverage_pct||0)+'%';
    document.getElementById('docTypes').textContent = Object.keys(d.by_file_type||{}).length;
    // Category breakdown
    const cats = d.by_category||{};
    let catHtml = '<div style="display:flex;flex-wrap:wrap;gap:4px">';
    Object.entries(cats).forEach(([cat,info])=>{
      catHtml += '<span class="ev-badge '+cat+'" style="font-size:9px">'+cat.replace(/_/g,' ')+': '+info.count+'</span>';
    });
    catHtml += '</div>';
    document.getElementById('docCategoryBreakdown').innerHTML = catHtml;
    // Recent uploads
    const recent = d.recent_uploads||[];
    let rHtml = '';
    recent.forEach(doc=>{
      rHtml += '<div class="doc-entry">';
      rHtml += '<span class="doc-icon">'+docIcon(doc.file_type)+'</span>';
      rHtml += '<span class="doc-name" title="'+doc.filename+'">'+doc.filename+'</span>';
      rHtml += '<span class="doc-cat">'+doc.category+'</span>';
      rHtml += '<span class="doc-size">'+humanSize(doc.file_size_bytes)+'</span>';
      rHtml += '</div>';
    });
    document.getElementById('docRecentList').innerHTML = rHtml || '<div style="text-align:center;color:#484f58;padding:12px;font-size:11px">No documents uploaded yet</div>';
  } catch(e){ console.warn('Doc stats error:', e) }
}

async function loadClaimDocuments(claimId){
  const panel = document.getElementById('evidencePanel');
  if(!panel) return;
  try {
    const r = await fetch(API_BASE + '/v1/claims/'+claimId+'/documents', {headers:{'Authorization':'Bearer operator'}});
    const data = await r.json();
    const docs = data.documents||[];
    if(!docs.length){
      panel.innerHTML = '<div style="color:#484f58;text-align:center;padding:12px;font-size:11px">No documents attached yet. Upload evidence to strengthen this case.</div>';
      return;
    }
    let html = '<div class="ev-list">';
    docs.forEach(doc=>{
      html += '<div class="ev-item">';
      html += '<span class="ev-icon">'+docIcon(doc.file_type)+'</span>';
      html += '<div class="ev-info"><span class="ev-name" title="'+doc.filename+'">'+doc.filename+'</span>';
      html += '<span class="ev-meta">'+humanSize(doc.file_size_bytes)+' &bull; '+(doc.uploaded_by||'operator')+' &bull; '+new Date(doc.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+'</span></div>';
      html += '<span class="ev-badge '+doc.category+'">'+doc.category.replace(/_/g,' ')+'</span>';
      html += '<button class="ev-del" title="Delete" onclick="deleteDocument(\''+doc.document_id+'\',\''+claimId+'\')">&times;</button>';
      html += '</div>';
    });
    html += '</div>';
    html += '<div style="text-align:right;font-size:10px;color:#484f58;margin-top:4px">'+docs.length+' document'+(docs.length!==1?'s':'')+'</div>';
    panel.innerHTML = html;
  } catch(e){
    panel.innerHTML = '<div style="color:#f85149;text-align:center;padding:8px;font-size:11px">Failed to load documents</div>';
  }
}

function openUploadForm(claimId){
  const form = document.getElementById('uploadForm');
  if(!form) return;
  if(form.style.display === 'block'){ form.style.display='none'; return; }
  form.style.display = 'block';
  form.innerHTML = '<div class="ev-upload-form">'+
    '<input type="text" id="evFilename" placeholder="Filename (e.g. receipt.pdf)" />'+
    '<select id="evCategory"><option value="evidence">Evidence</option><option value="receipt">Receipt</option><option value="screenshot">Screenshot</option><option value="correspondence">Correspondence</option><option value="contract">Contract</option><option value="financial">Financial</option><option value="legal">Legal</option><option value="identification">Identification</option><option value="communication_log">Communication Log</option><option value="other">Other</option></select>'+
    '<textarea id="evDescription" placeholder="Description (optional)" rows="2"></textarea>'+
    '<input type="text" id="evTags" placeholder="Tags (comma-separated, optional)" />'+
    '<input type="number" id="evSize" placeholder="File size in bytes (optional)" />'+
    '<button class="ev-upload-btn" onclick="submitUpload(\''+claimId+'\')">&#x1F4CE; Upload Document Record</button>'+
    '</div>';
}

async function submitUpload(claimId){
  const filename = document.getElementById('evFilename').value.trim();
  if(!filename){ showToast('Filename is required','#f85149'); return; }
  const category = document.getElementById('evCategory').value;
  const description = document.getElementById('evDescription').value.trim();
  const tagsStr = document.getElementById('evTags').value.trim();
  const tags = tagsStr ? tagsStr.split(',').map(t=>t.trim()).filter(Boolean) : [];
  const size = parseInt(document.getElementById('evSize').value)||0;
  // Detect mime from extension
  const ext = filename.includes('.') ? filename.split('.').pop().toLowerCase() : '';
  const mimeMap = {pdf:'application/pdf',png:'image/png',jpg:'image/jpeg',jpeg:'image/jpeg',gif:'image/gif',doc:'application/msword',docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',xls:'application/vnd.ms-excel',xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',txt:'text/plain',csv:'text/csv',eml:'message/rfc822',zip:'application/zip'};
  const mime = mimeMap[ext]||'application/octet-stream';
  try {
    const r = await fetch(API_BASE + '/v1/claims/'+claimId+'/documents', {
      method:'POST',
      headers:{'Authorization':'Bearer operator','Content-Type':'application/json'},
      body:JSON.stringify({filename,category,description,mime_type:mime,file_size_bytes:size,tags,uploaded_by:'operator'})
    });
    if(!r.ok) throw new Error('Upload failed');
    showToast('Document recorded: '+filename, '#4ade80');
    document.getElementById('uploadForm').style.display = 'none';
    loadClaimDocuments(claimId);
    fetchDocumentStats();
  } catch(e){
    showToast('Failed to record document','#f85149');
  }
}

async function deleteDocument(docId, claimId){
  if(!confirm('Delete this document record?')) return;
  try {
    const r = await fetch(API_BASE + '/v1/documents/'+docId, {
      method:'DELETE',
      headers:{'Authorization':'Bearer operator'}
    });
    if(!r.ok) throw new Error('Delete failed');
    showToast('Document deleted', '#f0ad4e');
    loadClaimDocuments(claimId);
    fetchDocumentStats();
  } catch(e){
    showToast('Failed to delete document','#f85149');
  }
}

// ===== FOLLOW-UPS =====
async function fetchFollowups(){
  const container = document.getElementById('fuContainer');
  const summary = document.getElementById('fuSummary');
  try {
    const r = await fetch(API_BASE + '/v1/followups');
    const data = await r.json();
    const fus = data.followups || [];
    summary.innerHTML = '<strong>'+data.total+'</strong> active' +
      (data.critical ? ' &nbsp; <span style="color:#f85149">'+data.critical+' critical</span>' : '') +
      (data.high ? ' &nbsp; <span style="color:#fbbf24">'+data.high+' high</span>' : '');

    if(!fus.length){
      container.innerHTML = '<div style="text-align:center;color:#484f58;padding:40px"><div style="font-size:32px;margin-bottom:8px">&#x2705;</div>No follow-ups needed â€” all claims are resolved or just filed.</div>';
      return;
    }
    let html = '';
    fus.forEach(f => {
      const tplBtn = f.template ? '<button class="btn btn-primary btn-sm" onclick="generateLetter(\''+f.claim_id+'\',\''+f.template+'\')">&#x1F4E8; Generate Letter</button>' : '';
      const lastContact = f.last_contacted ? new Date(f.last_contacted).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : 'â€”';
      html += '<div class="fu-card urgency-'+f.urgency+'">';
      html += '<div class="fu-age">'+f.age_days+'<small>day'+(f.age_days!==1?'s':'')+'</small></div>';
      html += '<div class="fu-info"><div class="fu-action">'+f.action+'</div>';
      html += '<div class="fu-meta"><strong>'+f.respondent+'</strong> &mdash; '+maskName(f.claimant)+' &mdash; $'+f.amount.toLocaleString()+'</div>';
      html += '<div class="fu-meta" style="margin-top:2px">'+f.recovery_path.replace(/_/g,' ')+' &bull; '+f.value_band.replace(/_/g,' ')+' &bull; <span style="color:#6e7681">Last contact: '+lastContact+'</span></div></div>';
      html += '<div title="Priority reflects coordination urgency, not case merit"><span class="fu-urgency '+f.urgency+'">'+f.urgency+'</span></div>';
      html += '<div>'+tplBtn+'<button class="btn btn-ghost btn-sm" style="margin-left:4px" onclick="openCase(\''+f.claim_id+'\')">View</button></div>';
      html += '</div>';
    });
    container.innerHTML = html;
  } catch(e){
    container.innerHTML = '<div style="color:#f85149;text-align:center;padding:20px">Cannot load follow-ups</div>';
  }
}

// ===== CSV EXPORT (PII-masked by default) =====
async function exportClaims(format){
  const statusFilter = document.getElementById('filterStatus').value;
  let url = API_BASE + '/v1/claims/export?format=' + encodeURIComponent(format);
  if(statusFilter && statusFilter !== 'all') url += '&status_filter=' + encodeURIComponent(statusFilter);
  try {
    const r = await fetch(url);
    if(!r.ok) throw new Error('Export failed');
    const blob = await r.blob();
    const checksum = r.headers.get('X-Export-Checksum') || '';
    const filename = 'ghostledger_claims_' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '.' + format;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    if(checksum){
      const notice = document.getElementById('reclassifyStatus');
      notice.style.display = 'block';
      notice.style.background = 'rgba(56,189,248,.08)';
      notice.style.color = '#38bdf8';
      notice.style.border = '1px solid rgba(56,189,248,.2)';
      notice.textContent = 'Exported ' + format.toUpperCase() + ' â€” SHA-256: ' + checksum.substring(0,20) + '...';
      setTimeout(() => { notice.style.display = 'none'; }, 5000);
    }
  } catch(ex){
    alert('Export failed: ' + ex.message);
  }
}

// ===== ANALYTICS CHARTS =====
async function fetchAnalytics(){
  try {
    const r = await fetch(API_BASE + '/v1/stats/trends');
    if(!r.ok) return;
    const data = await r.json();
    renderFiledChart(data.filed_per_day || []);
    renderStatusChart(data.status_breakdown || {});
    renderRespondentChart(data.top_respondents_by_amount || []);
    renderValueBandChart(data.value_band_amounts || {});
  } catch(ex){ console.error('Analytics fetch failed:', ex); }
}

function renderFiledChart(series){
  const container = document.getElementById('chartFiled');
  if(!series.length){ container.innerHTML = '<div style="color:#484f58;font-size:12px;text-align:center;width:100%">No data yet</div>'; return; }
  const maxVal = Math.max(...series.map(d => d.count), 1);
  let html = '';
  series.forEach(d => {
    const h = Math.max(2, (d.count / maxVal) * 100);
    const isToday = d.date === new Date().toISOString().slice(0,10);
    const color = isToday ? '#8B5E3C' : (d.count > 0 ? '#58a6ff' : '#21262d');
    html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;min-width:0" title="'+d.date+': '+d.count+'">';
    html += '<div style="font-size:8px;color:#484f58;margin-bottom:2px">'+(d.count>0?d.count:'')+'</div>';
    html += '<div style="width:100%;max-width:12px;height:'+h+'%;background:'+color+';border-radius:2px 2px 0 0;min-height:2px"></div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderStatusChart(breakdown){
  const container = document.getElementById('chartStatus');
  const entries = Object.entries(breakdown).sort((a,b) => b[1] - a[1]);
  if(!entries.length){ container.innerHTML = '<div style="color:#484f58;font-size:12px;text-align:center">No data yet</div>'; return; }
  const total = entries.reduce((s, e) => s + e[1], 0);
  const colors = {filed:'#58a6ff',under_review:'#fbbf24',escalated:'#f97316',in_resolution:'#a78bfa',resolved:'#4ade80',closed:'#6e7681',appealed:'#f85149'};
  let html = '<div style="display:flex;height:24px;border-radius:6px;overflow:hidden;margin-bottom:10px">';
  entries.forEach(([status, count]) => {
    const pct = (count / total * 100).toFixed(1);
    html += '<div style="width:'+pct+'%;background:'+(colors[status]||'#6e7681')+';min-width:2px" title="'+status.replace(/_/g,' ')+': '+count+' ('+pct+'%)"></div>';
  });
  html += '</div>';
  entries.forEach(([status, count]) => {
    const pct = (count / total * 100).toFixed(1);
    const c = colors[status] || '#6e7681';
    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:12px">';
    html += '<div style="width:8px;height:8px;border-radius:2px;background:'+c+';flex-shrink:0"></div>';
    html += '<span style="color:#8b949e;flex:1">'+status.replace(/_/g,' ')+'</span>';
    html += '<span style="color:#c9d1d9;font-weight:500">'+count+'</span>';
    html += '<span style="color:#484f58;font-size:11px">('+pct+'%)</span>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderRespondentChart(respondents){
  const container = document.getElementById('chartRespondents');
  if(!respondents.length){ container.innerHTML = '<div style="color:#484f58;font-size:12px;text-align:center">No data yet</div>'; return; }
  const maxAmt = respondents[0]?.total_usd || 1;
  let html = '';
  respondents.slice(0, 6).forEach(r => {
    const pct = (r.total_usd / maxAmt * 100).toFixed(0);
    html += '<div style="margin-bottom:8px">';
    html += '<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px"><span style="color:#c9d1d9">'+r.respondent+'</span><span style="color:#c9956b;font-weight:500">$'+r.total_usd.toLocaleString()+'</span></div>';
    html += '<div style="height:6px;background:#161b22;border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,#8B5E3C,#c9956b);border-radius:3px"></div></div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderValueBandChart(bands){
  const container = document.getElementById('chartValueBands');
  const order = ['micro','small','medium','large','strategic'];
  const colors = {micro:'#6e7681',small:'#58a6ff',medium:'#fbbf24',large:'#f97316',strategic:'#f85149'};
  const labels = {micro:'Micro (<$500)',small:'Small ($500-5K)',medium:'Medium ($5K-50K)',large:'Large ($50K-250K)',strategic:'Strategic ($250K+)'};
  const entries = order.filter(b => bands[b]).map(b => ({band:b, amount:bands[b]}));
  if(!entries.length){ container.innerHTML = '<div style="color:#484f58;font-size:12px;text-align:center">No data yet</div>'; return; }
  const maxAmt = Math.max(...entries.map(e => e.amount), 1);
  let html = '';
  entries.forEach(e => {
    const pct = (e.amount / maxAmt * 100).toFixed(0);
    const c = colors[e.band] || '#6e7681';
    html += '<div style="margin-bottom:8px">';
    html += '<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px"><span style="color:#8b949e">'+(labels[e.band]||e.band)+'</span><span style="color:'+c+';font-weight:500">$'+e.amount.toLocaleString()+'</span></div>';
    html += '<div style="height:6px;background:#161b22;border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+c+';border-radius:3px"></div></div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

// ===== RECOVERY TRACKING =====
async function fetchRecoveryDashboard(){
  try {
    const r = await fetch(API_BASE + '/v1/stats/recovery');
    if(!r.ok) throw new Error();
    const data = await r.json();
    renderRecoveryDashboard(data);
  } catch(e){ /* silently skip if no recoveries */ }
}

function renderRecoveryDashboard(data){
  const dash = document.getElementById('recoveryDash');
  if(data.recovery_count === 0 && data.total_recovered_usd === 0){
    dash.style.display = 'none';
    return;
  }
  dash.style.display = 'block';

  document.getElementById('rdTotalRecovered').textContent = '$' + data.total_recovered_usd.toLocaleString(undefined,{minimumFractionDigits:2});
  document.getElementById('rdRecoveryRate').textContent = data.recovery_rate_usd + '%';
  document.getElementById('rdClaimsRecovered').textContent = data.claims_with_recovery + ' / ' + data.total_claims;
  document.getElementById('rdClaimRate').textContent = data.claim_recovery_rate + '%';

  // Timeline chart
  const timeline = data.timeline_30d || [];
  const tlEl = document.getElementById('recoveryTimeline');
  if(!timeline.length){
    tlEl.innerHTML = '<div style="color:#484f58;font-size:11px;text-align:center;padding:20px">No recoveries in last 30 days</div>';
  } else {
    const maxAmt = Math.max(...timeline.map(t => t.amount), 1);
    let html = '';
    timeline.forEach(t => {
      const h = Math.max((t.amount / maxAmt * 70), 2);
      html += '<div class="rc-bar" style="height:'+h+'px" data-tip="'+t.date+': $'+t.amount.toLocaleString()+'" title="'+t.date+': $'+t.amount.toLocaleString()+'"></div>';
    });
    tlEl.innerHTML = html;
  }

  // By method breakdown
  const methods = data.by_method || {};
  const methEl = document.getElementById('recoveryByMethod');
  const methodLabels = {direct_refund:'Direct Refund',chargeback:'Chargeback',mediation_settlement:'Mediation',legal_settlement:'Legal Settlement',platform_credit:'Platform Credit',partial_refund:'Partial Refund',other:'Other'};
  const methEntries = Object.entries(methods).sort((a,b) => b[1].total_usd - a[1].total_usd);
  if(!methEntries.length){
    methEl.innerHTML = '<div style="color:#484f58;font-size:11px;text-align:center;padding:20px">No recovery methods recorded</div>';
  } else {
    const maxM = Math.max(...methEntries.map(e => e[1].total_usd), 1);
    let html = '';
    methEntries.forEach(([m, v]) => {
      const pct = (v.total_usd / maxM * 100).toFixed(0);
      html += '<div style="margin-bottom:6px">';
      html += '<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px"><span style="color:#8b949e">'+(methodLabels[m]||m)+'</span><span style="color:#4ade80;font-weight:600">$'+v.total_usd.toLocaleString()+' ('+v.count+')</span></div>';
      html += '<div style="height:5px;background:#0d1117;border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,#4ade80,#22c55e);border-radius:3px"></div></div>';
      html += '</div>';
    });
    methEl.innerHTML = html;
  }
}

async function loadClaimRecoveries(claimId){
  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/recoveries');
    if(!r.ok) return;
    const data = await r.json();
    renderClaimRecoveryPanel(claimId, data);
  } catch(e){ /* skip */ }
}

function renderClaimRecoveryPanel(claimId, data){
  const container = document.getElementById('recoveryPanel');
  if(!container) return;

  const claimed = data.amount_claimed || 0;
  const recovered = data.total_recovered || 0;
  const pct = data.recovery_pct || 0;
  const recs = data.recoveries || [];

  let html = '';

  // Progress bar
  html += '<div class="recovery-bar"><div class="filled" style="width:'+Math.min(pct,100)+'%"></div></div>';
  html += '<div class="recovery-stats-row">';
  html += '<span>Recovered: <span class="val" style="color:#4ade80">$'+recovered.toLocaleString(undefined,{minimumFractionDigits:2})+'</span></span>';
  html += '<span>of $'+claimed.toLocaleString(undefined,{minimumFractionDigits:2})+' claimed</span>';
  html += '<span style="font-weight:700;color:'+(pct>=80?'#4ade80':pct>=40?'#fbbf24':'#f85149')+'">'+pct+'%</span>';
  html += '</div>';

  // Recovery log
  if(recs.length){
    html += '<div class="recovery-log">';
    recs.forEach(rec => {
      const methodLabels = {direct_refund:'Direct Refund',chargeback:'Chargeback',mediation_settlement:'Mediation',legal_settlement:'Legal',platform_credit:'Platform Credit',partial_refund:'Partial',other:'Other'};
      html += '<div class="rec-entry">';
      html += '<span class="rec-amt">+$'+rec.amount_recovered.toLocaleString(undefined,{minimumFractionDigits:2})+'</span>';
      html += '<span class="rec-method">'+(methodLabels[rec.recovery_method]||rec.recovery_method)+'</span>';
      html += '<span class="rec-date">'+new Date(rec.recorded_at).toLocaleDateString()+'</span>';
      html += '</div>';
    });
    html += '</div>';
  }

  // Add recovery form
  html += '<div class="recovery-form">';
  html += '<input type="number" id="recAmount" placeholder="Amount $" min="0.01" step="0.01">';
  html += '<select id="recMethod"><option value="direct_refund">Direct Refund</option><option value="chargeback">Chargeback</option><option value="mediation_settlement">Mediation</option><option value="legal_settlement">Legal Settlement</option><option value="platform_credit">Platform Credit</option><option value="partial_refund">Partial Refund</option><option value="other">Other</option></select>';
  html += '<input type="text" id="recNotes" placeholder="Notes (optional)">';
  html += '<button class="btn btn-primary btn-sm" onclick="submitRecovery(\''+claimId+'\')" style="background:#22c55e;color:#0a0e14;font-weight:700">&#x2795; Log Recovery</button>';
  html += '</div>';

  container.innerHTML = html;
}

async function submitRecovery(claimId){
  const amt = parseFloat(document.getElementById('recAmount').value);
  const method = document.getElementById('recMethod').value;
  const notes = document.getElementById('recNotes').value.trim();

  if(!amt || amt <= 0){
    alert('Enter a valid recovery amount.');
    return;
  }

  try {
    const r = await fetch(API_BASE + '/v1/claims/' + claimId + '/recovery', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({amount: amt, method: method, notes: notes})
    });
    if(!r.ok){
      const err = await r.json();
      alert(err.detail || 'Failed to record recovery');
      return;
    }
    // Reload recovery panel
    loadClaimRecoveries(claimId);
    // Show success toast
    const banner = document.createElement('div');
    banner.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#161b22;border:1px solid #22c55e;color:#4ade80;padding:12px 24px;border-radius:8px;font-size:13px;z-index:10000;animation:fadeIn .3s ease';
    banner.textContent = 'Recovery of $' + amt.toLocaleString(undefined,{minimumFractionDigits:2}) + ' recorded successfully';
    document.body.appendChild(banner);
    setTimeout(() => banner.remove(), 3000);
  } catch(e){
    alert('Network error recording recovery');
  }
}

// ===== SLA ENGINE =====
async function fetchSlaStatus(){
  try {
    const r = await fetch(API_BASE + '/v1/sla/status');
    if(!r.ok) throw new Error();
    const data = await r.json();
    renderSlaWidget(data);
  } catch(e){ /* silently skip */ }
}

function renderSlaWidget(data){
  const widget = document.getElementById('slaWidget');
  if(!data.total_active){
    widget.style.display = 'none';
    return;
  }
  widget.style.display = 'block';

  // Summary pills
  const sumEl = document.getElementById('slaSummary');
  let sumHtml = '';
  sumHtml += '<div class="sla-pill on-track"><span class="sp-dot"></span>'+data.on_track+' On Track</div>';
  sumHtml += '<div class="sla-pill at-risk"><span class="sp-dot"></span>'+data.at_risk+' At Risk</div>';
  sumHtml += '<div class="sla-pill breached"><span class="sp-dot"></span>'+data.breached+' Breached</div>';
  sumHtml += '<div class="sla-pill" style="color:#8b949e;margin-left:auto">Compliance: <strong style="color:'+(data.compliance_rate>=80?'#4ade80':data.compliance_rate>=50?'#fbbf24':'#f85149')+'">'+data.compliance_rate+'%</strong></div>';
  sumEl.innerHTML = sumHtml;

  // Claims list (only show at_risk + breached, or all if few)
  const claims = data.claims || [];
  const urgent = claims.filter(c => c.sla_status !== 'on_track');
  const showClaims = urgent.length > 0 ? urgent : claims.slice(0, 5);

  const claimsEl = document.getElementById('slaClaims');
  if(!showClaims.length){
    claimsEl.innerHTML = '<div style="color:#4ade80;font-size:12px;text-align:center;padding:12px">All claims within SLA targets</div>';
    return;
  }

  let html = '';
  showClaims.forEach(c => {
    const pct = Math.min(c.usage_pct, 100);
    const remaining = c.remaining_days;
    const remLabel = remaining > 0 ? remaining.toFixed(1) + 'd left' : Math.abs(remaining).toFixed(1) + 'd over';
    html += '<div class="sla-row" onclick="openCase(\'' + c.claim_id + '\')">';
    html += '<span class="sr-id">' + c.claim_id.substring(0,12) + '</span>';
    html += '<span class="sr-respondent">' + (c.respondent || 'â€”') + '</span>';
    html += '<span class="sr-rule">' + c.sla_rule + '</span>';
    html += '<div class="sla-bar-wrap"><div class="sla-bar"><div class="sb-fill ' + c.sla_status + '" style="width:' + pct + '%"></div></div></div>';
    html += '<span class="sr-remaining ' + c.sla_status + '">' + remLabel + '</span>';
    html += '</div>';
  });

  if(urgent.length > 0 && claims.length > urgent.length){
    html += '<div style="text-align:center;padding:6px;font-size:11px;color:#6e7681">' + data.on_track + ' more claims on track (not shown)</div>';
  }

  claimsEl.innerHTML = html;
}

function getSlaIndicator(claim){
  const st = claim.sla_status;
  if(!st || st === 'n/a') return '';
  const remaining = claim.sla_days_remaining;
  if(st === 'breached') return '<span class="sla-badge breached" title="SLA breached: '+Math.abs(remaining).toFixed(1)+'d overdue">SLA BREACH</span>';
  if(st === 'at_risk') return '<span class="sla-badge at-risk" title="SLA at risk: '+remaining.toFixed(1)+'d remaining">SLA RISK</span>';
  return '<span class="sla-badge on-track" title="SLA on track: '+remaining.toFixed(1)+'d remaining">ON TRACK</span>';
}

// ===== ESCALATION ENGINE =====
let escalationData = null;

async function fetchEscalationQueue(){
  try {
    const r = await fetch(API_BASE + '/v1/escalation/evaluate', {method:'POST'});
    if(!r.ok) throw new Error();
    escalationData = await r.json();
    renderEscalationWidget(escalationData);
  } catch(e){ /* silently skip */ }
}

function renderEscalationWidget(data){
  const widget = document.getElementById('escWidget');
  const recs = data.recommendations || [];
  if(!recs.length){
    widget.style.display = 'none';
    return;
  }
  widget.style.display = 'block';

  // Stats
  const statsEl = document.getElementById('escStats');
  const bp = data.by_priority || {};
  let statsHtml = '';
  if(bp.critical) statsHtml += '<div class="esc-stat critical"><span class="es-dot"></span>'+bp.critical+' Critical</div>';
  if(bp.high) statsHtml += '<div class="esc-stat high"><span class="es-dot"></span>'+bp.high+' High</div>';
  if(bp.medium) statsHtml += '<div class="esc-stat medium"><span class="es-dot"></span>'+bp.medium+' Medium</div>';
  statsHtml += '<div class="esc-stat" style="margin-left:auto;color:#6e7681">'+data.total_evaluated+' claims evaluated</div>';
  statsEl.innerHTML = statsHtml;

  // Queue
  const queueEl = document.getElementById('escQueue');
  let html = '';
  recs.forEach(rec => {
    const actionDesc = rec.action.type === 'status_change'
      ? rec.current_status.replace(/_/g,' ') + ' â†’ ' + rec.action.target_status.replace(/_/g,' ')
      : 'Flag: ' + (rec.action.flag || 'attention');
    html += '<div class="esc-item ' + rec.priority + '">';
    html += '<div class="ei-info">';
    html += '<div class="ei-rule">' + rec.rule_name + '</div>';
    html += '<div class="ei-claim"><strong>' + rec.claim_id.substring(0,12) + '</strong> â€” ' + (rec.respondent||'Unknown') + ' ($' + (rec.amount||0).toLocaleString() + ')</div>';
    html += '<div class="ei-action">' + actionDesc + '</div>';
    html += '</div>';
    html += '<div class="ei-actions">';
    html += '<button class="btn-approve" onclick="executeEscalation(\'' + rec.claim_id + '\',\'' + rec.rule_id + '\',' + JSON.stringify(rec.action).replace(/"/g,'&quot;') + ')">Approve</button>';
    html += '<button class="btn-dismiss" onclick="dismissEscalation(this)">Skip</button>';
    html += '</div>';
    html += '</div>';
  });
  queueEl.innerHTML = html;

  document.getElementById('escBatchActions').style.display = recs.length > 1 ? 'flex' : 'none';
}

async function executeEscalation(claimId, ruleId, action){
  try {
    const r = await fetch(API_BASE + '/v1/escalation/execute', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({claim_id: claimId, rule_id: ruleId, action: action})
    });
    if(!r.ok){
      const err = await r.json();
      alert(err.detail?.message || err.detail || 'Execution failed');
      return;
    }
    // Success toast
    const banner = document.createElement('div');
    banner.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#161b22;border:1px solid #22c55e;color:#4ade80;padding:12px 24px;border-radius:8px;font-size:13px;z-index:10000;animation:fadeIn .3s ease';
    banner.textContent = 'Escalation executed for ' + claimId.substring(0,12);
    document.body.appendChild(banner);
    setTimeout(() => banner.remove(), 3000);
    // Refresh
    fetchClaims();
    fetchEscalationQueue();
  } catch(e){
    alert('Network error executing escalation');
  }
}

function dismissEscalation(btn){
  const item = btn.closest('.esc-item');
  if(item){
    item.style.opacity = '0.3';
    item.style.pointerEvents = 'none';
  }
}

async function executeAllEscalations(){
  if(!confirm('Execute all pending escalation recommendations?')) return;
  try {
    const r = await fetch(API_BASE + '/v1/escalation/execute-all', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({})
    });
    if(!r.ok) throw new Error();
    const result = await r.json();
    const s = result.summary || {};
    const banner = document.createElement('div');
    banner.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#161b22;border:1px solid #22c55e;color:#4ade80;padding:12px 24px;border-radius:8px;font-size:13px;z-index:10000;animation:fadeIn .3s ease';
    banner.textContent = 'Batch escalation: ' + (s.executed||0) + ' executed, ' + (s.skipped||0) + ' skipped';
    document.body.appendChild(banner);
    setTimeout(() => banner.remove(), 4000);
    fetchClaims();
    fetchEscalationQueue();
  } catch(e){
    alert('Batch escalation failed');
  }
}

// ===== SIGNAL SCOUTS =====
async function fetchSignals(){
  const container = document.getElementById('sigContainer');
  const threats = document.getElementById('sigThreats');
  container.innerHTML = '<div style="color:#fbbf24;text-align:center;padding:40px"><div style="font-size:24px;margin-bottom:8px">&#x1F50D;</div>Scanning claims for patterns...</div>';
  try {
    const r = await fetch(API_BASE + '/v1/signals');
    if(!r.ok) throw new Error();
    const data = await r.json();
    const sum = data.summary || {};

    // Update stats
    document.getElementById('sigTotal').textContent = sum.total_signals || 0;
    document.getElementById('sigCritical').textContent = sum.critical || 0;
    document.getElementById('sigAlerts').textContent = sum.alerts || 0;
    document.getElementById('sigWarnings').textContent = sum.warnings || 0;
    document.getElementById('sigSystemic').textContent = sum.systemic_claims || 0;
    document.getElementById('sigStale').textContent = sum.stale_signals || 0;
    document.getElementById('sigScanTime').textContent = 'Scanned ' + data.claims_scanned + ' claims at ' + new Date(data.scanned_at).toLocaleTimeString();

    // Update badge (only fresh/recent signals count)
    const totalSig = (sum.critical || 0) + (sum.alerts || 0);
    if(totalSig > 0){ setBadge('badgeSignals', totalSig, totalSig >= 3 ? '' : 'copper'); }

    // Render top signal sources (now weighted by recency)
    const tt = data.top_threats || [];
    if(tt.length){
      let thtml = '';
      tt.forEach((t,i) => {
        const scoreLabel = t.weighted_score ? ' (score: '+t.weighted_score+')' : '';
        thtml += '<div class="threat-card"><div class="threat-rank">#'+(i+1)+'</div><div><div class="threat-name">'+t.respondent+'</div><div class="threat-count">'+t.signal_count+' signal'+(t.signal_count!==1?'s':'')+scoreLabel+'</div></div></div>';
      });
      threats.innerHTML = thtml;
    } else {
      threats.innerHTML = '<div style="color:#4ade80;text-align:center;padding:20px;grid-column:1/-1">No elevated signal sources detected</div>';
    }

    // Render signals with decay indicators
    const sigs = data.signals || [];
    if(!sigs.length){
      container.innerHTML = '<div style="color:#4ade80;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px">&#x2705;</div>No patterns detected â€” claim data looks clean</div>';
      return;
    }
    let html = '';
    const sigHelpers = {
      'amount_anomaly': 'Large deviations from historical averages may indicate higher complexity or review priority.',
      'respondent_cluster': 'Multiple claims naming the same entity may warrant coordination, not accusation.',
      'harm_concentration': 'Concentrated harm types may suggest systemic process issues, not intent.',
      'velocity_spike': 'Unusual filing volume may reflect external events or awareness campaigns.',
      'high_value_cluster': 'High-value clusters may need professional routing review.'
    };
    const freshnessColors = {fresh:'#4ade80', recent:'#58a6ff', aging:'#fbbf24', stale:'#484f58'};
    const freshnessLabels = {fresh:'Fresh', recent:'Recent', aging:'Aging', stale:'Stale'};
    sigs.forEach(s => {
      const sev = s.severity || 'info';
      const sigType = (s.signal_type || '').replace(/_/g, ' ');
      const helper = sigHelpers[s.signal_type] || '';
      const freshness = s.freshness || 'recent';
      const isStale = freshness === 'stale';
      const staleClass = isStale ? ' data-stale="true"' : '';
      const fadeStyle = isStale ? 'opacity:.5;' : '';
      html += '<div class="sig-card sev-'+sev+'" style="'+fadeStyle+'"'+staleClass+'>';
      html += '<div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;align-items:center">';
      html += '<div class="sig-badge '+sev+'">'+sev+'</div>';
      html += '<span style="font-size:8px;letter-spacing:.3px;color:'+freshnessColors[freshness]+';text-transform:uppercase">'+freshnessLabels[freshness]+'</span>';
      html += '</div>';
      html += '<div class="sig-body">';
      html += '<div class="sig-msg">'+s.message;
      if(s.decay_applied) html += ' <span style="font-size:10px;color:#484f58" title="Severity downgraded from '+s.original_severity+' due to signal age">[decayed from '+s.original_severity+']</span>';
      html += '</div>';
      html += '<div class="sig-type">'+sigType+'</div>';
      if(helper) html += '<div style="font-size:11px;color:#6e7681;margin-top:4px;font-style:italic">'+helper+'</div>';
      html += '<div class="sig-details">';
      if(s.claim_count) html += '<span>Claims: '+s.claim_count+'</span>';
      if(s.total_amount) html += '<span>Total: $'+s.total_amount.toLocaleString()+'</span>';
      if(s.unique_claimants) html += '<span>Claimants: '+s.unique_claimants+'</span>';
      if(s.avg_amount) html += '<span>Avg: $'+s.avg_amount.toLocaleString()+'</span>';
      if(s.claims_this_week) html += '<span>This week: '+s.claims_this_week+'</span>';
      if(s.ratio) html += '<span>'+s.ratio+'x avg</span>';
      if(s.signal_age_days != null) html += '<span>Age: '+s.signal_age_days+'d</span>';
      html += '</div></div></div>';
    });
    container.innerHTML = html;

    // Refresh claims to pick up any newly flagged systemic claims
    fetchClaims();
  } catch(e){
    container.innerHTML = '<div style="color:#f85149;text-align:center;padding:40px">Cannot reach Signal Scouts API</div>';
  }
}

// ===== AUDIT LOG =====
const auditActionLabels = {
  'signal.scan': {icon:'&#x1F50D;', label:'Signal Scan', color:'#58a6ff'},
  'letter.generated': {icon:'&#x1F4E8;', label:'Letter Generated', color:'#fbbf24'},
  'status.changed': {icon:'&#x1F504;', label:'Status Changed', color:'#a78bfa'},
  'claim.intake': {icon:'&#x1F4E5;', label:'Claim Received', color:'#4ade80'},
  'claim.classified': {icon:'&#x1F3AF;', label:'Classified', color:'#38bdf8'},
  'handoff.initiated': {icon:'&#x1F91D;', label:'Handoff Initiated', color:'#f97316'},
  'export.audit_log': {icon:'&#x1F4CB;', label:'Audit Exported', color:'#6e7681'},
  'export.claims': {icon:'&#x1F4E5;', label:'Claims Exported', color:'#6e7681'},
  'ilf.lawyer.registered': {icon:'&#x2696;&#xFE0F;', label:'Professional Registered', color:'#38bdf8'},
  'ilf.lawyer.status_changed': {icon:'&#x2696;&#xFE0F;', label:'Professional Status', color:'#38bdf8'},
  'ilf.referral.updated': {icon:'&#x1F91D;', label:'Referral Updated', color:'#f97316'},
};
async function fetchAuditLog(){
  const container = document.getElementById('auditContainer');
  const filter = document.getElementById('auditFilter').value;
  container.innerHTML = '<div style="color:#fbbf24;text-align:center;padding:30px">Loading audit log...</div>';
  try {
    const url = API_BASE + '/v1/audit-log' + (filter ? '?action='+encodeURIComponent(filter) : '');
    const r = await fetch(url);
    if(!r.ok) throw new Error();
    const data = await r.json();
    const entries = data.entries || [];
    if(!entries.length){
      container.innerHTML = '<div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x1F4CB;</div>No audit entries found'+(filter?' for this filter':'')+'</div>';
      return;
    }
    let html = '<table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="border-bottom:1px solid #21262d;text-align:left">';
    html += '<th style="padding:8px;color:#6e7681;font-weight:600;width:40px">#</th>';
    html += '<th style="padding:8px;color:#6e7681;font-weight:600">Time</th>';
    html += '<th style="padding:8px;color:#6e7681;font-weight:600">Action</th>';
    html += '<th style="padding:8px;color:#6e7681;font-weight:600">Actor</th>';
    html += '<th style="padding:8px;color:#6e7681;font-weight:600">Details</th>';
    html += '</tr></thead><tbody>';
    entries.forEach(e => {
      const meta = auditActionLabels[e.action] || {icon:'&#x2022;', label:e.action, color:'#6e7681'};
      const ts = new Date(e.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const detail = e.detail || {};
      let detailStr = '';
      if(e.action === 'signal.scan'){
        detailStr = (detail.claims_scanned||0)+' claims \u2192 '+(detail.total_signals||0)+' signals ('+(detail.critical||0)+' crit, '+(detail.alerts||0)+' alert, '+(detail.warnings||0)+' warn, '+(detail.stale_signals||0)+' stale)';
        if(detail.systemic_flagged && detail.systemic_flagged.length) detailStr += ' | Flagged: '+detail.systemic_flagged.join(', ');
      } else if(e.action === 'letter.generated'){
        detailStr = (detail.template||'â€”')+' \u2192 '+(detail.respondent||'â€”')+' ($'+(detail.amount||0).toLocaleString()+') ['+(detail.claim_id||'â€”')+']';
      } else if(e.action === 'status.changed'){
        detailStr = (detail.claim_id||'â€”')+': '+(detail.old_status||'initial')+' \u2192 '+(detail.new_status||'â€”')+' ('+(detail.respondent||'â€”')+')'+(detail.reason && detail.reason!=='â€”' ? ' â€” '+detail.reason : '');
      } else if(e.action === 'claim.intake'){
        detailStr = (detail.claim_id||'â€”')+' vs '+(detail.respondent||'â€”')+' ($'+(detail.amount||0).toLocaleString()+')';
      } else if(e.action === 'claim.classified'){
        detailStr = (detail.claim_id||'â€”')+' â†’ '+(detail.value_band||'â€”')+' / '+(detail.dispute_type||'â€”')+' / '+(detail.recovery_path||'â€”')+' (complexity: '+(detail.complexity_score||'?')+', triage: '+(detail.requires_human_triage?'yes':'no')+') ['+(detail.trigger||'â€”')+']';
      } else if(e.action === 'handoff.initiated'){
        detailStr = (detail.claim_id||'â€”')+' vs '+(detail.respondent||'â€”')+' ($'+(detail.amount||0).toLocaleString()+') â€” '+(detail.from_status||'initial')+' â†’ '+(detail.to_status||'â€”')+' ['+(detail.recovery_path||'â€”')+', '+(detail.value_band||'â€”')+']';
      } else if(e.action === 'export.claims'){
        detailStr = (detail.format||'â€”').toUpperCase()+' export â€” '+(detail.claims_exported||0)+' claims'+(detail.filter?' (filter: '+detail.filter+')':'');
      } else if(e.action === 'export.audit_log'){
        detailStr = (detail.format||'â€”').toUpperCase()+' export â€” '+(detail.entries_exported||0)+' entries'+(detail.filter?' (filter: '+detail.filter+')':'');
      } else if(e.action === 'ilf.lawyer.registered'){
        detailStr = (detail.name||detail.full_name||'New professional')+' ('+(detail.jurisdiction||'â€”')+') â€” '+(detail.specializations||[]).join(', ');
      } else if(e.action === 'ilf.lawyer.status_changed'){
        var lid = detail.lawyer_id||'';
        detailStr = (detail.name||lid.substring(0,4)+'****'+lid.slice(-4)||'â€”')+': '+(detail.old_status||'â€”')+' \u2192 '+(detail.new_status||'â€”');
      } else if(e.action === 'ilf.referral.updated'){
        detailStr = (detail.referral_id||'â€”')+' â€” '+(detail.old_status||'initial')+' \u2192 '+(detail.new_status||'â€”')+(detail.notes?' ('+detail.notes+')':'');
      } else if(e.action === 'case.note.added'){
        detailStr = (detail.claim_id||'â€”')+' ('+(detail.respondent||'â€”')+') â€” '+(detail.content_length||0)+' chars by '+(detail.author||'operator');
      } else {
        detailStr = JSON.stringify(detail).substring(0,120);
      }
      html += '<tr style="border-bottom:1px solid #12171e">';
      html += '<td style="padding:8px;color:#30363d;font-size:10px;font-family:monospace">'+(e.seq||'â€”')+'</td>';
      html += '<td style="padding:8px;color:#8b949e;white-space:nowrap;font-size:12px">'+ts+'</td>';
      html += '<td style="padding:8px"><span style="color:'+meta.color+'">'+meta.icon+' '+meta.label+'</span></td>';
      html += '<td style="padding:8px;color:#6e7681">'+e.actor+'</td>';
      html += '<td style="padding:8px;color:#c9d1d9;font-size:12px">'+detailStr+'</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch(ex){
    container.innerHTML = '<div style="color:#f85149;text-align:center;padding:40px">Cannot load audit log</div>';
  }
}

async function exportAuditLog(format){
  const filter = document.getElementById('auditFilter').value;
  let url = API_BASE + '/v1/audit-log/export?format=' + encodeURIComponent(format);
  if(filter) url += '&action=' + encodeURIComponent(filter);
  try {
    const r = await fetch(url);
    if(!r.ok) throw new Error('Export failed');
    const blob = await r.blob();
    const ts = r.headers.get('X-Export-Timestamp') || new Date().toISOString().slice(0,10).replace(/-/g,'');
    const checksum = r.headers.get('X-Export-Checksum') || '';
    const filename = 'ghostledger_audit_' + ts.slice(0,10).replace(/-/g,'') + '.' + format;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    // Show checksum confirmation
    if(checksum){
      const container = document.getElementById('auditContainer');
      const notice = document.createElement('div');
      notice.style.cssText = 'background:rgba(56,189,248,.1);border:1px solid #38bdf8;border-radius:6px;padding:8px 12px;margin-bottom:8px;font-size:11px;color:#38bdf8;display:flex;justify-content:space-between;align-items:center';
      notice.innerHTML = '<span>&#x2705; Exported ' + format.toUpperCase() + ' â€” SHA-256: <code style="background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;font-size:10px">' + checksum.substring(0,16) + '...</code></span><span style="cursor:pointer;opacity:.6" onclick="this.parentElement.remove()">âœ•</span>';
      container.insertBefore(notice, container.firstChild);
    }
    // Refresh audit log to show the export entry
    setTimeout(() => fetchAuditLog(), 500);
  } catch(ex){
    alert('Export failed: ' + ex.message);
  }
}

// ===== ILF NETWORK =====
let _ilfLawyers = [];

async function fetchILFData(){
  try {
    const [statsR, lawyersR, referralsR] = await Promise.all([
      fetch(API_BASE + '/v1/ilf/stats'),
      fetch(API_BASE + '/v1/ilf/lawyers'),
      fetch(API_BASE + '/v1/ilf/referrals' + (document.getElementById('ilfRefFilter').value ? '?status_filter=' + document.getElementById('ilfRefFilter').value : '')),
    ]);
    const stats = await statsR.json();
    const lawyersData = await lawyersR.json();
    const referralsData = await referralsR.json();

    // Stats
    document.getElementById('ilfLawyersActive').textContent = stats.lawyers_active || 0;
    document.getElementById('ilfRefPending').textContent = stats.referrals_pending || 0;
    document.getElementById('ilfRefAccepted').textContent = stats.referrals_accepted || 0;
    document.getElementById('ilfRefCompleted').textContent = stats.referrals_completed || 0;
    // Badge
    const pending = stats.referrals_pending || 0;
    const badge = document.getElementById('badgeILF');
    if(pending > 0){ badge.textContent = pending; badge.classList.remove('hidden'); }
    else { badge.classList.add('hidden'); }

    // Lawyers table
    _ilfLawyers = lawyersData.lawyers || [];
    const lc = document.getElementById('ilfLawyersContainer');
    if(!_ilfLawyers.length){
      lc.innerHTML = '<div style="color:#484f58;text-align:center;padding:30px"><div style="font-size:28px;margin-bottom:6px;opacity:.5">&#x2696;&#xFE0F;</div>No legal professionals registered yet. Click "+ Register Legal Professional" to add one.</div>';
    } else {
      let html = '<table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="border-bottom:1px solid #21262d;text-align:left">';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Name</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Jurisdiction</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Specializations</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Caseload</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Status</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Verified</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Actions</th>';
      html += '</tr></thead><tbody>';
      _ilfLawyers.forEach(l => {
        const statusColors = {active:'#4ade80',inactive:'#6e7681',on_leave:'#fbbf24'};
        const sc = statusColors[l.status] || '#6e7681';
        const specs = (l.specializations||[]).join(', ') || 'General';
        const load = l.current_caseload + '/' + l.max_caseload;
        const loadPct = l.current_caseload / l.max_caseload;
        const loadColor = loadPct >= 0.9 ? '#f85149' : loadPct >= 0.7 ? '#fbbf24' : '#4ade80';
        html += '<tr style="border-bottom:1px solid #12171e">';
        html += '<td style="padding:8px;color:#c9d1d9;font-weight:500">'+l.full_name+'</td>';
        html += '<td style="padding:8px;color:#8b949e">'+l.jurisdiction+'</td>';
        html += '<td style="padding:8px;color:#8b949e;font-size:12px">'+specs+'</td>';
        html += '<td style="padding:8px"><span style="color:'+loadColor+'">'+load+'</span></td>';
        html += '<td style="padding:8px"><span style="color:'+sc+';font-size:11px;text-transform:uppercase;letter-spacing:.3px">'+l.status+'</span></td>';
        html += '<td style="padding:8px"><span style="font-size:10px;color:'+(l.verification_status==='verified'?'#4ade80':'#484f58')+'">'+(l.verification_status==='verified'?'&#x2705; Verified':'Unverified')+'</span></td>';
        html += '<td style="padding:8px">';
        if(l.status === 'active') html += '<button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="toggleLawyerStatus(\''+l.lawyer_id+'\',\'on_leave\')">Pause</button>';
        else html += '<button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="toggleLawyerStatus(\''+l.lawyer_id+'\',\'active\')">Activate</button>';
        html += '</td></tr>';
      });
      html += '</tbody></table>';
      lc.innerHTML = html;
    }

    // Update lawyer select in refer modal
    const sel = document.getElementById('ilfReferLawyer');
    sel.innerHTML = '<option value="">Select Professional...</option>';
    _ilfLawyers.filter(l => l.status === 'active').forEach(l => {
      sel.innerHTML += '<option value="'+l.lawyer_id+'">'+l.full_name+' ('+l.jurisdiction+', '+l.current_caseload+'/'+l.max_caseload+')</option>';
    });

    // Referrals table
    const refs = referralsData.referrals || [];
    const rc = document.getElementById('ilfReferralsContainer');
    if(!refs.length){
      rc.innerHTML = '<div style="color:#484f58;text-align:center;padding:30px"><div style="font-size:28px;margin-bottom:6px;opacity:.5">&#x1F4CB;</div>No referrals found'+(document.getElementById('ilfRefFilter').value?' for this filter':'')+'</div>';
    } else {
      let html = '<table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="border-bottom:1px solid #21262d;text-align:left">';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Referral</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Claim</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Respondent</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Amount</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Professional</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Status</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Referred</th>';
      html += '<th style="padding:8px;color:#6e7681;font-weight:600">Actions</th>';
      html += '</tr></thead><tbody>';
      refs.forEach(r => {
        const cs = r.claim_summary || {};
        const refStatusColors = {pending:'#fbbf24',accepted:'#4ade80',declined:'#f85149',engaged:'#38bdf8',completed:'#a78bfa'};
        const rsc = refStatusColors[r.status] || '#6e7681';
        const ts = new Date(r.referred_at).toLocaleDateString('en-US',{month:'short',day:'numeric'});
        html += '<tr style="border-bottom:1px solid #12171e">';
        html += '<td style="padding:8px;color:#8b949e;font-size:11px;font-family:monospace">'+r.referral_id+'</td>';
        html += '<td style="padding:8px;color:#58a6ff;font-size:11px;font-family:monospace;cursor:pointer" onclick="openDrawer(\''+r.claim_id+'\')">'+r.claim_id+'</td>';
        html += '<td style="padding:8px;color:#c9d1d9">'+(cs.respondent||'â€”')+'</td>';
        html += '<td style="padding:8px;color:#c9d1d9">$'+((cs.amount||0).toLocaleString())+'</td>';
        html += '<td style="padding:8px;color:#c9d1d9">'+(r.lawyer_name||'â€”')+'</td>';
        html += '<td style="padding:8px"><span style="color:'+rsc+';font-size:11px;text-transform:uppercase;letter-spacing:.3px;border:1px solid '+rsc+';border-radius:4px;padding:2px 6px">'+r.status+'</span></td>';
        html += '<td style="padding:8px;color:#8b949e;font-size:12px">'+ts+'</td>';
        html += '<td style="padding:8px">';
        if(r.status === 'pending'){
          html += '<button class="btn btn-ghost btn-sm" style="font-size:11px;color:#4ade80" onclick="updateReferral(\''+r.referral_id+'\',\'accepted\')">Accept</button> ';
          html += '<button class="btn btn-ghost btn-sm" style="font-size:11px;color:#f85149" onclick="updateReferral(\''+r.referral_id+'\',\'declined\')">Decline</button>';
        } else if(r.status === 'accepted'){
          html += '<button class="btn btn-ghost btn-sm" style="font-size:11px;color:#38bdf8" onclick="updateReferral(\''+r.referral_id+'\',\'engaged\')">Engaged</button> ';
          html += '<button class="btn btn-ghost btn-sm" style="font-size:11px;color:#f85149" onclick="updateReferral(\''+r.referral_id+'\',\'declined\')">Decline</button>';
        } else if(r.status === 'engaged'){
          html += '<button class="btn btn-ghost btn-sm" style="font-size:11px;color:#a78bfa" onclick="updateReferral(\''+r.referral_id+'\',\'completed\')">Complete</button>';
        } else {
          html += '<span style="color:#484f58;font-size:11px">â€”</span>';
        }
        html += '</td></tr>';
      });
      html += '</tbody></table>';
      rc.innerHTML = html;
    }
  } catch(ex){
    console.error('ILF fetch error:', ex);
    document.getElementById('ilfLawyersContainer').innerHTML = '<div style="color:#f85149;text-align:center;padding:20px">Cannot load ILF data</div>';
  }
}

async function registerILFLawyer(){
  const statusEl = document.getElementById('ilfRegStatus');
  const name = document.getElementById('ilfRegName').value.trim();
  const email = document.getElementById('ilfRegEmail').value.trim();
  if(!name || !email){ statusEl.innerHTML = '<span style="color:#f85149">Name and email required</span>'; return; }
  statusEl.innerHTML = '<span style="color:#fbbf24">Registering...</span>';
  try {
    const specs = document.getElementById('ilfRegSpecs').value.trim().split(',').map(s=>s.trim()).filter(Boolean);
    const r = await fetch(API_BASE + '/v1/ilf/lawyers', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        full_name: name,
        email: email,
        bar_number: document.getElementById('ilfRegBar').value.trim(),
        jurisdiction: document.getElementById('ilfRegJurisdiction').value.trim() || 'US-General',
        specializations: specs,
        max_caseload: parseInt(document.getElementById('ilfRegCaseload').value) || 10,
      }),
    });
    const data = await r.json();
    if(!r.ok) throw new Error(data.detail?.message || 'Registration failed');
    statusEl.innerHTML = '<span style="color:#4ade80">Registered: ' + data.lawyer_id + '</span>';
    setTimeout(() => {
      document.getElementById('ilfRegisterModal').style.display = 'none';
      document.getElementById('ilfRegName').value = '';
      document.getElementById('ilfRegEmail').value = '';
      document.getElementById('ilfRegBar').value = '';
      document.getElementById('ilfRegSpecs').value = '';
      statusEl.innerHTML = '';
      fetchILFData();
    }, 1000);
  } catch(ex){
    statusEl.innerHTML = '<span style="color:#f85149">' + ex.message + '</span>';
  }
}

async function toggleLawyerStatus(lawyerId, newStatus){
  try {
    await fetch(API_BASE + '/v1/ilf/lawyers/' + lawyerId + '/status', {
      method: 'PATCH',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({status: newStatus}),
    });
    fetchILFData();
  } catch(ex){ console.error('Toggle lawyer status failed:', ex); }
}

function openReferModal(claimId){
  document.getElementById('ilfReferClaim').value = claimId || '';
  document.getElementById('ilfReferStatus').innerHTML = '';
  document.getElementById('ilfReferModal').style.display = 'flex';
  // Ensure lawyers are loaded
  if(!_ilfLawyers.length) fetchILFData();
}

async function createILFReferral(){
  const statusEl = document.getElementById('ilfReferStatus');
  const claimId = document.getElementById('ilfReferClaim').value.trim();
  const lawyerId = document.getElementById('ilfReferLawyer').value;
  if(!claimId || !lawyerId){ statusEl.innerHTML = '<span style="color:#f85149">Select both a claim and a professional</span>'; return; }
  const consent = document.getElementById('ilfReferConsent').checked;
  if(!consent){ statusEl.innerHTML = '<span style="color:#f85149">Claimant consent is required before referral</span>'; return; }
  statusEl.innerHTML = '<span style="color:#fbbf24">Creating referral...</span>';
  try {
    const r = await fetch(API_BASE + '/v1/ilf/referrals', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({claim_id: claimId, lawyer_id: lawyerId, claimant_consent: true}),
    });
    const data = await r.json();
    if(!r.ok) throw new Error(data.detail?.message || 'Referral failed');
    statusEl.innerHTML = '<span style="color:#4ade80">Referral created: ' + data.referral_id + '</span>';
    setTimeout(() => {
      document.getElementById('ilfReferModal').style.display = 'none';
      fetchILFData();
    }, 1000);
  } catch(ex){
    statusEl.innerHTML = '<span style="color:#f85149">' + ex.message + '</span>';
  }
}

async function updateReferral(referralId, action){
  const label = action === 'accepted' ? 'accept' : action === 'declined' ? 'decline' : 'complete';
  if(!confirm('Are you sure you want to ' + label + ' this referral?')) return;
  try {
    const r = await fetch(API_BASE + '/v1/ilf/referrals/' + referralId, {
      method: 'PATCH',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({action: action, notes: ''}),
    });
    if(!r.ok){ const d = await r.json(); throw new Error(d.detail?.message || 'Update failed'); }
    fetchILFData();
  } catch(ex){
    alert('Referral update failed: ' + ex.message);
  }
}

// ===== STALE SIGNAL TOGGLE =====
function toggleStaleSignals(){
  const show = document.getElementById('showStaleToggle').checked;
  document.querySelectorAll('#sigContainer .sig-card[data-stale]').forEach(el => {
    el.style.display = show ? '' : 'none';
  });
}

// ===== ACTIVITY FEED =====
const feedIcons = {
  intake: '&#x1F4CB;', status: '&#x1F504;', classify: '&#x1F3AF;',
  handoff: '&#x1F91D;', letter: '&#x2709;', scan: '&#x1F4E1;',
  professional: '&#x2696;', referral: '&#x1F91D;', note: '&#x1F4DD;',
  export: '&#x1F4E5;', system: '&#x2699;'
};

let lastSeenActivityTs = localStorage.getItem('gl_last_activity_ts') || '';

async function fetchActivityFeed(){
  const container = document.getElementById('activityFeedContainer');
  if(!container) return;
  try {
    const r = await fetch(API_BASE + '/v1/activity?limit=40');
    if(!r.ok) throw new Error();
    const data = await r.json();
    renderActivityFeed(data.feed || []);
    document.getElementById('feedLastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();

    // Update notification dot
    if(data.feed.length > 0){
      const latestTs = data.feed[0].timestamp;
      if(latestTs > lastSeenActivityTs){
        document.getElementById('notifDot').classList.add('active');
        const unseenCount = data.feed.filter(f => f.timestamp > lastSeenActivityTs).length;
        const badge = document.getElementById('badgeActivity');
        if(badge && unseenCount > 0){
          badge.textContent = unseenCount > 99 ? '99+' : unseenCount;
          badge.classList.remove('hidden');
        }
      }
    }
  } catch(e){
    container.innerHTML = '<div style="color:#f85149;text-align:center;padding:40px">Failed to load activity feed â€” check API connection</div>';
  }
}

function renderActivityFeed(feed){
  const container = document.getElementById('activityFeedContainer');
  if(!feed.length){
    container.innerHTML = '<div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x1F4ED;</div>No activity yet. Submit a claim to get started.</div>';
    return;
  }

  let html = '';
  let lastDate = '';
  feed.forEach(item => {
    // Date separator
    const itemDate = item.timestamp ? item.timestamp.split('T')[0] : '';
    if(itemDate && itemDate !== lastDate){
      const d = new Date(itemDate);
      const dateLabel = d.toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
      html += '<div style="padding:8px 14px;font-size:11px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;font-weight:700;background:#0d1117;border-bottom:1px solid #1c2129">'+dateLabel+'</div>';
      lastDate = itemDate;
    }

    const icon = feedIcons[item.icon] || '&#x2699;';
    const iconCls = item.icon || 'system';
    let time = item.timestamp ? new Date(item.timestamp).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}) : '';
    if(item.seq) time += ' <span style="color:#30363d;font-size:9px">(' + item.seq + ')</span>';
    const refType = item.ref?.type || '';
    const refId = item.ref?.id || '';
    const onclick = refType && refId ? 'onclick="feedNavigate(\'' + refType + '\',\'' + refId + '\')"' : '';

    html += '<div class="feed-item" '+onclick+'>';
    html += '<div class="feed-icon '+iconCls+'">'+icon+'</div>';
    html += '<div class="feed-body">';
    html += '<div class="feed-title">'+(item.title||item.action)+'</div>';
    if(item.detail) html += '<div class="feed-detail">'+item.detail+'</div>';
    html += '</div>';
    html += '<div class="feed-time">'+time+'</div>';
    html += '</div>';
  });

  container.innerHTML = html;
}

function feedNavigate(type, id){
  if(type === 'claim' && id){
    const casesTab = document.querySelector('.tab[onclick*="cases"]');
    if(casesTab) showTab('cases', casesTab);
    setTimeout(()=> openCase(id), 300);
  } else if(type === 'professional'){
    const ilfTab = document.querySelector('.tab[onclick*="ilf"]');
    if(ilfTab) showTab('ilf', ilfTab);
  } else if(type === 'referral'){
    const ilfTab = document.querySelector('.tab[onclick*="ilf"]');
    if(ilfTab) showTab('ilf', ilfTab);
  }
}

// Mark activity as seen when tab is opened
function markActivitySeen(){
  lastSeenActivityTs = new Date().toISOString();
  try { localStorage.setItem('gl_last_activity_ts', lastSeenActivityTs); } catch(e){}
  document.getElementById('notifDot').classList.remove('active');
  const badge = document.getElementById('badgeActivity');
  if(badge){ badge.classList.add('hidden'); }
}

// ===== RESPONDENT INTELLIGENCE =====
let intelProfiles = [];

async function fetchRespondentIntel(){
  try {
    const r = await fetch(API_BASE + '/v1/respondents');
    if(!r.ok) throw new Error();
    const data = await r.json();
    intelProfiles = data.profiles || [];
    const summary = data.summary || {};

    // Update summary stats
    document.getElementById('intelTotalResp').textContent = summary.total_respondents || 0;
    document.getElementById('intelTotalClaims').textContent = summary.total_claims || 0;
    document.getElementById('intelCritical').textContent = summary.critical_risk || 0;
    document.getElementById('intelHigh').textContent = summary.high_risk || 0;

    // Avg resolution rate
    if(intelProfiles.length > 0){
      const avgRes = intelProfiles.reduce((s,p) => s + p.resolution_rate, 0) / intelProfiles.length;
      document.getElementById('intelAvgResolution').textContent = avgRes.toFixed(1) + '%';
    }

    // Update intel badge
    const critHigh = (summary.critical_risk||0) + (summary.high_risk||0);
    const badge = document.getElementById('badgeIntel');
    if(badge){
      if(critHigh > 0){ badge.textContent = critHigh; badge.classList.remove('hidden'); badge.className = 'badge'; }
      else { badge.classList.add('hidden'); }
    }

    renderIntelCards(intelProfiles);
    fetchIntelLitmusScores(intelProfiles);
  } catch(e){
    document.getElementById('intelContainer').innerHTML =
      '<div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x26A0;</div>Cannot load respondent intelligence. Check API.</div>';
  }
}

function renderIntelCards(profiles){
  const container = document.getElementById('intelContainer');
  if(!profiles || !profiles.length){
    container.innerHTML = '<div style="color:#484f58;text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:8px;opacity:.5">&#x1F575;</div>No respondent data yet. Claims will populate intelligence profiles automatically.</div>';
    return;
  }

  let html = '';
  profiles.forEach((p, idx) => {
    const riskCls = p.risk_level || 'low';
    const resolved = p.resolved_claims || 0;
    const active = p.active_claims || 0;
    const total = p.total_claims || 1;
    const resolvePct = Math.round(resolved / total * 100);
    const activePct = Math.round(active / total * 100);
    const escalated = (p.statuses||{}).escalated || 0;
    const escPct = Math.round(escalated / total * 100);

    // Harm type tags
    let tagsHtml = '';
    const harms = Object.entries(p.harm_types || {}).sort((a,b) => b[1] - a[1]);
    harms.forEach(([ht, cnt]) => {
      tagsHtml += '<span class="intel-tag">' + ht.replace(/_/g,' ') + ' (' + cnt + ')</span>';
    });

    // Status bar segments
    const barHtml = '<div style="display:flex;gap:2px">' +
      (resolvePct > 0 ? '<div class="intel-bar" style="flex:' + resolvePct + '"><div class="intel-bar-fill fill-resolved" style="width:100%"></div></div>' : '') +
      (activePct > 0 ? '<div class="intel-bar" style="flex:' + activePct + '"><div class="intel-bar-fill fill-active" style="width:100%"></div></div>' : '') +
      (escPct > 0 ? '<div class="intel-bar" style="flex:' + escPct + '"><div class="intel-bar-fill fill-escalated" style="width:100%"></div></div>' : '') +
      '</div>';

    // Claims sub-table
    let claimsTableHtml = '<table class="intel-claims-table"><thead><tr><th>Claim ID</th><th>Amount</th><th>Status</th><th>Harm Type</th><th>Filed</th></tr></thead><tbody>';
    (p.claims || []).forEach(c => {
      const st = c.status || 'filed';
      claimsTableHtml += '<tr onclick="openCase(\'' + c.claim_id + '\')" style="cursor:pointer">' +
        '<td style="color:#58a6ff;font-family:monospace;font-size:11px">' + (c.claim_id||'').substring(0,16) + '</td>' +
        '<td>$' + (c.amount||0).toLocaleString() + '</td>' +
        '<td><span class="status s-' + st + '">' + st.replace(/_/g,' ') + '</span></td>' +
        '<td style="text-transform:capitalize">' + (c.harm_type||'â€”').replace(/_/g,' ') + '</td>' +
        '<td style="color:#484f58;font-size:11px">' + (c.filed_at||'').substring(0,10) + '</td>' +
        '</tr>';
    });
    claimsTableHtml += '</tbody></table>';

    // Recovery path tags
    let rpTags = '';
    Object.entries(p.recovery_paths || {}).sort((a,b) => b[1] - a[1]).forEach(([rp, cnt]) => {
      rpTags += '<span class="intel-tag" style="background:rgba(88,166,255,.1);color:#58a6ff">' + rp.replace(/_/g,' ') + ' (' + cnt + ')</span>';
    });

    html += '<div class="intel-card risk-' + riskCls + '" onclick="toggleIntelExpand(' + idx + ')">' +
      '<div class="intel-top">' +
        '<div class="intel-entity">' +
          '<span class="risk-score-dial ' + riskCls + '">' + p.risk_score + '</span>' +
          '<span>' + p.entity + '</span>' +
        '</div>' +
        '<span class="intel-risk ' + riskCls + '">' + riskCls + ' risk</span>' +
      '</div>' +

      '<div class="intel-metrics">' +
        '<div class="intel-metric"><div class="im-num">' + p.total_claims + '</div><div class="im-lbl">Claims</div></div>' +
        '<div class="intel-metric"><div class="im-num" style="color:#58a6ff">' + p.active_claims + '</div><div class="im-lbl">Active</div></div>' +
        '<div class="intel-metric"><div class="im-num" style="color:#4ade80">' + p.resolved_claims + '</div><div class="im-lbl">Resolved</div></div>' +
        '<div class="intel-metric"><div class="im-num">$' + formatAmount(p.total_amount) + '</div><div class="im-lbl">Total Value</div></div>' +
        '<div class="intel-metric"><div class="im-num">' + p.resolution_rate + '%</div><div class="im-lbl">Resolution</div></div>' +
        '<div class="intel-metric"><div class="im-num">' + p.avg_age_days + 'd</div><div class="im-lbl">Avg Age</div></div>' +
      '</div>' +

      '<div style="display:flex;align-items:center;gap:8px;margin:8px 0;flex-wrap:wrap" class="intel-litmus-row" id="intelLitmus' + idx + '"></div>' +

      barHtml +

      '<div class="intel-tags">' + tagsHtml + '</div>' +

      '<div class="intel-expand" id="intelExpand' + idx + '">' +
        '<div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">' +
          '<div style="font-size:11px;color:#585e68">First claim: <strong style="color:#c9d1d9">' + (p.first_claim||'â€”').substring(0,10) + '</strong></div>' +
          '<div style="font-size:11px;color:#585e68">Last claim: <strong style="color:#c9d1d9">' + (p.last_claim||'â€”').substring(0,10) + '</strong></div>' +
          '<div style="font-size:11px;color:#585e68">Avg claim: <strong style="color:#c9d1d9">$' + formatAmount(p.avg_amount) + '</strong></div>' +
        '</div>' +
        (rpTags ? '<div style="margin-bottom:8px"><div style="font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Recovery Paths</div>' + rpTags + '</div>' : '') +
        '<div style="font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Associated Claims</div>' +
        '<div class="table-wrap" style="max-height:250px;overflow-y:auto">' + claimsTableHtml + '</div>' +
        '<div style="margin-top:12px;padding-top:10px;border-top:1px solid #21262d">' +
          '<div style="font-size:10px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">LICO â€” Signal Decision</div>' +
          '<div style="display:flex;gap:6px;flex-wrap:wrap" id="licoActions' + idx + '">' +
            '<button class="btn btn-sm" style="background:#1f6feb22;color:#58a6ff;border:1px solid #1f6feb44;font-size:11px;padding:4px 10px;border-radius:4px;cursor:pointer" onclick="event.stopPropagation();licoDecide(\'' + p.entity + '\',\'monitor\')">ðŸ‘ Monitor</button>' +
            '<button class="btn btn-sm" style="background:#48484822;color:#8b949e;border:1px solid #48484866;font-size:11px;padding:4px 10px;border-radius:4px;cursor:pointer" onclick="event.stopPropagation();licoDecide(\'' + p.entity + '\',\'dismiss\')">âœ— Dismiss</button>' +
            '<button class="btn btn-sm" style="background:#f8514922;color:#f85149;border:1px solid #f8514944;font-size:11px;padding:4px 10px;border-radius:4px;cursor:pointer" onclick="event.stopPropagation();licoDecide(\'' + p.entity + '\',\'escalate\')">âš¡ Escalate â†’ Case Group</button>' +
          '</div>' +
          '<div style="font-size:10px;color:#484f58;margin-top:4px" id="licoStatus' + idx + '"></div>' +
        '</div>' +
      '</div>' +

      '<div style="text-align:center;margin-top:8px"><span style="font-size:10px;color:#484f58" id="intelToggleLabel' + idx + '">Click to expand dossier &#x25BC;</span></div>' +
    '</div>';
  });

  container.innerHTML = html;
}

// Fetch LITMUS scores for Intel cards
async function fetchIntelLitmusScores(profiles){
  for(let i = 0; i < profiles.length; i++){
    const el = document.getElementById('intelLitmus' + i);
    if(!el) continue;
    try {
      const r = await fetch(API + '/litmus/respondent/' + encodeURIComponent(profiles[i].entity), {headers: authHeaders()});
      if(!r.ok) continue;
      const data = await r.json();
      if(data.avg_composite !== null && data.count > 0){
        const score = data.avg_composite;
        const color = score >= 0.7 ? '#3fb950' : score >= 0.5 ? '#d29922' : '#f85149';
        el.innerHTML = '<span style="font-family:\'JetBrains Mono\',monospace;font-size:11px;font-weight:600;color:' + color + ';background:' + color + '18;border:1px solid ' + color + '33;border-radius:4px;padding:2px 8px">LITMUS ' + score.toFixed(3) + '</span>' +
          '<span style="font-size:10px;color:#6e7681">' + data.count + ' scored</span>';
      } else {
        el.innerHTML = '<span style="font-size:10px;color:#484f58">No LITMUS scores</span>';
      }
    } catch(e){}
  }
}

// LICO decision handler
async function licoDecide(entity, decision){
  const reason = decision === 'escalate' ? 'operator_escalation' : decision === 'dismiss' ? 'operator_dismissed' : 'under_review';
  try {
    const r = await fetch(API + '/lico/decide', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', ...authHeaders()},
      body: JSON.stringify({signal_key: entity, decision: decision, reason_code: reason})
    });
    const data = await r.json();
    // Find the status element for this entity
    for(let i = 0; i < intelProfiles.length; i++){
      if(intelProfiles[i].entity === entity){
        const statusEl = document.getElementById('licoStatus' + i);
        if(statusEl){
          const colors = {monitor: '#58a6ff', dismiss: '#8b949e', escalate: '#f85149'};
          let msg = 'âœ“ Decision recorded: ' + decision.toUpperCase();
          if(data.case_group) msg += ' â†’ Case Group ' + data.case_group.group_id + ' (' + data.case_group.claims_linked + ' claims linked)';
          statusEl.innerHTML = '<span style="color:' + (colors[decision]||'#8b949e') + '">' + msg + '</span>';
        }
        break;
      }
    }
  } catch(e){
    alert('LICO decision failed: ' + e.message);
  }
}

function formatAmount(amt){
  if(!amt) return '0';
  if(amt >= 1000000) return (amt/1000000).toFixed(1) + 'M';
  if(amt >= 1000) return (amt/1000).toFixed(1) + 'K';
  return amt.toLocaleString();
}

function toggleIntelExpand(idx){
  const el = document.getElementById('intelExpand' + idx);
  const label = document.getElementById('intelToggleLabel' + idx);
  if(!el) return;
  if(el.classList.contains('open')){
    el.classList.remove('open');
    if(label) label.innerHTML = 'Click to expand dossier &#x25BC;';
  } else {
    el.classList.add('open');
    if(label) label.innerHTML = 'Click to collapse &#x25B2;';
  }
}

function openRespondentIntel(entityName){
  if(!entityName || entityName === 'â€”') return;
  const intelTab = document.querySelector('.tab[onclick*="intel"]');
  if(intelTab) showTab('intel', intelTab);
  // After loading, find and expand the matching card
  setTimeout(function(){
    for(let i = 0; i < intelProfiles.length; i++){
      if(intelProfiles[i].entity === entityName){
        const el = document.getElementById('intelExpand' + i);
        if(el && !el.classList.contains('open')){
          toggleIntelExpand(i);
        }
        // Scroll to the card
        const cards = document.querySelectorAll('.intel-card');
        if(cards[i]) cards[i].scrollIntoView({behavior:'smooth', block:'center'});
        break;
      }
    }
  }, 500);
}

// ===== GLOBAL SEARCH (COMMAND PALETTE) =====
let searchActiveIdx = -1;
let searchDebounceTimer = null;

function openSearchPalette(){
  const pal = document.getElementById('searchPalette');
  pal.classList.add('open');
  const inp = document.getElementById('searchInput');
  inp.value = '';
  inp.focus();
  searchActiveIdx = -1;
  document.getElementById('searchResults').innerHTML =
    '<div class="search-empty"><div class="se-icon">&#x2328;</div><div class="se-text">Start typing to search across all records</div></div>';
}

function closeSearchPalette(){
  document.getElementById('searchPalette').classList.remove('open');
  document.getElementById('searchInput').value = '';
  searchActiveIdx = -1;
}

// Keyboard shortcut: Ctrl+K to toggle
document.addEventListener('keydown', function(e){
  if((e.ctrlKey || e.metaKey) && e.key === 'k'){
    e.preventDefault();
    const pal = document.getElementById('searchPalette');
    if(pal.classList.contains('open')) closeSearchPalette();
    else openSearchPalette();
  }
  if(e.key === 'Escape' && document.getElementById('searchPalette').classList.contains('open')){
    e.preventDefault();
    closeSearchPalette();
  }
});

// Input handler with debounce
document.addEventListener('DOMContentLoaded', function(){
  const inp = document.getElementById('searchInput');
  if(!inp) return;
  inp.addEventListener('input', function(){
    clearTimeout(searchDebounceTimer);
    const q = inp.value.trim();
    if(q.length < 2){
      document.getElementById('searchResults').innerHTML =
        '<div class="search-empty"><div class="se-icon">&#x2328;</div><div class="se-text">Type at least 2 characters to search</div></div>';
      searchActiveIdx = -1;
      return;
    }
    searchDebounceTimer = setTimeout(()=> performSearch(q), 250);
  });

  inp.addEventListener('keydown', function(e){
    const items = document.querySelectorAll('#searchResults .search-item');
    if(!items.length) return;
    if(e.key === 'ArrowDown'){
      e.preventDefault();
      searchActiveIdx = Math.min(searchActiveIdx + 1, items.length - 1);
      highlightSearchItem(items);
    } else if(e.key === 'ArrowUp'){
      e.preventDefault();
      searchActiveIdx = Math.max(searchActiveIdx - 1, 0);
      highlightSearchItem(items);
    } else if(e.key === 'Enter' && searchActiveIdx >= 0){
      e.preventDefault();
      items[searchActiveIdx].click();
    }
  });
});

function highlightSearchItem(items){
  items.forEach((el,i) => {
    el.classList.toggle('active', i === searchActiveIdx);
    if(i === searchActiveIdx) el.scrollIntoView({block:'nearest'});
  });
}

async function performSearch(query){
  const resultsEl = document.getElementById('searchResults');
  resultsEl.innerHTML = '<div class="search-empty"><div class="se-icon" style="animation:pulse 1s infinite">&#x1F50D;</div><div class="se-text">Searching...</div></div>';
  searchActiveIdx = -1;
  try {
    const r = await fetch(API_BASE + '/v1/search?q=' + encodeURIComponent(query));
    if(!r.ok) throw new Error('Search failed');
    const data = await r.json();
    renderSearchResults(data, query);
  } catch(ex){
    resultsEl.innerHTML = '<div class="search-empty"><div class="se-icon">&#x26A0;</div><div class="se-text">Search unavailable â€” check API connection</div></div>';
  }
}

function highlightMatch(text, query){
  if(!text) return '';
  const safe = text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const re = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
  return safe.replace(re, '<mark>$1</mark>');
}

function renderSearchResults(data, query){
  const resultsEl = document.getElementById('searchResults');
  const all = data.results || [];
  const claims = all.filter(r => r.type === 'claim');
  const professionals = all.filter(r => r.type === 'professional');
  const referrals = all.filter(r => r.type === 'referral');
  const total = all.length;

  if(total === 0){
    resultsEl.innerHTML = '<div class="search-empty"><div class="se-icon">&#x1F50E;</div><div class="se-text">No results found for "' + query.replace(/</g,'&lt;') + '"</div></div>';
    return;
  }

  let html = '';

  if(claims.length){
    html += '<div class="search-category">Claims (' + claims.length + ')</div>';
    claims.forEach(item => {
      const statusClass = 's-' + (item.meta?.status || 'filed');
      html += '<div class="search-item" onclick="searchNavigate(\'claim\',\'' + item.id + '\')">'
        + '<div class="si-icon claim">&#x1F4CB;</div>'
        + '<div class="si-body">'
        + '<div class="si-title">' + highlightMatch(item.title, query) + '</div>'
        + '<div class="si-sub">' + highlightMatch(item.subtitle, query) + '</div>'
        + '</div>'
        + '<div class="si-meta"><span class="status ' + statusClass + '" style="font-size:10px">' + (item.meta?.status || '').replace(/_/g,' ') + '</span></div>'
        + '</div>';
    });
  }

  if(professionals.length){
    html += '<div class="search-category">Professionals (' + professionals.length + ')</div>';
    professionals.forEach(item => {
      html += '<div class="search-item" onclick="searchNavigate(\'professional\',\'' + item.id + '\')">'
        + '<div class="si-icon professional">&#x2696;</div>'
        + '<div class="si-body">'
        + '<div class="si-title">' + highlightMatch(item.title, query) + '</div>'
        + '<div class="si-sub">' + highlightMatch(item.subtitle, query) + '</div>'
        + '</div>'
        + '<div class="si-meta"><div class="si-type">' + (item.meta?.status || 'active') + '</div></div>'
        + '</div>';
    });
  }

  if(referrals.length){
    html += '<div class="search-category">Referrals (' + referrals.length + ')</div>';
    referrals.forEach(item => {
      html += '<div class="search-item" onclick="searchNavigate(\'referral\',\'' + item.id + '\')">'
        + '<div class="si-icon referral">&#x1F91D;</div>'
        + '<div class="si-body">'
        + '<div class="si-title">' + highlightMatch(item.title, query) + '</div>'
        + '<div class="si-sub">' + highlightMatch(item.subtitle, query) + '</div>'
        + '</div>'
        + '<div class="si-meta"><div class="si-type">' + (item.meta?.status || 'pending') + '</div></div>'
        + '</div>';
    });
  }

  resultsEl.innerHTML = html;
  searchActiveIdx = -1;
}

function searchNavigate(type, id){
  closeSearchPalette();
  if(type === 'claim'){
    // Switch to Cases tab, then open the case drawer
    const casesTab = document.querySelector('.tab[onclick*="cases"]');
    if(casesTab) showTab('cases', casesTab);
    setTimeout(()=> openCase(id), 300);
  } else if(type === 'professional'){
    // Switch to ILF Network tab
    const ilfTab = document.querySelector('.tab[onclick*="ilf"]');
    if(ilfTab) showTab('ilf', ilfTab);
  } else if(type === 'referral'){
    // Switch to ILF Network tab (referrals section)
    const ilfTab = document.querySelector('.tab[onclick*="ilf"]');
    if(ilfTab) showTab('ilf', ilfTab);
  }
}

// ===== INIT =====
renderTweets();
fetchClaims();
fetchActivityFeed(); // Load activity on startup for notification dot
setInterval(fetchActivityFeed, 60000); // Poll activity every 60s for notifications
fetchRespondentIntel(); // Pre-load intel for badge count
fetchHealthCheck(); // Load system health on startup
fetchRecoveryDashboard(); // Load recovery metrics on startup
fetchSlaStatus(); // Load SLA compliance on startup
loadSavedViews(); // Load saved filter views on startup
fetchEscalationQueue(); // Evaluate escalation rules on startup
fetchOutreachDashboard(); // Load outreach metrics on startup
fetchWorkload(); // Load workload distribution on startup
fetchResolutionDashboard(); // Load resolution metrics on startup
fetchWorkflowRules(); // Load workflow rules on startup
fetchDocumentStats(); // Load document/evidence metrics on startup
fetchNotifBadge(); // Load notification badge count on startup
fetchCaseGroups(); // Load case groups on startup
fetchAnalytics(); // Load analytics & performance on startup
fetchTriageQueue(); // Load priority queue on startup
fetchTagStats(); // Load tags on startup
fetchDataQuality(); // Load data quality & dedup on startup
fetchActivityFeed(); // Load activity timeline on startup
fetchWebhookStats(); // Load webhook stats on startup
fetchSavedSearches(); // Load saved searches on startup
fetchReminderStats(); // Load reminders on startup
fetchTemplateStats(); // Load claim templates on startup
fetchKBStats(); // Load knowledge base on startup
fetchFinancialDashboard(); // Load financial reconciliation on startup
fetchComplianceStats(); // Load compliance framework on startup
fetchRiskDashboard(); // Load risk assessment on startup
fetchCorrespondenceStats(); // Load correspondence on startup
fetchWatchlist(); // Load watchlist on startup
fetchNegotiationStats(); // Load negotiations on startup
fetchTaskStats(); // Load task queue on startup
fetchScorecards(); // Load operator scorecards on startup
fetchExportStats(); // Load export center on startup
fetchMilestoneStats(); // Load milestones on startup
fetchRespondentProfiles(); // Load respondent profiles on startup
fetchSurveyStats(); // Load satisfaction surveys on startup
fetchPlaybookStats(); // Load escalation playbooks on startup
fetchChannelStats(); // Load communication channels on startup
fetchBillingStats(); // Load fee & billing tracker on startup
fetchClaimLinkStats(); // Load claim dependencies on startup
fetchEvidenceStats(); // Load evidence vault on startup

// ===== SATISFACTION SURVEYS (F43) =====
let surveyStatsData = null;

async function fetchSurveyStats(){
  try {
    const r = await fetch('/v1/surveys/stats', {headers:{'Authorization':'Bearer '+apiKey}});
    if(!r.ok) return;
    surveyStatsData = await r.json();
    renderSurveyWidget(surveyStatsData);
  } catch(e) { console.warn('Survey stats error:', e); }
}

function renderSurveyWidget(d){
  document.getElementById('surveyWidget').style.display='block';
  document.getElementById('survAvgRating').textContent = d.avg_rating ? d.avg_rating.toFixed(1) : 'â€”';
  const npsEl = document.getElementById('survNPS');
  npsEl.textContent = d.nps_score !== undefined ? (d.nps_score > 0 ? '+' : '') + d.nps_score : 'â€”';
  npsEl.className = 'ss-num ' + (d.nps_score > 0 ? 'nps-pos' : d.nps_score < 0 ? 'nps-neg' : '');
  document.getElementById('survCompleted').textContent = d.completed || 0;
  document.getElementById('survPending').textContent = (d.pending || 0) + (d.sent || 0);
  document.getElementById('survResponseRate').textContent = (d.response_rate || 0) + '%';

  // Rating distribution bar
  const dist = d.rating_distribution || {};
  const total = Object.values(dist).reduce((a,b)=>a+b, 0) || 1;
  const bar = document.getElementById('survRatingBar');
  bar.innerHTML = '';
  for(let i=5; i>=1; i--){
    const count = dist[String(i)] || 0;
    const pct = Math.max(count/total*100, count>0?5:0);
    bar.innerHTML += '<div class="surv-bar-seg surv-bar-'+i+'" style="flex:'+pct+'" title="'+i+' star: '+count+'">'+
      (pct>8 ? i+'â˜… '+count : count>0 ? count : '') +'</div>';
  }

  // 30-day trend
  const trend = d.trend_30d || [];
  const trendEl = document.getElementById('survTrend');
  if(trend.length === 0){
    trendEl.innerHTML = '<div style="color:#484f58;font-size:11px;width:100%;text-align:center">No trend data yet</div>';
  } else {
    const maxCnt = Math.max(...trend.map(t=>t.count), 1);
    trendEl.innerHTML = trend.map(t => {
      const h = Math.max(t.count / maxCnt * 100, 8);
      return '<div class="surv-trend-bar" style="height:'+h+'%" data-tip="'+t.date+': '+t.avg_rating.toFixed(1)+'â˜… ('+t.count+')"></div>';
    }).join('');
  }

  // Recent feedback
  const list = document.getElementById('survFeedbackList');
  const recent = d.recent_feedback || [];
  if(recent.length === 0){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No survey responses yet. Create surveys to collect claimant feedback.</div>';
  } else {
    list.innerHTML = recent.map(s => {
      const rClass = 'r' + (s.rating || 0);
      const stars = 'â˜…'.repeat(s.rating || 0) + 'â˜†'.repeat(5 - (s.rating || 0));
      return '<div class="surv-card">' +
        '<div class="sc-rating '+rClass+'">'+stars+'</div>' +
        '<div class="sc-body">' +
          '<div class="sc-meta">'+(s.respondent_name||'Unknown')+' Â· '+(s.completed_at ? new Date(s.completed_at).toLocaleDateString() : 'â€”')+
          ' <span class="sc-trigger">'+esc(s.trigger_event||'manual')+'</span></div>' +
          (s.feedback_text ? '<div class="sc-text">"'+esc(s.feedback_text)+'"</div>' : '') +
        '</div></div>';
    }).join('');
  }
}

async function createSurveyForClaim(claimId){
  if(!claimId) return showToast('No claim selected','error');
  try {
    const r = await fetch('/v1/surveys', {
      method:'POST', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
      body: JSON.stringify({claim_id: claimId, trigger_event: 'manual'})
    });
    const d = await r.json();
    if(!r.ok) return showToast(d.detail||'Failed to create survey','error');
    showToast('Survey created: '+d.survey_id,'success');
    fetchSurveyStats();
  } catch(e){ showToast('Error creating survey','error'); }
}

// ===== ESCALATION PLAYBOOKS (F44) =====
let pbStatsData = null;
let pbAllPlaybooks = [];

async function fetchPlaybookStats(){
  try {
    const [statsR, listR] = await Promise.all([
      fetch('/v1/playbooks/stats', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/playbooks', {headers:{'Authorization':'Bearer '+apiKey}})
    ]);
    if(statsR.ok) { pbStatsData = await statsR.json(); renderPlaybookStats(pbStatsData); }
    if(listR.ok) { const ld = await listR.json(); pbAllPlaybooks = ld.playbooks || []; renderPlaybookList(pbAllPlaybooks); }
    document.getElementById('playbookWidget').style.display='block';
  } catch(e) { console.warn('Playbook stats error:', e); }
}

function renderPlaybookStats(d){
  document.getElementById('pbTotal').textContent = d.total_playbooks || 0;
  document.getElementById('pbActive').textContent = d.active_playbooks || 0;
  document.getElementById('pbExecutions').textContent = d.total_executions || 0;
  const rateEl = document.getElementById('pbSuccessRate');
  rateEl.textContent = d.total_executions > 0 ? d.success_rate + '%' : 'â€”';
  rateEl.className = 'es-num ' + (d.success_rate >= 80 ? 'rate-high' : d.success_rate < 50 ? 'rate-low' : '');

  // Recent executions
  const items = document.getElementById('pbExecItems');
  const recent = d.recent_executions || [];
  if(recent.length === 0){
    items.innerHTML = 'No executions yet';
  } else {
    items.innerHTML = recent.map(e =>
      '<div class="epb-exec-item">' +
        '<div class="exi-status '+e.status+'"></div>' +
        '<span>'+esc(e.playbook_name||'?')+' â†’ '+esc(e.claim_id||'')+' ('+e.status+')</span>' +
      '</div>'
    ).join('');
  }
}

function renderPlaybookList(playbooks){
  const list = document.getElementById('playbookList');
  if(!playbooks || playbooks.length === 0){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No playbooks configured. Default playbooks will be auto-created.</div>';
    return;
  }
  list.innerHTML = playbooks.map(p => {
    const stepsCount = p.steps_count || (p.steps||[]).length;
    const active = p.is_active ? 'active' : 'inactive';
    return '<div class="epb-card">' +
      '<div class="ec-head"><span class="ec-name">'+esc(p.name)+'</span>' +
      '<span class="ec-badge '+active+'">'+(p.is_active?'Active':'Inactive')+'</span></div>' +
      (p.description ? '<div class="ec-desc">'+esc(p.description)+'</div>' : '') +
      '<div class="ec-meta">' +
        '<span class="ec-trigger">'+esc(p.trigger_type||'manual')+'</span>' +
        '<span>'+stepsCount+' steps</span>' +
        '<span>Cooldown: '+(p.cooldown_hours||24)+'h</span>' +
      '</div></div>';
  }).join('');
}

async function executePlaybook(playbookId, claimId){
  if(!playbookId || !claimId) return showToast('Missing playbook or claim ID','error');
  try {
    const r = await fetch('/v1/playbooks/'+playbookId+'/execute', {
      method:'POST', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
      body: JSON.stringify({claim_id: claimId})
    });
    const d = await r.json();
    if(!r.ok) return showToast(d.detail||'Playbook execution failed','error');
    showToast('Playbook executed: '+d.steps_executed+' steps, status: '+d.status,'success');
    fetchPlaybookStats();
  } catch(e){ showToast('Error executing playbook','error'); }
}

// ===== COMMUNICATION CHANNEL REGISTRY (F45) =====
let channelData = [];
let channelFilter = '';

async function fetchChannelStats(){
  try {
    const [statsR, listR, typesR] = await Promise.all([
      fetch('/v1/channels/stats', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/channels', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/channels/types', {headers:{'Authorization':'Bearer '+apiKey}})
    ]);
    if(!statsR.ok || !listR.ok) return;
    const stats = await statsR.json();
    const list = await listR.json();
    const types = typesR.ok ? await typesR.json() : {types:[]};
    channelData = list.channels || list || [];
    document.getElementById('chTotal').textContent = stats.total_channels || 0;
    document.getElementById('chEntities').textContent = stats.unique_entities || 0;
    document.getElementById('chSuccess').textContent = stats.total_successes || 0;
    const rate = stats.total_channels > 0 && stats.total_successes !== undefined
      ? Math.round((stats.total_successes / Math.max(stats.total_successes + (stats.total_failures||0), 1)) * 100) + '%'
      : 'â€”';
    document.getElementById('chRate').textContent = rate;
    renderChannelTypeBar(types.types || []);
    renderChannelList(channelData);
    document.getElementById('channelWidget').style.display='block';
  } catch(e) { console.warn('Channel stats error:', e); }
}

function renderChannelTypeBar(types){
  const bar = document.getElementById('chTypeBar');
  bar.innerHTML = '<span class="ccr-type-chip '+(channelFilter===''?'active':'')+'" onclick="filterChannels(\'\')">All</span>';
  types.forEach(t => {
    bar.innerHTML += '<span class="ccr-type-chip '+(channelFilter===t?'active':'')+'" onclick="filterChannels(\''+t+'\')">'+esc(t)+'</span>';
  });
}

function filterChannels(type){
  channelFilter = type;
  const filtered = type ? channelData.filter(c => c.channel_type === type) : channelData;
  renderChannelList(filtered);
  document.querySelectorAll('.ccr-type-chip').forEach(el => {
    el.classList.toggle('active', (type==='' && el.textContent==='All') || el.textContent===type);
  });
}

function renderChannelList(channels){
  const list = document.getElementById('channelList');
  if(!channels || channels.length === 0){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No channels registered</div>';
    return;
  }
  list.innerHTML = channels.map(c => {
    const typeCls = (c.channel_type||'other').toLowerCase();
    const successRate = (c.success_count||0) + (c.fail_count||0) > 0
      ? Math.round((c.success_count||0) / ((c.success_count||0) + (c.fail_count||0)) * 100) + '%'
      : 'â€”';
    return '<div class="ccr-card">' +
      '<div class="cc-head">' +
        '<span class="cc-entity">'+esc(c.respondent_entity||'Unknown')+(c.is_primary?'<span class="cc-primary">PRIMARY</span>':'')+'</span>' +
        '<span class="cc-type-badge '+typeCls+'">'+esc(c.channel_type||'other')+'</span>' +
      '</div>' +
      '<div class="cc-contact">'+esc(c.contact_value||'')+(c.notes?' &mdash; '+esc(c.notes):'')+'</div>' +
      '<div class="cc-meta">' +
        '<span style="color:#3fb950">&#x2713; '+(c.success_count||0)+'</span>' +
        '<span style="color:#f85149">&#x2717; '+(c.fail_count||0)+'</span>' +
        '<span>Rate: '+successRate+'</span>' +
        (c.last_used ? '<span>Last: '+new Date(c.last_used).toLocaleDateString()+'</span>' : '') +
      '</div>' +
      '<div class="cc-actions">' +
        '<button class="cc-success" onclick="recordChannelOutcome(\''+c.channel_id+'\',\'success\')">&#x2713; Success</button>' +
        '<button class="cc-fail" onclick="recordChannelOutcome(\''+c.channel_id+'\',\'failure\')">&#x2717; Fail</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

async function recordChannelOutcome(channelId, outcome){
  try {
    const r = await fetch('/v1/channels/'+channelId+'/outcome', {
      method:'POST', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
      body: JSON.stringify({outcome: outcome, notes: 'Recorded via dashboard'})
    });
    const d = await r.json();
    if(!r.ok) return showToast(d.detail||'Failed to record outcome','error');
    showToast('Channel outcome recorded: '+outcome,'success');
    fetchChannelStats();
  } catch(e){ showToast('Error recording outcome','error'); }
}

// ===== FEE & BILLING TRACKER (F46) =====
let billingData = [];
let billingFilter = '';

async function fetchBillingStats(){
  try {
    const [statsR, listR] = await Promise.all([
      fetch('/v1/billing/stats', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/billing', {headers:{'Authorization':'Bearer '+apiKey}})
    ]);
    if(!statsR.ok) return;
    const stats = await statsR.json();
    const list = listR.ok ? await listR.json() : {entries:[]};
    billingData = list.entries || [];
    document.getElementById('bilTotal').textContent = stats.total_entries || 0;
    document.getElementById('bilBilled').textContent = '$' + (stats.total_billed_usd||0).toLocaleString();
    document.getElementById('bilCollected').textContent = '$' + (stats.total_collected_usd||0).toLocaleString();
    document.getElementById('bilOutstanding').textContent = '$' + (stats.total_outstanding_usd||0).toLocaleString();
    document.getElementById('bilOverdue').textContent = stats.overdue || 0;
    const rate = stats.collection_rate || 0;
    document.getElementById('bilRate').textContent = rate + '%';
    document.getElementById('bilRateFill').style.width = Math.min(rate, 100) + '%';
    renderBillingList(billingData);
    document.getElementById('billingWidget').style.display='block';
  } catch(e){ console.warn('Billing stats error:', e); }
}

function filterBilling(status){
  billingFilter = status;
  const filtered = status ? billingData.filter(b => b.status === status) : billingData;
  renderBillingList(filtered);
  document.querySelectorAll('.bil-filter-chip').forEach(el => {
    const elStatus = el.textContent.toLowerCase();
    el.classList.toggle('active', (status==='' && elStatus==='all') || elStatus===status);
  });
}

function renderBillingList(entries){
  const list = document.getElementById('billingList');
  if(!entries || entries.length === 0){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No billing entries</div>';
    return;
  }
  list.innerHTML = entries.map(b => {
    const statusCls = b.status === 'paid' ? 'paid' : (b.due_date && b.due_date < new Date().toISOString() && b.status === 'pending') ? 'overdue' : b.status;
    const amt = '$' + (b.amount_usd||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    return '<div class="bil-card">' +
      '<div class="bc-head">' +
        '<span class="bc-desc">'+esc(b.description || b.entry_type || 'Fee')+'</span>' +
        '<span class="bc-amount">'+amt+'</span>' +
      '</div>' +
      '<div class="bc-head">' +
        '<span class="bc-type">'+esc(b.entry_type||'fee')+'</span>' +
        '<span class="bc-status '+statusCls+'">'+esc(statusCls)+'</span>' +
      '</div>' +
      '<div class="bc-meta">' +
        '<span>Claim: '+esc((b.claim_id||'').substring(0,8))+'</span>' +
        (b.fee_pct ? '<span>'+b.fee_pct+'%</span>' : '') +
        (b.invoice_number ? '<span>'+esc(b.invoice_number)+'</span>' : '') +
        (b.due_date ? '<span>Due: '+new Date(b.due_date).toLocaleDateString()+'</span>' : '') +
        (b.paid_date ? '<span style="color:#3fb950">Paid: '+new Date(b.paid_date).toLocaleDateString()+'</span>' : '') +
      '</div>' +
      (b.status === 'pending' ? '<div class="bc-actions"><button class="bc-pay" onclick="markBillingPaid(\''+b.entry_id+'\')">&#x1F4B3; Mark Paid</button></div>' : '') +
    '</div>';
  }).join('');
}

async function markBillingPaid(entryId){
  try {
    const r = await fetch('/v1/billing/'+entryId+'/pay', {
      method:'POST', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
      body: JSON.stringify({payment_method: 'dashboard', notes: 'Marked paid via dashboard'})
    });
    const d = await r.json();
    if(!r.ok) return showToast(d.detail||'Failed to mark paid','error');
    showToast('Entry marked as paid','success');
    fetchBillingStats();
  } catch(e){ showToast('Error marking paid','error'); }
}

// ===== CLAIM DEPENDENCIES & LINKED CASES (F47) =====
let claimLinksData = [];
let claimLinkFilter = '';

async function fetchClaimLinkStats(){
  try {
    const [statsR, listR, typesR] = await Promise.all([
      fetch('/v1/claim-links/stats', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/claim-links', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/claim-links/types', {headers:{'Authorization':'Bearer '+apiKey}})
    ]);
    if(!statsR.ok) return;
    const stats = await statsR.json();
    const list = listR.ok ? await listR.json() : {links:[]};
    const types = typesR.ok ? await typesR.json() : {types:[]};
    claimLinksData = list.links || [];
    document.getElementById('clTotal').textContent = stats.total_links || 0;
    document.getElementById('clClaims').textContent = stats.claims_with_links || 0;
    document.getElementById('clStrength').textContent = stats.avg_strength || 'â€”';
    document.getElementById('clTypes').textContent = (stats.link_types||[]).length || 0;
    renderClaimLinkTypeBar(types.types || []);
    renderClaimLinkList(claimLinksData);
    document.getElementById('claimLinksWidget').style.display='block';
  } catch(e){ console.warn('Claim links error:', e); }
}

function renderClaimLinkTypeBar(types){
  const bar = document.getElementById('clTypeBar');
  bar.innerHTML = '<span class="cdl-type-chip '+(claimLinkFilter===''?'active':'')+'" onclick="filterClaimLinks(\'\')">All</span>';
  types.forEach(t => {
    bar.innerHTML += '<span class="cdl-type-chip '+(claimLinkFilter===t?'active':'')+'" onclick="filterClaimLinks(\''+t+'\')">'+esc(t)+'</span>';
  });
}

function filterClaimLinks(type){
  claimLinkFilter = type;
  const filtered = type ? claimLinksData.filter(l => l.link_type === type) : claimLinksData;
  renderClaimLinkList(filtered);
  document.querySelectorAll('.cdl-type-chip').forEach(el => {
    el.classList.toggle('active', (type==='' && el.textContent==='All') || el.textContent===type);
  });
}

function renderClaimLinkList(links){
  const list = document.getElementById('claimLinkList');
  if(!links || links.length === 0){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No claim links yet</div>';
    return;
  }
  list.innerHTML = links.map(l => {
    const typeCls = (l.link_type||'related').replace(/\s/g,'_');
    return '<div class="cdl-card">' +
      '<div class="dl-head">' +
        '<span class="dl-claims">'+esc((l.source_claim_id||'').substring(0,12))+'<span class="dl-arrow">&rarr;</span>'+esc((l.target_claim_id||'').substring(0,12))+'</span>' +
        '<span class="dl-type-badge '+typeCls+'">'+esc(l.link_type||'related')+'</span>' +
      '</div>' +
      (l.description ? '<div class="dl-desc">'+esc(l.description)+'</div>' : '') +
      '<div class="dl-meta">' +
        '<span class="dl-strength">Strength: '+(l.strength||1.0)+'</span>' +
        '<span>'+new Date(l.created_at).toLocaleDateString()+'</span>' +
        (l.created_by ? '<span>by '+esc(l.created_by)+'</span>' : '') +
      '</div>' +
    '</div>';
  }).join('');
}

// ===== CLAIM EVIDENCE VAULT (F48) =====
let evidenceData = [];
let evidenceFilter = '';

async function fetchEvidenceStats(){
  try {
    const [statsR, listR, typesR] = await Promise.all([
      fetch('/v1/evidence/stats', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/evidence', {headers:{'Authorization':'Bearer '+apiKey}}),
      fetch('/v1/evidence/types', {headers:{'Authorization':'Bearer '+apiKey}})
    ]);
    if(!statsR.ok) return;
    const stats = await statsR.json();
    const list = listR.ok ? await listR.json() : {evidence:[]};
    const types = typesR.ok ? await typesR.json() : {types:[]};
    evidenceData = list.evidence || [];
    document.getElementById('evTotal').textContent = stats.total_items || 0;
    document.getElementById('evVerified').textContent = stats.verified || 0;
    document.getElementById('evPending').textContent = stats.pending || 0;
    document.getElementById('evClaims').textContent = stats.claims_with_evidence || 0;
    const rate = stats.verification_rate || 0;
    document.getElementById('evRate').textContent = rate + '%';
    document.getElementById('evRateFill').style.width = Math.min(rate, 100) + '%';
    renderEvidenceTypeBar(types.types || []);
    renderEvidenceList(evidenceData);
    document.getElementById('evidenceWidget').style.display='block';
  } catch(e){ console.warn('Evidence stats error:', e); }
}

function renderEvidenceTypeBar(types){
  const bar = document.getElementById('evTypeBar');
  bar.innerHTML = '<span class="cev-type-chip '+(evidenceFilter===''?'active':'')+'" onclick="filterEvidence(\'\')">All</span>';
  types.forEach(t => {
    bar.innerHTML += '<span class="cev-type-chip '+(evidenceFilter===t?'active':'')+'" onclick="filterEvidence(\''+t+'\')">'+esc(t)+'</span>';
  });
}

function filterEvidence(type){
  evidenceFilter = type;
  const filtered = type ? evidenceData.filter(e => e.evidence_type === type) : evidenceData;
  renderEvidenceList(filtered);
  document.querySelectorAll('.cev-type-chip').forEach(el => {
    el.classList.toggle('active', (type==='' && el.textContent==='All') || el.textContent===type);
  });
}

function renderEvidenceList(items){
  const list = document.getElementById('evidenceList');
  if(!items || items.length === 0){
    list.innerHTML = '<div style="text-align:center;color:#484f58;font-size:12px;padding:20px">No evidence items</div>';
    return;
  }
  list.innerHTML = items.map(e => {
    const typeCls = (e.evidence_type||'document').replace(/\s/g,'_');
    const tags = (e.tags||[]).map(t => '<span class="ev-tag">'+esc(t)+'</span>').join('');
    return '<div class="cev-card">' +
      '<div class="ev-head">' +
        '<span class="ev-title">'+esc(e.title||'Untitled')+'</span>' +
        '<span class="ev-type-badge '+typeCls+'">'+esc(e.evidence_type||'document')+'</span>' +
      '</div>' +
      (e.description ? '<div class="ev-desc">'+esc(e.description)+'</div>' : '') +
      '<div class="ev-meta">' +
        (e.verified ? '<span class="ev-verified">&#x2713; Verified</span>' : '<span class="ev-pending">Pending</span>') +
        '<span>Claim: '+esc((e.claim_id||'').substring(0,8))+'</span>' +
        (e.file_size_bytes > 0 ? '<span>'+Math.round(e.file_size_bytes/1024)+'KB</span>' : '') +
        '<span>'+new Date(e.created_at).toLocaleDateString()+'</span>' +
      '</div>' +
      (tags ? '<div class="ev-tags">'+tags+'</div>' : '') +
      (!e.verified ? '<div class="ev-actions"><button class="ev-verify-btn" onclick="verifyEvidence(\''+e.evidence_id+'\')">&#x2713; Verify</button></div>' : '') +
    '</div>';
  }).join('');
}

async function verifyEvidence(evidenceId){
  try {
    const r = await fetch('/v1/evidence/'+evidenceId+'/verify', {
      method:'POST', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
      body: JSON.stringify({verified_by: 'dashboard_operator', notes: 'Verified via dashboard'})
    });
    const d = await r.json();
    if(!r.ok) return showToast(d.detail||'Failed to verify','error');
    showToast('Evidence verified','success');
    fetchEvidenceStats();
  } catch(e){ showToast('Error verifying evidence','error'); }
}
</script>

<!-- Compliance Checklist Modal -->
<div id="complianceModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);align-items:center;justify-content:center" onclick="if(event.target===this)complianceCancel()">
  <div style="background:#161b22;border:1px solid #30363d;border-radius:10px;padding:28px 32px;max-width:440px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5)">
    <h3 style="margin:0 0 4px;font-size:16px;color:#e6edf3">&#x1F4CB; Letter Compliance Checklist</h3>
    <p style="margin:0 0 16px;font-size:13px;color:#6e7681">Before generating the <strong id="complianceLetterLabel" style="color:#58a6ff"></strong> letter, confirm each item:</p>
    <label style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;cursor:pointer;font-size:14px;color:#c9d1d9">
      <input type="checkbox" onchange="complianceCheckChanged()" style="margin-top:3px;accent-color:#58a6ff;width:16px;height:16px;flex-shrink:0">
      <span>Letter contains <strong>no legal threats</strong> or claims of filing authority</span>
    </label>
    <label style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;cursor:pointer;font-size:14px;color:#c9d1d9">
      <input type="checkbox" onchange="complianceCheckChanged()" style="margin-top:3px;accent-color:#58a6ff;width:16px;height:16px;flex-shrink:0">
      <span>Letter does <strong>not impersonate</strong> a lawyer, agency, or government body</span>
    </label>
    <label style="display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;cursor:pointer;font-size:14px;color:#c9d1d9">
      <input type="checkbox" onchange="complianceCheckChanged()" style="margin-top:3px;accent-color:#58a6ff;width:16px;height:16px;flex-shrink:0">
      <span>All statements are <strong>factual and verifiable</strong> based on claimant-provided information</span>
    </label>
    <label style="display:flex;align-items:flex-start;gap:10px;margin-bottom:16px;cursor:pointer;font-size:14px;color:#c9d1d9">
      <input type="checkbox" onchange="complianceCheckChanged()" style="margin-top:3px;accent-color:#58a6ff;width:16px;height:16px;flex-shrink:0">
      <span><strong>Claimant authorization</strong> is on file for this communication</span>
    </label>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button onclick="complianceCancel()" style="background:transparent;border:1px solid #30363d;color:#8b949e;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px">Cancel</button>
      <button id="complianceGenBtn" onclick="complianceConfirm()" disabled style="background:#238636;border:none;color:#fff;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;opacity:0.4">Generate Letter</button>
    </div>
  </div>
</div>

<!-- STATUS TRANSITION MODAL -->
<div id="transitionModal" class="transition-modal" onclick="if(event.target===this)closeTransitionModal()">
  <div class="transition-box">
    <div class="transition-header">
      <h3>&#x1F504; Change Status</h3>
      <button onclick="closeTransitionModal()" style="background:none;border:none;color:#6e7681;font-size:18px;cursor:pointer">&times;</button>
    </div>
    <div class="transition-current">
      <span>Claim:</span>
      <strong id="tmClaimId" style="color:#c9956b;font-family:monospace"></strong>
      <span>&mdash;</span>
      <span id="tmRespondent" style="color:#e6edf3"></span>
    </div>
    <div class="transition-current">
      <span>Current status:</span>
      <span id="tmCurrentStatus" class="status" style="font-size:12px"></span>
    </div>
    <div style="font-size:11px;color:#585e68;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Select New Status</div>
    <div class="transition-options" id="tmOptions"></div>
    <div class="transition-reason">
      <label>Reason for transition *</label>
      <textarea id="tmReason" placeholder="Brief explanation for this status change (required for audit trail)..." maxlength="500"></textarea>
    </div>
    <div class="transition-error" id="tmError"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost btn-sm" onclick="closeTransitionModal()">Cancel</button>
      <button class="btn btn-primary btn-sm" id="tmConfirmBtn" onclick="confirmTransition()">Confirm Transition</button>
    </div>
  </div>
</div>

<!-- SEARCH COMMAND PALETTE -->
<div id="searchPalette" class="search-palette" onclick="if(event.target===this)closeSearchPalette()">
  <div class="search-box">
    <div class="search-input-wrap">
      <span class="search-icon">&#x1F50D;</span>
      <input id="searchInput" type="text" placeholder="Search claims, professionals, referrals..." autocomplete="off" spellcheck="false">
      <span class="search-shortcut">ESC to close</span>
    </div>
    <div id="searchResults" class="search-results">
      <div class="search-empty">
        <div class="se-icon">&#x2328;</div>
        <div class="se-text">Start typing to search across all records</div>
      </div>
    </div>
    <div class="search-footer">
      <span><kbd>&#x2191;</kbd> <kbd>&#x2193;</kbd> Navigate &nbsp; <kbd>&#x21B5;</kbd> Open</span>
      <span><kbd>Ctrl</kbd>+<kbd>K</kbd> Toggle</span>
    </div>
  </div>
</div>

</body>
</html>
